<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29645087-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>gateone &mdash; Gate One 1.2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/ansi.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="top" title="Gate One 1.2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for gateone</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#       Copyright 2011 Liftoff Software Corporation</span>
<span class="c">#</span>
<span class="c"># For license information see LICENSE.txt</span>

<span class="c"># Meta</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;1.2.0&#39;</span>
<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;AGPLv3 or Proprietary (see LICENSE.txt)&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>
<span class="n">__commit__</span> <span class="o">=</span> <span class="s">&quot;20130903213249&quot;</span> <span class="c"># Gets replaced by git (holds the date/time)</span>

<span class="c"># NOTE: Docstring includes reStructuredText markup for use with Sphinx.</span>
<span class="n">__doc__</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">.. _gateone.py:</span>

<span class="s">Gate One</span>
<span class="s">========</span>
<span class="s">Gate One is a web-based terminal emulator written in Python using the Tornado</span>
<span class="s">web framework.  This module runs the primary daemon process and acts as a</span>
<span class="s">central controller for all running terminals and terminal programs.  It supports</span>
<span class="s">numerous configuration options and can also be called with the --kill switch</span>
<span class="s">to kill all running terminal programs (if using dtach--otherwise they die on</span>
<span class="s">their own when gateone.py is stopped).</span>

<span class="s">Dependencies</span>
<span class="s">------------</span>
<span class="s">Gate One requires Python 2.6+ but runs best with Python 2.7+.  It also depends</span>
<span class="s">on the following 3rd party Python modules:</span>

<span class="s"> * `Tornado &lt;http://www.tornadoweb.org/&gt;`_ 3.0+ - A non-blocking web server framework that powers FriendFeed.</span>

<span class="s">The following modules are optional and can provide Gate One with additional</span>
<span class="s">functionality:</span>

<span class="s"> * `pyOpenSSL &lt;https://launchpad.net/pyopenssl&gt;`_ 0.10+ - An OpenSSL module/wrapper for Python.  Only used to generate self-signed SSL keys and certificates.  If pyOpenSSL isn&#39;t available Gate One will fall back to using the &#39;openssl&#39; command to generate self-signed certificates.</span>
<span class="s"> * `kerberos &lt;http://pypi.python.org/pypi/kerberos&gt;`_ 1.0+ - A high-level Kerberos interface for Python.  Only necessary if you plan to use the Kerberos authentication module.</span>
<span class="s"> * `python-pam &lt;http://packages.debian.org/lenny/python-pam&gt;`_ 0.4.2+ - A Python module for interacting with PAM (the Pluggable Authentication Module present on nearly every Unix).  Only necessary if you plan to use PAM authentication.</span>
<span class="s"> * `PIL (Python Imaging Library) &lt;http://www.pythonware.com/products/pil/&gt;`_ 1.1.7+ - A Python module for manipulating images.  **Alternative:** `Pillow &lt;https://github.com/python-imaging/Pillow&gt;`_ 2.0+ - A &quot;friendly fork&quot; of PIL that works with Python 3.</span>
<span class="s"> * `mutagen &lt;https://code.google.com/p/mutagen/&gt;`_ 1.21+ - A Python module to handle audio metadata.  Makes it so that if you ``cat music_file.ogg`` in a terminal you&#39;ll get useful track/tag information.</span>

<span class="s">With the exception of python-pam, all required and optional modules can usually be installed via one of these commands:</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@modern-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo pip install --upgrade tornado pyopenssl kerberos pillow mutagen</span>

<span class="s">...or:</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@legacy-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo easy_install tornado pyopenssl kerberos pillow mutagen</span>

<span class="s">.. note:: The use of pip is recommended.  See http://www.pip-installer.org/en/latest/installing.html if you don&#39;t have it.</span>

<span class="s">The python-pam module is available in most Linux distribution repositories.  Simply executing one of the following should take care of it:</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@debian-or-ubuntu-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo apt-get install python-pam</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@redhat-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo yum install python-pam</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@gentoo-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo emerge python-pam</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@suse-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo yast -i python-pam</span>

<span class="s">Settings</span>
<span class="s">--------</span>
<span class="s">Most of Gate One&#39;s options can be controlled by command line switches or via</span>
<span class="s">.conf files in the settings directory.  If you haven&#39;t configured Gate One</span>
<span class="s">before a number of .conf files will be automatically generated using defaults</span>
<span class="s">and/or the command line switches provided the first time you run `gateone.py`.</span>

<span class="s">Settings in the various `settings/*.conf` files are JSON-formatted:</span>

<span class="s">.. note::</span>

<span class="s">    Technically, JSON doesn&#39;t allow comments but Gate One&#39;s .conf files do.</span>

<span class="s">.. code-block:: javascript</span>

<span class="s">    { // You can use single-line comments like this</span>
<span class="s">    /*</span>
<span class="s">    Or multi-line comments like this.</span>
<span class="s">    */</span>
<span class="s">        &quot;*&quot;: { // The * here designates this as &quot;default&quot; values</span>
<span class="s">            &quot;gateone&quot;: { // Settings in this dict are specific to the &quot;gateone&quot; app</span>
<span class="s">                &quot;address&quot;: &quot;10.0.0.100&quot;, // A string value</span>
<span class="s">                &quot;log_file_num_backups&quot;: 10, // An integer value</span>
<span class="s">                // Here&#39;s an example list:</span>
<span class="s">                &quot;origins&quot;: [&quot;localhost&quot;, &quot;127.0.0.1&quot;, &quot;10.0.0.100&quot;],</span>
<span class="s">                &quot;https_redirect&quot;: false, // Booleans are all lower case</span>
<span class="s">                &quot;log_to_stderr&quot;: null // Same as `None` in Python (also lower case)</span>
<span class="s">                // NOTE: No comma after last item</span>
<span class="s">            },</span>
<span class="s">            &quot;terminal&quot;: { // Example of a different application&#39;s settings</span>
<span class="s">                &quot;default_command&quot;: &quot;SSH&quot;, // &lt;-- don&#39;t leave traling commas like this!</span>
<span class="s">                ... // So on and so forth</span>
<span class="s">            }</span>
<span class="s">        }</span>
<span class="s">    }</span>

<span class="s">.. note::</span>

<span class="s">    You *must* use double quotes (&quot;&quot;) to define strings.  Single quotes *can* be</span>
<span class="s">    used inside double quotes, however.  `&quot;example&quot;: &quot;of &#39;single&#39; quotes&quot;`  To</span>
<span class="s">    escape a double-quote inside a double quote use three slashes:</span>
<span class="s">    `&quot;</span><span class="se">\\\\\\\\\\\\</span><span class="s">&quot;foo</span><span class="se">\\\\\\\\\\\\</span><span class="s">&quot;&quot;`</span>

<span class="s">.. All those slashes above are so Sphinx won&#39;t mangle it in HTML.</span>

<span class="s">You can have as many .conf files in your settings directory as you like.  When</span>
<span class="s">Gate One runs it reads all files in alphanumeric order and combines all settings</span>
<span class="s">into a single Python dictionary.  Files loaded last will override settings from</span>
<span class="s">earlier files.  Example:</span>

<span class="s">.. topic:: 20example.conf</span>

<span class="s">    .. code-block:: javascript</span>

<span class="s">        {</span>
<span class="s">            &quot;*&quot;: {</span>
<span class="s">                &quot;terminal&quot;: {</span>
<span class="s">                    &quot;session_logging&quot;: true,</span>
<span class="s">                    &quot;default_command&quot;: &quot;SSH&quot;</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">        }</span>

<span class="s">.. topic:: 99override.conf</span>

<span class="s">    .. code-block:: javascript</span>

<span class="s">        {</span>
<span class="s">            &quot;*&quot;: {</span>
<span class="s">                &quot;terminal&quot;: {</span>
<span class="s">                    &quot;default_command&quot;: &quot;my_override&quot;</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">        }</span>

<span class="s">If Gate One loaded the above example .conf files the resulting dict would be:</span>

<span class="s">.. topic:: Merged settings</span>

<span class="s">    .. code-block:: javascript</span>

<span class="s">        {</span>
<span class="s">            &quot;*&quot;: {</span>
<span class="s">                &quot;terminal&quot;: {</span>
<span class="s">                    &quot;session_logging&quot;: true,</span>
<span class="s">                    &quot;default_command&quot;: &quot;my_override&quot;</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">        }</span>

<span class="s">.. note::</span>

<span class="s">    These settings are loaded using the `~utils.RUDict` (Recusive Update Dict)</span>
<span class="s">    class.</span>

<span class="s">There are a few important differences between the configuration file and</span>
<span class="s">command line switches in regards to boolean values (True/False).  A switch such</span>
<span class="s">as `--debug` is equivalent to ``&quot;debug&quot; = true`` in 10server.conf:</span>

<span class="s">.. code-block:: javascript</span>

<span class="s">    &quot;debug&quot; = true // Booleans are all lower case (not in quotes)</span>

<span class="s">.. tip::</span>

<span class="s">    Use `--setting=True`, `--setting=False`, or `--setting=None` to avoid</span>
<span class="s">    confusion.</span>

<span class="s">.. note::</span>

<span class="s">    The following values in 10server.conf are case sensitive: `true`, `false`</span>
<span class="s">    and `null` (and should not be placed in quotes).</span>

<span class="s">Running gateone.py with the `--help` switch will print the usage information as</span>
<span class="s">well as descriptions of what each configurable option does:</span>

<span class="s">.. ansi-block::</span>

<span class="s">    </span><span class="se">\x1b</span><span class="s">[1;31mroot</span><span class="se">\x1b</span><span class="s">[0m@host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m ./gateone.py --help</span>
<span class="s">    Usage: ./gateone.py [OPTIONS]</span>

<span class="s">    Options:</span>

<span class="s">    --address                       Run on the given address.  Default is all</span>
<span class="s">                                    addresses (IPv6 included).  Multiple address</span>
<span class="s">                                    can be specified using a semicolon as a</span>
<span class="s">                                    separator (e.g. &#39;127.0.0.1;::1;10.1.1.100&#39;).</span>
<span class="s">    --api_keys                      The &#39;key:secret,...&#39; API key pairs you wish</span>
<span class="s">                                    to use (only applies if using API</span>
<span class="s">                                    authentication)</span>
<span class="s">    --api_timestamp_window          How long before an API authentication object</span>
<span class="s">                                    becomes invalid.  Default is &#39;30s&#39; (30</span>
<span class="s">                                    seconds). (default 30s)</span>
<span class="s">    --auth                          Authentication method to use.  Valid options</span>
<span class="s">                                    are: none, api, google, ssl, kerberos, pam</span>
<span class="s">                                    (default none)</span>
<span class="s">    --ca_certs                      Path to a file containing any number of</span>
<span class="s">                                    concatenated CA certificates in PEM format.</span>
<span class="s">                                    They will be used to authenticate clients if</span>
<span class="s">                                    the &#39;ssl_auth&#39; option is set to &#39;optional&#39;</span>
<span class="s">                                    or &#39;required&#39;.</span>
<span class="s">    --cache_dir                     Path where Gate One should store temporary</span>
<span class="s">                                    global files (e.g. rendered templates, CSS,</span>
<span class="s">                                    JS, etc). (default /tmp/gateone_cache)</span>
<span class="s">    --certificate                   Path to the SSL certificate.  Will be auto-</span>
<span class="s">                                    generated if none is provided. (default</span>
<span class="s">                                    certificate.pem)</span>
<span class="s">    --combine_css                   Combines all of Gate One&#39;s CSS Template</span>
<span class="s">                                    files into one big file and saves it at the</span>
<span class="s">                                    given path (e.g. ./gateone.py</span>
<span class="s">                                    --combine_css=/tmp/gateone.css).</span>
<span class="s">    --combine_css_container         Use this setting in conjunction with</span>
<span class="s">                                    --combine_css if the &lt;div&gt; where Gate One</span>
<span class="s">                                    lives is named something other than #gateone</span>
<span class="s">                                    (default #gateone)</span>
<span class="s">    --combine_js                    Combines all of Gate One&#39;s JavaScript files</span>
<span class="s">                                    into one big file and saves it at the given</span>
<span class="s">                                    path (e.g. ./gateone.py</span>
<span class="s">                                    --combine_js=/tmp/gateone.js)</span>
<span class="s">    --command                       DEPRECATED: Use the &#39;commands&#39; option in the</span>
<span class="s">                                    terminal settings.</span>
<span class="s">    --config                        DEPRECATED.  Use --settings_dir. (default</span>
<span class="s">                                    /opt/gateone/server.conf)</span>
<span class="s">    --cookie_secret                 Use the given 45-character string for cookie</span>
<span class="s">                                    encryption.</span>
<span class="s">    --debug                         Enable debugging features such as auto-</span>
<span class="s">                                    restarting when files are modified. (default</span>
<span class="s">                                    False)</span>
<span class="s">    --disable_ssl                   If enabled, Gate One will run without SSL</span>
<span class="s">                                    (generally not a good idea). (default False)</span>
<span class="s">    --dtach                         Wrap terminals with dtach. Allows sessions</span>
<span class="s">                                    to be resumed even if Gate One is stopped</span>
<span class="s">                                    and started (which is a sweet feature).</span>
<span class="s">                                    (default True)</span>
<span class="s">    --embedded                      When embedding Gate One, this option is</span>
<span class="s">                                    available to templates. (default False)</span>
<span class="s">    --enable_unix_socket            Enable Unix socket support. (default False)</span>
<span class="s">    --gid                           Drop privileges and run Gate One as this</span>
<span class="s">                                    group/gid. (default 0)</span>
<span class="s">    --help                          show this help information</span>
<span class="s">    --https_redirect                If enabled, a separate listener will be</span>
<span class="s">                                    started on port 80 that redirects users to</span>
<span class="s">                                    the configured port using HTTPS. (default</span>
<span class="s">                                    False)</span>
<span class="s">    --js_init                       A JavaScript object (string) that will be</span>
<span class="s">                                    used when running GateOne.init() inside</span>
<span class="s">                                    index.html.  Example: --js_init=&quot;{scheme:</span>
<span class="s">                                    &#39;white&#39;}&quot; would result in</span>
<span class="s">                                    GateOne.init({scheme: &#39;white&#39;})</span>
<span class="s">    --keyfile                       Path to the SSL keyfile.  Will be auto-</span>
<span class="s">                                    generated if none is provided. (default</span>
<span class="s">                                    keyfile.pem)</span>
<span class="s">    --kill                          Kill any running Gate One terminal processes</span>
<span class="s">                                    including dtach&#39;d processes. (default False)</span>
<span class="s">    --locale                        The locale (e.g. pt_PT) Gate One should use</span>
<span class="s">                                    for translations.  If not provided, will</span>
<span class="s">                                    default to $LANG (which is &#39;en_US&#39; in your</span>
<span class="s">                                    current shell), or en_US if not set.</span>
<span class="s">                                    (default en_US)</span>
<span class="s">    --new_api_key                   Generate a new API key that an external</span>
<span class="s">                                    application can use to embed Gate One.</span>
<span class="s">                                    (default False)</span>
<span class="s">    --origins                       A semicolon-separated list of origins you</span>
<span class="s">                                    wish to allow access to your Gate One server</span>
<span class="s">                                    over the WebSocket.  This value must contain</span>
<span class="s">                                    the hostnames and FQDNs (e.g. foo;foo.bar;)</span>
<span class="s">                                    users will use to connect to your Gate One</span>
<span class="s">                                    server as well as the hostnames/FQDNs of any</span>
<span class="s">                                    sites that will be embedding Gate One.</span>
<span class="s">                                    Here&#39;s the default on your system: &#39;localhos</span>
<span class="s">                                    t;127.0.0.1;enterprise.lan;enterprise;localh</span>
<span class="s">                                    ost;enterprise.lan;enterprise;enterprise.exa</span>
<span class="s">                                    mple.com;127.0.0.1;10.1.1.100&#39;.</span>
<span class="s">                                    Alternatively, &#39;*&#39; may be  specified to</span>
<span class="s">                                    allow access from anywhere. (default localho</span>
<span class="s">                                    st;127.0.0.1;enterprise.lan;enterprise;local</span>
<span class="s">                                    host;enterprise.lan;enterprise;enterprise.ex</span>
<span class="s">                                    ample.com;127.0.0.1;10.1.1.100)</span>
<span class="s">    --pam_realm                     Basic auth REALM to display when</span>
<span class="s">                                    authenticating clients.  Default: hostname.</span>
<span class="s">                                    Only relevant if PAM authentication is</span>
<span class="s">                                    enabled. (default enterprise)</span>
<span class="s">    --pam_service                   PAM service to use.  Defaults to &#39;login&#39;.</span>
<span class="s">                                    Only relevant if PAM authentication is</span>
<span class="s">                                    enabled. (default login)</span>
<span class="s">    --pid_file                      Define the path to the pid file.  Default:</span>
<span class="s">                                    /tmp/gateone.pid (default /tmp/gateone.pid)</span>
<span class="s">    --port                          Run on the given port. (default 443)</span>
<span class="s">    --session_dir                   Path to the location where session</span>
<span class="s">                                    information will be stored. (default</span>
<span class="s">                                    /tmp/gateone)</span>
<span class="s">    --session_logging               If enabled, logs of user sessions will be</span>
<span class="s">                                    saved in &lt;user_dir&gt;/&lt;user&gt;/logs.  Default:</span>
<span class="s">                                    Enabled (default True)</span>
<span class="s">    --session_timeout               Amount of time that a session is allowed to</span>
<span class="s">                                    idle before it is killed.  Accepts &lt;num&gt;X</span>
<span class="s">                                    where X could be one of s, m, h, or d for</span>
<span class="s">                                    seconds, minutes, hours, and days.  Default</span>
<span class="s">                                    is &#39;5d&#39; (5 days).  Set to &#39;0&#39; to disable</span>
<span class="s">                                    the ability to resume sessions. (default 5d)</span>
<span class="s">    --settings_dir                  Path to the settings directory.  Default:</span>
<span class="s">                                    /opt/gateone/settings (default</span>
<span class="s">                                    /opt/gateone/settings)</span>
<span class="s">    --ssl_auth                      Enable the use of client SSL (X.509)</span>
<span class="s">                                    certificates as a secondary authentication</span>
<span class="s">                                    factor (the configured &#39;auth&#39; type will come</span>
<span class="s">                                    after SSL auth).  May be one of &#39;none&#39;,</span>
<span class="s">                                    &#39;optional&#39;, or &#39;required&#39;.  NOTE: Only works</span>
<span class="s">                                    if the &#39;ca_certs&#39; option is configured.</span>
<span class="s">                                    (default none)</span>
<span class="s">    --sso_realm                     Kerberos REALM (aka DOMAIN) to use when</span>
<span class="s">                                    authenticating clients. Only relevant if</span>
<span class="s">                                    Kerberos authentication is enabled.</span>
<span class="s">    --sso_service                   Kerberos service (aka application) to use.</span>
<span class="s">                                    Defaults to HTTP. Only relevant if Kerberos</span>
<span class="s">                                    authentication is enabled. (default HTTP)</span>
<span class="s">    --syslog_facility               Syslog facility to use when logging to</span>
<span class="s">                                    syslog (if syslog_session_logging is</span>
<span class="s">                                    enabled).  Must be one of: auth, cron,</span>
<span class="s">                                    daemon, kern, local0, local1, local2,</span>
<span class="s">                                    local3, local4, local5, local6, local7, lpr,</span>
<span class="s">                                    mail, news, syslog, user, uucp.  Default:</span>
<span class="s">                                    daemon (default daemon)</span>
<span class="s">    --syslog_host                   Remote host to send syslog messages to if</span>
<span class="s">                                    syslog_logging is enabled.  Default: None</span>
<span class="s">                                    (log to the local syslog daemon directly).</span>
<span class="s">                                    NOTE:  This setting is required on platforms</span>
<span class="s">                                    that don&#39;t include Python&#39;s syslog module.</span>
<span class="s">    --syslog_session_logging        If enabled, logs of user sessions will be</span>
<span class="s">                                    written to syslog. (default False)</span>
<span class="s">    --uid                           Drop privileges and run Gate One as this</span>
<span class="s">                                    user/uid. (default 0)</span>
<span class="s">    --unix_socket_path              Path to the Unix socket (if</span>
<span class="s">                                    --enable_unix_socket=True). (default</span>
<span class="s">                                    /tmp/gateone.sock)</span>
<span class="s">    --url_prefix                    An optional prefix to place before all Gate</span>
<span class="s">                                    One URLs. e.g. &#39;/gateone/&#39;.  Use this if</span>
<span class="s">                                    Gate One will be running behind a reverse</span>
<span class="s">                                    proxy where you want it to be located at</span>
<span class="s">                                    some sub-URL path. (default /)</span>
<span class="s">    --user_dir                      Path to the location where user files will</span>
<span class="s">                                    be stored. (default /opt/gateone/users)</span>
<span class="s">    --user_logs_max_age             Maximum amount of length of time to keep any</span>
<span class="s">                                    given user log before it is removed.</span>
<span class="s">                                    (default 30d)</span>

<span class="s">    /usr/local/lib/python2.7/dist-packages/tornado/log.py options:</span>

<span class="s">    --log_file_max_size             max size of log files before rollover</span>
<span class="s">                                    (default 100000000)</span>
<span class="s">    --log_file_num_backups          number of log files to keep (default 10)</span>
<span class="s">    --log_file_prefix=PATH          Path prefix for log files. Note that if you</span>
<span class="s">                                    are running multiple tornado processes,</span>
<span class="s">                                    log_file_prefix must be different for each</span>
<span class="s">                                    of them (e.g. include the port number)</span>
<span class="s">    --log_to_stderr                 Send log output to stderr (colorized if</span>
<span class="s">                                    possible). By default use stderr if</span>
<span class="s">                                    --log_file_prefix is not set and no other</span>
<span class="s">                                    logging is configured.</span>
<span class="s">    --logging=debug|info|warning|error|none</span>
<span class="s">                                    Set the Python log level. If &#39;none&#39;, tornado</span>
<span class="s">                                    won&#39;t touch the logging configuration.</span>
<span class="s">                                    (default info)</span>

<span class="s">.. note::</span>

<span class="s">    Some of these options (e.g. log_file_prefix) are inherent to the</span>
<span class="s">    Tornado framework.  You won&#39;t find them anywhere in gateone.py.</span>

<span class="s">File Paths</span>
<span class="s">----------</span>
<span class="s">Gate One stores its files, temporary session information, and persistent user</span>
<span class="s">data in the following locations (Note: Many of these are configurable):</span>

<span class="s">==================  ==========================================================================================</span>
<span class="s">File/Directory      Description</span>
<span class="s">==================  ==========================================================================================</span>
<span class="s">authpam.py          Contains the PAM authentication Mixin used by auth.py.</span>
<span class="s">auth.py             Authentication classes.</span>
<span class="s">babel_gateone.cfg   Pybabel configuration for generating localized translations of Gate One&#39;s strings.</span>
<span class="s">certificate.pem     The default certificate Gate One will use in SSL communications.</span>
<span class="s">docs/               Gate One&#39;s documentation.</span>
<span class="s">gateone.py          Gate One&#39;s primary executable/script. Also, the file containing this documentation.</span>
<span class="s">gopam.py            PAM (Authentication) Python module (used by authpam.py).</span>
<span class="s">i18n/               Gate One&#39;s internationalization (i18n) support and locale/translation files.</span>
<span class="s">keyfile.pem         The default private key used with SSL communications.</span>
<span class="s">logviewer.py        A utility to view Gate One session logs.</span>
<span class="s">plugins/            (Global) Plugins go here in the form of ./plugins/&lt;plugin name&gt;/&lt;plugin files|directories&gt;</span>
<span class="s">remote_syslog.py    A module that supports sending syslog messages over UDP to a remote syslog host.</span>
<span class="s">settings/           All Gate One settings files live here (.conf files).</span>
<span class="s">sso.py              A Kerberos Single Sign-on module for Tornado (used by auth.py)</span>
<span class="s">static/             Non-dynamic files that get served to clients (e.g. gateone.js, gateone.css, etc).</span>
<span class="s">templates/          Tornado template files such as index.html.</span>
<span class="s">tests/              Various scripts and tools to test Gate One&#39;s functionality.</span>
<span class="s">utils.py            Various supporting functions.</span>
<span class="s">users/              Persistent user data in the form of ./users/&lt;username&gt;/&lt;user-specific files&gt;</span>
<span class="s">users/&lt;user&gt;/logs   This is where session logs get stored if session_logging is set.</span>
<span class="s">/tmp/gateone        Temporary session data in the form of /tmp/gateone/&lt;session ID&gt;/&lt;files&gt;</span>
<span class="s">/tmp/gateone_cache  Used to store cached files such as minified JavaScript and CSS.</span>
<span class="s">==================  ==========================================================================================</span>

<span class="s">Running</span>
<span class="s">-------</span>
<span class="s">Executing Gate One is as simple as:</span>

<span class="s">.. ansi-block::</span>

<span class="s">    </span><span class="se">\x1b</span><span class="s">[1;31mroot</span><span class="se">\x1b</span><span class="s">[0m@host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m ./gateone.py</span>

<span class="s">.. note::</span>

<span class="s">    By default Gate One will run on port 443 which requires root on most</span>
<span class="s">    systems.  Use `--port=(something higher than 1024)` for non-root users.</span>

<span class="s">Applications and Plugins</span>
<span class="s">------------------------</span>
<span class="s">Gate One supports both *applications* and *plugins*.  The difference is mostly</span>
<span class="s">architectural.  Applications go in the `gateone/applications` directory while</span>
<span class="s">(global) plugins reside in `gateone/plugins`.  The scope of application code</span>
<span class="s">applies only to the application wheras global Gate One plugin code will apply</span>
<span class="s">to Gate One itself and all applications.</span>

<span class="s">.. note:: Applications may have plugins of their own (e.g. terminal/plugins).</span>

<span class="s">Gate One applications and plugins can be written using any combination of the</span>
<span class="s">following:</span>

<span class="s"> * Python</span>
<span class="s"> * JavaScript</span>
<span class="s"> * CSS</span>

<span class="s">Applications and Python plugins can integrate with Gate One in a number ways:</span>

<span class="s"> * Adding or overriding request handlers to provide custom URLs (with a given regex).</span>
<span class="s"> * Adding or overriding methods in `GOApplication` to handle asynchronous WebSocket &quot;actions&quot;.</span>
<span class="s"> * Adding or overriding events via the :meth:`on`, :meth:`off`, :meth:`once`, and :meth:`trigger` functions.</span>
<span class="s"> * Delivering custom content to clients (e.g. JavaScript and CSS templates).</span>

<span class="s">JavaScript and CSS plugins will be delivered over the WebSocket and cached at</span>
<span class="s">the client by way of a novel synchronization mechanism.  Once JavaScript and CSS</span>
<span class="s">assets have been delivered they will only ever have to be re-delivered to</span>
<span class="s">clients if they have been modified (on the server).  This mechanism is extremely</span>
<span class="s">bandwidth efficient and should allow clients to load Gate One content much more</span>
<span class="s">quickly than traditional HTTP GET requests.</span>

<span class="s">.. tip::</span>

<span class="s">    If you install the `cssmin` and/or `slimit` Python modules all JavaScript</span>
<span class="s">    and CSS assets will be automatically minified before being delivered to</span>
<span class="s">    clients.</span>

<span class="s">Class Docstrings</span>
<span class="s">================</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="c"># Standard library modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">pty</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>

<span class="c"># This is used as a way to ensure users get a friendly message about missing</span>
<span class="c"># dependencies:</span>
<span class="n">MISSING_DEPS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c"># This is needed before other globals for certain checks:</span>
<span class="n">GATEONE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>

<span class="n">tornado_version</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="c"># Placeholder in case Tornado import fails below</span>

<span class="c"># Tornado modules (yeah, we use all this stuff)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tornado.httpserver</span>
    <span class="kn">import</span> <span class="nn">tornado.ioloop</span>
    <span class="kn">import</span> <span class="nn">tornado.options</span>
    <span class="kn">import</span> <span class="nn">tornado.web</span>
    <span class="kn">import</span> <span class="nn">tornado.log</span>
    <span class="kn">import</span> <span class="nn">tornado.auth</span>
    <span class="kn">import</span> <span class="nn">tornado.template</span>
    <span class="kn">import</span> <span class="nn">tornado.netutil</span>
    <span class="kn">from</span> <span class="nn">tornado.websocket</span> <span class="kn">import</span> <span class="n">WebSocketHandler</span>
    <span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="kn">import</span> <span class="n">json_decode</span>
    <span class="kn">from</span> <span class="nn">tornado.options</span> <span class="kn">import</span> <span class="n">define</span><span class="p">,</span> <span class="n">options</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">locale</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">tornado_version</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
    <span class="n">MISSING_DEPS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;tornado &gt;= 3.0&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">tornado_version</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;3&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;tornado &gt;= 3.0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MISSING_DEPS</span><span class="p">:</span>
        <span class="n">MISSING_DEPS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;tornado &gt;= 3.0&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">MISSING_DEPS</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[31;1mERROR:</span><span class="se">\x1b</span><span class="s">[0m: This host is missing dependencies:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">MISSING_DEPS</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;    </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dep</span><span class="p">)</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">MISSING_DEPS</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[1m  sudo pip install --upgrade </span><span class="si">%s</span><span class="se">\x1b</span><span class="s">[0m.&quot;</span> <span class="o">%</span>
        <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MISSING_DEPS</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># We want this turned on right away</span>
<span class="n">tornado</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">enable_pretty_logging</span><span class="p">()</span>

<span class="c"># If Gate One was not installed (via setup.py) it won&#39;t have access to some</span>
<span class="c"># modules that get installed along with it.  We&#39;ll add them to sys.path if they</span>
<span class="c"># are missing.  This way users can use Gate One without *having* to install it.</span>
<span class="n">setup_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;../&#39;</span><span class="p">))</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span> <span class="s">&#39;onoff&#39;</span><span class="p">)):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setup_path</span><span class="p">)</span>
<span class="k">del</span> <span class="n">setup_path</span> <span class="c"># Don&#39;t need this for anything else</span>

<span class="c"># Our own modules</span>
<span class="kn">from</span> <span class="nn">auth</span> <span class="kn">import</span> <span class="n">NullAuthHandler</span><span class="p">,</span> <span class="n">KerberosAuthHandler</span><span class="p">,</span> <span class="n">GoogleAuthHandler</span>
<span class="kn">from</span> <span class="nn">auth</span> <span class="kn">import</span> <span class="n">APIAuthHandler</span><span class="p">,</span> <span class="n">SSLAuthHandler</span><span class="p">,</span> <span class="n">PAMAuthHandler</span>
<span class="kn">from</span> <span class="nn">auth</span> <span class="kn">import</span> <span class="n">require</span><span class="p">,</span> <span class="n">authenticated</span><span class="p">,</span> <span class="n">policies</span><span class="p">,</span> <span class="n">applicable_policies</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">generate_session_id</span><span class="p">,</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">SettingsError</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">gen_self_signed_ssl</span><span class="p">,</span> <span class="n">killall</span><span class="p">,</span> <span class="n">get_plugins</span><span class="p">,</span> <span class="n">load_modules</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">merge_handlers</span><span class="p">,</span> <span class="n">none_fix</span><span class="p">,</span> <span class="n">convert_to_timedelta</span><span class="p">,</span> <span class="n">short_hash</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">FACILITIES</span><span class="p">,</span> <span class="n">json_encode</span><span class="p">,</span> <span class="n">recursive_chown</span><span class="p">,</span> <span class="n">ChownError</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">write_pid</span><span class="p">,</span> <span class="n">read_pid</span><span class="p">,</span> <span class="n">remove_pid</span><span class="p">,</span> <span class="n">drop_privileges</span><span class="p">,</span> <span class="n">get_or_cache</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">check_write_permissions</span><span class="p">,</span> <span class="n">get_applications</span><span class="p">,</span> <span class="n">get_settings</span>
<span class="kn">from</span> <span class="nn">onoff</span> <span class="kn">import</span> <span class="n">OnOffMixin</span>

<span class="c"># Setup our base loggers (these get overwritten in main())</span>
<span class="kn">from</span> <span class="nn">golog</span> <span class="kn">import</span> <span class="n">go_logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="n">auth_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.auth&#39;</span><span class="p">)</span>
<span class="n">msg_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.message&#39;</span><span class="p">)</span>

<span class="c"># Setup the locale functions before anything else</span>
<span class="n">locale</span><span class="o">.</span><span class="n">set_default_locale</span><span class="p">(</span><span class="s">&#39;en_US&#39;</span><span class="p">)</span>
<span class="n">user_locale</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Replaced with the actual user locale object in __main__</span>
<div class="viewcode-block" id="_"><a class="viewcode-back" href="../Developer/gateone.html#gateone._">[docs]</a><span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps user_locale.translate so we don&#39;t get errors if loading a locale fails</span>
<span class="sd">    (or we output a message before it is initialized).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">user_locale</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user_locale</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span>

<span class="c"># Globals</span></div>
<span class="n">SESSIONS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># We store the crux of most session info here</span>
<span class="n">CMD</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Will be overwritten by options.command</span>
<span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c"># Gets overridden by options.session_timeout</span>
<span class="c"># SESSION_WATCHER be replaced with a tornado.ioloop.PeriodicCallback that watches for</span>
<span class="c"># sessions that have timed out and takes care of cleaning them up.</span>
<span class="n">SESSION_WATCHER</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">CLEANER</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Log cleaner PeriodicCallback</span>
<span class="n">FILE_CACHE</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c"># PERSIST is a generic place for applications and plugins to store stuff in a</span>
<span class="c"># way that lasts between page loads.  USE RESPONSIBLY.</span>
<span class="n">PERSIST</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">APPLICATIONS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">PLUGINS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">PLUGIN_WS_CMDS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Gives plugins the ability to extend/enhance ApplicationWebSocket</span>
<span class="n">PLUGIN_HOOKS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Gives plugins the ability to hook into various things.</span>
<span class="n">PLUGIN_AUTH_HOOKS</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># For plugins to register functions to be called after a</span>
                       <span class="c"># user successfully authenticates</span>
<span class="n">PLUGIN_ENV_HOOKS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Allows plugins to add environment variables that will be</span>
                      <span class="c"># available to all executed commands.</span>
<span class="c"># Gate One registers a handler for for terminal.py&#39;s CALLBACK_OPT special escape</span>
<span class="c"># sequence callback.  Whenever this escape sequence is encountered, Gate One</span>
<span class="c"># will parse the sequence&#39;s contained characters looking for the following</span>
<span class="c"># format:</span>
<span class="c">#   &lt;plugin name&gt;|&lt;whatever&gt;</span>
<span class="c"># The &lt;whatever&gt; part will be passed to any plugin matching &lt;plugin name&gt; if the</span>
<span class="c"># plugin has &#39;Escape&#39;: &lt;function&gt; registered in its hooks.</span>
<span class="n">PLUGIN_ESC_HANDLERS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c"># This is used to store plugin terminal hooks that are called when a new</span>
<span class="c"># terminal is created (so a plugin could override/attach callbacks to the</span>
<span class="c"># multiplex or terminal emulator instances).  NOTE: This is specifically for</span>
<span class="c"># adding to the terminal emulator&#39;s CALLBACK_* capability.  For modifying the</span>
<span class="c"># terminal emulator instance directly see PLUGIN_NEW_TERM_HOOKS.</span>
<span class="n">PLUGIN_TERM_HOOKS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c"># The NEW_TERM hooks are called at the end of ApplicationWebSocket.new_terminal()</span>
<span class="c"># with &#39;self&#39; and the new instance of the terminal emulator as the only</span>
<span class="c"># arguments.  It&#39;s a more DIY/generic version of PLUGIN_TERM_HOOKS.</span>
<span class="n">PLUGIN_NEW_TERM_HOOKS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c"># &#39;Command&#39; hooks get called before a new Multiplex instance is created inside</span>
<span class="c"># of ApplicationWebSocket.new_multiplex().  They are passed the &#39;command&#39; and must</span>
<span class="c"># return a string that will be used as the replacement &#39;command&#39;.  This allows</span>
<span class="c"># plugin authors to modify the configured &#39;command&#39; before it is executed</span>
<span class="n">PLUGIN_COMMAND_HOOKS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c"># &#39;Multiplex&#39; hooks get called at the end of ApplicationWebSocket.new_multiplex()</span>
<span class="c"># with the instance of ApplicationWebSocket and the new instance of Multiplex as</span>
<span class="c"># the only arguments, respectively.</span>
<span class="n">PLUGIN_NEW_MULTIPLEX_HOOKS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c"># Secondary locale setup</span>
<span class="n">locale_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;i18n&#39;</span><span class="p">)</span>
<span class="n">locale</span><span class="o">.</span><span class="n">load_gettext_translations</span><span class="p">(</span><span class="n">locale_dir</span><span class="p">,</span> <span class="s">&#39;gateone&#39;</span><span class="p">)</span>
<span class="c"># NOTE: The locale gets set in __main__</span>

<span class="c"># Helper functions</span>
<div class="viewcode-block" id="require_auth"><a class="viewcode-back" href="../Developer/gateone.html#gateone.require_auth">[docs]</a><span class="k">def</span> <span class="nf">require_auth</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An equivalent to `tornado.web.authenticated` for WebSockets</span>
<span class="sd">    (`ApplicationWebSocket`, specifically).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Only valid users please.  Thanks!&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</div>
<div class="viewcode-block" id="cleanup_user_logs"><a class="viewcode-back" href="../Developer/gateone.html#gateone.cleanup_user_logs">[docs]</a><span class="k">def</span> <span class="nf">cleanup_user_logs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans up all user logs (everything in the user&#39;s &#39;logs&#39; directory and</span>
<span class="sd">    subdirectories that ends in &#39;log&#39;) older than the `user_logs_max_age`</span>
<span class="sd">    setting.  The log directory is assumed to be:</span>

<span class="sd">        *user_dir*/&lt;user&gt;/logs</span>

<span class="sd">    ...where *user_dir* is whatever Gate One happens to have configured for</span>
<span class="sd">    that particular setting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;cleanup_session_logs()&quot;</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
    <span class="n">user_dir</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">][</span><span class="s">&#39;user_dir&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;user_dir&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c"># NOTE: options is global</span>
        <span class="n">user_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">user_dir</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;30d&quot;</span>
    <span class="n">max_age_str</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_logs_max_age&#39;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;user_logs_max_age&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">max_age_str</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">user_logs_max_age</span>
    <span class="n">max_age</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">max_age_str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">descend</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Descends *path* removing logs it finds older than `max_age` and calls</span>
<span class="sd">        :func:`descend` on any directories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">log_path</span><span class="p">):</span>
                <span class="n">descend</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">log_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="c"># Convert to a datetime object for easier comparison</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">mtime</span> <span class="o">&gt;</span> <span class="n">max_age</span><span class="p">:</span>
                <span class="c"># The log is older than max_age, remove it</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Removing log due to age (&gt;</span><span class="si">%s</span><span class="s"> old): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">max_age_str</span><span class="p">,</span> <span class="n">log_path</span><span class="p">)))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">user_dir</span><span class="p">):</span>
        <span class="n">logs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;logs&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logs_path</span><span class="p">):</span>
            <span class="c"># Nothing to do</span>
            <span class="k">continue</span>
        <span class="n">descend</span><span class="p">(</span><span class="n">logs_path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="policy_send_user_message"><a class="viewcode-back" href="../Developer/gateone.html#gateone.policy_send_user_message">[docs]</a><span class="k">def</span> <span class="nf">policy_send_user_message</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`gateone_policies`, returns True if the user is</span>
<span class="sd">    authorized to send messages to other users and if applicable, all users</span>
<span class="sd">    (broadcasts).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;You do not have permission to send messages to </span><span class="si">%s</span><span class="s">.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">upn</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">f_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
        <span class="c"># send_user_message got bad *settings*.  Deny</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c"># TODO: Add a mechanism that allows users to mute other users here.</span>
    <span class="k">if</span> <span class="n">upn</span> <span class="o">==</span> <span class="s">&#39;AUTHENTICATED&#39;</span><span class="p">:</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error_msg</span> <span class="o">%</span> <span class="s">&quot;all users at once&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error_msg</span> <span class="o">%</span> <span class="n">upn</span>
    <span class="k">return</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;send_user_messages&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="policy_broadcast"><a class="viewcode-back" href="../Developer/gateone.html#gateone.policy_broadcast">[docs]</a><span class="k">def</span> <span class="nf">policy_broadcast</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`gateone_policies`, returns True if the user is</span>
<span class="sd">    authorized to broadcast messages using the</span>
<span class="sd">    :meth:`ApplicationWebSocket.broadcast` method.  It makes this determination</span>
<span class="sd">    by checking the `[&#39;gateone&#39;][&#39;send_broadcasts&#39;]` policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;You do not have permission to broadcast messages.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;send_broadcasts&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="c"># Default deny</span>
</div>
<div class="viewcode-block" id="policy_list_users"><a class="viewcode-back" href="../Developer/gateone.html#gateone.policy_list_users">[docs]</a><span class="k">def</span> <span class="nf">policy_list_users</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`gateone_policies`, returns True if the user is</span>
<span class="sd">    authorized to retrieve a list of the users currently connected to the Gate</span>
<span class="sd">    One server via the :meth:`ApplicationWebSocket.list_server_users` method.</span>
<span class="sd">    It makes this determination by checking the `[&#39;gateone&#39;][&#39;list_users&#39;]`</span>
<span class="sd">    policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;You do not have permission to list connected users.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;list_users&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="gateone_policies"><a class="viewcode-back" href="../Developer/gateone.html#gateone.gateone_policies">[docs]</a><span class="k">def</span> <span class="nf">gateone_policies</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function gets registered under &#39;gateone&#39; in the</span>
<span class="sd">    :attr:`ApplicationWebSocket.security` dict and is called by the</span>
<span class="sd">    :func:`require` decorator by way of the :class:`policies` sub-function. It</span>
<span class="sd">    returns True or False depending on what is defined in the settings dir and</span>
<span class="sd">    what function is being called.</span>

<span class="sd">    This function will keep track of and place limits on the following:</span>

<span class="sd">        * Who can send messages to other users (including broadcasts).</span>
<span class="sd">        * Who can retrieve a list of connected users.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">instance</span> <span class="c"># ApplicationWebSocket instance</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">function</span> <span class="c"># Wrapped function</span>
    <span class="c">#f_args = cls.f_args     # Wrapped function&#39;s arguments</span>
    <span class="c">#f_kwargs = cls.f_kwargs # Wrapped function&#39;s keyword arguments</span>
    <span class="n">policy_functions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;send_user_message&#39;</span><span class="p">:</span> <span class="n">policy_send_user_message</span><span class="p">,</span>
        <span class="s">&#39;broadcast&#39;</span><span class="p">:</span> <span class="n">policy_broadcast</span><span class="p">,</span>
        <span class="s">&#39;list_server_users&#39;</span><span class="p">:</span> <span class="n">policy_list_users</span>
    <span class="p">}</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">current_user</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span><span class="s">&#39;gateone&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">policies</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span> <span class="c"># Empty RUDict</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="c"># A world without limits!</span>
    <span class="k">if</span> <span class="n">function</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">in</span> <span class="n">policy_functions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">policy_functions</span><span class="p">[</span><span class="n">function</span><span class="o">.</span><span class="n">__name__</span><span class="p">](</span><span class="n">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span> <span class="c"># Default to permissive if we made it this far</span>
</div>
<span class="nd">@atexit.register</span> <span class="c"># I love this feature!</span>
<div class="viewcode-block" id="kill_all_sessions"><a class="viewcode-back" href="../Developer/gateone.html#gateone.kill_all_sessions">[docs]</a><span class="k">def</span> <span class="nf">kill_all_sessions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls all &#39;timeout_callbacks&#39; attached to all `SESSIONS`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Killing all sessions...&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s">&quot;timeout_callbacks&quot;</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="timeout_sessions"><a class="viewcode-back" href="../Developer/gateone.html#gateone.timeout_sessions">[docs]</a><span class="k">def</span> <span class="nf">timeout_sessions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loops over the SESSIONS dict killing any sessions that haven&#39;t been used</span>
<span class="sd">    for the length of time specified in *TIMEOUT* (global).  The value of</span>
<span class="sd">    *TIMEOUT* can be set in 10server.conf or specified on the command line via</span>
<span class="sd">    the *session_timeout* value.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This function is meant to be called via Tornado&#39;s</span>
<span class="sd">        :meth:`~tornado.ioloop.PeriodicCallback`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">disabled</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># If the user sets session_timeout to &quot;0&quot;</span>
    <span class="c"># Commented because it is a bit noisy.  Uncomment to debug this mechanism.</span>
    <span class="c">#if TIMEOUT != disabled:</span>
        <span class="c">#logging.debug(&quot;timeout_sessions() TIMEOUT: %s&quot; % TIMEOUT)</span>
    <span class="c">#else :</span>
        <span class="c">#logging.debug(&quot;timeout_sessions() TIMEOUT: disabled&quot;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SESSIONS</span><span class="p">:</span> <span class="c"># Last client has timed out</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;All user sessions have terminated.&quot;</span><span class="p">))</span>
            <span class="k">global</span> <span class="n">SESSION_WATCHER</span>
            <span class="k">if</span> <span class="n">SESSION_WATCHER</span><span class="p">:</span>
                <span class="n">SESSION_WATCHER</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span> <span class="c"># Stop ourselves</span>
                <span class="n">SESSION_WATCHER</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># So authenticate() will know to start it</span>
            <span class="c"># Reload gateone.py to free up memory (CPython can be a bit</span>
            <span class="c"># overzealous in keeping things cached).  In theory this isn&#39;t</span>
            <span class="c"># necessary due to Gate One&#39;s prodigous use of dynamic imports but</span>
            <span class="c"># in reality people will see an idle gateone.py eating up 30 megs of</span>
            <span class="c"># RAM and wonder, &quot;WTF...  No one has connected in weeks.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;The last idle session has timed out. Reloading...&quot;</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">execv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="c"># Mac OS X versions prior to 10.6 do not support execv in</span>
                <span class="c"># a process that contains multiple threads.</span>
                <span class="n">os</span><span class="o">.</span><span class="n">spawnv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">P_NOWAIT</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="s">&quot;last_seen&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
                <span class="c"># Session is in the process of being created.  We&#39;ll check it</span>
                <span class="c"># the next time timeout_sessions() is called.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;connected&#39;</span><span class="p">:</span>
                <span class="c"># Connected sessions do not need to be checked for timeouts</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">TIMEOUT</span> <span class="o">==</span> <span class="n">disabled</span> <span class="ow">or</span> \
                <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">TIMEOUT</span><span class="p">:</span>
                <span class="c"># Kill the session</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;{session} timeout.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)))</span>
                <span class="k">if</span> <span class="s">&quot;timeout_callbacks&quot;</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                            <span class="n">callback</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Exception encountered in timeout_sessions(): {exception}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="p">))</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

<span class="c"># Classes</span></div>
<div class="viewcode-block" id="HTTPSRedirectHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.HTTPSRedirectHandler">[docs]</a><span class="k">class</span> <span class="nc">HTTPSRedirectHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler to redirect clients from HTTP to HTTPS.  Only used if</span>
<span class="sd">    `https_redirect` is True in Gate One&#39;s settings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="HTTPSRedirectHandler.get"><a class="viewcode-back" href="../Developer/gateone.html#gateone.HTTPSRedirectHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Just redirects the client from HTTP to HTTPS&quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Host&#39;</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span>
            <span class="s">&#39;https://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">url_prefix</span><span class="p">))</span>
</div></div>
<div class="viewcode-block" id="StaticHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.StaticHandler">[docs]</a><span class="k">class</span> <span class="nc">StaticHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An override of :class:`tornado.web.StaticFileHandler` to ensure that the</span>
<span class="sd">    Access-Control-Allow-Origin header gets set correctly.  This is necessary in</span>
<span class="sd">    order to support embedding Gate One into other web-based applications.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Gate One performs its own origin checking so header-based access</span>
<span class="sd">        controls at the client are unnecessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># This is the only function we need to override thanks to the thoughtfulness</span>
    <span class="c"># of the Tornado devs.</span>
<div class="viewcode-block" id="StaticHandler.set_extra_headers"><a class="viewcode-back" href="../Developer/gateone.html#gateone.StaticHandler.set_extra_headers">[docs]</a>    <span class="k">def</span> <span class="nf">set_extra_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the Access-Control-Allow-Origin header to allow cross-origin</span>
<span class="sd">        access to static content for applications embedding Gate One.</span>
<span class="sd">        Specifically, this is necessary in order to support loading fonts</span>
<span class="sd">        from different origins.</span>

<span class="sd">        Also sets the &#39;X-UA-Compatible&#39; header to &#39;IE=edge&#39; to enforce IE 10+</span>
<span class="sd">        into standards mode when content is loaded from intranet sites.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;X-UA-Compatible&#39;</span><span class="p">,</span> <span class="s">&#39;IE=edge&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="BaseHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.BaseHandler">[docs]</a><span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base handler that all Gate One RequestHandlers will inherit methods from.</span>

<span class="sd">    Provides the :meth:`get_current_user` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Right now it&#39;s just the one function...</span>
<div class="viewcode-block" id="BaseHandler.get_current_user"><a class="viewcode-back" href="../Developer/gateone.html#gateone.BaseHandler.get_current_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tornado standard method--implemented our way.&quot;&quot;&quot;</span>
        <span class="c"># NOTE: self.current_user is actually an @property that calls</span>
        <span class="c">#       self.get_current_user() and caches the result.</span>
        <span class="n">user_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="s">&quot;gateone_user&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_json</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">user_json</span><span class="p">)</span>
            <span class="n">user</span><span class="p">[</span><span class="s">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">user</span>
    <span class="c"># More may be added in the future</span>
</div></div>
<div class="viewcode-block" id="DownloadHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.DownloadHandler">[docs]</a><span class="k">class</span> <span class="nc">DownloadHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`tornado.web.RequestHandler` to serve up files that wind up in a</span>
<span class="sd">    given user&#39;s `session_dir` in the &#39;downloads&#39; directory.  Generally speaking</span>
<span class="sd">    these files are generated by the terminal emulator (e.g. cat somefile.pdf)</span>
<span class="sd">    but it can be used by applications and plugins as a way to serve up</span>
<span class="sd">    all sorts of (temporary/transient) files to users.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># NOTE:  This is a modified version of torando.web.StaticFileHandler</span>
    <span class="nd">@tornado.web.authenticated</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">include_body</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;session&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;DownloadHandler: Could not determine use session&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="c"># Something is wrong</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="s">&#39;downloads&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_error_html</span><span class="p">(</span><span class="mi">404</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a file&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">stat</span><span class="o">,</span> <span class="nn">mimetypes</span>
        <span class="n">stat_result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat_result</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Last-Modified&quot;</span><span class="p">,</span> <span class="n">modified</span><span class="p">)</span>
        <span class="n">mime_type</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mime_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">)</span>
        <span class="c"># Set the Cache-Control header to private since this file is not meant</span>
        <span class="c"># to be public.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Cache-Control&quot;</span><span class="p">,</span> <span class="s">&quot;private&quot;</span><span class="p">)</span>
        <span class="c"># Check the If-Modified-Since, and don&#39;t send the result if the</span>
        <span class="c"># content has not been modified</span>
        <span class="n">ims_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;If-Modified-Since&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ims_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">email.utils</span>
            <span class="n">date_tuple</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate</span><span class="p">(</span><span class="n">ims_value</span><span class="p">)</span>
            <span class="n">if_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date_tuple</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">if_since</span> <span class="o">&gt;=</span> <span class="n">modified</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="c"># Finally, deliver the file</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Etag&quot;</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">include_body</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;HEAD&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_error_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s">&quot;static_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">403</span><span class="p">]:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;static_url&#39;</span><span class="p">],</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">.html&#39;</span> <span class="o">%</span> <span class="n">status_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="kn">import</span> <span class="nn">httplib</span>
        <span class="k">return</span> <span class="s">&quot;&lt;html&gt;&lt;title&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/title&gt;&quot;</span> \
                <span class="s">&quot;&lt;body class=&#39;bodyErrorPage&#39;&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/body&gt;&lt;/html&gt;&quot;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s">&quot;code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
            <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">status_code</span><span class="p">],</span>
        <span class="p">}</span>
</div>
<div class="viewcode-block" id="MainHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.MainHandler">[docs]</a><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renders index.html which loads Gate One.</span>

<span class="sd">    Will include the minified version of gateone.js if available as</span>
<span class="sd">    gateone.min.js.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@tornado.web.authenticated</span>
    <span class="nd">@tornado.web.addslash</span>
    <span class="c"># TODO: Get this auto-minifying gateone.js</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Force IE 10 into Standard Mode:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;X-UA-Compatible&#39;</span><span class="p">,</span> <span class="s">&#39;IE=edge&#39;</span><span class="p">)</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;location&quot;</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">)</span>
        <span class="n">prefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;prefs&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">gateone_js</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">static/gateone.js&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">minified_js_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
        <span class="n">minified_js_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">minified_js_abspath</span><span class="p">,</span> <span class="s">&#39;gateone.min.js&#39;</span><span class="p">)</span>
        <span class="n">js_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;js_init&#39;</span><span class="p">]</span>
        <span class="c"># Use the minified version if it exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">minified_js_abspath</span><span class="p">):</span>
            <span class="n">gateone_js</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">static/gateone.min.js&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">index_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s">&#39;index.html&#39;</span><span class="p">)</span>
        <span class="n">head_html</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">body_html</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;HTML&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;head&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">][</span><span class="s">&#39;head&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">][</span><span class="s">&#39;head&#39;</span><span class="p">]:</span>
                            <span class="n">head_html</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">item</span>
                <span class="k">if</span> <span class="s">&#39;body&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">][</span><span class="s">&#39;body&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">][</span><span class="s">&#39;body&#39;</span><span class="p">]:</span>
                            <span class="n">body_html</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">index_path</span><span class="p">,</span>
            <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>
            <span class="n">gateone_js</span><span class="o">=</span><span class="n">gateone_js</span><span class="p">,</span>
            <span class="n">jsplugins</span><span class="o">=</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;js&#39;</span><span class="p">],</span>
            <span class="n">cssplugins</span><span class="o">=</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;css&#39;</span><span class="p">],</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">js_init</span><span class="o">=</span><span class="n">js_init</span><span class="p">,</span>
            <span class="n">url_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">],</span>
            <span class="n">head</span><span class="o">=</span><span class="n">head_html</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">body_html</span><span class="p">,</span>
            <span class="n">prefs</span><span class="o">=</span><span class="n">prefs</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="GOApplication"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication">[docs]</a><span class="k">class</span> <span class="nc">GOApplication</span><span class="p">(</span><span class="n">OnOffMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base from which all Gate One Applications will inherit.  Applications</span>
<span class="sd">    are expected to be written like so::</span>

<span class="sd">        class SomeApplication(GOApplication):</span>
<span class="sd">            def initialize(self):</span>
<span class="sd">                &quot;Called when the Application is instantiated.&quot;</span>
<span class="sd">                initialize_stuff()</span>
<span class="sd">                # Here&#39;s some good things to do in an initialize() function...</span>
<span class="sd">                # Register a policy-checking function:</span>
<span class="sd">                self.ws.security.update({&#39;some_app&#39;: policy_checking_func})</span>
<span class="sd">                # Register some WebSocket actions (note the app:action naming convention)</span>
<span class="sd">                self.ws.actions.update({</span>
<span class="sd">                    &#39;some_app:do_stuff&#39;: self.do_stuff,</span>
<span class="sd">                    &#39;some_app:do_other_stuff&#39;: self.do_other_stuff</span>
<span class="sd">                })</span>
<span class="sd">            def open(self):</span>
<span class="sd">                &quot;Called when the connection is established.&quot;</span>
<span class="sd">                # Setup whatever is necessary for session tracking and whatnot.</span>
<span class="sd">            def authenticate(self):</span>
<span class="sd">                &quot;Called when the user *successfully* authenticates.&quot;</span>
<span class="sd">                # Here&#39;s the best place to instantiate things, send the user</span>
<span class="sd">                # JavaScript/CSS files, and similar post-authentication details.</span>
<span class="sd">            def on_close(self):</span>
<span class="sd">                &quot;Called when the connection is closed.&quot;</span>
<span class="sd">                # This is a good place to halt any background/periodic operations.</span>

<span class="sd">    GOApplications will be automatically imported into Gate One and registered</span>
<span class="sd">    appropriately as long as they follow the following conventions:</span>

<span class="sd">        * The application and its module(s) should live inside its own directory inside the &#39;applications&#39; directory.  For example, `/opt/gateone/applications/some_app/some_app.py`</span>
<span class="sd">        * Subclasses of `GOApplication` must be added to an `apps` global (list) inside of the application&#39;s module(s) like so: `apps = [SomeApplication]` (usually a good idea to put that at the very bottom of the module).</span>

<span class="sd">    .. note::</span>

<span class="sd">        All .py modules inside of the application&#39;s main directory will be</span>
<span class="sd">        imported even if they do not contain or register a `GOApplication`.</span>

<span class="sd">    .. tip::</span>

<span class="sd">        You can add command line arguments to Gate One by calling</span>
<span class="sd">        :func:`tornado.options.define` anywhere in your application&#39;s global</span>
<span class="sd">        namespace.  This works because the :func:`~tornado.options.define`</span>
<span class="sd">        function registers options in Gate One&#39;s global namespace (as</span>
<span class="sd">        `tornado.options.options`) and Gate One imports application modules</span>
<span class="sd">        before it evaluates command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span> <span class="c"># WebSocket instance</span>
        <span class="c"># Setup some shortcuts to make things more natural and convenient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">write_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_binary</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">write_binary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_and_send_css</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">render_and_send_css</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_style</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">render_style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">send_css</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">send_js</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">security</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">settings</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;GOApplication: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>

<div class="viewcode-block" id="GOApplication.initialize"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :meth:`ApplicationWebSocket.open` after __init__().</span>
<span class="sd">        GOApplications can override this function to perform their own actions</span>
<span class="sd">        when the Application is initialized (happens just before the WebSocket</span>
<span class="sd">        is opened).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="GOApplication.open"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :meth:`ApplicationWebSocket.open` after the WebSocket is</span>
<span class="sd">        opened.  GOApplications can override this function to perform their own</span>
<span class="sd">        actions when the WebSocket is opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="GOApplication.on_close"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication.on_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :meth:`ApplicationWebSocket.on_close` after the WebSocket is</span>
<span class="sd">        closed.  GOApplications can override this function to perform their own</span>
<span class="sd">        actions when the WebSocket is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="GOApplication.add_handler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication.add_handler">[docs]</a>    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the given *handler* (`tornado.web.RequestHandler`) to the Tornado</span>
<span class="sd">        Application (`self.ws.application`) to handle URLs matching *pattern*.</span>
<span class="sd">        If given, *kwargs* will be added to the `tornado.web.URLSpec` when the</span>
<span class="sd">        complete handler is assembled.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If the *pattern* does not start with the configured `url_prefix` it</span>
<span class="sd">            will be automatically prepended.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Adding handler: (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">))</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
                <span class="c"># Get rid of the / (it will be in the url_prefix)</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">URLSpec</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># Why the Tornado devs didn&#39;t give us a simple way to do this is beyond</span>
        <span class="c"># me.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="ApplicationWebSocket"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket">[docs]</a><span class="k">class</span> <span class="nc">ApplicationWebSocket</span><span class="p">(</span><span class="n">WebSocketHandler</span><span class="p">,</span> <span class="n">OnOffMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main WebSocket interface for Gate One, this class is setup to call</span>
<span class="sd">    WebSocket &#39;actions&#39; which are methods registered in `self.actions`.</span>
<span class="sd">    Methods that are registered this way will be exposed and directly callable</span>
<span class="sd">    over the WebSocket.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instances</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c"># These three attributes handle watching files for changes:</span>
    <span class="n">watched_files</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c"># Format: {&lt;file path&gt;: &lt;modification time&gt;}</span>
    <span class="n">file_update_funcs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Format: {&lt;file path&gt;: &lt;function called on update&gt;}</span>
    <span class="n">file_watcher</span> <span class="o">=</span> <span class="bp">None</span>    <span class="c"># Will be replaced with a PeriodicCallback</span>
    <span class="n">prefs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Gets updated with every call to initialize()</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;go:ping&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pong</span><span class="p">,</span>
            <span class="s">&#39;go:authenticate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">,</span>
            <span class="s">&#39;go:get_theme&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_theme</span><span class="p">,</span>
            <span class="s">&#39;go:get_js&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_js</span><span class="p">,</span>
            <span class="s">&#39;go:enumerate_themes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_themes</span><span class="p">,</span>
            <span class="s">&#39;go:file_request&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">,</span>
            <span class="s">&#39;go:cache_cleanup&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_cleanup</span><span class="p">,</span>
            <span class="s">&#39;go:send_user_message&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_user_message</span><span class="p">,</span>
            <span class="s">&#39;go:broadcast&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">,</span>
            <span class="s">&#39;go:list_users&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_server_users</span><span class="p">,</span>
            <span class="s">&#39;go:get_locations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locations</span><span class="p">,</span>
            <span class="s">&#39;go:set_location&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_location</span><span class="p">,</span>
            <span class="s">&#39;go:set_locale&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_locale</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c"># Setup some instance-specific loggers that we can later update with</span>
        <span class="c"># more metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.auth&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.message&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># This is used to keep track of used API authentication signatures so</span>
        <span class="c"># we can prevent replay attacks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_signatures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># Only allow valid origins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span> <span class="o">=</span> <span class="n">FILE_CACHE</span> <span class="c"># So applications and plugins can reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist</span> <span class="o">=</span> <span class="n">PERSIST</span> <span class="c"># So applications and plugins can reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apps</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Gets filled up by self.initialize()</span>
        <span class="c"># The security dict stores applications&#39; various policy functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">WebSocketHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket.file_checker"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.file_checker">[docs]</a>    <span class="k">def</span> <span class="nf">file_checker</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A `Tornado.IOLoop.PeriodicCallback` that regularly checks all files</span>
<span class="sd">        registered in the `ApplicationWebSocket.watched_files` dict for changes.</span>

<span class="sd">        If changes are detected the corresponding function(s) in</span>
<span class="sd">        `ApplicationWebSocket.file_update_funcs` will be called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#logging.debug(&quot;file_checker()&quot;) # Noisy so I&#39;ve commented it out</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="c"># No connected sessions; no point in watching files</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">file_watcher</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="c"># Also remove the broadcast file so we know to start up the</span>
            <span class="c"># file_watcher again if a user connects.</span>
            <span class="n">session_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span>
            <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="s">&#39;broadcast&#39;</span><span class="p">)</span> <span class="c"># Default</span>
            <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s">&#39;broadcast_file&#39;</span><span class="p">,</span> <span class="n">broadcast_file</span><span class="p">)</span> <span class="c"># If set, use that</span>
            <span class="k">del</span> <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="p">[</span><span class="n">broadcast_file</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">cls</span><span class="o">.</span><span class="n">file_update_funcs</span><span class="p">[</span><span class="n">broadcast_file</span><span class="p">]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">mtime</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="c"># Someone deleted something they shouldn&#39;t have</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;{path} has been removed.  Removing from file &quot;</span>
                    <span class="s">&quot;checker.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)))</span>
                <span class="k">del</span> <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">cls</span><span class="o">.</span><span class="n">file_update_funcs</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="n">current_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
            <span class="k">if</span> <span class="n">current_mtime</span> <span class="o">==</span> <span class="n">mtime</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_mtime</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">file_update_funcs</span><span class="p">[</span><span class="n">path</span><span class="p">]()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;Exception encountered trying to execute the file update &quot;</span>
                    <span class="s">&quot;function for {path}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span> <span class="o">==</span> <span class="s">&#39;debug&#39;</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">traceback</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket.watch_file"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.watch_file">[docs]</a>    <span class="k">def</span> <span class="nf">watch_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A classmethod that registers the given file *path* and *func* in</span>
<span class="sd">        `ApplicationWebSocket.watched_files` and</span>
<span class="sd">        `ApplicationWebSocket.file_update_funcs`, respectively.  The given</span>
<span class="sd">        *func* will be called (by `ApplicationWebSocket.file_checker`) whenever</span>
<span class="sd">        the file at *path* is modified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;watch_file(&#39;{path}&#39;, {func}())&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">path</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">})</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">file_update_funcs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">path</span><span class="p">:</span> <span class="n">func</span><span class="p">})</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket.broadcast_file_update"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.broadcast_file_update">[docs]</a>    <span class="k">def</span> <span class="nf">broadcast_file_update</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when there&#39;s an update to the `broadcast_file` (e.g.</span>
<span class="sd">        `&lt;session_dir&gt;/broadcast`); broadcasts its contents to all connected</span>
<span class="sd">        users.  The message will be displayed via the</span>
<span class="sd">        :js:meth:`GateOne.Visual.displayMessage` function at the client and can</span>
<span class="sd">        be formatted with HTML.  For this reason it is important to strictly</span>
<span class="sd">        control write access to the broadcast file.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Under normal circumstances only root (or the owner of the</span>
<span class="sd">            gateone.py process) can enter and/or write to files inside</span>
<span class="sd">            Gate One&#39;s `session_dir` directory.</span>

<span class="sd">        The path to the broadcast file can be configured via the</span>
<span class="sd">        `broadcast_file` setting which can be placed anywhere under the</span>
<span class="sd">        &#39;gateone&#39; application/scope (e.g. inside 10server.conf).  The setting</span>
<span class="sd">        isn&#39;t there by default but you can simply add it if you wish:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            &quot;broadcast_file&quot;: &quot;/whatever/path/you/want/broadcast&quot;</span>

<span class="sd">        .. tip::</span>

<span class="sd">            Want to broadcast a message to all the users currently connected to</span>
<span class="sd">            Gate One?  Just `sudo echo &quot;your message&quot; &gt; /tmp/gateone/broadcast`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span>
        <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="s">&#39;broadcast&#39;</span><span class="p">)</span>
        <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;broadcast_file&#39;</span><span class="p">,</span> <span class="n">broadcast_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="n">msg_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Broadcast (via broadcast_file): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">message_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message_dict</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="s">&quot;AUTHENTICATED&quot;</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">u&#39;&#39;</span><span class="p">)</span> <span class="c"># Empty it out</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.initialize"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This gets called by the Tornado framework when `ApplicationWebSocket` is</span>
<span class="sd">        instantiated.  It will be passed the list of *apps* (Gate One</span>
<span class="sd">        applications) that are assigned inside the :class:`GOApplication`</span>
<span class="sd">        object.  These :class:`GOApplication`s will be instantiated and stored</span>
<span class="sd">        in `self.apps`.</span>

<span class="sd">        These *apps* will be mutated in-place so that `self` will refer to the</span>
<span class="sd">        current instance of :class:`ApplicationWebSocket`.  Kind of like a</span>
<span class="sd">        dynamic mixin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;ApplicationWebSocket.initialize(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">apps</span><span class="p">)</span>
        <span class="c"># Make sure we have all prefs ready for checking</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">plugin_name</span><span class="p">,</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;Events&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="c"># Setup some actions to take place after the user authenticates</span>
        <span class="c"># Send our plugin .js and .css files to the client</span>
        <span class="n">send_plugin_static_files</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_plugin_static_files</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="n">send_plugin_static_files</span><span class="p">)</span>
        <span class="c"># Tell the client about any existing locations where applications may be</span>
        <span class="c"># storing things like terminal instances and whatnot:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locations</span><span class="p">)</span>
        <span class="c"># This is so the client knows what applications it can use:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_applications</span><span class="p">)</span>
        <span class="c"># This starts up the PeriodicCallback that watches sessions for timeouts</span>
        <span class="c"># and cleans them up (if not already started):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_session_watcher</span><span class="p">)</span>
        <span class="c"># This starts up the PeriodicCallback that watches and cleans up old</span>
        <span class="c"># user logs (anything in gateone/users/&lt;user&gt;/logs):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_log_cleaner</span><span class="p">)</span>
        <span class="c"># This starts up the file watcher PeriodicCallback:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_file_watcher</span><span class="p">)</span>
        <span class="c"># This ensures that sessions will timeout immediately if session_timeout</span>
        <span class="c"># is set to 0:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;go:close&quot;</span><span class="p">,</span> <span class="n">timeout_sessions</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">apps</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Initializing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;initialize&#39;</span><span class="p">):</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.allow_draft76"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.allow_draft76">[docs]</a>    <span class="k">def</span> <span class="nf">allow_draft76</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        By overriding this function we&#39;re allowing the older version of the</span>
<span class="sd">        WebSockets protocol.  As long as communications happens over SSL there</span>
<span class="sd">        shouldn&#39;t be any security concerns with this.  This is mostly to support</span>
<span class="sd">        iOS Safari.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.get_current_user"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.get_current_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mostly identical to the function of the same name in MainHandler.  The</span>
<span class="sd">        difference being that when API authentication is enabled the WebSocket</span>
<span class="sd">        will expect and perform its own auth of the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
        <span class="n">user_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="s">&quot;gateone_user&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_json</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="c"># This can happen if the user&#39;s browser isn&#39;t allowing</span>
                <span class="c"># persistent cookies (e.g. incognito mode)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s">&#39;upn&#39;</span><span class="p">:</span> <span class="s">&#39;ANONYMOUS&#39;</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">generate_session_id</span><span class="p">()}</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">user_json</span><span class="p">)</span>
        <span class="n">user</span><span class="p">[</span><span class="s">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
        <span class="k">return</span> <span class="n">user</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.write_binary"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.write_binary">[docs]</a>    <span class="k">def</span> <span class="nf">write_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the given *message* to the WebSocket in binary mode (opcode</span>
<span class="sd">        0x02).  Binary WebSocket messages are handled differently from regular</span>
<span class="sd">        messages at the client (they use a completely different &#39;action&#39;</span>
<span class="sd">        mechanism).  For more information see the JavaScript developer</span>
<span class="sd">        documentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.open"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when a new WebSocket is opened.  Will deny access to any</span>
<span class="sd">        origin that is not defined in `self.settings[&#39;origin&#39;]`.  Also sends</span>
<span class="sd">        any relevant localization data (JavaScript) to the client and calls the</span>
<span class="sd">        :meth:`open` method of any and all enabled Applications.</span>

<span class="sd">        Triggers the `go:open` event.</span>

<span class="sd">        .. note::</span>

<span class="sd">            `self.settings` comes from the Tornado framework and includes most</span>
<span class="sd">            command line arguments and the settings from the `settings_dir` that</span>
<span class="sd">            fall under the &quot;gateone&quot; scope.  It is not the same thing as</span>
<span class="sd">            `self.prefs` which includes *all* of Gate One&#39;s settings (including</span>
<span class="sd">            settings for other applications and scopes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">valid_origins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;origins&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;Origin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Origin&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s">&#39;Sec-Websocket-Origin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="c"># Old version</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Sec-Websocket-Origin&#39;</span><span class="p">]</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c"># hostnames are case-insensitive</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;://&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;open() origin: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">origin</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_origins</span><span class="p">:</span> <span class="c"># NOTE: valid_origins is a list</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_origins</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">denied_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s">&#39;{&quot;ip_address&quot;: &quot;</span><span class="si">%s</span><span class="s">&quot;} Access denied for origin: </span><span class="si">%s</span><span class="s">&#39;</span>
                    <span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_address</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
                <span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">denied_msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">denied_msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;If you feel this is incorrect you just have to add &#39;</span><span class="si">%s</span><span class="s">&#39; to&quot;</span>
                    <span class="s">&quot; the &#39;origin&#39; option in your settings.  See the docs &quot;</span>
                    <span class="s">&quot;for details.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">origin</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># client_id is unique to the browser/client whereas session_id is unique</span>
        <span class="c"># to the user.  It isn&#39;t used much right now but it will be useful in</span>
        <span class="c"># the future once more stuff is running over WebSockets.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="c"># NOTE: self.current_user will call self.get_current_user() the first</span>
        <span class="c"># time it is used.</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="c"># Update our loggers to include the user metadata</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;upn&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">],</span> <span class="s">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;ip_address&#39;</span><span class="p">]}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.auth&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.message&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="c"># Use global auth_log so we&#39;re not redundant</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket opened (</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">) via origin </span><span class="si">%s</span><span class="s">.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">],</span> <span class="n">client_address</span><span class="p">,</span> <span class="n">origin</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&#39;{&quot;ip_address&quot;: &quot;</span><span class="si">%s</span><span class="s">&quot;} WebSocket opened (unknown user).&#39;</span><span class="p">)</span>
            <span class="o">%</span> <span class="n">client_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span> <span class="c"># Invalid user info</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&#39;{&quot;ip_address&quot;: &quot;</span><span class="si">%s</span><span class="s">&quot;} Unauthenticated WebSocket attempt.&#39;</span>
                <span class="p">)</span> <span class="o">%</span> <span class="n">client_address</span><span class="p">)</span>
            <span class="c"># In case this is a legitimate client that simply had its auth info</span>
            <span class="c"># expire/go bad, tell it to re-auth by calling the appropriate</span>
            <span class="c"># action on the other side.</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="c"># NOTE: By getting the prefs with each call to open() we make</span>
        <span class="c">#       it possible to make changes inside the settings dir without</span>
        <span class="c">#       having to restart Gate One (just need to wait for users to</span>
        <span class="c">#       eventually re-connect or reload the page).</span>
        <span class="c"># NOTE: Why store prefs in the class itself?  No need for redundancy.</span>
        <span class="k">if</span> <span class="s">&#39;cache_dir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]:</span>
            <span class="c"># Set the cache dir to a default if not set in the prefs</span>
            <span class="c">#cache_dir = os.path.join(tempfile.gettempdir(), &#39;gateone_cache&#39;)</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;cache_dir&#39;</span><span class="p">]</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">][</span><span class="s">&#39;cache_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache_dir</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="c"># Clean out the cache_dir every page reload when in debug mode</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="c"># NOTE: This is here so that the client will have all the necessary</span>
        <span class="c"># strings *before* the calls to various init() functions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_translation</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span> <span class="c"># Call applications&#39; open() functions (if any)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s">&#39;open&#39;</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s">&quot;go:open&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.on_message"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.on_message">[docs]</a>    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when we receive a message from the client.  Performs some basic</span>
<span class="sd">        validation of the message, decodes it (JSON), and finally calls an</span>
<span class="sd">        appropriate WebSocket action (registered method) with the message</span>
<span class="sd">        contents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># This is super useful when debugging:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;message: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Message rejected due to invalid origin.&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="n">message_obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message_obj</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="c"># JSON FTW!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;&#39;Error: Message bust be a JSON dict.&#39;&quot;</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># We didn&#39;t get JSON</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;&#39;Error: We only accept JSON here.&#39;&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">message_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">message_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">PLUGIN_WS_CMDS</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span> <span class="c"># Plugins first so they can override behavior</span>
                        <span class="n">PLUGIN_WS_CMDS</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                        <span class="c"># tws==ApplicationWebSocket</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;Error running plugin WebSocket action: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">key</span><span class="p">]()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># Try, try again</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">traceback</span>
                        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">frame</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                         <span class="s">&quot;Error/Unknown WebSocket action, </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s"> line </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;logging&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;debug&#39;</span><span class="p">:</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.on_close"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.on_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the client terminates the connection.  Also calls the</span>
<span class="sd">        :meth:`on_close` method of any and all enabled Applications.</span>

<span class="sd">        Triggers the `go:close` event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;on_close()&quot;</span><span class="p">)</span>
        <span class="n">ApplicationWebSocket</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="c"># Update &#39;last_seen&#39; with a datetime object for accuracy</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]][</span><span class="s">&#39;last_seen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket closed (</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">).&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">],</span> <span class="n">client_address</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket closed (unknown user).&quot;</span><span class="p">))</span>
        <span class="c"># Call applications&#39; on_close() functions (if any)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s">&#39;on_close&#39;</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">on_close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s">&quot;go:close&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.pong"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.pong">[docs]</a>    <span class="k">def</span> <span class="nf">pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Responds to a client &#39;ping&#39; request...  Just returns the given</span>
<span class="sd">        timestamp back to the client so it can measure round-trip time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:pong&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.authenticate"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticates the client by first trying to use the &#39;gateone_user&#39;</span>
<span class="sd">        cookie or if Gate One is configured to use API authentication it will</span>
<span class="sd">        use *settings[&#39;auth&#39;]*.  Additionally, it will accept</span>
<span class="sd">        *settings[&#39;container&#39;]* and *settings[&#39;prefix&#39;]* to apply those to the</span>
<span class="sd">        equivalent properties (`self.container` and `self.prefix`).</span>

<span class="sd">        .. note::</span>

<span class="sd">            &#39;container&#39; refers to the element on which Gate One was initialized</span>
<span class="sd">            at the client (e.g. `#gateone`).  &#39;prefix&#39; refers to the string that</span>
<span class="sd">            will be prepended to all Gate One element IDs when added to the web</span>
<span class="sd">            page (to avoid namespace conflicts).  Both these values are only</span>
<span class="sd">            used when generating CSS templates.</span>

<span class="sd">        If *settings[&#39;location&#39;]* is something other than &#39;default&#39; all new</span>
<span class="sd">        application instances will be associated with the given (string) value.</span>
<span class="sd">        These applications will be treated separately so they can exist in a</span>
<span class="sd">        different browser tab/window.</span>

<span class="sd">        Triggers the `go:authenticate` event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;authenticate(): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="c"># Make sure the client is authenticated if authentication is enabled</span>
        <span class="n">reauth</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;api&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
                    <span class="c"># This usually happens when the cookie_secret gets changed</span>
                    <span class="c"># resulting in &quot;Invalid cookie...&quot; errors.  If we tell the</span>
                    <span class="c"># client to re-auth the problem should correct itself.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;ANONYMOUS&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
                    <span class="c"># This can happen when a client logs in with no auth type</span>
                    <span class="c"># configured and then later the server is configured to use</span>
                    <span class="c"># authentication.  The client must be told to re-auth:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># &#39;upn&#39; wasn&#39;t in user</span>
                <span class="c"># Force them to authenticate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;api&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c"># &#39;auth&#39; message should look like this:</span>
                <span class="c"># {</span>
                <span class="c">#    &#39;api_key&#39;: &#39;MjkwYzc3MDI2MjhhNGZkNDg1MjJkODgyYjBmN2MyMTM4M&#39;,</span>
                <span class="c">#    &#39;upn&#39;: &#39;joe@company.com&#39;,</span>
                <span class="c">#    &#39;timestamp&#39;: &#39;1323391717238&#39;,</span>
                <span class="c">#    &#39;signature&#39;: &lt;gibberish&gt;,</span>
                <span class="c">#    &#39;signature_method&#39;: &#39;HMAC-SHA1&#39;,</span>
                <span class="c">#    &#39;api_version&#39;: &#39;1.0&#39;</span>
                <span class="c"># }</span>
                <span class="c">#</span>
                <span class="c"># *api_key* is the first half of what gets generated when you</span>
                <span class="c">#   run ./gateone --new_api_key.</span>
                <span class="c"># *upn* is the User Principal Name of the user.  This is</span>
                <span class="c">#   typically something like &quot;joe@company.com&quot;.</span>
                <span class="c"># *timestamp* is a JavaScript Date() object converted into an</span>
                <span class="c">#   &quot;time since the epoch&quot; (int or string is OK):</span>
                <span class="c">#       var timestamp = new Date().getTime()</span>
                <span class="c"># *signature* is an HMAC signature of the previous three</span>
                <span class="c">#   variables that was created using the given API key&#39;s secret.</span>
                <span class="c"># *signature_method* is the HMAC hashing algorithm to use for</span>
                <span class="c">#   the signature.  Only HMAC-SHA1 is supported for now.</span>
                <span class="c"># *api_version* is the auth API version.  Always &quot;1.0&quot; for now.</span>
                <span class="c">#</span>
                <span class="c"># For reference, here&#39;s how to make a signature using PHP:</span>
                <span class="c"># $authobj = array(&#39;api_key&#39; =&gt; &#39;M2I1MzJmZjk4MTEwNDk2Zjk4MjMwNmMwMTVkODQzMTEyO&#39;, &#39;upn&#39; =&gt; $_SERVER[&#39;REMOTE_USER&#39;], &#39;timestamp&#39; =&gt; time() . &#39;0000&#39;, &#39;signature_method&#39; =&gt; &#39;HMAC-SHA1&#39;, &#39;api_version&#39; =&gt; &#39;1.0&#39;);</span>
                <span class="c"># $authobj[&#39;signature&#39;] = hash_hmac(&#39;sha1&#39;, $authobj[&#39;api_key&#39;] . $authobj[&#39;upn&#39;] . $authobj[&#39;timestamp&#39;], &#39;&lt;secret&gt;&#39;);</span>
                <span class="c"># Note that the order matters:  api_key -&gt; upn -&gt; timestamp</span>
                <span class="n">auth_obj</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span>
                <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">create_signature</span>
                <span class="k">if</span> <span class="s">&#39;api_key&#39;</span> <span class="ow">in</span> <span class="n">auth_obj</span><span class="p">:</span>
                    <span class="c"># Assume everything else is present if the api_key is there</span>
                    <span class="n">api_key</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;api_key&#39;</span><span class="p">]</span>
                    <span class="n">upn</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;timestamp&#39;</span><span class="p">])</span> <span class="c"># str in case integer</span>
                    <span class="n">signature</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;signature&#39;</span><span class="p">]</span>
                    <span class="n">signature_method</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;signature_method&#39;</span><span class="p">]</span>
                    <span class="n">api_version</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;api_version&#39;</span><span class="p">]</span>
                    <span class="n">supported_hmacs</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">&#39;HMAC-SHA1&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">,</span>
                        <span class="s">&#39;HMAC-SHA256&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span>
                        <span class="s">&#39;HMAC-SHA384&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha384</span><span class="p">,</span>
                        <span class="s">&#39;HMAC-SHA512&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">signature_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_hmacs</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTHENTICATION ERROR: Unsupported API auth &#39;</span>
                                <span class="s">&#39;signature method: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">signature_method</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                        <span class="k">return</span>
                    <span class="n">hmac_algo</span> <span class="o">=</span> <span class="n">supported_hmacs</span><span class="p">[</span><span class="n">signature_method</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">api_version</span> <span class="o">!=</span> <span class="s">&quot;1.0&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTHENTICATION ERROR: Unsupported API version:&#39;</span>
                                <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">api_version</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                        <span class="k">return</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;api_keys&#39;</span><span class="p">][</span><span class="n">api_key</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&#39;AUTHENTICATION ERROR: API Key not found.&#39;</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                        <span class="k">return</span>
                    <span class="c"># TODO: Make API version 1.1 that signs *all* attributes--not just the known ones</span>
                    <span class="c"># Check the signature against existing API keys</span>
                    <span class="n">sig_check</span> <span class="o">=</span> <span class="n">create_signature</span><span class="p">(</span>
                        <span class="n">secret</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">upn</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">hmac_algo</span><span class="o">=</span><span class="n">hmac_algo</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sig_check</span> <span class="o">==</span> <span class="n">signature</span><span class="p">:</span>
                        <span class="c"># Everything matches (great!) so now we do due diligence</span>
                        <span class="c"># by checking the timestamp against the</span>
                        <span class="c"># api_timestamp_window setting and whether or not we&#39;ve</span>
                        <span class="c"># already used it (to prevent replay attacks).</span>
                        <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_signatures</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;API authentication replay attack detected!  User: &quot;</span>
                            <span class="s">&quot;</span><span class="si">%s</span><span class="s">, Remote IP: </span><span class="si">%s</span><span class="s">, Origin: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">upn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)))</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTH FAILED: Replay attack detected!  This &#39;</span>
                                <span class="s">&#39;event has been logged.&#39;</span><span class="p">)}</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">return</span>
                        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;api_timestamp_window&#39;</span><span class="p">]</span>
                        <span class="n">then</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
                        <span class="n">time_diff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">then</span>
                        <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;API authentication failed due to an expired auth &quot;</span>
                            <span class="s">&quot;object.  If you just restarted the server this is &quot;</span>
                            <span class="s">&quot;normal (users just need to reload the page).  If &quot;</span>
                            <span class="s">&quot; this problem persists it could be a problem with &quot;</span>
                            <span class="s">&quot;the server&#39;s clock (either this server or the &quot;</span>
                            <span class="s">&quot;server(s) embedding Gate One).&quot;</span>
                            <span class="p">))</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTH FAILED: Authentication object timed out. &#39;</span>
                                <span class="s">&#39;Try reloading this page (F5).&#39;</span><span class="p">)}</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTH FAILED: If the problem persists after &#39;</span>
                                <span class="s">&#39;reloading this page please contact your server&#39;</span>
                                <span class="s">&#39; administrator to notify them of the issue.&#39;</span><span class="p">)}</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">return</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;API Authentication Successful&quot;</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_signatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span> <span class="c"># Prevent replays</span>
                <span class="c"># Make a directory to store this user&#39;s settings/files/logs/etc</span>
                        <span class="n">user_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">upn</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">user_dir</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s">&quot;Creating user directory: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">user_dir</span><span class="p">))</span>
                            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">user_dir</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
                        <span class="n">session_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
                            <span class="n">session_data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">session_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">session_data</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">session_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c"># Save it so we can keep track across multiple clients</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s">&#39;upn&#39;</span><span class="p">:</span> <span class="n">upn</span><span class="p">,</span> <span class="c"># FYI: UPN == userPrincipalName</span>
                                    <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">generate_session_id</span><span class="p">()</span>
                                <span class="p">}</span>
                                <span class="n">session_info_json</span> <span class="o">=</span> <span class="n">json_encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">session_info_json</span><span class="p">)</span>
                        <span class="c"># Attach any additional provided keys/values to the user</span>
                        <span class="c"># object so applications embedding Gate One can use</span>
                        <span class="c"># them in their own plugins and whatnot.</span>
                        <span class="n">known_params</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s">&#39;api_key&#39;</span><span class="p">,</span>
                            <span class="s">&#39;api_version&#39;</span><span class="p">,</span>
                            <span class="s">&#39;timestamp&#39;</span><span class="p">,</span>
                            <span class="s">&#39;upn&#39;</span><span class="p">,</span>
                            <span class="s">&#39;signature&#39;</span><span class="p">,</span>
                            <span class="s">&#39;signature_method&#39;</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_params</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="c"># user dicts need a little extra attention for IPs...</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
                        <span class="c"># Force-set the current user:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
                        <span class="c"># Update our loggers to include the user metadata</span>
                        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s">&#39;upn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">],</span>
                            <span class="s">&#39;ip_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;ip_address&#39;</span><span class="p">]</span>
                        <span class="p">}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.auth&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.message&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;WebSocket auth failed signature check.&quot;</span><span class="p">))</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                        <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;Missing API Key in authentication object&quot;</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Anonymous auth</span>
            <span class="c"># Double-check there isn&#39;t a user set in the cookie (i.e. we have</span>
            <span class="c"># recently changed Gate One&#39;s settings).  If there is, force it</span>
            <span class="c"># back to ANONYMOUS.</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="n">cookie_data</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="c"># The client is trying to authenticate using the</span>
                    <span class="c"># &#39;gateone_user&#39; parameter in localStorage.</span>
                    <span class="c"># Authenticate/decode the encoded auth info</span>
                    <span class="n">cookie_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span>
                        <span class="s">&#39;gateone_user&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">])</span>
                    <span class="c"># NOTE: The above doesn&#39;t actually touch any cookies</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Someone is attempting to perform API-based authentication</span>
                    <span class="c"># but this server isn&#39;t configured with &#39;auth = &quot;api&quot;&#39;.</span>
                    <span class="c"># Let&#39;s be real user-friendly and point out this mistake</span>
                    <span class="c"># with a helpful error message...</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;Client tried to use API-based authentication but this &quot;</span>
                        <span class="s">&quot;server is configured with &#39;auth = </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&#39;.  Did you &quot;</span>
                        <span class="s">&quot;forget to set &#39;auth = </span><span class="se">\&quot;</span><span class="s">api</span><span class="se">\&quot;</span><span class="s"> in your settings?&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]))</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;AUTHENTICATION ERROR: Server is not configured to &quot;</span>
                        <span class="s">&quot;perform API-based authentication.  Did someone forget &quot;</span>
                        <span class="s">&quot;to set &#39;auth = </span><span class="se">\&quot;</span><span class="s">api</span><span class="se">\&quot;</span><span class="s"> in the settings?&quot;</span><span class="p">)}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">cookie_data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">cookie_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                <span class="c"># Generate a new session/anon user</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
                <span class="c"># Also store/update their session info in localStorage</span>
                <span class="n">encoded_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_signed_value</span><span class="p">(</span>
                    <span class="s">&#39;gateone_user&#39;</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
                <span class="n">session_message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:gateone_user&#39;</span><span class="p">:</span> <span class="n">encoded_user</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">session_message</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;ANONYMOUS&#39;</span><span class="p">:</span>
                <span class="c"># Gate One server&#39;s auth config probably changed</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="c">#self.close() # Close the WebSocket</span>
                <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;session&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Authentication failed for unknown user&quot;</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;AUTHENTICATION ERROR: User unknown&#39;</span><span class="p">)}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Exception encountered trying to authenticate: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Execute any post-authentication hooks that plugins have registered</span>
            <span class="k">if</span> <span class="n">PLUGIN_AUTH_HOOKS</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">auth_hook</span> <span class="ow">in</span> <span class="n">PLUGIN_AUTH_HOOKS</span><span class="p">:</span>
                    <span class="n">auth_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Exception in registered Auth hook: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
        <span class="c"># Apply the container/prefix settings (if present)</span>
        <span class="k">if</span> <span class="s">&#39;container&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;container&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span>
        <span class="c"># Locations are used to differentiate between different tabs/windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
        <span class="k">if</span> <span class="s">&#39;location&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span>
        <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s">&quot;User {upn} authenticated successfully via origin {origin}&quot;</span>
              <span class="s">&quot; (location: {location}).&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                  <span class="n">upn</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">))</span>
        <span class="c"># This check is to make sure there&#39;s no existing session so we don&#39;t</span>
        <span class="c"># accidentally clobber it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="c"># Start a new session:</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;last_seen&#39;</span><span class="p">:</span> <span class="s">&#39;connected&#39;</span><span class="p">,</span>
                <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span>
                <span class="s">&#39;timeout_callbacks&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="c"># Locations are virtual containers that indirectly correlate</span>
                <span class="c"># with browser windows/tabs.  The point is to allow things like</span>
                <span class="c"># opening/moving applications/terminals in/to new windows/tabs.</span>
                <span class="s">&#39;locations&#39;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;last_seen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;connected&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;locations&#39;</span><span class="p">]:</span>
                <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;locations&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># A shortcut for SESSIONS[self.session][&#39;locations&#39;]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locations</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;locations&#39;</span><span class="p">]</span>
        <span class="c"># Call applications&#39; authenticate() functions (if any)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="c"># Set the current user for convenient access</span>
            <span class="n">app</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s">&#39;authenticate&#39;</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">authenticate</span><span class="p">()</span>
        <span class="c"># This is just so the client has a human-readable point of reference:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:set_username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s">&#39;go:authenticate&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket._start_session_watcher"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket._start_session_watcher">[docs]</a>    <span class="k">def</span> <span class="nf">_start_session_watcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts up the `SESSION_WATCHER` (assigned to that global)</span>
<span class="sd">        :class:`~tornado.ioloop.PeriodicCallback` that regularly checks for user</span>
<span class="sd">        sessions that have timed out via the :func:`timeout_sessions` function</span>
<span class="sd">        and cleans them up (shuts down associated processes).</span>

<span class="sd">        The interval in which it performs this check is controlled via the</span>
<span class="sd">        `session_timeout_check_interval` setting. This setting is not included</span>
<span class="sd">        in Gate One&#39;s 10server.conf by default but can be added if needed to</span>
<span class="sd">        override the default value of 30 seconds.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;*&quot;: {</span>
<span class="sd">                    &quot;gateone&quot;: {</span>
<span class="sd">                        &quot;session_timeout_check_interval&quot;: &quot;30s&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">SESSION_WATCHER</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SESSION_WATCHER</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s">&#39;session_timeout_check_interval&#39;</span><span class="p">,</span> <span class="s">&quot;30s&quot;</span><span class="p">)</span> <span class="c"># 30s default</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="p">((</span>
                <span class="n">td</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">*</span>
                <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">SESSION_WATCHER</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">PeriodicCallback</span><span class="p">(</span>
                <span class="n">timeout_sessions</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">SESSION_WATCHER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket._start_log_cleaner"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket._start_log_cleaner">[docs]</a>    <span class="k">def</span> <span class="nf">_start_log_cleaner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts up the `CLEANER` (assigned to that global)</span>
<span class="sd">        `~tornado.ioloop.PeriodicCallback` that regularly checks for and</span>
<span class="sd">        deletes expired user logs (e.g. terminal session logs or anything in the</span>
<span class="sd">        `GATEONE_DIR/users/&lt;user&gt;/logs` dir) via the</span>
<span class="sd">        :func:`cleanup_user_logs` function.</span>

<span class="sd">        The interval in which it performs this check is controlled via the</span>
<span class="sd">        `user_logs_cleanup_interval` setting. This setting is not included in</span>
<span class="sd">        Gate One&#39;s 10server.conf by default but can be added if needed to</span>
<span class="sd">        override the default value of 5 minutes.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;*&quot;: {</span>
<span class="sd">                    &quot;gateone&quot;: {</span>
<span class="sd">                        &quot;user_logs_cleanup_interval&quot;: &quot;5m&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">CLEANER</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">CLEANER</span><span class="p">:</span>
            <span class="n">default_interval</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span> <span class="c"># 5 minutes</span>
            <span class="c"># NOTE: This interval isn&#39;t in the settings by default because it is</span>
            <span class="c"># kind of obscure.  No reason to clutter things up.</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s">&#39;user_logs_cleanup_interval&#39;</span><span class="p">,</span> <span class="n">default_interval</span><span class="p">)</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="p">((</span>
                <span class="n">td</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">*</span>
                <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">CLEANER</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">PeriodicCallback</span><span class="p">(</span>
                <span class="n">cleanup_user_logs</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">CLEANER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket._start_file_watcher"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket._start_file_watcher">[docs]</a>    <span class="k">def</span> <span class="nf">_start_file_watcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts up the :attr:`ApplicationWebSocket.file_watcher`</span>
<span class="sd">        `~tornado.ioloop.PeriodicCallback` (which regularly calls</span>
<span class="sd">        :meth:`ApplicationWebSocket.file_checker` and immediately starts it</span>
<span class="sd">        watching the broadcast file for changes (if not already watching it).</span>

<span class="sd">        The path to the broadcast file defaults to &#39;*settings_dir*/broadcast&#39;</span>
<span class="sd">        but can be changed via the &#39;broadcast_file&#39; setting.  This setting is</span>
<span class="sd">        not included in Gate One&#39;s 10server.conf by default but can be added if</span>
<span class="sd">        needed to overrided the default value.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;*&quot;: {</span>
<span class="sd">                    &quot;gateone&quot;: {</span>
<span class="sd">                        &quot;broadcast_file&quot;: &quot;/some/path/to/broadcast&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        .. tip::</span>

<span class="sd">            You can send messages to all users currently connected to the Gate</span>
<span class="sd">            One server by writing text to the broadcast file.  Example:</span>
<span class="sd">            `sudo echo &quot;Server will be rebooted as part of regularly scheduled</span>
<span class="sd">            maintenance in 5 minutes.  Pleas save your work.&quot; &gt;</span>
<span class="sd">            /tmp/gateone/broadcast`</span>

<span class="sd">        The interval in which it performs this check is controlled via the</span>
<span class="sd">        `file_check_interval` setting. This setting is not included in</span>
<span class="sd">        Gate One&#39;s 10server.conf by default but can be added if needed to</span>
<span class="sd">        override the default value of 5 seconds.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;*&quot;: {</span>
<span class="sd">                    &quot;gateone&quot;: {</span>
<span class="sd">                        &quot;file_check_interval&quot;: &quot;5s&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="s">&#39;broadcast&#39;</span><span class="p">)</span>
        <span class="n">broadcast_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;broadcast_file&#39;</span><span class="p">,</span> <span class="n">broadcast_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">broadcast_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="p">:</span>
            <span class="c"># No broadcast file means the file watcher isn&#39;t running</span>
            <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">u&#39;&#39;</span><span class="p">)</span> <span class="c"># Touch file</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s">&#39;file_check_interval&#39;</span><span class="p">,</span> <span class="s">&quot;5s&quot;</span><span class="p">)</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="p">((</span>
                <span class="n">td</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">*</span>
                <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">watch_file</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">broadcast_file_update</span><span class="p">)</span>
            <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">file_watcher</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">PeriodicCallback</span><span class="p">(</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">file_checker</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">io_loop</span><span class="o">=</span><span class="n">io_loop</span><span class="p">)</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">file_watcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.list_applications"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.list_applications">[docs]</a>    <span class="k">def</span> <span class="nf">list_applications</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client indiciating which applications are</span>
<span class="sd">        available to the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span><span class="s">&quot;gateone&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">enabled_applications</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;enabled_applications&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled_applications</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span> <span class="c"># Use the app&#39;s name attribute</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">name</span>
                <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c"># I&#39;ve been using these for testing stuff...  Ignore</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Bookmarks&quot;</span><span class="p">)</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Terminal: Nethack&quot;</span><span class="p">)</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Terminal: Login&quot;</span><span class="p">)</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Admin&quot;</span><span class="p">)</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;IRC&quot;</span><span class="p">)</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Log Viewer&quot;</span><span class="p">)</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Help&quot;</span><span class="p">)</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;RDP&quot;</span><span class="p">)</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;VNC&quot;</span><span class="p">)</span>
        <span class="n">enabled_applications</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="c"># Use this user&#39;s specific allowed list of applications if possible:</span>
        <span class="n">user_apps</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_applications&#39;</span><span class="p">,</span> <span class="n">enabled_applications</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:applications&#39;</span><span class="p">:</span> <span class="n">user_apps</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</div>
    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:set_location` WebSocket action.  Sets</span>
<span class="sd">        ``self.location`` to the given value.</span>

<span class="sd">        This mechanism can be used by applications embedding Gate One to</span>
<span class="sd">        create/control groups of application resources (e.g. terminals) that</span>
<span class="sd">        each reside in unique virtual &#39;locations&#39;.  Use this function to change</span>
<span class="sd">        locations on-the-fly without having to re-authenticate the user.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If this location is new, ``self.locations[*location*]`` will be</span>
<span class="sd">            created automatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s">&quot;go:set_location&quot;</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">get_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:get_locations` WebSocket action.  Sends a message to</span>
<span class="sd">        the client (via the `go:locations` WebSocket action) with a list of all</span>
<span class="sd">        the locations associated with the connected user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:locations&#39;</span><span class="p">:</span> <span class="n">locations</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s">&quot;go:get_locations&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationWebSocket.render_style"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.render_style">[docs]</a>    <span class="k">def</span> <span class="nf">render_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style_path</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renders the CSS template at *style_path* using *kwargs* and returns the</span>
<span class="sd">        path to the rendered result.  If the given style has already been</span>
<span class="sd">        rendered the existing cache path will be returned.</span>

<span class="sd">        If *force* is ``True`` the stylesheet will be rendered even if it</span>
<span class="sd">        already exists (cached).</span>

<span class="sd">        This method also cleans up older versions of the same rendered template.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">style_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">style_path</span> <span class="o">=</span> <span class="n">style_path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">style_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">shortened_path</span> <span class="o">=</span> <span class="n">short_hash</span><span class="p">(</span><span class="n">style_path</span><span class="p">)</span>
        <span class="n">rendered_filename</span> <span class="o">=</span> <span class="s">&#39;rendered_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shortened_path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
        <span class="n">rendered_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">rendered_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">style_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
                <span class="n">style_path</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="c"># NOTE: Tornado templates are always rendered as bytes.  That is why</span>
            <span class="c"># we&#39;re using &#39;wb&#39; below...</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">style_css</span><span class="p">)</span>
            <span class="c"># Remove older versions of the rendered template if present</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="n">rendered_filename</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">shortened_path</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                    <span class="c"># Older version present.</span>
                    <span class="c"># Remove it (and it&#39;s minified counterpart).</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rendered_path</span>

<span class="c"># TODO:  Get this checking the modification time of all theme files and only</span>
<span class="c">#        rendering/sending a new theme if something has changed.</span></div>
<div class="viewcode-block" id="ApplicationWebSocket.get_theme"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.get_theme">[docs]</a>    <span class="k">def</span> <span class="nf">get_theme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the theme stylesheets matching the properties specified in</span>
<span class="sd">        *settings* to the client.  *settings* must contain the following:</span>

<span class="sd">            * **container** - The element Gate One resides in (e.g. &#39;gateone&#39;)</span>
<span class="sd">            * **prefix** - The string being used to prefix all elements (e.g. &#39;go\_&#39;)</span>
<span class="sd">            * **theme** - The name of the CSS theme to be retrieved.</span>

<span class="sd">        .. note:: This will send the theme files for all applications and plugins that have a matching stylesheet in their &#39;templates&#39; directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;get_theme(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">send_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;send_css&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send_css</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s">&#39;logged_css_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;send_css is false; will not send JavaScript.&quot;</span><span class="p">))</span>
            <span class="c"># So we don&#39;t repeat this message a zillion times in the logs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logged_css_message</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>
        <span class="n">use_client_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;use_client_cache&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="n">templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">themes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="s">&#39;themes&#39;</span><span class="p">)</span>
        <span class="n">go_url</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;go_url&#39;</span><span class="p">]</span> <span class="c"># Used to prefix the url_prefix</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">go_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">go_url</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;container&quot;</span><span class="p">]</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;prefix&quot;</span><span class="p">]</span>
        <span class="n">theme</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;theme&quot;</span><span class="p">]</span>
        <span class="n">template_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
            <span class="n">url_prefix</span><span class="o">=</span><span class="n">go_url</span><span class="p">,</span>
            <span class="n">embedded</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;embedded&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;files&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">theme_filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.css&quot;</span> <span class="o">%</span> <span class="n">theme</span>
        <span class="n">theme_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">themes_path</span><span class="p">,</span> <span class="n">theme_filename</span><span class="p">)</span>
        <span class="n">template_loaders</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span>
        <span class="c"># This wierd little bit empties Tornado&#39;s template cache:</span>
        <span class="k">for</span> <span class="n">web_template_path</span> <span class="ow">in</span> <span class="n">template_loaders</span><span class="p">:</span>
            <span class="n">template_loaders</span><span class="p">[</span><span class="n">web_template_path</span><span class="p">]</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">rendered_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_style</span><span class="p">(</span>
            <span class="n">theme_path</span><span class="p">,</span> <span class="o">**</span><span class="n">template_args</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">theme_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">theme_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">)</span>
        <span class="c"># Now enumerate all applications/plugins looking for their own</span>
        <span class="c"># implementations of this theme (must have same name).</span>
        <span class="n">plugins_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">)</span>
        <span class="c"># Find plugin&#39;s theme-specific CSS files</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="n">plugin_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>
            <span class="n">themes_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_dir</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;themes&#39;</span><span class="p">)</span>
            <span class="n">theme_css_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">themes_dir</span><span class="p">,</span> <span class="n">theme_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">theme_css_file</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">rendered_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_style</span><span class="p">(</span>
                <span class="n">theme_css_file</span><span class="p">,</span> <span class="o">**</span><span class="n">template_args</span><span class="p">)</span>
            <span class="n">theme_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">)</span>
        <span class="c"># Find application&#39;s theme-specific CSS files</span>
        <span class="n">applications_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;applications&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">applications_dir</span><span class="p">):</span>
            <span class="n">app_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">applications_dir</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
            <span class="n">themes_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app_dir</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;themes&#39;</span><span class="p">)</span>
            <span class="n">theme_css_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">themes_dir</span><span class="p">,</span> <span class="n">theme_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">theme_css_file</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">rendered_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_style</span><span class="p">(</span>
                <span class="n">theme_css_file</span><span class="p">,</span> <span class="o">**</span><span class="n">template_args</span><span class="p">)</span>
            <span class="n">theme_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">)</span>
            <span class="c"># Find application plugin&#39;s theme-specific CSS files</span>
            <span class="n">plugins_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app_dir</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
                <span class="n">plugin_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>
                <span class="n">themes_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_dir</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;themes&#39;</span><span class="p">)</span>
                <span class="n">theme_css_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">themes_dir</span><span class="p">,</span> <span class="n">theme_filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">theme_css_file</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">rendered_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_style</span><span class="p">(</span>
                    <span class="n">theme_css_file</span><span class="p">,</span> <span class="o">**</span><span class="n">template_args</span><span class="p">)</span>
                <span class="n">theme_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">)</span>
        <span class="c"># Combine the theme files into one</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;theme.css&#39;</span> <span class="c"># Don&#39;t need a hashed name for the theme</span>
        <span class="n">cached_theme_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">new_theme_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">+</span><span class="s">&#39;.new&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">new_theme_path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">theme_files</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_theme_path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">old</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cached_theme_path</span><span class="p">):</span>
            <span class="n">old</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cached_theme_path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new</span> <span class="o">!=</span> <span class="n">old</span><span class="p">:</span>
            <span class="c"># They&#39;re different.  Replace the old one...</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_theme_path</span><span class="p">,</span> <span class="n">cached_theme_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Clean up</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_theme_path</span><span class="p">)</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">cached_theme_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="c"># This makes sure that the files are always re-downloaded</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;css&#39;</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s">&#39;element_id&#39;</span><span class="p">:</span> <span class="s">&#39;theme&#39;</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">cached_theme_path</span><span class="p">,</span>
            <span class="s">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s">&#39;element_id&#39;</span><span class="p">:</span> <span class="s">&#39;theme&#39;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">use_client_cache</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:file_sync&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;files&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="n">use_client_cache</span><span class="p">)</span>
</div>
    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">get_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to find the specified *filename* file in Gate One&#39;s static</span>
<span class="sd">        directories (GATEONE_DIR/static/ and each plugin&#39;s respective &#39;static&#39;</span>
<span class="sd">        dir).</span>

<span class="sd">        In the event that a plugin&#39;s JavaScript file has the same name as a file</span>
<span class="sd">        in GATEONE_DIR/static/ the plugin&#39;s copy of the file will take</span>
<span class="sd">        precedence.  This is to allow plugins to override defaults.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This will alow authenticated clients to download whatever file they</span>
<span class="sd">            want that ends in .js inside of /static/ directories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;get_js(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="n">js_files</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Key:value == &#39;somefile.js&#39;: &#39;/full/path/to/somefile.js&#39;</span>
        <span class="n">static_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">static_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
                <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">static_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">js_files</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">f</span><span class="p">:</span> <span class="n">js_file_path</span><span class="p">})</span>
        <span class="c"># Build a list of plugins</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plugins_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)):</span>
                <span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c"># Add each found JS file to the respective dict</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="n">plugin_static_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
                        <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                        <span class="n">js_files</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">f</span><span class="p">:</span> <span class="n">js_file_path</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">js_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">js_files</span><span class="p">[</span><span class="n">filename</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:load_js&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationWebSocket.cache_cleanup"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.cache_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cache_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:cache_cleanup` WebSocket action; rifles through the</span>
<span class="sd">        given list of *message[&#39;filenames&#39;]* from the client and sends a</span>
<span class="sd">        `go:cache_expired` WebSocket action to the client with a list of files</span>
<span class="sd">        that no longer exist in `self.file_cache` (so it can clean them up).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;cache_cleanup(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s">&#39;filenames&#39;</span><span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s">&#39;kind&#39;</span><span class="p">]</span>
        <span class="n">expired</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
                <span class="c"># The file_cache uses hashes; convert it</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span>
                    <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">:</span>
                <span class="n">expired</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expired</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;No expired </span><span class="si">%s</span><span class="s"> files at client </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Requesting deletion of expired files at client </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)))</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:cache_expired&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="c"># Also clean up stale files in the cache while we&#39;re at it</span>
        <span class="n">newest_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">filename_hash</span><span class="p">,</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_obj</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">newest_files</span><span class="p">:</span>
                <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_obj</span>
                <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s">&#39;filename_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename_hash</span>
            <span class="k">if</span> <span class="n">file_obj</span><span class="p">[</span><span class="s">&#39;mtime&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s">&#39;mtime&#39;</span><span class="p">]:</span>
                <span class="c"># Delete then replace the stale one</span>
                <span class="n">stale_hash</span> <span class="o">=</span> <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s">&#39;filename_hash&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">stale_hash</span><span class="p">]</span>
                <span class="n">newest_files</span><span class="p">[</span><span class="n">file_obj</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">file_obj</span>
            <span class="k">if</span> <span class="n">file_obj</span><span class="p">[</span><span class="s">&#39;mtime&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s">&#39;mtime&#39;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span> <span class="c"># Stale</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.file_request"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.file_request">[docs]</a>    <span class="k">def</span> <span class="nf">file_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files_or_hash</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:file_request` WebSocket action; minifies, caches,</span>
<span class="sd">        and finally sends the requested file to the client.  If</span>
<span class="sd">        *use_client_cache* is `False` the client will be instructed not to cache</span>
<span class="sd">        the file.  Example message from the client requesting a file:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({</span>
<span class="sd">                &#39;go:file_request&#39;: {&#39;some_file.js&#39;}}));</span>

<span class="sd">        .. note:: In reality &#39;some_file.js&#39; will be a unique/unguessable hash.</span>

<span class="sd">        Optionally, *files_or_hash* may be given as a list or tuple and all the</span>
<span class="sd">        requested files will be sent.</span>

<span class="sd">        Files will be cached after being minified until a file is modified or</span>
<span class="sd">        Gate One is restarted.</span>

<span class="sd">        If the `slimit` module is installed JavaScript files will be minified</span>
<span class="sd">        before being sent to the client.</span>

<span class="sd">        If the `cssmin` module is installed CSS files will be minified before</span>
<span class="sd">        being sent to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s">&quot;file_request(</span><span class="si">%s</span><span class="s">, use_client_cache=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">files_or_hash</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files_or_hash</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">filename_hash</span> <span class="ow">in</span> <span class="n">files_or_hash</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">(</span>
                    <span class="n">filename_hash</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="n">use_client_cache</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename_hash</span> <span class="o">=</span> <span class="n">files_or_hash</span>
        <span class="k">if</span> <span class="n">filename_hash</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
            <span class="c"># The file_cache uses hashes; convert it</span>
            <span class="n">filename_hash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span>
                <span class="n">filename_hash</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c"># Get the file info out of the file_cache so we can send it</span>
        <span class="n">element_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;element_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">][</span><span class="s">&#39;path&#39;</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">][</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">][</span><span class="s">&#39;kind&#39;</span><span class="p">]</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">][</span><span class="s">&#39;mtime&#39;</span><span class="p">]</span>
        <span class="n">requires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;requires&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">media</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;media&#39;</span><span class="p">,</span> <span class="s">&#39;screen&#39;</span><span class="p">)</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">,</span>
            <span class="s">&#39;cache&#39;</span><span class="p">:</span> <span class="n">use_client_cache</span><span class="p">,</span>
            <span class="s">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename_hash</span><span class="p">,</span>
            <span class="s">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s">&#39;element_id&#39;</span><span class="p">:</span> <span class="n">element_id</span><span class="p">,</span>
            <span class="s">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">,</span>
            <span class="s">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
            <span class="c"># JavaScript files can have dependencies which require that the</span>
            <span class="c"># client knows the filename.  The path-is-information-disclosure</span>
            <span class="c"># problem really only applies to rendered CSS template files anyway</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_or_cache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">minify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_or_cache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">minify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;js&#39;</span><span class="p">:</span>
            <span class="n">source_url</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="s">&#39;gateone/applications/&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">application</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;applications/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;plugins&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">static_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/plugins/&quot;</span> <span class="o">%</span> <span class="n">application</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c"># /terminal/ssh/static/</span>
                    <span class="n">source_url</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">url_prefix</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">static_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">static_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/static/&quot;</span> <span class="o">%</span> <span class="n">application</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">source_url</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">/static/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">url_prefix</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">static_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s">&#39;gateone/plugins/&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">plugin_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;gateone/plugins/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">static_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/static/&quot;</span> <span class="o">%</span> <span class="n">plugin_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">source_url</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">plugins/</span><span class="si">%s</span><span class="s">/static/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">url_prefix</span><span class="p">,</span> <span class="n">plugin_name</span><span class="p">,</span> <span class="n">static_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source_url</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">//# sourceURL={source_url}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">source_url</span><span class="o">=</span><span class="n">source_url</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:load_js&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;css&#39;</span><span class="p">:</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;css&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># So loadStyleAction() knows what to do</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:load_style&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;theme&#39;</span><span class="p">:</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;theme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:load_theme&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.send_js_or_css"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_js_or_css">[docs]</a>    <span class="k">def</span> <span class="nf">send_js_or_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">paths_or_fileobj</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="s">&quot;screen&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiates a file synchronization of the given *paths_or_fileobj* with</span>
<span class="sd">        the client to ensure it has the latest version of the file(s).</span>

<span class="sd">        The *kind* argument must be one of &#39;js&#39; or &#39;css&#39; to indicate JavaScript</span>
<span class="sd">        or CSS, respectively.</span>

<span class="sd">        Optionally, *element_id* may be provided which will be assigned to the</span>
<span class="sd">        &lt;script&gt; or &lt;style&gt; tag that winds up being created (only works with</span>
<span class="sd">        single files).</span>

<span class="sd">        Optionally, a *requires* string or list/tuple may be given which will</span>
<span class="sd">        ensure that the given file gets loaded after any dependencies.</span>

<span class="sd">        Optionally, a *media* string may be provided to specify the &#39;media=&#39;</span>
<span class="sd">        value when creating a &lt;style&gt; tag to hold the given CSS.</span>

<span class="sd">        .. note:</span>

<span class="sd">            If the slimit module is installed it will be used to minify the JS</span>
<span class="sd">            before being sent to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;js&#39;</span><span class="p">:</span>
            <span class="n">send_js</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;send_js&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">send_js</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s">&#39;logged_js_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;send_js is false; will not send JavaScript.&quot;</span><span class="p">))</span>
                <span class="c"># So we don&#39;t repeat this message a zillion times in the logs:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logged_js_message</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;css&#39;</span><span class="p">:</span>
            <span class="n">send_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;send_css&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">send_css</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s">&#39;logged_css_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;send_css is false; will not send CSS.&quot;</span><span class="p">))</span>
                <span class="c"># So we don&#39;t repeat this message a zillion times in the logs:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logged_css_message</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">use_client_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;use_client_cache&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">requires</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">requires</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">requires</span> <span class="o">=</span> <span class="p">[</span><span class="n">requires</span><span class="p">]</span> <span class="c"># This makes the logic simpler at the client</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths_or_fileobj</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;files&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">paths_or_fileobj</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">file_obj</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_obj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># Just in case</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
                <span class="n">filename_hash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span>
                    <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="s">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                    <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                    <span class="s">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
                    <span class="s">&#39;element_id&#39;</span><span class="p">:</span> <span class="n">element_id</span><span class="p">,</span>
                    <span class="s">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">,</span>
                    <span class="s">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span> <span class="c"># NOTE: Ignored if JS</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]:</span>
                    <span class="c"># This makes sure that the files are always re-downloaded</span>
                    <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
                    <span class="c"># JavaScript files don&#39;t need a hashed filename</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_hash</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="s">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
                    <span class="s">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                    <span class="s">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">,</span>
                    <span class="s">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span> <span class="c"># NOTE: Ignored if JS</span>
                <span class="p">})</span>
            <span class="k">if</span> <span class="n">use_client_cache</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:file_sync&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;files&#39;</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="n">use_client_cache</span><span class="p">)</span>
            <span class="k">return</span> <span class="c"># No further processing is necessary</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths_or_fileobj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">paths_or_fileobj</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paths_or_fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># Just in case</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">paths_or_fileobj</span><span class="o">.</span><span class="n">name</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">paths_or_fileobj</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;send_js_or_css(</span><span class="si">%s</span><span class="s">) (mtime: </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;send_js_or_css(): File not found: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="c"># Use a hash of the filename because these names can get quite long.</span>
        <span class="c"># Also, we don&#39;t want to reveal the file structure on the server.</span>
        <span class="n">filename_hash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c"># NOTE: The .split(&#39;.&#39;) above is so the hash we generate is always the</span>
        <span class="c"># same.  The tail end of the filename will have its modification date.</span>
        <span class="c"># Cache the metadata for sync</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
            <span class="s">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s">&#39;element_id&#39;</span><span class="p">:</span> <span class="n">element_id</span><span class="p">,</span>
            <span class="s">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">,</span>
            <span class="s">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span> <span class="c"># NOTE: Ignored if JS</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="c"># This makes sure that the files are always re-downloaded</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
            <span class="c"># JavaScript files don&#39;t need a hashed filename</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_hash</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;files&#39;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">,</span>
            <span class="s">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span> <span class="c"># NOTE: Ignored if JS</span>
        <span class="p">}]}</span>
        <span class="k">if</span> <span class="n">use_client_cache</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:file_sync&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;files&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="n">use_client_cache</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.send_js"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_js">[docs]</a>    <span class="k">def</span> <span class="nf">send_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut for `self.send_js_or_css(path, &#39;js&#39;, requires=requires)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_or_css</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span> <span class="s">&#39;js&#39;</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="n">element_id</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">requires</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.send_css"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_css">[docs]</a>    <span class="k">def</span> <span class="nf">send_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="s">&quot;screen&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut for</span>
<span class="sd">        `self.send_js_or_css(path, &#39;css&#39;, element_id=element_id, media=media)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_or_css</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;css&#39;</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="n">element_id</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="n">media</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.render_and_send_css"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.render_and_send_css">[docs]</a>    <span class="k">def</span> <span class="nf">render_and_send_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">css_path</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="s">&quot;screen&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renders, caches (in the `cache_dir`), and sends a stylesheet template at</span>
<span class="sd">        the given *css_path*.  The template will be rendered with the following</span>
<span class="sd">        keyword arguments::</span>

<span class="sd">            container = self.container</span>
<span class="sd">            prefix = self.prefix</span>
<span class="sd">            url_prefix = self.settings[&#39;url_prefix&#39;]</span>
<span class="sd">            **kwargs</span>

<span class="sd">        Returns the path to the rendered template.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If you want to serve Gate One&#39;s CSS via a different mechanism</span>
<span class="sd">            (e.g. nginx) this functionality can be completely disabled by adding</span>
<span class="sd">            `&quot;send_css&quot;: false` to gateone/settings/10server.conf</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">send_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;send_css&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send_css</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s">&#39;logged_css_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;send_css is false; will not send CSS.&quot;</span><span class="p">))</span>
            <span class="c"># So we don&#39;t repeat this message a zillion times in the logs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logged_css_message</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">css_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">safe_path</span> <span class="o">=</span> <span class="n">css_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="c"># So we can name the file safely</span>
        <span class="n">rendered_filename</span> <span class="o">=</span> <span class="s">&#39;rendered_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">safe_path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
        <span class="n">rendered_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">rendered_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="n">element_id</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="n">media</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">template_loaders</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span>
        <span class="c"># This wierd little bit empties Tornado&#39;s template cache:</span>
        <span class="k">for</span> <span class="n">web_template_path</span> <span class="ow">in</span> <span class="n">template_loaders</span><span class="p">:</span>
            <span class="n">template_loaders</span><span class="p">[</span><span class="n">web_template_path</span><span class="p">]</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">rendered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
            <span class="n">css_path</span><span class="p">,</span>
            <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
            <span class="n">url_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="n">element_id</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="n">media</span><span class="p">)</span>
        <span class="c"># Remove older versions of the rendered template if present</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="n">rendered_filename</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">safe_path</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                <span class="c"># Older version present.</span>
                <span class="c"># Remove it (and it&#39;s minified counterpart).</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rendered_path</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.send_plugin_static_files"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_plugin_static_files">[docs]</a>    <span class="k">def</span> <span class="nf">send_plugin_static_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">plugins_dir</span><span class="p">,</span> <span class="n">application</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends all plugin .js and .css files to the client that exist inside</span>
<span class="sd">        *plugins_dir*.  Optionally, if *application* is given the policies that</span>
<span class="sd">        apply to the current user for that application will be used to determine</span>
<span class="sd">        whether or not a given plugin&#39;s static files will be sent.</span>

<span class="sd">        If *requires* is given it will be passed along to `self.send_js()`.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If you want to serve Gate One&#39;s JavaScript via a different mechanism</span>
<span class="sd">            (e.g. nginx) this functionality can be completely disabled by adding</span>
<span class="sd">            `&quot;send_js&quot;: false` to gateone/settings/10server.conf</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;send_plugin_static_files(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">plugins_dir</span><span class="p">)</span>
        <span class="n">send_js</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;send_js&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send_js</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s">&#39;logged_js_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;send_js is false; will not send JavaScript.&quot;</span><span class="p">))</span>
            <span class="c"># So we don&#39;t repeat this message a zillion times in the logs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logged_js_message</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">globally_enabled_plugins</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;enabled_plugins&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c"># This controls the client-side plugins that will be sent</span>
        <span class="n">allowed_client_side_plugins</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_plugins&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c"># Remove non-globally-enabled plugins from user_plugins (if set)</span>
        <span class="k">if</span> <span class="n">globally_enabled_plugins</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">allowed_client_side_plugins</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">allowed_client_side_plugins</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">globally_enabled_plugins</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">allowed_client_side_plugins</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">globally_enabled_plugins</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allowed_client_side_plugins</span><span class="p">:</span>
            <span class="n">allowed_client_side_plugins</span> <span class="o">=</span> <span class="n">globally_enabled_plugins</span>
        <span class="c"># Build a list of plugins</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="k">return</span> <span class="c"># Nothing to do</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">allowed_client_side_plugins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">allowed_client_side_plugins</span><span class="p">:</span>
                        <span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c"># Add each found JS file to the respective dict</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="n">plugin_static_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">):</span>
                <span class="n">static_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">)</span>
                <span class="n">static_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">static_files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
                        <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">js_file_path</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">requires</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.css&#39;</span><span class="p">):</span>
                        <span class="n">css_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="n">css_file_path</span><span class="p">)</span>

<span class="c"># TODO:  Add support for a setting that can control which themes are visible to users.</span></div>
<div class="viewcode-block" id="ApplicationWebSocket.enumerate_themes"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.enumerate_themes">[docs]</a>    <span class="k">def</span> <span class="nf">enumerate_themes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a JSON-encoded object containing the installed themes and text</span>
<span class="sd">        color schemes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">themes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="s">&#39;themes&#39;</span><span class="p">)</span>
        <span class="c"># NOTE: This is temporary until this logic is moved to the terminal app:</span>
        <span class="n">colors_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span>
            <span class="s">&#39;applications&#39;</span><span class="p">,</span> <span class="s">&#39;terminal&#39;</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;term_colors&#39;</span><span class="p">)</span>
        <span class="n">themes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">themes_path</span><span class="p">)</span>
        <span class="n">themes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.css&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">themes</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">colors_path</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.css&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:themes_list&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;themes&#39;</span><span class="p">:</span> <span class="n">themes</span><span class="p">,</span> <span class="s">&#39;colors&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">set_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the client&#39;s locale to *message[&#39;locale&#39;]*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">][</span><span class="s">&#39;locale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s">&#39;locale&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_translation</span><span class="p">()</span>

<div class="viewcode-block" id="ApplicationWebSocket.send_js_translation"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_js_translation">[docs]</a>    <span class="k">def</span> <span class="nf">send_js_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client containing a JSON-encoded table of strings</span>
<span class="sd">        that have been translated to the user&#39;s locale.</span>

<span class="sd">        If a *path* is given it will be used to send the client that file.  If</span>
<span class="sd">        more than one JSON translation is sent to the client the new translation</span>
<span class="sd">        will be merged into the existing one.</span>

<span class="sd">        .. note:: Translation files must be the result of a `pojson /path/to/translation.po` conversion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chosen_locale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;locale&#39;</span><span class="p">,</span> <span class="s">&#39;en_US&#39;</span><span class="p">)</span>
        <span class="n">json_translation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">GATEONE_DIR</span><span class="p">,</span>
            <span class="s">&#39;i18n&#39;</span><span class="p">,</span>
            <span class="n">chosen_locale</span><span class="p">,</span>
            <span class="s">&#39;LC_MESSAGES&#39;</span><span class="p">,</span>
            <span class="s">&#39;gateone_js.json&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">decoded</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:register_translation&#39;</span><span class="p">:</span> <span class="n">decoded</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&quot;Translation file, </span><span class="si">%s</span><span class="s"> could not be found&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_translation</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">json_translation</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:register_translation&#39;</span><span class="p">:</span> <span class="n">decoded</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="c"># NOTE: This is not meant to be a chat application.  That&#39;ll come later :)</span>
<span class="c">#       The real purpose of send_user_message() and broadcast() are for</span>
<span class="c">#       programmatic use.  For example, when a user shares a terminal and it</span>
<span class="c">#       would be appropriate to notify certain users that the terminal is now</span>
<span class="c">#       available for them to connect.  This may use something other than the</span>
<span class="c">#       &#39;notice&#39; WebSocket action in the future to avoid confusion (if need be).</span></div>
    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">send_user_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the given *settings[&#39;message&#39;]* to the given *settings[&#39;upn&#39;]*.</span>

<span class="sd">        if *upn* is &#39;AUTHENTICATED&#39; all users will get the message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;message&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Error: No message to send.&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Error: Missing UPN.&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">],</span> <span class="n">upn</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s">&#39;go:send_user_message&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationWebSocket.send_message"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_message">[docs]</a>    <span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the given *message* to the client using the `go:notice` WebSocket</span>
<span class="sd">        action at the currently-connected client.</span>

<span class="sd">        If *upn* is provided the *message* will be sent to all users with a</span>
<span class="sd">        matching &#39;upn&#39; value.</span>

<span class="sd">        If *session* is provided the message will be sent to all users with a</span>
<span class="sd">        matching session ID.  This is useful in situations where all users share</span>
<span class="sd">        the same &#39;upn&#39; (i.e. ANONYMOUS).</span>

<span class="sd">        if *upn* is &#39;AUTHENTICATED&#39; all users will get the message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">upn</span><span class="p">:</span>
            <span class="n">ApplicationWebSocket</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message_dict</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="n">upn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">ApplicationWebSocket</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message_dict</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Just send to the currently-connected client</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s">&#39;go:send_message&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</div>
    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the given *message* (string) to all connected, authenticated</span>
<span class="sd">        users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Broadcast: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">strip_xss</span> <span class="c"># Prevent XSS attacks</span>
        <span class="n">message</span><span class="p">,</span> <span class="n">bad_tags</span> <span class="o">=</span> <span class="n">strip_xss</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="s">&quot;entities&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="s">&quot;AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s">&#39;go:broadcast&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">list_server_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of users currently connected to the Gate One server to</span>
<span class="sd">        the client via the &#39;go:user_list&#39; WebSocket action.  Only users with the</span>
<span class="sd">        &#39;list_users&#39; policy are allowed to execute this action.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({&quot;go:list_users&quot;: null}));</span>

<span class="sd">        That would send a JSON message to the client like so::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;go:user_list&quot;: [</span>
<span class="sd">                    {&quot;upn&quot;: &quot;user@enterprise&quot;, &quot;ip_address&quot;: &quot;10.0.1.11&quot;},</span>
<span class="sd">                    {&quot;upn&quot;: &quot;bsmith@enterprise&quot;, &quot;ip_address&quot;: &quot;10.0.2.15&quot;}</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span><span class="o">.</span><span class="n">_list_connected_users</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;list_server_users(): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">users</span><span class="p">))</span>
        <span class="c"># Remove things that users should not see such as their session ID</span>
        <span class="n">filtered_users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span><span class="s">&#39;gateone&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">allowed_fields</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_list_fields&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="c"># If not set, just strip the session ID</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_fields</span><span class="p">:</span>
            <span class="n">allowed_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;upn&#39;</span><span class="p">,</span> <span class="s">&#39;ip_address&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="n">user_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">allowed_fields</span><span class="p">:</span>
                    <span class="n">user_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">filtered_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_dict</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;go:user_list&#39;</span><span class="p">:</span> <span class="n">filtered_users</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s">&#39;go:user_list&#39;</span><span class="p">,</span> <span class="n">filtered_users</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket._deliver"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket._deliver">[docs]</a>    <span class="k">def</span> <span class="nf">_deliver</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="s">&quot;AUTHENTICATED&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the given *message* (string) to all users matching *upn* using</span>
<span class="sd">        the write_message() function.  If *upn* is not provided or is</span>
<span class="sd">        &quot;AUTHENTICATED&quot;, will send the *message* to all users.</span>

<span class="sd">        Alternatively a *session* ID may be specified instead of a *upn*.  This</span>
<span class="sd">        is useful when more than one user shares a UPN (i.e. ANONYMOUS).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;_deliver(</span><span class="si">%s</span><span class="s">, upn=</span><span class="si">%s</span><span class="s">, session=</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="p">,</span> <span class="n">session</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="c"># Only send to users that have authenticated</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">current_user</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">session</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">upn</span> <span class="o">==</span> <span class="s">&quot;AUTHENTICATED&quot;</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">upn</span> <span class="o">==</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket._list_connected_users"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket._list_connected_users">[docs]</a>    <span class="k">def</span> <span class="nf">_list_connected_users</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple of user objects representing the users that are</span>
<span class="sd">        currently connected (and authenticated) to this Gate One server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;_list_connected_users()&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="c"># We only care about authenticated users</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">current_user</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="ErrorHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ErrorHandler">[docs]</a><span class="k">class</span> <span class="nc">ErrorHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates an error response with status_code for all requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_error_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s">&quot;static_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">403</span><span class="p">]:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;static_url&#39;</span><span class="p">],</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">.html&#39;</span> <span class="o">%</span> <span class="n">status_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="kn">import</span> <span class="nn">httplib</span>
        <span class="k">return</span> <span class="s">&quot;&lt;html&gt;&lt;title&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/title&gt;&quot;</span> \
           <span class="s">&quot;&lt;body class=&#39;bodyErrorPage&#39;&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/body&gt;&lt;/html&gt;&quot;</span> <span class="o">%</span> <span class="p">{</span>
               <span class="s">&quot;code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
               <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">status_code</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">GateOneApp</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup our Tornado application...  Everything in *settings* will wind up</span>
<span class="sd">        in the Tornado settings dict so as to be accessible under self.settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">PLUGIN_WS_CMDS</span>
        <span class="k">global</span> <span class="n">PLUGIN_COMMAND_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_ESC_HANDLERS</span>
        <span class="k">global</span> <span class="n">PLUGIN_AUTH_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_TERM_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_NEW_TERM_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_NEW_MULTIPLEX_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_ENV_HOOKS</span>
        <span class="c"># Base settings for our Tornado app</span>
        <span class="n">static_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;static&quot;</span><span class="p">)</span>
        <span class="n">tornado_settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">cookie_secret</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">],</span>
            <span class="n">static_url</span><span class="o">=</span><span class="n">static_url</span><span class="p">,</span>
            <span class="n">static_url_prefix</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">static/&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">],</span>
            <span class="n">gzip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">login_url</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">auth&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c"># Make sure all the provided settings wind up in self.settings</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tornado_settings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c"># Setup the configured authentication type</span>
        <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">NullAuthHandler</span> <span class="c"># Default</span>
        <span class="k">if</span> <span class="s">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;kerberos&#39;</span> <span class="ow">and</span> <span class="n">KerberosAuthHandler</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">KerberosAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;pam&#39;</span> <span class="ow">and</span> <span class="n">PAMAuthHandler</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">PAMAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;google&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">GoogleAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;ssl&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">SSLAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;api&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">APIAuthHandler</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Using </span><span class="si">%s</span><span class="s"> authentication&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;No authentication method configured. All users will be &quot;</span>
                <span class="s">&quot;ANONYMOUS&quot;</span><span class="p">))</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;docs&#39;</span><span class="p">)</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docs_path</span><span class="p">,</span> <span class="s">&#39;build&#39;</span><span class="p">)</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docs_path</span><span class="p">,</span> <span class="s">&#39;html&#39;</span><span class="p">)</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url_prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
            <span class="c"># Make sure there&#39;s a trailing slash</span>
            <span class="n">url_prefix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span>
        <span class="c"># Make the / optional in the regex so it works with the @addslash</span>
        <span class="c"># decorator.  e.g. &quot;/whatever/&quot; would become &quot;/whatever/?&quot;</span>
        <span class="n">index_regex</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">?&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span>
        <span class="c"># Setup our URL handlers</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">index_regex</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">ws&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span>
                <span class="n">ApplicationWebSocket</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">apps</span><span class="o">=</span><span class="n">APPLICATIONS</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">auth&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">AuthHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">downloads/(.*)&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">DownloadHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">docs/(.*)&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">docs_path</span><span class="p">,</span>
                <span class="s">&quot;default_filename&quot;</span><span class="p">:</span> <span class="s">&quot;index.html&quot;</span>
            <span class="p">})</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;web_handlers&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">handler_tuple</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;web_handlers&#39;</span><span class="p">]:</span>
                <span class="n">regex</span> <span class="o">=</span> <span class="n">handler_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">handler_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">handler_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c"># No kwargs for this handler</span>
                <span class="c"># Make sure the regex is prefix with the url_prefix</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">regex</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span>
                    <span class="n">regex</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_prefix</span><span class="p">,</span> <span class="n">regex</span><span class="p">)</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">regex</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="c"># Override the default static handler to ensure the headers are set</span>
        <span class="c"># to allow cross-origin requests.</span>
        <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">static/(.*)&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">StaticHandler</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">static_url</span><span class="p">}</span>
        <span class="p">))</span>
        <span class="c"># Hook up the hooks</span>
        <span class="k">for</span> <span class="n">plugin_name</span><span class="p">,</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;Web&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Web handlers</span>
                <span class="n">fixed_hooks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">]:</span>
                        <span class="c"># h == (regex, Handler)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span> <span class="c"># Fix it</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">url_prefix</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">),</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span> <span class="c"># Fix it</span>
                        <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">url_prefix</span> <span class="o">+</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">),</span>
                            <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">])</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fixed_hooks</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;WebSocket&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s WebSocket commands</span>
                <span class="n">PLUGIN_WS_CMDS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;WebSocket&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Escape&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Escape handler</span>
                <span class="n">PLUGIN_ESC_HANDLERS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plugin_name</span><span class="p">:</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Escape&#39;</span><span class="p">]})</span>
            <span class="k">if</span> <span class="s">&#39;Auth&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s post-authentication functions</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">PLUGIN_AUTH_HOOKS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PLUGIN_AUTH_HOOKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Command&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s &#39;Command&#39; hooks (called by new_multiplex)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Command&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">PLUGIN_COMMAND_HOOKS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Command&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PLUGIN_COMMAND_HOOKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Command&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Multiplex&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Multiplex hooks (called by new_multiplex)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Multiplex&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">PLUGIN_NEW_MULTIPLEX_HOOKS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Multiplex&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PLUGIN_NEW_MULTIPLEX_HOOKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Multiplex&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Terminal&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Terminal hooks (called by new_terminal)</span>
                <span class="n">PLUGIN_TERM_HOOKS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Terminal&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;TermInstance&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s TermInstance hooks (called by new_terminal)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;TermInstance&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">PLUGIN_NEW_TERM_HOOKS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;TermInstance&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PLUGIN_NEW_TERM_HOOKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;TermInstance&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Environment&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="n">PLUGIN_ENV_HOOKS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Environment&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Init&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Call the plugin&#39;s initialization functions</span>
                <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Init&#39;</span><span class="p">](</span><span class="n">tornado_settings</span><span class="p">)</span>
        <span class="c"># Include JS-only and CSS-only plugins (for logging purposes)</span>
        <span class="n">js_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;js&#39;</span><span class="p">]]</span>
        <span class="c"># Add static handlers for all the JS plugins (primarily for source URLs)</span>
        <span class="k">for</span> <span class="n">js_plugin</span> <span class="ow">in</span> <span class="n">js_plugins</span><span class="p">:</span>
            <span class="n">js_plugin_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">,</span> <span class="n">js_plugin</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
            <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="s">r&quot;</span><span class="si">%s</span><span class="s">plugins/</span><span class="si">%s</span><span class="s">/static/(.*)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_prefix</span><span class="p">,</span> <span class="n">js_plugin</span><span class="p">),</span>
                <span class="n">StaticHandler</span><span class="p">,</span>
                <span class="p">{</span><span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">js_plugin_path</span><span class="p">}</span>
            <span class="p">))</span>
        <span class="c"># This removes duplicate handlers for the same regex, allowing plugins</span>
        <span class="c"># to override defaults:</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="n">merge_handlers</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>
        <span class="n">css_plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">css_plugins</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span> <span class="c"># CSS Template</span>
                <span class="n">css_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;plugin=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Static CSS file</span>
                <span class="n">css_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;py&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">js_plugins</span> <span class="o">+</span> <span class="n">css_plugins</span><span class="p">))</span>
        <span class="n">plugin_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c"># So there&#39;s consistent ordering</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Loaded plugins: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">))</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="p">,</span> <span class="o">**</span><span class="n">tornado_settings</span><span class="p">)</span>

<div class="viewcode-block" id="define_options"><a class="viewcode-back" href="../Developer/gateone.html#gateone.define_options">[docs]</a><span class="k">def</span> <span class="nf">define_options</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls `tornado.options.define` for all of Gate One&#39;s command-line options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># NOTE: To test this function interactively you must import tornado.options</span>
    <span class="c"># and call tornado.options.parse_config_file(*some_config_path*).  After you</span>
    <span class="c"># do that the options will wind up in tornado.options.options</span>
    <span class="k">global</span> <span class="n">user_locale</span>
    <span class="c"># Default to using the shell&#39;s LANG variable as the locale</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">default_locale</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LANG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># $LANG isn&#39;t set</span>
        <span class="n">default_locale</span> <span class="o">=</span> <span class="s">&quot;en_US&quot;</span>
    <span class="n">user_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">default_locale</span><span class="p">)</span>
    <span class="c"># NOTE: The locale setting above is only for the --help messages.</span>
    <span class="c"># Simplify the auth option help message</span>
    <span class="n">auths</span> <span class="o">=</span> <span class="s">&quot;none, api, google, ssl&quot;</span>
    <span class="k">if</span> <span class="n">KerberosAuthHandler</span><span class="p">:</span>
        <span class="n">auths</span> <span class="o">+=</span> <span class="s">&quot;, kerberos&quot;</span>
    <span class="k">if</span> <span class="n">PAMAuthHandler</span><span class="p">:</span>
        <span class="n">auths</span> <span class="o">+=</span> <span class="s">&quot;, pam&quot;</span>
    <span class="c"># Simplify the syslog_facility option help message</span>
    <span class="n">facilities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FACILITIES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">facilities</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c"># Figure out the default origins</span>
    <span class="n">default_origins</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="c"># Used both http and https above to demonstrate that both are acceptable</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">additional_origins</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">:</span>
        <span class="c"># Couldn&#39;t get any IPs from the hostname</span>
        <span class="n">additional_origins</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">additional_origins</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">default_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">host</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># It&#39;s a list</span>
            <span class="k">for</span> <span class="n">_host</span> <span class="ow">in</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">default_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">_host</span><span class="p">)</span>
    <span class="n">default_origins</span> <span class="o">=</span> <span class="s">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">default_origins</span><span class="p">)</span>
    <span class="n">config_default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;server.conf&quot;</span><span class="p">)</span>
    <span class="c"># NOTE: --settings_dir deprecates --config</span>
    <span class="n">settings_default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;settings&quot;</span><span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">config_default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;DEPRECATED.  Use --settings_dir.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;settings_dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">settings_default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Path to the settings directory.  Default: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">settings_default</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;cache_dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="s">&#39;gateone_cache&#39;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Path where Gate One should store temporary global files (e.g. &quot;</span>
            <span class="s">&quot;rendered templates, CSS, JS, etc).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;debug&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Enable debugging features such as auto-restarting when files &quot;</span>
               <span class="s">&quot;are modified.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;cookie_secret&quot;</span><span class="p">,</span> <span class="c"># 45 chars is, &quot;Good enough for me&quot; (cookie joke =)</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Use the given 45-character string for cookie encryption.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;command&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;DEPRECATED: Use the &#39;commands&#39; option in the terminal settings.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;address&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Run on the given address.  Default is all addresses (IPv6 &quot;</span>
               <span class="s">&quot;included).  Multiple address can be specified using a semicolon&quot;</span>
               <span class="s">&quot; as a separator (e.g. &#39;127.0.0.1;::1;10.1.1.100&#39;).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span><span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">443</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Run on the given port.&quot;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;enable_unix_socket&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Enable Unix socket support.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;unix_socket_path&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;/tmp/gateone.sock&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the Unix socket (if --enable_unix_socket=True).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span><span class="p">)</span>
    <span class="c"># Please only use this if Gate One is running behind something with SSL:</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;disable_ssl&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;If enabled, Gate One will run without SSL (generally not a &quot;</span>
               <span class="s">&quot;good idea).&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;certificate&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;certificate.pem&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the SSL certificate.  Will be auto-generated if none is&quot;</span>
               <span class="s">&quot; provided.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;keyfile&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;keyfile.pem&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the SSL keyfile.  Will be auto-generated if none is&quot;</span>
               <span class="s">&quot; provided.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;ca_certs&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to a file containing any number of concatenated CA &quot;</span>
               <span class="s">&quot;certificates in PEM format.  They will be used to authenticate &quot;</span>
               <span class="s">&quot;clients if the &#39;ssl_auth&#39; option is set to &#39;optional&#39; or &quot;</span>
               <span class="s">&quot;&#39;required&#39;.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;ssl_auth&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Enable the use of client SSL (X.509) certificates as a &quot;</span>
               <span class="s">&quot;secondary authentication factor (the configured &#39;auth&#39; type &quot;</span>
               <span class="s">&quot;will come after SSL auth).  May be one of &#39;none&#39;, &#39;optional&#39;, &quot;</span>
               <span class="s">&quot;or &#39;required&#39;.  NOTE: Only works if the &#39;ca_certs&#39; option is &quot;</span>
               <span class="s">&quot;configured.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;user_dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;users&quot;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the location where user files will be stored.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;user_logs_max_age&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;30d&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Maximum amount of length of time to keep any given user log &quot;</span>
                <span class="s">&quot;before it is removed.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;session_dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;/tmp/gateone&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Path to the location where session information will be stored.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;syslog_facility&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;daemon&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Syslog facility to use when logging to syslog (if &quot;</span>
               <span class="s">&quot;syslog_session_logging is enabled).  Must be one of: </span><span class="si">%s</span><span class="s">.&quot;</span>
               <span class="s">&quot;  Default: daemon&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">facilities</span><span class="p">)),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;syslog_host&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Remote host to send syslog messages to if syslog_logging is &quot;</span>
               <span class="s">&quot;enabled.  Default: None (log to the local syslog daemon &quot;</span>
               <span class="s">&quot;directly).  NOTE:  This setting is required on platforms that &quot;</span>
               <span class="s">&quot;don&#39;t include Python&#39;s syslog module.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;session_timeout&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;5d&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Amount of time that a session is allowed to idle before it is &quot;</span>
        <span class="s">&quot;killed.  Accepts &lt;num&gt;X where X could be one of s, m, h, or d for &quot;</span>
        <span class="s">&quot;seconds, minutes, hours, and days.  Default is &#39;5d&#39; (5 days).   Set to&quot;</span>
        <span class="s">&quot; &#39;0&#39; to disable the ability to resume sessions.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;new_api_key&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Generate a new API key that an external application can use to &quot;</span>
               <span class="s">&quot;embed Gate One.&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;auth&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Authentication method to use.  Valid options are: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">auths</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="c"># This is to prevent replay attacks.  Gate One only keeps a &quot;working memory&quot;</span>
    <span class="c"># of API auth objects for this amount of time.  So if the Gate One server is</span>
    <span class="c"># restarted we don&#39;t have to write them to disk as anything older than this</span>
    <span class="c"># setting will be invalid (no need to check if it has already been used).</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;api_timestamp_window&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;30s&quot;</span><span class="p">,</span> <span class="c"># 30 seconds</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;How long before an API authentication object becomes invalid.  &quot;</span>
            <span class="s">&quot;Default is &#39;30s&#39; (30 seconds).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;sso_realm&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Kerberos REALM (aka DOMAIN) to use when authenticating clients.&quot;</span>
               <span class="s">&quot; Only relevant if Kerberos authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;sso_service&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&#39;HTTP&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Kerberos service (aka application) to use. Defaults to HTTP. &quot;</span>
               <span class="s">&quot;Only relevant if Kerberos authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;pam_realm&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Basic auth REALM to display when authenticating clients.  &quot;</span>
        <span class="s">&quot;Default: hostname.  &quot;</span>
        <span class="s">&quot;Only relevant if PAM authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="c"># NOTE: This is only used to show the user a REALM at the basic auth</span>
        <span class="c">#       prompt and as the name in the GATEONE_DIR+&#39;/users&#39; directory</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;pam_service&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&#39;login&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;PAM service to use.  Defaults to &#39;login&#39;. &quot;</span>
               <span class="s">&quot;Only relevant if PAM authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;embedded&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;When embedding Gate One, this option is available to templates.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;locale&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default_locale</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;The locale (e.g. pt_PT) Gate One should use for translations.&quot;</span>
             <span class="s">&quot;  If not provided, will default to $LANG (which is &#39;</span><span class="si">%s</span><span class="s">&#39; in your &quot;</span>
             <span class="s">&quot;current shell), or en_US if not set.&quot;</span>
             <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LANG&#39;</span><span class="p">,</span> <span class="s">&#39;not set&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;js_init&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A JavaScript object (string) that will be used when running &quot;</span>
               <span class="s">&quot;GateOne.init() inside index.html.  &quot;</span>
               <span class="s">&quot;Example: --js_init=</span><span class="se">\&quot;</span><span class="s">{scheme: &#39;white&#39;}</span><span class="se">\&quot;</span><span class="s"> would result in &quot;</span>
               <span class="s">&quot;GateOne.init({scheme: &#39;white&#39;})&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;https_redirect&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;If enabled, a separate listener will be started on port 80 that&quot;</span>
               <span class="s">&quot; redirects users to the configured port using HTTPS.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;url_prefix&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;An optional prefix to place before all Gate One URLs. e.g. &quot;</span>
               <span class="s">&quot;&#39;/gateone/&#39;.  Use this if Gate One will be running behind a &quot;</span>
               <span class="s">&quot;reverse proxy where you want it to be located at some sub-&quot;</span>
               <span class="s">&quot;URL path.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;origins&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default_origins</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A semicolon-separated list of origins you wish to allow access &quot;</span>
               <span class="s">&quot;to your Gate One server over the WebSocket.  This value must &quot;</span>
               <span class="s">&quot;contain the hostnames and FQDNs (e.g. foo;foo.bar;) users will&quot;</span>
               <span class="s">&quot; use to connect to your Gate One server as well as the &quot;</span>
               <span class="s">&quot;hostnames/FQDNs of any sites that will be embedding Gate One. &quot;</span>
               <span class="s">&quot;Here&#39;s the default on your system: &#39;</span><span class="si">%s</span><span class="s">&#39;. &quot;</span>
               <span class="s">&quot;Alternatively, &#39;*&#39; may be  specified to allow access from &quot;</span>
               <span class="s">&quot;anywhere.&quot;</span> <span class="o">%</span> <span class="n">default_origins</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;pid_file&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;/tmp/gateone.pid&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Define the path to the pid file.  Default: /tmp/gateone.pid&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;uid&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()),</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Drop privileges and run Gate One as this user/uid.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;gid&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()),</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Drop privileges and run Gate One as this group/gid.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;api_keys&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;The &#39;key:secret,...&#39; API key pairs you wish to use (only &quot;</span>
               <span class="s">&quot;applies if using API authentication)&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;combine_js&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Combines all of Gate One&#39;s JavaScript files into one big file and &quot;</span>
            <span class="s">&quot;saves it at the given path (e.g. ./gateone.py &quot;</span>
            <span class="s">&quot;--combine_js=/tmp/gateone.js)&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;combine_css&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Combines all of Gate One&#39;s CSS Template files into one big file &quot;</span>
            <span class="s">&quot;and saves it at the given path (e.g. ./gateone.py &quot;</span>
            <span class="s">&quot;--combine_css=/tmp/gateone.css).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;combine_css_container&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;gateone&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Use this setting in conjunction with --combine_css if the &lt;div&gt; &quot;</span>
            <span class="s">&quot;where Gate One lives is named something other than #gateone&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
</div>
<div class="viewcode-block" id="generate_server_conf"><a class="viewcode-back" href="../Developer/gateone.html#gateone.generate_server_conf">[docs]</a><span class="k">def</span> <span class="nf">generate_server_conf</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a fresh settings/10server.conf file using the arguments provided</span>
<span class="sd">    on the command line to override defaults.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s">u&quot;Gate One settings are incomplete.  A new settings/10server.conf&quot;</span>
        <span class="s">u&quot; will be generated.&quot;</span><span class="p">))</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">options_to_settings</span>
    <span class="n">auth_settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Auth stuff goes in 20authentication.conf</span>
    <span class="n">all_setttings</span> <span class="o">=</span> <span class="n">options_to_settings</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="c"># NOTE: options is global</span>
    <span class="n">settings_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span>
    <span class="n">server_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">server_conf_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;You have a 10server.conf but it is either invalid (syntax &quot;</span>
            <span class="s">&quot;error) or missing essential settings.&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">config_defaults</span> <span class="o">=</span> <span class="n">all_setttings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span>
    <span class="c"># Don&#39;t need this in the actual settings file:</span>
    <span class="k">del</span> <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;settings_dir&#39;</span><span class="p">]</span>
    <span class="n">non_options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c"># These are things that don&#39;t really belong in settings</span>
        <span class="s">&#39;new_api_key&#39;</span><span class="p">,</span> <span class="s">&#39;help&#39;</span><span class="p">,</span> <span class="s">&#39;kill&#39;</span><span class="p">,</span> <span class="s">&#39;config&#39;</span>
    <span class="p">]</span>
    <span class="c"># Don&#39;t need non-options in there either:</span>
    <span class="k">for</span> <span class="n">non_option</span> <span class="ow">in</span> <span class="n">non_options</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">non_option</span> <span class="ow">in</span> <span class="n">config_defaults</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">config_defaults</span><span class="p">[</span><span class="n">non_option</span><span class="p">]</span>
    <span class="c"># Generate a new cookie_secret</span>
    <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
    <span class="c"># Separate out the authentication settings</span>
    <span class="n">authentication_options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c"># These are here only for logical separation in the .conf files</span>
        <span class="s">&#39;api_timestamp_window&#39;</span><span class="p">,</span> <span class="s">&#39;auth&#39;</span><span class="p">,</span> <span class="s">&#39;pam_realm&#39;</span><span class="p">,</span> <span class="s">&#39;pam_service&#39;</span><span class="p">,</span>
        <span class="s">&#39;sso_realm&#39;</span><span class="p">,</span> <span class="s">&#39;sso_service&#39;</span><span class="p">,</span> <span class="s">&#39;ssl_auth&#39;</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">config_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">authentication_options</span><span class="p">:</span>
            <span class="n">auth_settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
            <span class="k">del</span> <span class="n">config_defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="c"># Make sure we have a valid log_file_prefix</span>
    <span class="k">if</span> <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">web_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;logs&#39;</span><span class="p">)</span>
        <span class="n">web_log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">web_log_dir</span><span class="p">,</span> <span class="s">&#39;webserver.log&#39;</span><span class="p">)</span>
        <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web_log_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">web_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">web_log_dir</span><span class="p">):</span>
        <span class="c"># Make sure the directory exists</span>
        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">web_log_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]):</span>
        <span class="c"># Make sure the file is present</span>
        <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">u&#39;&#39;</span><span class="p">)</span>
    <span class="n">auth_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;20authentication.conf&#39;</span><span class="p">)</span>
    <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">settings_template</span>
    <span class="n">new_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span>
        <span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">config_defaults</span><span class="p">)</span>
    <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">server_conf_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">u&quot;// This is Gate One&#39;s main settings file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_settings</span><span class="p">)</span>
    <span class="n">new_auth_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span>
        <span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">auth_settings</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">auth_conf_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">u&quot;// This is Gate One&#39;s authentication settings file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_auth_settings</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="convert_old_server_conf"><a class="viewcode-back" href="../Developer/gateone.html#gateone.convert_old_server_conf">[docs]</a><span class="k">def</span> <span class="nf">convert_old_server_conf</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts old-style server.conf files to the new settings/10server.conf</span>
<span class="sd">    format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">settings_template</span><span class="p">,</span> <span class="n">RUDict</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">()</span>
    <span class="n">auth_settings</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">()</span>
    <span class="n">terminal_settings</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">()</span>
    <span class="n">api_keys</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">({</span><span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gateone&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;api_keys&quot;</span><span class="p">:</span> <span class="p">{}}}})</span>
    <span class="n">terminal_options</span> <span class="o">=</span> <span class="p">[</span> <span class="c"># These are now terminal-app-specific setttings</span>
        <span class="s">&#39;command&#39;</span><span class="p">,</span> <span class="s">&#39;dtach&#39;</span><span class="p">,</span> <span class="s">&#39;session_logging&#39;</span><span class="p">,</span> <span class="s">&#39;session_logs_max_age&#39;</span><span class="p">,</span>
        <span class="s">&#39;syslog_session_logging&#39;</span>
    <span class="p">]</span>
    <span class="n">authentication_options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c"># These are here only for logical separation in the .conf files</span>
        <span class="s">&#39;api_timestamp_window&#39;</span><span class="p">,</span> <span class="s">&#39;auth&#39;</span><span class="p">,</span> <span class="s">&#39;pam_realm&#39;</span><span class="p">,</span> <span class="s">&#39;pam_service&#39;</span><span class="p">,</span>
        <span class="s">&#39;sso_realm&#39;</span><span class="p">,</span> <span class="s">&#39;sso_service&#39;</span><span class="p">,</span> <span class="s">&#39;ssl_auth&#39;</span>
    <span class="p">]</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c"># Regular server-wide settings will go in 10server.conf by default.</span>
        <span class="c"># These settings can actually be spread out into any number of .conf</span>
        <span class="c"># files in the settings directory using whatever naming convention</span>
        <span class="c"># you want.</span>
        <span class="n">settings_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span>
        <span class="n">server_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
        <span class="c"># Using 20authentication.conf for authentication settings</span>
        <span class="n">auth_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;20authentication.conf&#39;</span><span class="p">)</span>
        <span class="n">terminal_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;50terminal.conf&#39;</span><span class="p">)</span>
        <span class="n">api_keys_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;20api_keys.conf&#39;</span><span class="p">)</span>
        <span class="c"># NOTE: Using a separate file for authentication stuff for no other</span>
        <span class="c">#       reason than it seems like a good idea.  Don&#39;t want one</span>
        <span class="c">#       gigantic config file for everything (by default, anyway).</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Old server.conf file found.  Converting to the new format as &quot;</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, and </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">server_conf_path</span><span class="p">,</span> <span class="n">auth_conf_path</span><span class="p">,</span> <span class="n">terminal_conf_path</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">terminal_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;command&#39;</span><span class="p">:</span>
                    <span class="c"># Fix the path to ssh_connect.py if present</span>
                    <span class="k">if</span> <span class="s">&#39;ssh_connect.py&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s">&#39;/plugins/&#39;</span><span class="p">,</span> <span class="s">&#39;/applications/terminal/plugins/&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;session_logs_max_age&#39;</span><span class="p">:</span>
                    <span class="c"># This is now user_logs_max_age.  Put it in &#39;gateone&#39;</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;user_logs_max_age&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
                <span class="n">terminal_settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">authentication_options</span><span class="p">:</span>
                <span class="n">auth_settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;origins&#39;</span><span class="p">:</span>
                <span class="c"># Convert to the new format (a list with no http://)</span>
                <span class="n">origins</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
                <span class="n">converted_origins</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">origins</span><span class="p">:</span>
                    <span class="c"># The new format doesn&#39;t bother with http:// or https://</span>
                    <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                        <span class="n">converted_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;://&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">origin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">converted_origins</span><span class="p">:</span>
                        <span class="n">converted_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">converted_origins</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;api_keys&#39;</span><span class="p">:</span>
                <span class="c"># Move these to the new location/format (20api_keys.conf)</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                    <span class="n">api_key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">bytes</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
                        <span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
                    <span class="n">api_keys</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">][</span><span class="s">&#39;api_keys&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">api_key</span><span class="p">:</span> <span class="n">secret</span><span class="p">})</span>
                <span class="c"># API keys can be written right away</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conf</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s">u&quot;// This file contains the key and secret pairs &quot;</span>
                        <span class="s">u&quot;used by Gate One&#39;s API authentication method.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">api_keys</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
        <span class="n">new_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">server_conf_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">server_conf_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">u&quot;// This is Gate One&#39;s main settings file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_settings</span><span class="p">)</span>
        <span class="n">new_auth_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span>
            <span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">auth_settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auth_conf_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">auth_conf_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">u&quot;// This is Gate One&#39;s authentication settings file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_auth_settings</span><span class="p">)</span>
        <span class="c"># Terminal uses a slightly different template; it converts &#39;command&#39;</span>
        <span class="c"># to the new &#39;commands&#39; format.</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;50terminal.conf&#39;</span><span class="p">)</span>
        <span class="n">new_term_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span>
            <span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">terminal_settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">terminal_conf_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">terminal_conf_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">u&quot;// This is Gate One&#39;s Terminal application settings &quot;</span>
                    <span class="s">u&quot;file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_term_settings</span><span class="p">)</span>
    <span class="c"># Rename the old server.conf so this logic doesn&#39;t happen again</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.old&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="apply_cli_overrides"><a class="viewcode-back" href="../Developer/gateone.html#gateone.apply_cli_overrides">[docs]</a><span class="k">def</span> <span class="nf">apply_cli_overrides</span><span class="p">(</span><span class="n">go_settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates *go_settings* in-place with values given on the command line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Figure out which options are being overridden on the command line</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">non_options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c"># These are things that don&#39;t really belong in settings</span>
        <span class="s">&#39;new_api_key&#39;</span><span class="p">,</span> <span class="s">&#39;help&#39;</span><span class="p">,</span> <span class="s">&#39;kill&#39;</span><span class="p">,</span> <span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;combine_js&#39;</span><span class="p">,</span> <span class="s">&#39;combine_css&#39;</span><span class="p">,</span>
        <span class="s">&#39;combine_css_container&#39;</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">non_options</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">go_settings</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
    <span class="c"># Update Tornado&#39;s options from our settings.</span>
    <span class="c"># NOTE: For options given on the command line this step should be redundant.</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">non_options</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span> <span class="o">==</span> <span class="nb">bytes</span><span class="p">:</span> <span class="c"># Python 2</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                    <span class="c"># For whatever reason Tornado doesn&#39;t like unicode values</span>
                    <span class="c"># for its own settings unless you&#39;re using Python 3...</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;origins&#39;</span><span class="p">,</span> <span class="s">&#39;api_keys&#39;</span><span class="p">]:</span>
                <span class="c"># These two settings are special and taken care of further down.</span>
                <span class="k">continue</span>
            <span class="n">options</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_</span>
    <span class="k">global</span> <span class="n">PLUGINS</span>
    <span class="k">global</span> <span class="n">APPLICATIONS</span>
    <span class="k">global</span> <span class="n">logger</span>
    <span class="k">global</span> <span class="n">auth_log</span>
    <span class="k">global</span> <span class="n">msg_log</span>
    <span class="n">define_options</span><span class="p">()</span>
    <span class="c"># Before we do anything else we need the get the settings_dir argument (if</span>
    <span class="c"># given) so we can make sure we&#39;re handling things accordingly.</span>
    <span class="n">settings_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;--settings_dir&#39;</span><span class="p">):</span>
            <span class="n">settings_dir</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">):</span>
        <span class="c"># Try to create it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
               <span class="s">&quot;Could not find/create settings directory at </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">settings_dir</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">all_settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SettingsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c"># The error will be logged to stdout inside all_settings</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">enabled_plugins</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">enabled_applications</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">go_settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s">&#39;gateone&#39;</span> <span class="ow">in</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">]:</span>
        <span class="c"># The check above will fail in first-run situations</span>
        <span class="n">enabled_plugins</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;enabled_plugins&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">enabled_applications</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;enabled_applications&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">go_settings</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span>
    <span class="n">PLUGINS</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">),</span> <span class="n">enabled_plugins</span><span class="p">)</span>
    <span class="n">imported</span> <span class="o">=</span> <span class="n">load_modules</span><span class="p">(</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;py&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">imported</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plugin</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span> <span class="n">plugin</span><span class="o">.</span><span class="n">hooks</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># No hooks--probably just a supporting .py file.</span>
    <span class="n">APPLICATIONS</span> <span class="o">=</span> <span class="n">get_applications</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;applications&#39;</span><span class="p">),</span> <span class="n">enabled_applications</span><span class="p">)</span>
    <span class="c"># NOTE: load_modules() imports all the .py files in applications.  This</span>
    <span class="c"># means that applications can place calls to tornado.options.define()</span>
    <span class="c"># anywhere in their .py files and they should automatically be usable by the</span>
    <span class="c"># user at this point in the startup process.</span>
    <span class="n">app_modules</span> <span class="o">=</span> <span class="n">load_modules</span><span class="p">(</span><span class="n">APPLICATIONS</span><span class="p">)</span>
    <span class="c"># Having parse_command_line() after loading applications in case an</span>
    <span class="c"># application has additional calls to define().</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">()</span>
    <span class="c"># NOTE: Here&#39;s how settings/command line args works:</span>
    <span class="c">#       * The &#39;options&#39; object gets set from the arguments on the command</span>
    <span class="c">#         line (parse_command_line() above).</span>
    <span class="c">#       * &#39;go_settings&#39; gets set from the stuff in the &#39;settings_dir&#39;</span>
    <span class="c">#       * Once both are parsed (on their own) we overwrite &#39;go_settings&#39;</span>
    <span class="c">#         with what was given on the command line.</span>
    <span class="c">#       * Once &#39;go_settings&#39; has been adjusted we overwrite &#39;options&#39; with</span>
    <span class="c">#         any settings that directly correlate with command line options.</span>
    <span class="c">#         This ensures that the &#39;options&#39; object (which controls Tornado&#39;</span>
    <span class="c">#         settings) gets the stuff from &#39;settings_dir&#39; if not provided on</span>
    <span class="c">#         the command line.</span>
    <span class="c"># TODO: Add a way for applications/plugins to add to this list:</span>
    <span class="n">non_options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c"># These are things that don&#39;t really belong in settings</span>
        <span class="s">&#39;new_api_key&#39;</span><span class="p">,</span> <span class="s">&#39;help&#39;</span><span class="p">,</span> <span class="s">&#39;kill&#39;</span><span class="p">,</span> <span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;combine_js&#39;</span><span class="p">,</span> <span class="s">&#39;combine_css&#39;</span><span class="p">,</span>
        <span class="s">&#39;combine_css_container&#39;</span>
    <span class="p">]</span>
    <span class="c"># Figure out which options are being overridden on the command line</span>
    <span class="n">apply_cli_overrides</span><span class="p">(</span><span class="n">go_settings</span><span class="p">)</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c"># Turn any API keys provided on the command line into a dict</span>
    <span class="n">api_keys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s">&#39;api_keys&#39;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">api_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">api_keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">api_key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">bytes</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
                    <span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
                <span class="n">api_keys</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">api_key</span><span class="p">:</span> <span class="n">secret</span><span class="p">})</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;api_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_keys</span>
    <span class="c"># Setting the log level using go_settings requires an additional step:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
    <span class="n">APPLICATIONS</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Replace it with a list of actual class instances</span>
    <span class="n">web_handlers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># Convert the old server.conf to the new settings file format and save it</span>
    <span class="c"># as a number of distinct .conf files to keep things better organized.</span>
    <span class="c"># NOTE: This logic will go away some day as it only applies when moving from</span>
    <span class="c">#       Gate One 1.1 (or older) to newer versions.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
        <span class="n">convert_old_server_conf</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&#39;gateone&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">]:</span>
        <span class="c"># User has yet to create a 10server.conf (or equivalent)</span>
        <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Will be filled out below</span>
    <span class="c"># If you want any missing config file entries re-generated just delete the</span>
    <span class="c"># cookie_secret line...</span>
    <span class="k">if</span> <span class="s">&#39;cookie_secret&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">go_settings</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">]:</span>
        <span class="c"># Generate a default 10server.conf with a random cookie secret</span>
        <span class="c"># NOTE: This will also generate a new 10server.conf if it is missing.</span>
        <span class="n">generate_server_conf</span><span class="p">()</span>
        <span class="c"># Make sure these values get updated</span>
        <span class="n">all_settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="n">go_settings</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">app_modules</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">SESSIONS</span> <span class="o">=</span> <span class="n">SESSIONS</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">APPLICATIONS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">apps</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;init&#39;</span><span class="p">):</span>
                <span class="n">module</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">all_settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;web_handlers&#39;</span><span class="p">):</span>
                <span class="n">web_handlers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">web_handlers</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># No apps--probably just a supporting .py file.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Imported applications: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">APPLICATIONS</span><span class="p">))))</span>
    <span class="c"># Change the uid/gid strings into integers</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;uid&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pwd</span>
        <span class="c"># Assume it&#39;s a username and grab its uid</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;uid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">pw_uid</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;gid&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">grp</span>
        <span class="c"># Assume it&#39;s a group name and grab its gid</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;gid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">gr_gid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">]):</span> <span class="c"># Make our user_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pwd</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Gate One could not create </span><span class="si">%s</span><span class="s">.  Please ensure that user,&quot;</span>
                <span class="s">&quot; </span><span class="si">%s</span><span class="s"> has permission to create this directory or create it &quot;</span>
                <span class="s">&quot;yourself and make user, </span><span class="si">%s</span><span class="s"> its owner.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]))))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># If we could create it we should be able to adjust its permissions:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_write_permissions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">]):</span>
        <span class="c"># Try correcting this first</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recursive_chown</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Failed to recursively change permissions of user_dir: </span><span class="si">%s</span><span class="s">, &quot;</span>
                <span class="s">&quot;uid: </span><span class="si">%s</span><span class="s">, gid: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]):</span> <span class="c"># Make our session_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Error: Gate One could not create </span><span class="si">%s</span><span class="s">.  Please ensure that user,&quot;</span>
                <span class="s">&quot; </span><span class="si">%s</span><span class="s"> has permission to create this directory or create it &quot;</span>
                <span class="s">&quot;yourself and make user, </span><span class="si">%s</span><span class="s"> its owner.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]))))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_write_permissions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]):</span>
        <span class="c"># Try correcting it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recursive_chown</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;session_dir: </span><span class="si">%s</span><span class="s">, uid: </span><span class="si">%s</span><span class="s">, gid: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># Re-do the locale in case the user supplied something as --locale</span>
    <span class="n">user_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;locale&#39;</span><span class="p">])</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">user_locale</span><span class="o">.</span><span class="n">translate</span> <span class="c"># Also replaces our wrapper so no more .encode()</span>
    <span class="c"># Create the log dir if not already present (NOTE: Assumes we&#39;re root)</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[1;31mERROR:</span><span class="se">\x1b</span><span class="s">[0m Could not create </span><span class="si">%s</span><span class="s"> for &quot;</span>
                <span class="s">&quot;log_file_prefix: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]</span>
            <span class="p">)))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;You probably want to change this option, run Gate &quot;</span>
                  <span class="s">&quot;One as root, or create that directory and give the proper &quot;</span>
                  <span class="s">&quot;user ownership of it.&quot;</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_write_permissions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">):</span>
        <span class="c"># Try to correct it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recursive_chown</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;log_dir: </span><span class="si">%s</span><span class="s">, uid: </span><span class="si">%s</span><span class="s">, gid: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">new_api_key</span><span class="p">:</span>
        <span class="c"># Generate a new API key for an application to use and save it to</span>
        <span class="c"># settings/20api_keys.conf.</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">RUDict</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="c"># Generate a new secret</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="n">api_keys_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;20api_keys.conf&#39;</span><span class="p">)</span>
        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">api_key</span><span class="p">:</span> <span class="n">secret</span><span class="p">}</span>
        <span class="n">api_keys</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">({</span><span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gateone&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;api_keys&quot;</span><span class="p">:</span> <span class="p">{}}}})</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">):</span>
            <span class="n">api_keys</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">)</span>
        <span class="n">api_keys</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gateone&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;api_keys&quot;</span><span class="p">:</span> <span class="n">new_keys</span><span class="p">}}})</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conf</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                <span class="s">u&quot;// This file contains the key and secret pairs used by Gate &quot;</span>
                <span class="s">u&quot;One&#39;s API authentication method.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">api_keys</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">u&quot;A new API key has been generated: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">api_key</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">u&quot;This key can now be used to embed Gate One into other &quot;</span>
                <span class="s">u&quot;applications.&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">combine_js</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">combine_javascript</span>
        <span class="n">combine_javascript</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">combine_js</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">combine_css</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">combine_css</span>
        <span class="n">combine_css</span><span class="p">(</span>
            <span class="n">options</span><span class="o">.</span><span class="n">combine_css</span><span class="p">,</span>
            <span class="n">options</span><span class="o">.</span><span class="n">combine_css_container</span><span class="p">,</span>
            <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c"># Display the version in case someone sends in a log for for support</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Version: </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__version__</span><span class="p">,</span> <span class="n">__commit__</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Tornado version </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tornado_version</span><span class="p">))</span>
    <span class="c"># Set our global session timeout</span>
    <span class="k">global</span> <span class="n">TIMEOUT</span>
    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_timeout&#39;</span><span class="p">])</span>
    <span class="c"># Fix the url_prefix if the user forgot the trailing slash</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
    <span class="c"># Convert the origins into a list if overridden via the command line</span>
    <span class="k">if</span> <span class="s">&#39;origins&#39;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">origins</span><span class="p">:</span>
            <span class="n">origins</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">origins</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
            <span class="n">real_origins</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">origins</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;://&#39;</span> <span class="ow">in</span> <span class="n">origin</span><span class="p">:</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;://&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">origin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">real_origins</span><span class="p">:</span>
                    <span class="n">real_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
            <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;origins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_origins</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s">&quot;Connections to this server will be allowed from the following&quot;</span>
        <span class="s">&quot; origins: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;origins&#39;</span><span class="p">]))</span>
    <span class="c"># Normalize certain settings</span>
    <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;api_timestamp_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;api_timestamp_window&#39;</span><span class="p">])</span>
    <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">none_fix</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">])</span>
    <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;settings_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_dir</span>
    <span class="c"># Check to make sure we have a certificate and keyfile and generate fresh</span>
    <span class="c"># ones if not.</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;keyfile&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;keyfile.pem&quot;</span><span class="p">:</span>
        <span class="c"># If set to the default we&#39;ll assume they want to use the one in the</span>
        <span class="c"># gateone_dir</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;keyfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/keyfile.pem&quot;</span> <span class="o">%</span> <span class="n">GATEONE_DIR</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;certificate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;certificate.pem&quot;</span><span class="p">:</span>
        <span class="c"># Just like the keyfile, assume they want to use the one in the</span>
        <span class="c"># gateone_dir</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;certificate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/certificate.pem&quot;</span> <span class="o">%</span> <span class="n">GATEONE_DIR</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;disable_ssl&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;keyfile&#39;</span><span class="p">]):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No SSL private key found.  One will be generated.&quot;</span><span class="p">))</span>
            <span class="n">gen_self_signed_ssl</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">GATEONE_DIR</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;certificate&#39;</span><span class="p">]):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No SSL certificate found.  One will be generated.&quot;</span><span class="p">))</span>
            <span class="n">gen_self_signed_ssl</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">GATEONE_DIR</span><span class="p">)</span>
    <span class="c"># When logging==&quot;debug&quot; it will display all user&#39;s keystrokes so make sure</span>
    <span class="c"># we warn about this.</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;logging&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;debug&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Logging is set to DEBUG.  Be aware that this will record the &quot;</span>
            <span class="s">&quot;keystrokes of all users.  Don&#39;t be evil!&quot;</span><span class="p">))</span>
    <span class="n">ssl_auth</span> <span class="o">=</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ssl_auth&#39;</span><span class="p">,</span> <span class="s">&#39;none&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ssl_auth</span> <span class="o">==</span> <span class="s">&#39;required&#39;</span><span class="p">:</span>
        <span class="c"># Convert to an integer using the ssl module</span>
        <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
    <span class="k">elif</span> <span class="n">ssl_auth</span> <span class="o">==</span> <span class="s">&#39;optional&#39;</span><span class="p">:</span>
        <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
    <span class="c"># Instantiate our Tornado web server</span>
    <span class="n">ssl_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;certfile&quot;</span><span class="p">:</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;certificate&#39;</span><span class="p">],</span>
        <span class="s">&quot;keyfile&quot;</span><span class="p">:</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;keyfile&#39;</span><span class="p">],</span>
        <span class="s">&quot;cert_reqs&quot;</span><span class="p">:</span> <span class="n">cert_reqs</span>
    <span class="p">}</span>
    <span class="n">ca_certs</span> <span class="o">=</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ca_certs&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ca_certs</span><span class="p">:</span>
        <span class="n">ssl_options</span><span class="p">[</span><span class="s">&#39;ca_certs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca_certs</span>
    <span class="n">disable_ssl</span> <span class="o">=</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;disable_ssl&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">disable_ssl</span><span class="p">:</span>
        <span class="n">proto</span> <span class="o">=</span> <span class="s">&quot;http://&quot;</span>
        <span class="n">ssl_options</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proto</span> <span class="o">=</span> <span class="s">&quot;https://&quot;</span>
    <span class="c"># Fill out our settings with command line args if any are missing</span>
    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">non_options</span><span class="p">:</span>
            <span class="k">continue</span> <span class="c"># These don&#39;t belong</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">go_settings</span><span class="p">:</span>
            <span class="n">go_settings</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">enable_pretty_logging</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="c"># Assign our logging globals</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">auth_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.auth&#39;</span><span class="p">)</span>
    <span class="n">msg_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s">&#39;gateone.message&#39;</span><span class="p">)</span>
    <span class="n">https_server</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span>
        <span class="n">GateOneApp</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">go_settings</span><span class="p">,</span> <span class="n">web_handlers</span><span class="o">=</span><span class="n">web_handlers</span><span class="p">),</span>
        <span class="n">ssl_options</span><span class="o">=</span><span class="n">ssl_options</span><span class="p">)</span>
    <span class="n">https_redirect</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span>
        <span class="p">[(</span><span class="s">r&quot;.*&quot;</span><span class="p">,</span> <span class="n">HTTPSRedirectHandler</span><span class="p">),],</span>
        <span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span>
        <span class="n">url_prefix</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">ErrorHandler</span> <span class="o">=</span> <span class="n">ErrorHandler</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;pam&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;PAM authentication is configured but you are not running Gate&quot;</span>
                <span class="s">&quot; One as root.  If the pam_service you&#39;ve selected (</span><span class="si">%s</span><span class="s">) is &quot;</span>
                <span class="s">&quot;configured to use pam_unix.so for &#39;auth&#39; (i.e. authenticating &quot;</span>
                <span class="s">&quot;against /etc/passwd and /etc/shadow) Gate One will not be able&quot;</span>
                <span class="s">&quot; to authenticate all users.  It will only be able to &quot;</span>
                <span class="s">&quot;authenticate the user that owns the gateone.py process.&quot;</span> <span class="o">%</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pam_service&#39;</span><span class="p">]))</span>
    <span class="k">try</span><span class="p">:</span> <span class="c"># Start your engines!</span>
        <span class="k">if</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;enable_unix_socket&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">https_server</span><span class="o">.</span><span class="n">add_socket</span><span class="p">(</span>
                <span class="n">tornado</span><span class="o">.</span><span class="n">netutil</span><span class="o">.</span><span class="n">bind_unix_socket</span><span class="p">(</span>
                    <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;unix_socket_path&#39;</span><span class="p">]))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Listening on Unix socket &#39;{socketpath}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">socketpath</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;unix_socket_path&#39;</span><span class="p">])))</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">none_fix</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">address</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">addr</span><span class="p">:</span> <span class="c"># Listen on all given addresses</span>
                    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;https_redirect&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;disable_ssl&#39;</span><span class="p">]:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;You have https_redirect *and* disable_ssl enabled.&quot;</span>
                            <span class="s">&quot;  Please pick one or the other.&quot;</span><span class="p">))</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;http://{addr}:80/ will be redirected to...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
                        <span class="p">))</span>
                        <span class="n">https_redirect</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;Listening on {proto}{address}:{port}/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">proto</span><span class="o">=</span><span class="n">proto</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">])</span>
                    <span class="p">))</span>
                    <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">address</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="c"># Listen on all addresses (including IPv6)</span>
            <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;https_redirect&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;disable_ssl&#39;</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;You have https_redirect *and* disable_ssl enabled.&quot;</span>
                        <span class="s">&quot;  Please pick one or the other.&quot;</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;http://*:80/ will be redirected to...&quot;</span><span class="p">))</span>
                <span class="n">https_redirect</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Listening on {proto}*:{port}/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">proto</span><span class="o">=</span><span class="n">proto</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">])))</span>
            <span class="k">try</span><span class="p">:</span> <span class="c"># Listen on all IPv4 and IPv6 addresses</span>
                <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span> <span class="c"># Fall back to all IPv4 addresses</span>
                <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">)</span>
        <span class="c"># NOTE:  To have Gate One *not* listen on a TCP/IP address you may set</span>
        <span class="c">#        address=None</span>
        <span class="n">write_pid</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">read_pid</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Process running with pid &quot;</span> <span class="o">+</span> <span class="n">pid</span><span class="p">))</span>
        <span class="c"># Check to see what group owns /dev/pts and use that for supl_groups</span>
        <span class="c"># First we have to make sure there&#39;s at least one pty present</span>
        <span class="n">tempfd1</span><span class="p">,</span> <span class="n">tempfd2</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
        <span class="c"># Now check the owning group (doesn&#39;t matter which one so we use 0)</span>
        <span class="n">ptm</span> <span class="o">=</span> <span class="s">&#39;/dev/ptm&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;/dev/ptm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;/dev/ptmx&#39;</span>
        <span class="n">tty_gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">ptm</span><span class="p">)</span><span class="o">.</span><span class="n">st_gid</span>
        <span class="c"># Close our temmporary pty/fds so we&#39;re not wasting them</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">tempfd1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">tempfd2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">():</span>
            <span class="n">drop_privileges</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="p">[</span><span class="n">tty_gid</span><span class="p">])</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span> <span class="c"># ctrl-c</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Caught KeyboardInterrupt.  Killing sessions...&quot;</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">remove_pid</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;pid file removed.&quot;</span><span class="p">))</span>
        <span class="c"># TODO: Move this dtach stuff to app_terminal.py</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;terminal&#39;</span><span class="p">][</span><span class="s">&#39;dtach&#39;</span><span class="p">]:</span>
            <span class="c"># If we&#39;re not using dtach play it safe by cleaning up any leftover</span>
            <span class="c"># processes.  When passwords are used with the ssh_conenct.py script</span>
            <span class="c"># it runs os.setsid() on the child process which means it won&#39;t die</span>
            <span class="c"># when Gate One is closed.  This is primarily to handle that</span>
            <span class="c"># specific situation.</span>
            <span class="n">killall</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">])</span>
            <span class="c"># Cleanup the session_dir (it&#39;s supposed to only contain temp stuff)</span>
            <span class="kn">import</span> <span class="nn">shutil</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/ls_logo_1inch_300dpi.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2013, Liftoff Software Corporation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
<script type="text/javascript">
window.onload = function(e) {
    // Make our collapseindex elements actually collapsible
    $('<span class="collapsindextitle">Index</span> <a class="showhide">[show]</a>').insertBefore('.collapseindex');
    $('.showhide').each(function(index, value){
        var showHide = $(this);
        showHide.click(function() {
            if (this.innerHTML == "[hide]") {
                this.innerHTML = "[show]";
            } else {
                this.innerHTML = "[hide]";
            }
            $(this).next('.collapseindex').toggle(1); // This should always be the next .collapseindex element
        });
    });
    $('.collapseindex').each(function(index, value){
        // Start them out hidden
        $(this).hide();
    });
}
</script>

  </body>
</html>