

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29645087-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gateone.core.server &mdash; Gate One 1.2.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/ansi.css" type="text/css" />
  

  
    <link rel="top" title="Gate One 1.2.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Gate One
          

          
          </a>

          
            
            
              <div class="version">
                1.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../About/index.html">About Gate One</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Applications/index.html">Gate One Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developer/index.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ReleaseNotes/index.html">Release Notes / Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Gate One</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>gateone.core.server</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gateone.core.server</h1><div class="highlight"><pre>
<span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1">#       Copyright 2013 Liftoff Software Corporation</span>
<span class="c1">#</span>
<span class="c1"># For license information see LICENSE.txt</span>

<span class="c1"># Meta</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;1.2.0&#39;</span>
<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;AGPLv3&quot;</span> <span class="c1"># ...or proprietary (see LICENSE.txt)</span>
<span class="n">__license_info__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;AGPLv3&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="s2">&quot;gateone&quot;</span><span class="p">,</span>
        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># 0 being unlimited</span>
        <span class="s2">&quot;customer&quot;</span><span class="p">:</span> <span class="s2">&quot;Unsupported&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">__version__</span><span class="p">,</span>
        <span class="s2">&quot;license_format&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>
<span class="n">__commit__</span> <span class="o">=</span> <span class="s2">&quot;20160618135724&quot;</span> <span class="c1"># Gets replaced by git (holds the date/time)</span>

<span class="c1"># NOTE: Docstring includes reStructuredText markup for use with Sphinx.</span>
<span class="n">__doc__</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">.. _gateone.py:</span>

<span class="s1">Gate One</span>
<span class="s1">========</span>
<span class="s1">Gate One is a web-based terminal emulator written in Python using the Tornado</span>
<span class="s1">web framework.  This module runs the primary daemon process and acts as a</span>
<span class="s1">central controller for all running terminals and terminal programs.  It supports</span>
<span class="s1">numerous configuration options and can also be called with the --kill switch</span>
<span class="s1">to kill all running terminal programs (if using dtach--otherwise they die on</span>
<span class="s1">their own when gateone.py is stopped).</span>

<span class="s1">Dependencies</span>
<span class="s1">------------</span>
<span class="s1">Gate One requires Python 2.6+ but runs best with Python 2.7+.  It also depends</span>
<span class="s1">on the following 3rd party Python modules:</span>

<span class="s1"> * `Tornado &lt;http://www.tornadoweb.org/&gt;`_ 3.1+ - A non-blocking web server framework that powers FriendFeed.</span>

<span class="s1">The following modules are optional and can provide Gate One with additional</span>
<span class="s1">functionality:</span>

<span class="s1"> * `pyOpenSSL &lt;https://launchpad.net/pyopenssl&gt;`_ 0.10+ - An OpenSSL module/wrapper for Python.  Only used to generate self-signed SSL keys and certificates.  If pyOpenSSL isn&#39;t available Gate One will fall back to using the &#39;openssl&#39; command to generate self-signed certificates.</span>
<span class="s1"> * `kerberos &lt;http://pypi.python.org/pypi/kerberos&gt;`_ 1.0+ - A high-level Kerberos interface for Python.  Only necessary if you plan to use the Kerberos authentication module.</span>
<span class="s1"> * `python-pam &lt;http://packages.debian.org/lenny/python-pam&gt;`_ 0.4.2+ - A Python module for interacting with PAM (the Pluggable Authentication Module present on nearly every Unix).  Only necessary if you plan to use PAM authentication.</span>
<span class="s1"> * `PIL (Python Imaging Library) &lt;http://www.pythonware.com/products/pil/&gt;`_ 1.1.7+ - A Python module for manipulating images.  **Alternative:** `Pillow &lt;https://github.com/python-imaging/Pillow&gt;`_ 2.0+ - A &quot;friendly fork&quot; of PIL that works with Python 3.</span>
<span class="s1"> * `mutagen &lt;https://code.google.com/p/mutagen/&gt;`_ 1.21+ - A Python module to handle audio metadata.  Makes it so that if you ``cat music_file.ogg`` in a terminal you&#39;ll get useful track/tag information.</span>

<span class="s1">With the exception of python-pam, all required and optional modules can usually be installed via one of these commands:</span>

<span class="s1">    .. ansi-block::</span>

<span class="s1">        </span><span class="se">\x1b</span><span class="s1">[1;34muser</span><span class="se">\x1b</span><span class="s1">[0m@modern-host</span><span class="se">\x1b</span><span class="s1">[1;34m:~ $</span><span class="se">\x1b</span><span class="s1">[0m sudo pip install --upgrade tornado pyopenssl kerberos pillow mutagen</span>

<span class="s1">...or:</span>

<span class="s1">    .. ansi-block::</span>

<span class="s1">        </span><span class="se">\x1b</span><span class="s1">[1;34muser</span><span class="se">\x1b</span><span class="s1">[0m@legacy-host</span><span class="se">\x1b</span><span class="s1">[1;34m:~ $</span><span class="se">\x1b</span><span class="s1">[0m sudo easy_install tornado pyopenssl kerberos pillow mutagen</span>

<span class="s1">.. note:: The use of pip is recommended.  See http://www.pip-installer.org/en/latest/installing.html if you don&#39;t have it.</span>

<span class="s1">The python-pam module is available in most Linux distribution repositories.  Simply executing one of the following should take care of it:</span>

<span class="s1">    .. ansi-block::</span>

<span class="s1">        </span><span class="se">\x1b</span><span class="s1">[1;34muser</span><span class="se">\x1b</span><span class="s1">[0m@debian-or-ubuntu-host</span><span class="se">\x1b</span><span class="s1">[1;34m:~ $</span><span class="se">\x1b</span><span class="s1">[0m sudo apt-get install python-pam</span>

<span class="s1">    .. ansi-block::</span>

<span class="s1">        </span><span class="se">\x1b</span><span class="s1">[1;34muser</span><span class="se">\x1b</span><span class="s1">[0m@redhat-host</span><span class="se">\x1b</span><span class="s1">[1;34m:~ $</span><span class="se">\x1b</span><span class="s1">[0m sudo yum install python-pam</span>

<span class="s1">    .. ansi-block::</span>

<span class="s1">        </span><span class="se">\x1b</span><span class="s1">[1;34muser</span><span class="se">\x1b</span><span class="s1">[0m@gentoo-host</span><span class="se">\x1b</span><span class="s1">[1;34m:~ $</span><span class="se">\x1b</span><span class="s1">[0m sudo emerge python-pam</span>

<span class="s1">    .. ansi-block::</span>

<span class="s1">        </span><span class="se">\x1b</span><span class="s1">[1;34muser</span><span class="se">\x1b</span><span class="s1">[0m@suse-host</span><span class="se">\x1b</span><span class="s1">[1;34m:~ $</span><span class="se">\x1b</span><span class="s1">[0m sudo yast -i python-pam</span>

<span class="s1">Settings</span>
<span class="s1">--------</span>
<span class="s1">Most of Gate One&#39;s options can be controlled by command line switches or via</span>
<span class="s1">.conf files in the settings directory.  If you haven&#39;t configured Gate One</span>
<span class="s1">before a number of .conf files will be automatically generated using defaults</span>
<span class="s1">and/or the command line switches provided the first time you run `gateone.py`.</span>

<span class="s1">Settings in the various `settings/*.conf` files are JSON-formatted:</span>

<span class="s1">.. note::</span>

<span class="s1">    Technically, JSON doesn&#39;t allow comments but Gate One&#39;s .conf files do.</span>

<span class="s1">.. code-block:: javascript</span>

<span class="s1">    { // You can use single-line comments like this</span>
<span class="s1">    /*</span>
<span class="s1">    Or multi-line comments like this.</span>
<span class="s1">    */</span>
<span class="s1">        &quot;*&quot;: { // The * here designates this as &quot;default&quot; values</span>
<span class="s1">            &quot;gateone&quot;: { // Settings in this dict are specific to the &quot;gateone&quot; app</span>
<span class="s1">                &quot;address&quot;: &quot;10.0.0.100&quot;, // A string value</span>
<span class="s1">                &quot;log_file_num_backups&quot;: 10, // An integer value</span>
<span class="s1">                // Here&#39;s an example list:</span>
<span class="s1">                &quot;origins&quot;: [&quot;localhost&quot;, &quot;127.0.0.1&quot;, &quot;10.0.0.100&quot;],</span>
<span class="s1">                &quot;https_redirect&quot;: false, // Booleans are all lower case</span>
<span class="s1">                &quot;log_to_stderr&quot;: null // Same as `None` in Python (also lower case)</span>
<span class="s1">                // NOTE: No comma after last item</span>
<span class="s1">            },</span>
<span class="s1">            &quot;terminal&quot;: { // Example of a different application&#39;s settings</span>
<span class="s1">                &quot;default_command&quot;: &quot;SSH&quot;, // &lt;-- don&#39;t leave traling commas like this!</span>
<span class="s1">                ... // So on and so forth</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>

<span class="s1">.. note::</span>

<span class="s1">    You *must* use double quotes (&quot;&quot;) to define strings.  Single quotes *can* be</span>
<span class="s1">    used inside double quotes, however.  `&quot;example&quot;: &quot;of &#39;single&#39; quotes&quot;`  To</span>
<span class="s1">    escape a double-quote inside a double quote use three slashes:</span>
<span class="s1">    `&quot;</span><span class="se">\\\\\\\\\\\\</span><span class="s1">&quot;foo</span><span class="se">\\\\\\\\\\\\</span><span class="s1">&quot;&quot;`</span>

<span class="s1">.. All those slashes above are so Sphinx won&#39;t mangle it in HTML.</span>

<span class="s1">You can have as many .conf files in your settings directory as you like.  When</span>
<span class="s1">Gate One runs it reads all files in alphanumeric order and combines all settings</span>
<span class="s1">into a single Python dictionary.  Files loaded last will override settings from</span>
<span class="s1">earlier files.  Example:</span>

<span class="s1">.. topic:: 20example.conf</span>

<span class="s1">    .. code-block:: javascript</span>

<span class="s1">        {</span>
<span class="s1">            &quot;*&quot;: {</span>
<span class="s1">                &quot;terminal&quot;: {</span>
<span class="s1">                    &quot;session_logging&quot;: true,</span>
<span class="s1">                    &quot;default_command&quot;: &quot;SSH&quot;</span>
<span class="s1">                }</span>
<span class="s1">            }</span>
<span class="s1">        }</span>

<span class="s1">.. topic:: 99override.conf</span>

<span class="s1">    .. code-block:: javascript</span>

<span class="s1">        {</span>
<span class="s1">            &quot;*&quot;: {</span>
<span class="s1">                &quot;terminal&quot;: {</span>
<span class="s1">                    &quot;default_command&quot;: &quot;my_override&quot;</span>
<span class="s1">                }</span>
<span class="s1">            }</span>
<span class="s1">        }</span>

<span class="s1">If Gate One loaded the above example .conf files the resulting dict would be:</span>

<span class="s1">.. topic:: Merged settings</span>

<span class="s1">    .. code-block:: javascript</span>

<span class="s1">        {</span>
<span class="s1">            &quot;*&quot;: {</span>
<span class="s1">                &quot;terminal&quot;: {</span>
<span class="s1">                    &quot;session_logging&quot;: true,</span>
<span class="s1">                    &quot;default_command&quot;: &quot;my_override&quot;</span>
<span class="s1">                }</span>
<span class="s1">            }</span>
<span class="s1">        }</span>

<span class="s1">.. note::</span>

<span class="s1">    These settings are loaded using the `~utils.RUDict` (Recusive Update Dict)</span>
<span class="s1">    class.</span>

<span class="s1">There are a few important differences between the configuration file and</span>
<span class="s1">command line switches in regards to boolean values (True/False).  A switch such</span>
<span class="s1">as `--debug` is equivalent to ``&quot;debug&quot; = true`` in 10server.conf:</span>

<span class="s1">.. code-block:: javascript</span>

<span class="s1">    &quot;debug&quot; = true // Booleans are all lower case (not in quotes)</span>

<span class="s1">.. tip::</span>

<span class="s1">    Use `--setting=True`, `--setting=False`, or `--setting=None` to avoid</span>
<span class="s1">    confusion.</span>

<span class="s1">.. note::</span>

<span class="s1">    The following values in 10server.conf are case sensitive: `true`, `false`</span>
<span class="s1">    and `null` (and should not be placed in quotes).</span>

<span class="s1">Gate One&#39;s configuration files also provide access control mechanisms.  These</span>
<span class="s1">are controlled by setting the *scope* of the configuration block.  In this</span>
<span class="s1">example all users that match the given IP address will be denied access to</span>
<span class="s1">Gate One::</span>

<span class="s1">    {</span>
<span class="s1">        &quot;user.ip_address=(127.0.0.1|10.1.1.100)&quot;: { // Replaces &quot;*&quot;</span>
<span class="s1">            &quot;gateone&quot;: { // These settings apply to all of Gate One</span>
<span class="s1">                &quot;blacklist&quot;: true,</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>

<span class="s1">You can define scopes however you like using user&#39;s attributes.  For example::</span>

<span class="s1">    {</span>
<span class="s1">        &quot;user.email=.*@company.com&quot;: {</span>
<span class="s1">            &quot;terminal&quot;: {</span>
<span class="s1">                &quot;commands&quot;: {&quot;extra&quot;: &quot;/some/extra/command.sh&quot;}</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>

<span class="s1">The above example would make it so that all users with an email address ending</span>
<span class="s1">in &#39;@company.com&#39; will get access to the &quot;extra&quot; command when using the</span>
<span class="s1">&quot;terminal&quot; application.</span>

<span class="s1">.. note::</span>

<span class="s1">    Different authentication types provide different user attributes.  For</span>
<span class="s1">    example, if you have &quot;auth&quot; set to &quot;google&quot; authenticated users will have a</span>
<span class="s1">    &#39;gender&#39; attribute.  So for example--if you wanted to be evil--you could</span>
<span class="s1">    provide different settings for men and women (e.g. &quot;user.gender=male&quot;).</span>

<span class="s1">.. tip::</span>

<span class="s1">    When using API authentication you can pass whatever extra user attributes</span>
<span class="s1">    you want via the &#39;auth&#39; object.  These attributes will be automatically</span>
<span class="s1">    assigned to the user and can be used with the policy mechanism to control</span>
<span class="s1">    access and settings.</span>

<span class="s1">Running gateone.py with the `--help` switch will print the usage information as</span>
<span class="s1">well as descriptions of what each configurable option does:</span>

<span class="s1">.. command-output:: gateone --help</span>

<span class="s1">File Paths</span>
<span class="s1">----------</span>
<span class="s1">Gate One stores its files, temporary session information, and persistent user</span>
<span class="s1">data in the following locations (Note: Many of these are configurable):</span>

<span class="s1">==================  ==========================================================================================</span>
<span class="s1">File/Directory      Description</span>
<span class="s1">==================  ==========================================================================================</span>
<span class="s1">authpam.py          Contains the PAM authentication Mixin used by auth.py.</span>
<span class="s1">auth.py             Authentication classes.</span>
<span class="s1">babel_gateone.cfg   Pybabel configuration for generating localized translations of Gate One&#39;s strings.</span>
<span class="s1">certificate.pem     The default certificate Gate One will use in SSL communications.</span>
<span class="s1">docs/               Gate One&#39;s documentation.</span>
<span class="s1">gateone.py          Gate One&#39;s primary executable/script. Also, the file containing this documentation.</span>
<span class="s1">gopam.py            PAM (Authentication) Python module (used by authpam.py).</span>
<span class="s1">i18n/               Gate One&#39;s internationalization (i18n) support and locale/translation files.</span>
<span class="s1">keyfile.pem         The default private key used with SSL communications.</span>
<span class="s1">logviewer.py        A utility to view Gate One session logs.</span>
<span class="s1">plugins/            (Global) Plugins go here in the form of ./plugins/&lt;plugin name&gt;/&lt;plugin files|directories&gt;</span>
<span class="s1">settings/           All Gate One settings files live here (.conf files).</span>
<span class="s1">sso.py              A Kerberos Single Sign-on module for Tornado (used by auth.py)</span>
<span class="s1">static/             Non-dynamic files that get served to clients (e.g. gateone.js, gateone.css, etc).</span>
<span class="s1">templates/          Tornado template files such as index.html.</span>
<span class="s1">tests/              Various scripts and tools to test Gate One&#39;s functionality.</span>
<span class="s1">utils.py            Various supporting functions.</span>
<span class="s1">users/              Persistent user data in the form of ./users/&lt;username&gt;/&lt;user-specific files&gt;</span>
<span class="s1">users/&lt;user&gt;/logs   This is where session logs get stored if session_logging is set.</span>
<span class="s1">/tmp/gateone        Temporary session data in the form of /tmp/gateone/&lt;session ID&gt;/&lt;files&gt;</span>
<span class="s1">/tmp/gateone_cache  Used to store cached files such as minified JavaScript and CSS.</span>
<span class="s1">==================  ==========================================================================================</span>

<span class="s1">Running</span>
<span class="s1">-------</span>
<span class="s1">Executing Gate One is as simple as:</span>

<span class="s1">.. ansi-block::</span>

<span class="s1">    </span><span class="se">\x1b</span><span class="s1">[1;31mroot</span><span class="se">\x1b</span><span class="s1">[0m@host</span><span class="se">\x1b</span><span class="s1">[1;34m:~ $</span><span class="se">\x1b</span><span class="s1">[0m gateone</span>

<span class="s1">.. note::</span>

<span class="s1">    By default Gate One will run on port 443 which requires root on most</span>
<span class="s1">    systems.  Use `--port=(something higher than 1024)` for non-root users.</span>

<span class="s1">Applications and Plugins</span>
<span class="s1">------------------------</span>
<span class="s1">Gate One supports both *applications* and *plugins*.  The difference is mostly</span>
<span class="s1">architectural.  Applications go in the `gateone/applications` directory while</span>
<span class="s1">(global) plugins reside in `gateone/plugins`.  The scope of application code</span>
<span class="s1">applies only to the application wheras global Gate One plugin code will apply</span>
<span class="s1">to Gate One itself and all applications.</span>

<span class="s1">.. note:: Applications may have plugins of their own (e.g. terminal/plugins).</span>

<span class="s1">Gate One applications and plugins can be written using any combination of the</span>
<span class="s1">following:</span>

<span class="s1"> * Python</span>
<span class="s1"> * JavaScript</span>
<span class="s1"> * CSS</span>

<span class="s1">Applications and Python plugins can integrate with Gate One in a number ways:</span>

<span class="s1"> * Adding or overriding request handlers to provide custom URLs (with a given regex).</span>
<span class="s1"> * Adding or overriding methods in `GOApplication` to handle asynchronous WebSocket &quot;actions&quot;.</span>
<span class="s1"> * Adding or overriding events via the :meth:`on`, :meth:`off`, :meth:`once`, and :meth:`trigger` functions.</span>
<span class="s1"> * Delivering custom content to clients (e.g. JavaScript and CSS templates).</span>

<span class="s1">JavaScript and CSS plugins will be delivered over the WebSocket and cached at</span>
<span class="s1">the client by way of a novel synchronization mechanism.  Once JavaScript and CSS</span>
<span class="s1">assets have been delivered they will only ever have to be re-delivered to</span>
<span class="s1">clients if they have been modified (on the server).  This mechanism is extremely</span>
<span class="s1">bandwidth efficient and should allow clients to load Gate One content much more</span>
<span class="s1">quickly than traditional HTTP GET requests.</span>

<span class="s1">.. tip::</span>

<span class="s1">    If you install the `cssmin` and/or `slimit` Python modules all JavaScript</span>
<span class="s1">    and CSS assets will be automatically minified before being delivered to</span>
<span class="s1">    clients.</span>

<span class="s1">Class Docstrings</span>
<span class="s1">================</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="c1"># Standard library modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">pty</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c1"># Python 3.X</span>
    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">urlparse</span>

<span class="c1"># This is used as a way to ensure users get a friendly message about missing</span>
<span class="c1"># dependencies:</span>
<span class="n">MISSING_DEPS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">tornado_version</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Placeholder in case Tornado import fails below</span>

<span class="c1"># 3rd party modules</span>
<span class="c1"># Technically setuptools isn&#39;t part of Python&#39;s stdlib:</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_filename</span><span class="p">,</span> <span class="n">resource_string</span><span class="p">,</span> <span class="n">resource_exists</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_listdir</span><span class="p">,</span> <span class="n">iter_entry_points</span>
<span class="c1"># Tornado modules (yeah, we use all this stuff)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tornado.httpserver</span>
    <span class="kn">import</span> <span class="nn">tornado.ioloop</span>
    <span class="kn">import</span> <span class="nn">tornado.options</span>
    <span class="kn">import</span> <span class="nn">tornado.web</span>
    <span class="kn">import</span> <span class="nn">tornado.log</span>
    <span class="kn">import</span> <span class="nn">tornado.auth</span>
    <span class="kn">import</span> <span class="nn">tornado.template</span>
    <span class="kn">import</span> <span class="nn">tornado.netutil</span>
    <span class="kn">from</span> <span class="nn">tornado.websocket</span> <span class="kn">import</span> <span class="n">WebSocketHandler</span><span class="p">,</span> <span class="n">WebSocketClosedError</span>
    <span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="kn">import</span> <span class="n">json_decode</span>
    <span class="kn">from</span> <span class="nn">tornado.options</span> <span class="kn">import</span> <span class="n">options</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">locale</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">tornado_version</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">version_info</span> <span class="k">as</span> <span class="n">tornado_version_info</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
    <span class="n">MISSING_DEPS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;tornado &gt;= 4.0&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="s1">&#39;tornado &gt;= 4.0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MISSING_DEPS</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">tornado_version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">MISSING_DEPS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;tornado &gt;= 4.0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tornado_version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">tornado_version_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">MISSING_DEPS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;tornado &gt;= 4.0&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">MISSING_DEPS</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[31;1mERROR:</span><span class="se">\x1b</span><span class="s2">[0m: This host is missing dependencies:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">MISSING_DEPS</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dep</span><span class="p">)</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">MISSING_DEPS</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[1m  sudo pip install --upgrade </span><span class="si">%s</span><span class="se">\x1b</span><span class="s2">[0m.&quot;</span> <span class="o">%</span>
        <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MISSING_DEPS</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># We want this turned on right away</span>
<span class="n">tornado</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">enable_pretty_logging</span><span class="p">()</span>

<span class="c1"># Our own modules</span>
<span class="kn">from</span> <span class="nn">gateone</span> <span class="kn">import</span> <span class="n">SESSIONS</span><span class="p">,</span> <span class="n">PERSIST</span>
<span class="kn">from</span> <span class="nn">gateone.auth.authentication</span> <span class="kn">import</span> <span class="n">NullAuthHandler</span><span class="p">,</span> <span class="n">KerberosAuthHandler</span>
<span class="kn">from</span> <span class="nn">gateone.auth.authentication</span> <span class="kn">import</span> <span class="n">GoogleAuthHandler</span><span class="p">,</span> <span class="n">APIAuthHandler</span>
<span class="kn">from</span> <span class="nn">gateone.auth.authentication</span> <span class="kn">import</span> <span class="n">CASAuthHandler</span><span class="p">,</span> <span class="n">PAMAuthHandler</span>
<span class="kn">from</span> <span class="nn">gateone.auth.authentication</span> <span class="kn">import</span> <span class="n">SSLAuthHandler</span>
<span class="kn">from</span> <span class="nn">gateone.auth.authorization</span> <span class="kn">import</span> <span class="n">require</span><span class="p">,</span> <span class="n">authenticated</span><span class="p">,</span> <span class="n">policies</span>
<span class="kn">from</span> <span class="nn">gateone.auth.authorization</span> <span class="kn">import</span> <span class="n">applicable_policies</span>
<span class="kn">from</span> <span class="nn">gateone.asynchronous</span> <span class="kn">import</span> <span class="n">MultiprocessRunner</span><span class="p">,</span> <span class="n">ThreadedRunner</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">generate_session_id</span><span class="p">,</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">touch</span><span class="p">,</span> <span class="n">noop</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">gen_self_signed_ssl</span><span class="p">,</span> <span class="n">entry_point_files</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">merge_handlers</span><span class="p">,</span> <span class="n">none_fix</span><span class="p">,</span> <span class="n">convert_to_timedelta</span><span class="p">,</span> <span class="n">short_hash</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">json_encode</span><span class="p">,</span> <span class="n">recursive_chown</span><span class="p">,</span> <span class="n">ChownError</span><span class="p">,</span> <span class="n">get_or_cache</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">write_pid</span><span class="p">,</span> <span class="n">read_pid</span><span class="p">,</span> <span class="n">remove_pid</span><span class="p">,</span> <span class="n">drop_privileges</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">check_write_permissions</span><span class="p">,</span> <span class="n">valid_hostname</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">total_seconds</span><span class="p">,</span> <span class="n">MEMO</span><span class="p">,</span> <span class="n">bind</span>
<span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="n">apply_cli_overrides</span><span class="p">,</span> <span class="n">define_options</span><span class="p">,</span> <span class="n">SettingsError</span>
<span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="n">get_settings</span>
<span class="kn">from</span> <span class="nn">onoff</span> <span class="kn">import</span> <span class="n">OnOffMixin</span>

<span class="c1"># Setup our base loggers (these get overwritten in main())</span>
<span class="kn">from</span> <span class="nn">gateone.core.log</span> <span class="kn">import</span> <span class="n">go_logger</span><span class="p">,</span> <span class="n">LOGS</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="n">auth_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.auth&#39;</span><span class="p">)</span>
<span class="n">msg_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.message&#39;</span><span class="p">)</span>
<span class="n">client_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.client&#39;</span><span class="p">)</span>

<span class="c1"># Setup the locale functions before anything else</span>
<span class="n">locale</span><span class="o">.</span><span class="n">set_default_locale</span><span class="p">(</span><span class="s1">&#39;en_US&#39;</span><span class="p">)</span>
<span class="n">server_locale</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Replaced with the actual server locale object in __main__</span>
<div class="viewcode-block" id="_"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server._">[docs]</a><span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps server_locale.translate so we don&#39;t get errors if loading a locale</span>
<span class="sd">    fails (or we output a message before it is initialized).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">server_locale</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">server_locale</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span></div>


<span class="c1"># Globals</span>
<span class="n">CMD</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Will be overwritten by options.command</span>
<span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># Gets overridden by options.session_timeout</span>
<span class="c1"># SESSION_WATCHER be replaced with a tornado.ioloop.PeriodicCallback that</span>
<span class="c1"># watches for sessions that have timed out and takes care of cleaning them up.</span>
<span class="n">SESSION_WATCHER</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">CLEANER</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Log and leftover session data cleaner PeriodicCallback</span>
<span class="n">FILE_CACHE</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">APPLICATIONS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">PLUGINS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">PLUGIN_HOOKS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Gives plugins the ability to hook into various things.</span>

<span class="c1"># Secondary locale setup</span>
<span class="n">locale_dir</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/i18n&#39;</span><span class="p">)</span>
<span class="n">locale</span><span class="o">.</span><span class="n">load_gettext_translations</span><span class="p">(</span><span class="n">locale_dir</span><span class="p">,</span> <span class="s1">&#39;gateone&#39;</span><span class="p">)</span>
<span class="c1"># NOTE: The locale gets set in __main__</span>

<div class="viewcode-block" id="cleanup_user_logs"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.cleanup_user_logs">[docs]</a><span class="k">def</span> <span class="nf">cleanup_user_logs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans up all user logs (everything in the user&#39;s &#39;logs&#39; directory and</span>
<span class="sd">    subdirectories that ends in &#39;log&#39;) older than the `user_logs_max_age`</span>
<span class="sd">    setting.  The log directory is assumed to be:</span>

<span class="sd">        *user_dir*/&lt;user&gt;/logs</span>

<span class="sd">    ...where *user_dir* is whatever Gate One happens to have configured for</span>
<span class="sd">    that particular setting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cleanup_user_logs()&quot;</span><span class="p">)</span>
    <span class="n">disabled</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># If the user sets user_logs_max_age to &quot;0&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
    <span class="n">user_dir</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">][</span><span class="s1">&#39;user_dir&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;user_dir&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="c1"># NOTE: options is global</span>
        <span class="n">user_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">user_dir</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;30d&quot;</span>
    <span class="n">max_age_str</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_logs_max_age&#39;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;user_logs_max_age&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
        <span class="n">max_age_str</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">user_logs_max_age</span>
    <span class="n">max_age</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">max_age_str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">descend</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Descends *path* removing logs it finds older than `max_age` and calls</span>
<span class="sd">        :func:`descend` on any directories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">log_path</span><span class="p">):</span>
                <span class="n">descend</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">log_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="c1"># Convert to a datetime object for easier comparison</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">mtime</span> <span class="o">&gt;</span> <span class="n">max_age</span><span class="p">:</span>
                <span class="c1"># The log is older than max_age, remove it</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Removing log due to age (&gt;</span><span class="si">%s</span><span class="s2"> old): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">max_age_str</span><span class="p">,</span> <span class="n">log_path</span><span class="p">)))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_age</span> <span class="o">!=</span> <span class="n">disabled</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">user_dir</span><span class="p">):</span>
            <span class="n">logs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logs_path</span><span class="p">):</span>
                <span class="c1"># Nothing to do</span>
                <span class="k">continue</span>
            <span class="n">descend</span><span class="p">(</span><span class="n">logs_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="cleanup_old_sessions"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.cleanup_old_sessions">[docs]</a><span class="k">def</span> <span class="nf">cleanup_old_sessions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans up old session directories inside the `session_dir`.  Any directories</span>
<span class="sd">    found that are older than the `auth_timeout` (global gateone setting) will</span>
<span class="sd">    be removed.  The modification time is what will be checked.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cleanup_old_sessions()&quot;</span><span class="p">)</span>
    <span class="n">disabled</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># If the user sets auth_timeout to &quot;0&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
    <span class="n">expiration_str</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth_timeout&#39;</span><span class="p">,</span> <span class="s2">&quot;14d&quot;</span><span class="p">)</span>
    <span class="n">expiration</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">expiration_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expiration</span> <span class="o">!=</span> <span class="n">disabled</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">):</span>
            <span class="c1"># If it&#39;s in the SESSIONS dict it&#39;s still valid for sure</span>
            <span class="k">if</span> <span class="n">session</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">45</span><span class="p">:</span>
                    <span class="c1"># Sessions are always 45 characters long.  This check allows</span>
                    <span class="c1"># us to skip the &#39;broadcast&#39; file which also lives in the</span>
                    <span class="c1"># session_dir.  Why not just check for &#39;broacast&#39;?  Just in</span>
                    <span class="c1"># case we put something else there in the future.</span>
                    <span class="k">continue</span>
                <span class="n">session_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>
                <span class="c1"># Convert to a datetime object for easier comparison</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">mtime</span> <span class="o">&gt;</span> <span class="n">expiration</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">shutil</span>
                    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">kill_session_processes</span>
                    <span class="c1"># The log is older than expiration, remove it and kill any</span>
                    <span class="c1"># processes that may be remaining.</span>
                    <span class="n">kill_session_processes</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Removing old session files due to age (&gt;</span><span class="si">%s</span><span class="s2"> old): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">expiration_str</span><span class="p">,</span> <span class="n">session_path</span><span class="p">)))</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="clean_up"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.clean_up">[docs]</a><span class="k">def</span> <span class="nf">clean_up</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regularly called via the `CLEANER` `~torando.ioloop.PeriodicCallback`, calls</span>
<span class="sd">    `cleanup_user_logs` and `cleanup_old_sessions`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        How often this function gets called can be controlled by adding a</span>
<span class="sd">        `cleanup_interval` setting to 10server.conf (&#39;gateone&#39; section).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cleanup_user_logs</span><span class="p">()</span>
    <span class="n">cleanup_old_sessions</span><span class="p">()</span></div>

<div class="viewcode-block" id="policy_send_user_message"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.policy_send_user_message">[docs]</a><span class="k">def</span> <span class="nf">policy_send_user_message</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`gateone_policies`, returns True if the user is</span>
<span class="sd">    authorized to send messages to other users and if applicable, all users</span>
<span class="sd">    (broadcasts).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You do not have permission to send messages to </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">upn</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">f_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
        <span class="c1"># send_user_message got bad *settings*.  Deny</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c1"># TODO: Add a mechanism that allows users to mute other users here.</span>
    <span class="k">if</span> <span class="n">upn</span> <span class="o">==</span> <span class="s1">&#39;AUTHENTICATED&#39;</span><span class="p">:</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error_msg</span> <span class="o">%</span> <span class="s2">&quot;all users at once&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error_msg</span> <span class="o">%</span> <span class="n">upn</span>
    <span class="k">return</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;send_user_messages&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="policy_broadcast"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.policy_broadcast">[docs]</a><span class="k">def</span> <span class="nf">policy_broadcast</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`gateone_policies`, returns True if the user is</span>
<span class="sd">    authorized to broadcast messages using the</span>
<span class="sd">    :meth:`ApplicationWebSocket.broadcast` method.  It makes this determination</span>
<span class="sd">    by checking the `[&#39;gateone&#39;][&#39;send_broadcasts&#39;]` policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You do not have permission to broadcast messages.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;send_broadcasts&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="c1"># Default deny</span></div>

<div class="viewcode-block" id="policy_list_users"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.policy_list_users">[docs]</a><span class="k">def</span> <span class="nf">policy_list_users</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`gateone_policies`, returns True if the user is</span>
<span class="sd">    authorized to retrieve a list of the users currently connected to the Gate</span>
<span class="sd">    One server via the :meth:`ApplicationWebSocket.list_server_users` method.</span>
<span class="sd">    It makes this determination by checking the `[&#39;gateone&#39;][&#39;list_users&#39;]`</span>
<span class="sd">    policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You do not have permission to list connected users.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;list_users&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="gateone_policies"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.gateone_policies">[docs]</a><span class="k">def</span> <span class="nf">gateone_policies</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function gets registered under &#39;gateone&#39; in the</span>
<span class="sd">    :attr:`ApplicationWebSocket.security` dict and is called by the</span>
<span class="sd">    :func:`require` decorator by way of the :class:`policies` sub-function. It</span>
<span class="sd">    returns True or False depending on what is defined in the settings dir and</span>
<span class="sd">    what function is being called.</span>

<span class="sd">    This function will keep track of and place limits on the following:</span>

<span class="sd">        * Who can send messages to other users (including broadcasts).</span>
<span class="sd">        * Who can retrieve a list of connected users.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">instance</span> <span class="c1"># ApplicationWebSocket instance</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">function</span> <span class="c1"># Wrapped function</span>
    <span class="c1">#f_args = cls.f_args     # Wrapped function&#39;s arguments</span>
    <span class="c1">#f_kwargs = cls.f_kwargs # Wrapped function&#39;s keyword arguments</span>
    <span class="n">policy_functions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;send_user_message&#39;</span><span class="p">:</span> <span class="n">policy_send_user_message</span><span class="p">,</span>
        <span class="s1">&#39;broadcast&#39;</span><span class="p">:</span> <span class="n">policy_broadcast</span><span class="p">,</span>
        <span class="s1">&#39;list_server_users&#39;</span><span class="p">:</span> <span class="n">policy_list_users</span>
    <span class="p">}</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">current_user</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">policies</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span> <span class="c1"># Empty RUDict</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="c1"># A world without limits!</span>
    <span class="k">if</span> <span class="n">function</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">in</span> <span class="n">policy_functions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">policy_functions</span><span class="p">[</span><span class="n">function</span><span class="o">.</span><span class="n">__name__</span><span class="p">](</span><span class="n">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span> <span class="c1"># Default to permissive if we made it this far</span></div>

<span class="nd">@atexit.register</span> <span class="c1"># I love this feature!</span>
<div class="viewcode-block" id="kill_all_sessions"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.kill_all_sessions">[docs]</a><span class="k">def</span> <span class="nf">kill_all_sessions</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls all &#39;kill_session_callbacks&#39; attached to all `SESSIONS`.</span>

<span class="sd">    If *timeout* is ``True``, emulate a session timeout event in order to</span>
<span class="sd">    *really* kill any user sessions (to ensure things like dtach processes get</span>
<span class="sd">    killed too).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Killing all sessions...&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;timeout_callbacks&quot;</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                        <span class="n">callback</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;kill_session_callbacks&quot;</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;kill_session_callbacks&quot;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;kill_session_callbacks&quot;</span><span class="p">]:</span>
                        <span class="n">callback</span><span class="p">(</span><span class="n">session</span><span class="p">)</span></div>

<div class="viewcode-block" id="timeout_sessions"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.timeout_sessions">[docs]</a><span class="k">def</span> <span class="nf">timeout_sessions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loops over the SESSIONS dict killing any sessions that haven&#39;t been used</span>
<span class="sd">    for the length of time specified in *TIMEOUT* (global).  The value of</span>
<span class="sd">    *TIMEOUT* can be set in 10server.conf or specified on the command line via</span>
<span class="sd">    the *session_timeout* value.</span>

<span class="sd">    Applications and plugins can register functions to be called when a session</span>
<span class="sd">    times out by attaching them to the user&#39;s session inside the `SESSIONS`</span>
<span class="sd">    dict under &#39;timeout_callbacks&#39;.  The best place to do this is inside of the</span>
<span class="sd">    application&#39;s `authenticate()` function or by attaching them to the</span>
<span class="sd">    `go:authenticate` event.  Examples::</span>

<span class="sd">        # Imagine this is inside an application&#39;s authenticate() method:</span>
<span class="sd">        sess = SESSIONS[self.ws.session]</span>
<span class="sd">        # Pretend timeout_session() is a function we wrote to kill stuff</span>
<span class="sd">        if timeout_session not in sess[&quot;timeout_session&quot;]:</span>
<span class="sd">            sess[&quot;timeout_session&quot;].append(timeout_session)</span>

<span class="sd">    .. note::</span>

<span class="sd">        This function is meant to be called via Tornado&#39;s</span>
<span class="sd">        :meth:`~tornado.ioloop.PeriodicCallback`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">disabled</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># If the user sets session_timeout to &quot;0&quot;</span>
    <span class="c1"># Commented because it is a bit noisy.  Uncomment to debug this mechanism.</span>
    <span class="c1">#if TIMEOUT != disabled:</span>
        <span class="c1">#logging.debug(&quot;timeout_sessions() TIMEOUT: %s&quot; % TIMEOUT)</span>
    <span class="c1">#else :</span>
        <span class="c1">#logging.debug(&quot;timeout_sessions() TIMEOUT: disabled&quot;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SESSIONS</span><span class="p">:</span> <span class="c1"># Last client has timed out</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;All user sessions have terminated.&quot;</span><span class="p">))</span>
            <span class="k">global</span> <span class="n">SESSION_WATCHER</span>
            <span class="k">if</span> <span class="n">SESSION_WATCHER</span><span class="p">:</span>
                <span class="n">SESSION_WATCHER</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span> <span class="c1"># Stop ourselves</span>
                <span class="n">SESSION_WATCHER</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># So authenticate() will know to start it</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="s2">&quot;last_seen&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
                <span class="c1"># Session is in the process of being created.  We&#39;ll check it</span>
                <span class="c1"># the next time timeout_sessions() is called.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
                <span class="c1"># Connected sessions do not need to be checked for timeouts</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">TIMEOUT</span> <span class="o">==</span> <span class="n">disabled</span> <span class="ow">or</span> \
                <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">TIMEOUT</span><span class="p">:</span>
                <span class="c1"># Kill the session</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;{session} timeout.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)))</span>
                <span class="k">if</span> <span class="s2">&quot;timeout_callbacks&quot;</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                            <span class="n">callback</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Exception encountered in timeout_sessions(): {exception}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="p">))</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span></div>

<div class="viewcode-block" id="broadcast_message"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.broadcast_message">[docs]</a><span class="k">def</span> <span class="nf">broadcast_message</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Broadcasts a given *message* to all users in Gate One.  If no message is</span>
<span class="sd">    given `sys.argv` will be parsed and everything after the word &#39;broadcast&#39;</span>
<span class="sd">    will be broadcast.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;--help&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Usage: gateone broadcast &#39;Your message here.&#39;&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">prefs</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
    <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="s1">&#39;broadcast&#39;</span><span class="p">)</span>
    <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;broadcast_file&#39;</span><span class="p">,</span> <span class="n">broadcast_file</span><span class="p">)</span> <span class="c1"># If set</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Broadcasting </span><span class="si">%s</span><span class="s2"> to all users&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="n">b</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<span class="c1"># Classes</span>
<div class="viewcode-block" id="StaticHandler"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.StaticHandler">[docs]</a><span class="k">class</span> <span class="nc">StaticHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An override of :class:`tornado.web.StaticFileHandler` to ensure that the</span>
<span class="sd">    Access-Control-Allow-Origin header gets set correctly.  This is necessary in</span>
<span class="sd">    order to support embedding Gate One into other web-based applications.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Gate One performs its own origin checking so header-based access</span>
<span class="sd">        controls at the client are unnecessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="StaticHandler.initialize"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.StaticHandler.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">default_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_pkg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called automatically by the Tornado framework when the `StaticHandler`</span>
<span class="sd">        class is instantiated; handles the usual arguments with the addition</span>
<span class="sd">        of *use_pkg* which indicates that the static file should attempt to be</span>
<span class="sd">        retrieved from that package via the `pkg_resources` module instead of</span>
<span class="sd">        directly via the filesystem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_filename</span> <span class="o">=</span> <span class="n">default_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pkg</span> <span class="o">=</span> <span class="n">use_pkg</span></div>

<div class="viewcode-block" id="StaticHandler.set_extra_headers"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.StaticHandler.set_extra_headers">[docs]</a>    <span class="k">def</span> <span class="nf">set_extra_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the Access-Control-Allow-Origin header to allow cross-origin</span>
<span class="sd">        access to static content for applications embedding Gate One.</span>
<span class="sd">        Specifically, this is necessary in order to support loading fonts</span>
<span class="sd">        from different origins.</span>

<span class="sd">        Also sets the &#39;X-UA-Compatible&#39; header to &#39;IE=edge&#39; to enforce IE 10+</span>
<span class="sd">        into standards mode when content is loaded from intranet sites.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;X-UA-Compatible&#39;</span><span class="p">,</span> <span class="s1">&#39;IE=edge&#39;</span><span class="p">)</span>
        <span class="c1"># Allow access to our static content from any page:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Server&#39;</span><span class="p">,</span> <span class="s1">&#39;GateOne&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;License&#39;</span><span class="p">,</span> <span class="n">__license__</span><span class="p">)</span></div>

<div class="viewcode-block" id="StaticHandler.options"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.StaticHandler.options">[docs]</a>    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replies to OPTIONS requests with the usual stuff (200 status, Allow</span>
<span class="sd">        header, etc).  Since this is just the static file handler we don&#39;t</span>
<span class="sd">        include any extra information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Allow&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD,GET,POST,OPTIONS&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Server&#39;</span><span class="p">,</span> <span class="s1">&#39;GateOne&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;License&#39;</span><span class="p">,</span> <span class="n">__license__</span><span class="p">)</span></div>

<div class="viewcode-block" id="StaticHandler.validate_absolute_path"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.StaticHandler.validate_absolute_path">[docs]</a>    <span class="k">def</span> <span class="nf">validate_absolute_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">absolute_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An override of</span>
<span class="sd">        :meth:`tornado.web.StaticFileHandler.validate_absolute_path`;</span>

<span class="sd">        Validate and returns the given *absolute_path* using `pkg_resources`</span>
<span class="sd">        if ``self.use_pkg`` is set otherwise performs a normal filesystem</span>
<span class="sd">        validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We have to generate the real absolute path in this method since the</span>
        <span class="c1"># Tornado devs--for whatever reason--decided that get_absolute_path()</span>
        <span class="c1"># must be a classmethod (we need access to self.use_pkg).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pkg</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resource_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pkg</span><span class="p">,</span> <span class="n">absolute_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resource_filename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pkg</span><span class="p">,</span> <span class="n">absolute_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span>
            <span class="n">StaticHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate_absolute_path</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">absolute_path</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="BaseHandler"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.BaseHandler">[docs]</a><span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base handler that all Gate One RequestHandlers will inherit methods from.</span>

<span class="sd">    Provides the :meth:`get_current_user` method, sets default headers, and</span>
<span class="sd">    provides a default :meth:`options` method that can be used for monitoring</span>
<span class="sd">    purposes and also for enumerating useful information about this Gate One</span>
<span class="sd">    server (see below for more info).</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="BaseHandler.set_default_headers"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.BaseHandler.set_default_headers">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An override of :meth:`tornado.web.RequestHandler.set_default_headers`</span>
<span class="sd">        (which is how Tornado wants you to set default headers) that</span>
<span class="sd">        adds/overrides the following headers:</span>

<span class="sd">            :Server: &#39;GateOne&#39;</span>
<span class="sd">            :X-UA-Compatible: &#39;IE=edge&#39; (forces IE 10+ into Standards mode)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Force IE 10 into Standards Mode:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;X-UA-Compatible&#39;</span><span class="p">,</span> <span class="s1">&#39;IE=edge&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Server&#39;</span><span class="p">,</span> <span class="s1">&#39;GateOne&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;License&#39;</span><span class="p">,</span> <span class="n">__license__</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseHandler.get_current_user"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.BaseHandler.get_current_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tornado standard method--implemented our way.&quot;&quot;&quot;</span>
        <span class="c1"># NOTE: self.current_user is actually an @property that calls</span>
        <span class="c1">#       self.get_current_user() and caches the result.</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth_timeout&#39;</span><span class="p">,</span> <span class="s2">&quot;14d&quot;</span><span class="p">)</span>
        <span class="c1"># Need the expiration in days (which is a bit silly but whatever):</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">total_seconds</span><span class="p">(</span><span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">expiration</span><span class="p">)))</span>
            <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">86400</span><span class="p">))</span>
        <span class="n">user_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span>
            <span class="s2">&quot;gateone_user&quot;</span><span class="p">,</span> <span class="n">max_age_days</span><span class="o">=</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_json</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">user_json</span><span class="p">)</span>
            <span class="n">user</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s1">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">user</span></div>

<div class="viewcode-block" id="BaseHandler.options"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.BaseHandler.options">[docs]</a>    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replies to OPTIONS requests with the usual stuff (200 status, Allow</span>
<span class="sd">        header, etc) but also includes some useful information in the response</span>
<span class="sd">        body that lists which authentication API features we support in</span>
<span class="sd">        addition to which applications are installed.  The response body is</span>
<span class="sd">        conveniently JSON-encoded:</span>

<span class="sd">        .. ansi-block::</span>

<span class="sd">            \x1b[1;34muser\x1b[0m@modern-host\x1b[1;34m:~ $\x1b[0m curl -k \</span>
<span class="sd">            -X OPTIONS https://gateone.company.com/ | python -mjson.tool</span>
<span class="sd">              % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span>
<span class="sd">                                             Dload  Upload   Total   Spent    Left  Speed</span>
<span class="sd">            100   158  100   158    0     0   6793      0 --:--:-- --:--:-- --:--:--  7181</span>
<span class="sd">            {</span>
<span class="sd">                &quot;applications&quot;: [</span>
<span class="sd">                    &quot;File Transfer&quot;,</span>
<span class="sd">                    &quot;Terminal&quot;,</span>
<span class="sd">                    &quot;X11&quot;</span>
<span class="sd">                ],</span>
<span class="sd">                &quot;auth_api&quot;: {</span>
<span class="sd">                    &quot;hmacs&quot;: [</span>
<span class="sd">                        &quot;HMAC-SHA1&quot;,</span>
<span class="sd">                        &quot;HMAC-SHA256&quot;,</span>
<span class="sd">                        &quot;HMAC-SHA384&quot;,</span>
<span class="sd">                        &quot;HMAC-SHA512&quot;</span>
<span class="sd">                    ],</span>
<span class="sd">                    &quot;versions&quot;: [</span>
<span class="sd">                        &quot;1.0&quot;</span>
<span class="sd">                    ]</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        .. note::</span>

<span class="sd">            The &#39;Server&#39; header does not supply the version information.  This</span>
<span class="sd">            is intentional as it amounts to an unnecessary information</span>
<span class="sd">            disclosure.  We don&#39;t need to make an attacker&#39;s job any easier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="n">enabled_applications</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;enabled_applications&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled_applications</span><span class="p">:</span>
            <span class="c1"># List all installed apps</span>
            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">APPLICATIONS</span><span class="p">:</span>
                <span class="n">enabled_applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Allow&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD,GET,POST,OPTIONS&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;License&#39;</span><span class="p">,</span> <span class="n">__license__</span><span class="p">)</span>
        <span class="n">features_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;auth_api&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;versions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;1.0&#39;</span><span class="p">],</span>
                <span class="s1">&#39;hmacs&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;HMAC-SHA1&#39;</span><span class="p">,</span> <span class="s1">&#39;HMAC-SHA256&#39;</span><span class="p">,</span> <span class="s1">&#39;HMAC-SHA384&#39;</span><span class="p">,</span> <span class="s1">&#39;HMAC-SHA512&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s2">&quot;applications&quot;</span><span class="p">:</span> <span class="n">enabled_applications</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">features_dict</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="HTTPSRedirectHandler"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.HTTPSRedirectHandler">[docs]</a><span class="k">class</span> <span class="nc">HTTPSRedirectHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler to redirect clients from HTTP to HTTPS.  Only used if</span>
<span class="sd">    `https_redirect` is True in Gate One&#39;s settings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="HTTPSRedirectHandler.get"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.HTTPSRedirectHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Just redirects the client from HTTP to HTTPS&quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Host&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span>
            <span class="s1">&#39;https://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">url_prefix</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="DownloadHandler"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.DownloadHandler">[docs]</a><span class="k">class</span> <span class="nc">DownloadHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`tornado.web.RequestHandler` to serve up files that wind up in a</span>
<span class="sd">    given user&#39;s `session_dir` in the &#39;downloads&#39; directory.  Generally speaking</span>
<span class="sd">    these files are generated by the terminal emulator (e.g. cat somefile.pdf)</span>
<span class="sd">    but it can be used by applications and plugins as a way to serve up</span>
<span class="sd">    all sorts of (temporary/transient) files to users.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE:  This is a modified version of torando.web.StaticFileHandler</span>
    <span class="nd">@tornado.web.authenticated</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">include_body</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s1">&#39;session&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DownloadHandler: Could not determine use session&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="c1"># Something is wrong</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="s1">&#39;downloads&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_error_html</span><span class="p">(</span><span class="mi">404</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a file&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">stat</span><span class="o">,</span> <span class="nn">mimetypes</span>
        <span class="n">stat_result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat_result</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">,</span> <span class="n">modified</span><span class="p">)</span>
        <span class="n">mime_type</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mime_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">)</span>
        <span class="c1"># Set the Cache-Control header to private since this file is not meant</span>
        <span class="c1"># to be public.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Cache-Control&quot;</span><span class="p">,</span> <span class="s2">&quot;private&quot;</span><span class="p">)</span>
        <span class="c1"># Add some additional headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="c1"># Check the If-Modified-Since, and don&#39;t send the result if the</span>
        <span class="c1"># content has not been modified</span>
        <span class="n">ims_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;If-Modified-Since&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ims_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">email.utils</span>
            <span class="n">date_tuple</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate</span><span class="p">(</span><span class="n">ims_value</span><span class="p">)</span>
            <span class="n">if_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date_tuple</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">if_since</span> <span class="o">&gt;=</span> <span class="n">modified</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="c1"># Finally, deliver the file</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Etag&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">include_body</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;HEAD&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_error_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s2">&quot;static_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">403</span><span class="p">]:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;static_url&#39;</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.html&#39;</span> <span class="o">%</span> <span class="n">status_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="kn">import</span> <span class="nn">httplib</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;html&gt;&lt;title&gt;</span><span class="si">%(code)d</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&lt;/title&gt;&quot;</span> \
                <span class="s2">&quot;&lt;body class=&#39;bodyErrorPage&#39;&gt;</span><span class="si">%(code)d</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&lt;/body&gt;&lt;/html&gt;&quot;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">status_code</span><span class="p">],</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="MainHandler"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.MainHandler">[docs]</a><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renders index.html which loads Gate One.</span>

<span class="sd">    Will include the minified version of gateone.js if available as</span>
<span class="sd">    gateone.min.js.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@tornado.web.authenticated</span>
    <span class="nd">@tornado.web.addslash</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set our server header so it doesn&#39;t say TornadoServer/&lt;version&gt;</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
        <span class="n">prefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;prefs&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">gateone_js</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">static/gateone.js&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">minified_js_abspath</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/gateone.min.js&#39;</span><span class="p">)</span>
        <span class="n">js_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;js_init&#39;</span><span class="p">]</span>
        <span class="c1"># Use the minified version if it exists and we&#39;re not debugging</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">minified_js_abspath</span><span class="p">):</span>
                <span class="n">gateone_js</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">static/gateone.min.js&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">])</span>
        <span class="n">index_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;templates/index.html&#39;</span><span class="p">)</span>
        <span class="n">head_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">body_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;HTML&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;head&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;HTML&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;HTML&#39;</span><span class="p">][</span><span class="s1">&#39;head&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;HTML&#39;</span><span class="p">][</span><span class="s1">&#39;head&#39;</span><span class="p">]:</span>
                            <span class="n">head_html</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item</span>
                <span class="k">if</span> <span class="s1">&#39;body&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;HTML&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;HTML&#39;</span><span class="p">][</span><span class="s1">&#39;body&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;HTML&#39;</span><span class="p">][</span><span class="s1">&#39;body&#39;</span><span class="p">]:</span>
                            <span class="n">body_html</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">index_path</span><span class="p">,</span>
            <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>
            <span class="n">gateone_js</span><span class="o">=</span><span class="n">gateone_js</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">js_init</span><span class="o">=</span><span class="n">js_init</span><span class="p">,</span>
            <span class="n">url_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">],</span>
            <span class="n">head</span><span class="o">=</span><span class="n">head_html</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">body_html</span><span class="p">,</span>
            <span class="n">prefs</span><span class="o">=</span><span class="n">prefs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GOApplication"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.GOApplication">[docs]</a><span class="k">class</span> <span class="nc">GOApplication</span><span class="p">(</span><span class="n">OnOffMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base from which all Gate One Applications will inherit.  Applications</span>
<span class="sd">    are expected to be written like so::</span>

<span class="sd">        class SomeApplication(GOApplication):</span>
<span class="sd">            def initialize(self):</span>
<span class="sd">                &quot;Called when the Application is instantiated.&quot;</span>
<span class="sd">                initialize_stuff()</span>
<span class="sd">                # Here&#39;s some good things to do in an initialize() function...</span>
<span class="sd">                # Register a policy-checking function:</span>
<span class="sd">                self.ws.security.update({&#39;some_app&#39;: policy_checking_func})</span>
<span class="sd">                # Register some WebSocket actions (note the app:action naming convention)</span>
<span class="sd">                self.ws.actions.update({</span>
<span class="sd">                    &#39;some_app:do_stuff&#39;: self.do_stuff,</span>
<span class="sd">                    &#39;some_app:do_other_stuff&#39;: self.do_other_stuff</span>
<span class="sd">                })</span>
<span class="sd">            def open(self):</span>
<span class="sd">                &quot;Called when the connection is established.&quot;</span>
<span class="sd">                # Setup whatever is necessary for session tracking and whatnot.</span>
<span class="sd">            def authenticate(self):</span>
<span class="sd">                &quot;Called when the user *successfully* authenticates.&quot;</span>
<span class="sd">                # Here&#39;s the best place to instantiate things, send the user</span>
<span class="sd">                # JavaScript/CSS files, and similar post-authentication details.</span>
<span class="sd">            def on_close(self):</span>
<span class="sd">                &quot;Called when the connection is closed.&quot;</span>
<span class="sd">                # This is a good place to halt any background/periodic operations.</span>

<span class="sd">    GOApplications will be automatically imported into Gate One and registered</span>
<span class="sd">    appropriately as long as they follow the following conventions:</span>

<span class="sd">        * The application and its module(s) should live inside its own directory inside the &#39;applications&#39; directory.  For example, `/opt/gateone/applications/some_app/some_app.py`</span>
<span class="sd">        * Subclasses of `GOApplication` must be added to an `apps` global (list) inside of the application&#39;s module(s) like so: `apps = [SomeApplication]` (usually a good idea to put that at the very bottom of the module).</span>

<span class="sd">    .. note::</span>

<span class="sd">        All .py modules inside of the application&#39;s main directory will be</span>
<span class="sd">        imported even if they do not contain or register a `GOApplication`.</span>

<span class="sd">    .. tip::</span>

<span class="sd">        You can add command line arguments to Gate One by calling</span>
<span class="sd">        :func:`tornado.options.define` anywhere in your application&#39;s global</span>
<span class="sd">        namespace.  This works because the :func:`~tornado.options.define`</span>
<span class="sd">        function registers options in Gate One&#39;s global namespace (as</span>
<span class="sd">        `tornado.options.options`) and Gate One imports application modules</span>
<span class="sd">        before it evaluates command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># You&#39;ll want to override these values in your own app:</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Unknown App&quot;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s2">&quot;The application developer has yet to provide a description.&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1"># NOTE: The above &#39;info&#39; dict will be sent to the client.</span>
    <span class="c1"># NOTE: The icon value will be replaced with the actual icon data.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span> <span class="c1"># WebSocket instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">current_user</span>
        <span class="c1"># Setup some shortcuts to make things more natural and convenient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">write_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_binary</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">write_binary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_and_send_css</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">render_and_send_css</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_style</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">render_style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">send_css</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">send_js</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">security</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_async</span> <span class="o">=</span> <span class="n">CPU_ASYNC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_async</span> <span class="o">=</span> <span class="n">IO_ASYNC</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;GOApplication: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="GOApplication.initialize"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.GOApplication.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :meth:`ApplicationWebSocket.open` after __init__().</span>
<span class="sd">        GOApplications can override this function to perform their own actions</span>
<span class="sd">        when the Application is initialized (happens just before the WebSocket</span>
<span class="sd">        is opened).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="GOApplication.open"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.GOApplication.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :meth:`ApplicationWebSocket.open` after the WebSocket is</span>
<span class="sd">        opened.  GOApplications can override this function to perform their own</span>
<span class="sd">        actions when the WebSocket is opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="GOApplication.on_close"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.GOApplication.on_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :meth:`ApplicationWebSocket.on_close` after the WebSocket is</span>
<span class="sd">        closed.  GOApplications can override this function to perform their own</span>
<span class="sd">        actions when the WebSocket is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="GOApplication.add_handler"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.GOApplication.add_handler">[docs]</a>    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the given *handler* (`tornado.web.RequestHandler`) to the Tornado</span>
<span class="sd">        Application (`self.ws.application`) to handle URLs matching *pattern*.</span>
<span class="sd">        If given, *kwargs* will be added to the `tornado.web.URLSpec` when the</span>
<span class="sd">        complete handler is assembled.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If the *pattern* does not start with the configured `url_prefix` it</span>
<span class="sd">            will be automatically prepended.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding handler: (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">))</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="c1"># Get rid of the / (it will be in the url_prefix)</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">URLSpec</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Why the Tornado devs didn&#39;t give us a simple way to do this is beyond</span>
        <span class="c1"># me.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span></div>

<div class="viewcode-block" id="GOApplication.add_timeout"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.GOApplication.add_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">add_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A convenience function that calls the given *func* after *timeout* using</span>
<span class="sd">        ``self.io_loop.add_timeout()`` (which uses</span>
<span class="sd">        :meth:`tornado.ioloop.IOLoop.add_timeout`).</span>

<span class="sd">        The given *timeout* may be a `datetime.timedelta` or a string compatible</span>
<span class="sd">        with `utils.convert_to_timedelta` such as, &quot;5s&quot; or &quot;10m&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ApplicationWebSocket"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket">[docs]</a><span class="k">class</span> <span class="nc">ApplicationWebSocket</span><span class="p">(</span><span class="n">WebSocketHandler</span><span class="p">,</span> <span class="n">OnOffMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main WebSocket interface for Gate One, this class is setup to call</span>
<span class="sd">    WebSocket &#39;actions&#39; which are methods registered in `self.actions`.</span>
<span class="sd">    Methods that are registered this way will be exposed and directly callable</span>
<span class="sd">    over the WebSocket.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instances</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># These three attributes handle watching files for changes:</span>
    <span class="n">watched_files</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># Format: {&lt;file path&gt;: &lt;modification time&gt;}</span>
    <span class="n">file_update_funcs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Format: {&lt;file path&gt;: &lt;function called on update&gt;}</span>
    <span class="n">file_watcher</span> <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># Will be replaced with a PeriodicCallback</span>
    <span class="n">prefs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Gets updated with every call to initialize()</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;go:ping&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pong</span><span class="p">,</span>
            <span class="s1">&#39;go:log&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">,</span>
            <span class="s1">&#39;go:authenticate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">,</span>
            <span class="s1">&#39;go:get_theme&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_theme</span><span class="p">,</span>
            <span class="s1">&#39;go:enumerate_themes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_themes</span><span class="p">,</span>
            <span class="s1">&#39;go:file_request&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">,</span>
            <span class="s1">&#39;go:cache_cleanup&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_cleanup</span><span class="p">,</span>
            <span class="s1">&#39;go:send_user_message&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_user_message</span><span class="p">,</span>
            <span class="s1">&#39;go:broadcast&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">,</span>
            <span class="s1">&#39;go:list_users&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_server_users</span><span class="p">,</span>
            <span class="s1">&#39;go:get_locations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locations</span><span class="p">,</span>
            <span class="s1">&#39;go:set_location&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_location</span><span class="p">,</span>
            <span class="s1">&#39;go:set_locales&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_locales</span><span class="p">,</span>
            <span class="s1">&#39;go:set_dimensions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">,</span>
            <span class="s1">&#39;go:license_info&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_info</span><span class="p">,</span>
            <span class="s1">&#39;go:debug&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># Setup some instance-specific loggers that we can later update with</span>
        <span class="c1"># more metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.sync&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.message&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.auth&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.client&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_locales</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Just a placeholder; gets set in authenticate()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locations</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Just a placeholder; gets set in authenticate()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span> <span class="c1"># Just a placeholder; gets set in authenticate()</span>
        <span class="c1"># This is used to keep track of used API authentication signatures so</span>
        <span class="c1"># we can prevent replay attacks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_signatures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># Only allow valid origins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span> <span class="o">=</span> <span class="n">FILE_CACHE</span> <span class="c1"># So applications and plugins can reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist</span> <span class="o">=</span> <span class="n">PERSIST</span> <span class="c1"># So applications and plugins can reference</span>
        <span class="k">if</span> <span class="s1">&#39;theme_mtimes&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">persist</span><span class="p">:</span>
            <span class="c1"># Track theme file modification times so we can be more efficient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;theme_mtimes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apps</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Gets filled up by self.initialize()</span>
        <span class="c1"># The security dict stores applications&#39; various policy functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latency_count</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># Starts at 12 so the first ping is logged</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinger</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Replaced with a PeriodicCallback inside open()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Tracks/averages client latency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latency</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Keeps a running average</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checked_origin</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">WebSocketHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket.file_checker"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.file_checker">[docs]</a>    <span class="k">def</span> <span class="nf">file_checker</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A `Tornado.IOLoop.PeriodicCallback` that regularly checks all files</span>
<span class="sd">        registered in the `ApplicationWebSocket.watched_files` dict for changes.</span>

<span class="sd">        If changes are detected the corresponding function(s) in</span>
<span class="sd">        `ApplicationWebSocket.file_update_funcs` will be called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#logging.debug(&quot;file_checker()&quot;) # Noisy so I&#39;ve commented it out</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="c1"># No connected sessions; no point in watching files</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">file_watcher</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="c1"># Also remove the broadcast file so we know to start up the</span>
            <span class="c1"># file_watcher again if a user connects.</span>
            <span class="n">session_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span>
            <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="s1">&#39;broadcast&#39;</span><span class="p">)</span> <span class="c1"># Default</span>
            <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;broadcast_file&#39;</span><span class="p">,</span> <span class="n">broadcast_file</span><span class="p">)</span> <span class="c1"># If set, use that</span>
            <span class="k">del</span> <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="p">[</span><span class="n">broadcast_file</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">cls</span><span class="o">.</span><span class="n">file_update_funcs</span><span class="p">[</span><span class="n">broadcast_file</span><span class="p">]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">mtime</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="c1"># Someone deleted something they shouldn&#39;t have</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;{path} has been removed.  Removing from file &quot;</span>
                    <span class="s2">&quot;checker.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)))</span>
                <span class="k">del</span> <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">cls</span><span class="o">.</span><span class="n">file_update_funcs</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="n">current_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
            <span class="k">if</span> <span class="n">current_mtime</span> <span class="o">==</span> <span class="n">mtime</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_mtime</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">file_update_funcs</span><span class="p">[</span><span class="n">path</span><span class="p">]()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Exception encountered trying to execute the file update &quot;</span>
                    <span class="s2">&quot;function for {path}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">traceback</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket.watch_file"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.watch_file">[docs]</a>    <span class="k">def</span> <span class="nf">watch_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A classmethod that registers the given file *path* and *func* in</span>
<span class="sd">        `ApplicationWebSocket.watched_files` and</span>
<span class="sd">        `ApplicationWebSocket.file_update_funcs`, respectively.  The given</span>
<span class="sd">        *func* will be called (by `ApplicationWebSocket.file_checker`) whenever</span>
<span class="sd">        the file at *path* is modified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;watch_file(&#39;{path}&#39;, {func}())&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">path</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">})</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">file_update_funcs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">path</span><span class="p">:</span> <span class="n">func</span><span class="p">})</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket.load_prefs"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.load_prefs">[docs]</a>    <span class="k">def</span> <span class="nf">load_prefs</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads all of Gate One&#39;s settings from `options.settings_dir` into</span>
<span class="sd">        ``cls.prefs``.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This ``classmethod`` gets called automatically whenever a change is</span>
<span class="sd">            detected inside Gate One&#39;s ``settings_dir``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Settings have been modified.  Reloading from </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">))</span>
        <span class="n">prefs</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="c1"># Only overwrite our settings if everything is proper</span>
        <span class="k">if</span> <span class="s1">&#39;gateone&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]:</span>
            <span class="c1"># NOTE: get_settings() records its own errors too</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Settings have NOT been loaded.&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span> <span class="o">=</span> <span class="n">prefs</span>
        <span class="c1"># Reset the memoization dict so that everything using</span>
        <span class="c1"># applicable_policies() gets the latest &amp; greatest settings</span>
        <span class="n">MEMO</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># Also update __license_info__ so folks don&#39;t have to restart Gate One</span>
        <span class="c1"># when installing a new license:</span>
        <span class="n">licenses</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;licenses&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">licenses</span><span class="p">:</span>
            <span class="n">validate_licenses</span><span class="p">(</span><span class="n">licenses</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Ensure the default license is applied (if license removed)</span>
            <span class="n">__license_info__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">__license_info__</span><span class="p">[</span><span class="s2">&quot;AGPLv3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="s2">&quot;gateone&quot;</span><span class="p">,</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># 0 being unlimited</span>
                <span class="s2">&quot;customer&quot;</span><span class="p">:</span> <span class="s2">&quot;Unsupported&quot;</span><span class="p">,</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">__version__</span><span class="p">,</span>
                <span class="s2">&quot;license_format&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
            <span class="p">}</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket.broadcast_file_update"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.broadcast_file_update">[docs]</a>    <span class="k">def</span> <span class="nf">broadcast_file_update</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when there&#39;s an update to the `broadcast_file` (e.g.</span>
<span class="sd">        `&lt;session_dir&gt;/broadcast`); broadcasts its contents to all connected</span>
<span class="sd">        users.  The message will be displayed via the</span>
<span class="sd">        :js:meth:`GateOne.Visual.displayMessage` function at the client and can</span>
<span class="sd">        be formatted with HTML.  For this reason it is important to strictly</span>
<span class="sd">        control write access to the broadcast file.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Under normal circumstances only root (or the owner of the</span>
<span class="sd">            gateone.py process) can enter and/or write to files inside</span>
<span class="sd">            Gate One&#39;s `session_dir` directory.</span>

<span class="sd">        The path to the broadcast file can be configured via the</span>
<span class="sd">        `broadcast_file` setting which can be placed anywhere under the</span>
<span class="sd">        &#39;gateone&#39; application/scope (e.g. inside 10server.conf).  The setting</span>
<span class="sd">        isn&#39;t there by default but you can simply add it if you wish:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            &quot;broadcast_file&quot;: &quot;/whatever/path/you/want/broadcast&quot;</span>

<span class="sd">        .. tip::</span>

<span class="sd">            Want to broadcast a message to all the users currently connected to</span>
<span class="sd">            Gate One?  Just `sudo echo &quot;your message&quot; &gt; /tmp/gateone/broadcast`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span>
        <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="s1">&#39;broadcast&#39;</span><span class="p">)</span>
        <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;broadcast_file&#39;</span><span class="p">,</span> <span class="n">broadcast_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;(Broadcast) </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">message</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clients&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="c1"># Only send to users that have authenticated</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">current_user</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">user_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;upn&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;clients&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_info</span><span class="p">)</span>
            <span class="n">msg_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Broadcast </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
            <span class="n">message_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:user_message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message_dict</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="s2">&quot;AUTHENTICATED&quot;</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">u&#39;&#39;</span><span class="p">)</span> <span class="c1"># Empty it out</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.initialize"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This gets called by the Tornado framework when `ApplicationWebSocket` is</span>
<span class="sd">        instantiated.  It will be passed the list of *apps* (Gate One</span>
<span class="sd">        applications) that are assigned inside the :class:`GOApplication`</span>
<span class="sd">        object.  These :class:`GOApplication`s will be instantiated and stored</span>
<span class="sd">        in `self.apps`.</span>

<span class="sd">        These *apps* will be mutated in-place so that `self` will refer to the</span>
<span class="sd">        current instance of :class:`ApplicationWebSocket`.  Kind of like a</span>
<span class="sd">        dynamic mixin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ApplicationWebSocket.initialize(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">apps</span><span class="p">)</span>
        <span class="c1"># Make sure we have all prefs ready for checking</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]):</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">plugin_name</span><span class="p">,</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;Events&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">bind</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;WebSocket&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c1"># Apply the plugin&#39;s WebSocket commands</span>
                <span class="k">for</span> <span class="n">ws_action</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;WebSocket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ws_action</span><span class="p">:</span> <span class="n">bind</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_extra</span><span class="p">)</span>
        <span class="c1"># Setup some actions to take place after the user authenticates</span>
        <span class="c1"># Send our plugin .js and .css files to the client</span>
        <span class="n">send_plugin_static_files</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_plugin_static_files</span><span class="p">,</span> <span class="s1">&#39;go_plugins&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="n">send_plugin_static_files</span><span class="p">)</span>
        <span class="c1"># Tell the client about any existing locations where applications may be</span>
        <span class="c1"># storing things like terminal instances and whatnot:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locations</span><span class="p">)</span>
        <span class="c1"># This is so the client knows what applications it can use:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_applications</span><span class="p">)</span>
        <span class="c1"># This starts up the PeriodicCallback that watches sessions for timeouts</span>
        <span class="c1"># and cleans them up (if not already started):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_session_watcher</span><span class="p">)</span>
        <span class="c1"># This starts up the PeriodicCallback that watches and cleans up old</span>
        <span class="c1"># user logs (anything in gateone/users/&lt;user&gt;/logs):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_cleaner</span><span class="p">)</span>
        <span class="c1"># This starts up the file watcher PeriodicCallback:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;go:authenticate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_file_watcher</span><span class="p">)</span>
        <span class="c1"># This ensures that sessions will timeout immediately if session_timeout</span>
        <span class="c1"># is set to 0:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;go:close&quot;</span><span class="p">,</span> <span class="n">timeout_sessions</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">apps</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s1">&#39;initialize&#39;</span><span class="p">):</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.send_extra"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.send_extra">[docs]</a>    <span class="k">def</span> <span class="nf">send_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends any extra JS/CSS files placed in Gate One&#39;s &#39;static/extra&#39;</span>
<span class="sd">        directory.  Can be useful if you want to use Gate One&#39;s file</span>
<span class="sd">        synchronization and caching capabilities in your app.</span>

<span class="sd">        .. note::</span>

<span class="sd">            You may have to create the &#39;static/extra&#39; directory before putting</span>
<span class="sd">            files in there.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;static/extra&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource_exists</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/extra&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">resource_listdir</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/extra&#39;</span><span class="p">):</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/extra/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.js&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.css&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.allow_draft76"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.allow_draft76">[docs]</a>    <span class="k">def</span> <span class="nf">allow_draft76</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        By overriding this function we&#39;re allowing the older version of the</span>
<span class="sd">        WebSockets protocol.  As long as communications happens over SSL there</span>
<span class="sd">        shouldn&#39;t be any security concerns with this.  This is mostly to support</span>
<span class="sd">        iOS Safari.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.get_current_user"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.get_current_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mostly identical to the function of the same name in MainHandler.  The</span>
<span class="sd">        difference being that when API authentication is enabled the WebSocket</span>
<span class="sd">        will expect and perform its own auth of the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth_timeout&#39;</span><span class="p">,</span> <span class="s2">&quot;14d&quot;</span><span class="p">)</span>
        <span class="c1"># Need the expiration in days (which is a bit silly but whatever):</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">total_seconds</span><span class="p">(</span><span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">expiration</span><span class="p">)))</span>
            <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">86400</span><span class="p">))</span>
        <span class="n">user_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span>
            <span class="s2">&quot;gateone_user&quot;</span><span class="p">,</span> <span class="n">max_age_days</span><span class="o">=</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_json</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="c1"># This can happen if the user&#39;s browser isn&#39;t allowing</span>
                <span class="c1"># persistent cookies (e.g. incognito mode)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;upn&#39;</span><span class="p">:</span> <span class="s1">&#39;ANONYMOUS&#39;</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">generate_session_id</span><span class="p">()}</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">user_json</span><span class="p">)</span>
        <span class="n">user</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
        <span class="k">return</span> <span class="n">user</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.write_binary"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.write_binary">[docs]</a>    <span class="k">def</span> <span class="nf">write_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the given *message* to the WebSocket in binary mode (opcode</span>
<span class="sd">        0x02).  Binary WebSocket messages are handled differently from regular</span>
<span class="sd">        messages at the client (they use a completely different &#39;action&#39;</span>
<span class="sd">        mechanism).  For more information see the JavaScript developer</span>
<span class="sd">        documentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.check_origin"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.check_origin">[docs]</a>    <span class="k">def</span> <span class="nf">check_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the given *origin* matches what&#39;s been set in Gate One&#39;s</span>
<span class="sd">        &quot;origins&quot; setting (usually in 10server.conf).  The *origin* will first</span>
<span class="sd">        be checked for an exact match in the &quot;origins&quot; setting but if that fails</span>
<span class="sd">        each valid origin will be evaluated as a regular expression (if it&#39;s not</span>
<span class="sd">        a valid hostname) and the given *origin* will be checked against that.</span>

<span class="sd">        Returns ``True`` if *origin* is valid.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If &#39;*&#39; is in the &quot;origins&quot; setting (anywhere) all origins will be</span>
<span class="sd">            allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;check_origin(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">origin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checked_origin</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">parsed_origin</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">parsed_origin</span><span class="o">.</span><span class="n">netloc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Host&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="n">host</span><span class="p">:</span> <span class="c1"># Reality check: Do we care?</span>
            <span class="c1"># If the origin matches the &quot;Host&quot; header it means that the user is</span>
            <span class="c1"># legitimately accessing Gate One directly.  We really only need to</span>
            <span class="c1"># worry about origins if the connection is coming from some external</span>
            <span class="c1"># site (e.g. to prevent spear phishing attacks; XSS and whatnot).</span>
            <span class="k">return</span> <span class="bp">True</span> <span class="c1"># Origin check successful; no need to continue</span>
        <span class="k">if</span> <span class="s1">&#39;origins&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cli_overrides&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="c1"># If given on the command line, always use those origins</span>
            <span class="n">valid_origins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;origins&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Why have this separate?  So you can change origins on-the-fly by</span>
            <span class="c1"># modifying 10server.conf (or whatever other conf you put it in).</span>
            <span class="n">valid_origins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;origins&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">valid_origins</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="ow">in</span> <span class="n">valid_origins</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="c1"># Treat the list of valid origins as regular expressions</span>
            <span class="k">for</span> <span class="n">check_origin</span> <span class="ow">in</span> <span class="n">valid_origins</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valid_hostname</span><span class="p">(</span><span class="n">check_origin</span><span class="p">):</span>
                    <span class="k">continue</span> <span class="c1"># Valid hostnames aren&#39;t regular expressions</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">check_origin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Origin check failed for: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">origin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.open"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when a new WebSocket is opened.  Will deny access to any</span>
<span class="sd">        origin that is not defined in `self.settings[&#39;origin&#39;]`.  Also sends</span>
<span class="sd">        any relevant localization data (JavaScript) to the client and calls the</span>
<span class="sd">        :meth:`open` method of any and all enabled Applications.</span>

<span class="sd">        This method kicks off the process that sends keepalive pings/checks to</span>
<span class="sd">        the client (A `~tornado.ioloop.PeriodicCallback` set as `self.pinger`).</span>

<span class="sd">        This method also sets the following instance attributes:</span>

<span class="sd">            * `self.client_id`: Unique identifier for this instance.</span>
<span class="sd">            * `self.base_url`: The base URL (e.g. https://foo.com/gateone/) used to access Gate One.</span>

<span class="sd">        Triggers the `go:open` event.</span>

<span class="sd">        .. note::</span>

<span class="sd">            `self.settings` comes from the Tornado framework and includes most</span>
<span class="sd">            command line arguments and the settings from the `settings_dir` that</span>
<span class="sd">            fall under the &quot;gateone&quot; scope.  It is not the same thing as</span>
<span class="sd">            `self.prefs` which includes *all* of Gate One&#39;s settings (including</span>
<span class="sd">            settings for other applications and scopes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;set_nodelay&#39;</span><span class="p">):</span>
            <span class="c1"># New feature of Tornado 3.1 that can reduce latency:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_nodelay</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;open() origin: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># client_id is unique to the browser/client whereas session_id is unique</span>
        <span class="c1"># to the user.  It isn&#39;t used much right now but it will be useful in</span>
        <span class="c1"># the future once more stuff is running over WebSockets.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;{protocol}://{host}:{port}{url_prefix}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
            <span class="n">url_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">])</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="c1"># NOTE: self.current_user will call self.get_current_user() and set</span>
        <span class="c1"># self._current_user the first time it is used.</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span><span class="s2">&quot;gateone&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">blacklisted</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blacklist&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">blacklisted</span><span class="p">:</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;{&quot;ip_address&quot;: &quot;</span><span class="si">%s</span><span class="s1">&quot;} Access Denied (blacklisted).&#39;</span><span class="p">))</span>
            <span class="n">blacklist_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Your IP address (</span><span class="si">%s</span><span class="s2">) has been blacklisted&quot;</span><span class="p">)</span>
                <span class="o">%</span> <span class="n">client_address</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:blacklisted&#39;</span><span class="p">:</span> <span class="n">blacklist_msg</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Close the WebSocket</span>
            <span class="k">return</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">client_address</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s1">&#39;upn&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="c1"># Update our loggers to include the user metadata</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span>
            <span class="c1"># NOTE: NOT using self.auth_log() here on purpose:</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="c1"># Use global auth_log so we&#39;re not redundant</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;WebSocket opened (</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">) via origin </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span> <span class="n">client_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NOTE: NOT using self.auth_log() here on purpose:</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;{&quot;ip_address&quot;: &quot;</span><span class="si">%s</span><span class="s1">&quot;} WebSocket opened (unknown user).&#39;</span><span class="p">)</span>
            <span class="o">%</span> <span class="n">client_address</span><span class="p">)</span>
        <span class="c1"># NOTE: These get updated with more metadata inside of authenticate():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.sync&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.auth&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.message&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.client&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s1">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span> <span class="c1"># Invalid user info</span>
            <span class="c1"># NOTE: NOT using self.auth_log() here on purpose:</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;{&quot;ip_address&quot;: &quot;</span><span class="si">%s</span><span class="s1">&quot;} Unauthenticated WebSocket attempt.&#39;</span>
                <span class="p">)</span> <span class="o">%</span> <span class="n">client_address</span><span class="p">)</span>
            <span class="c1"># In case this is a legitimate client that simply had its auth info</span>
            <span class="c1"># expire/go bad, tell it to re-auth by calling the appropriate</span>
            <span class="c1"># action on the other side.</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Close the WebSocket</span>
        <span class="c1"># NOTE: By getting the prefs with each call to open() we make</span>
        <span class="c1">#       it possible to make changes inside the settings dir without</span>
        <span class="c1">#       having to restart Gate One (just need to wait for users to</span>
        <span class="c1">#       eventually re-connect or reload the page).</span>
        <span class="c1"># NOTE: Why store prefs in the class itself?  No need for redundancy.</span>
        <span class="k">if</span> <span class="s1">&#39;cache_dir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]:</span>
            <span class="c1"># Set the cache dir to a default if not set in the prefs</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">][</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache_dir</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="c1"># Clean out the cache_dir every page reload when in debug mode</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="c1"># NOTE: This is here so that the client will have all the necessary</span>
        <span class="c1"># strings *before* the calls to various init() functions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_translation</span><span class="p">()</span>
        <span class="n">additional_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;gateone_utils_extra.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gateone_visual_extra.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gateone_input.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gateone_misc.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;doT.js&#39;</span> <span class="c1"># For simple HTML templates</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">js_file</span> <span class="ow">in</span> <span class="n">additional_files</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">js_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="c1"># Call applications&#39; open() functions (if any)</span>
        <span class="c1"># Ping the client every 5 seconds so we can keep track of latency and</span>
        <span class="c1"># ensure firewalls don&#39;t close the connection.</span>
        <span class="k">def</span> <span class="nf">send_ping</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">WebSocketClosedError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="c1"># Connection closed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinger</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinger</span>
        <span class="n">send_ping</span><span class="p">()</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="mi">5000</span> <span class="c1"># milliseconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinger</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">PeriodicCallback</span><span class="p">(</span><span class="n">send_ping</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinger</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;go:open&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.on_message"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.on_message">[docs]</a>    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when we receive a message from the client.  Performs some basic</span>
<span class="sd">        validation of the message, decodes it (JSON), and finally calls an</span>
<span class="sd">        appropriate WebSocket action (registered method) with the message</span>
<span class="sd">        contents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This is super useful when debugging:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Message rejected due to invalid origin.&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Close the WebSocket</span>
        <span class="n">message_obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message_obj</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="c1"># JSON FTW!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;&#39;Error: Message bust be a JSON dict.&#39;&quot;</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># We didn&#39;t get JSON</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;&#39;Error: We only accept JSON here.&#39;&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">message_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">message_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">key</span><span class="p">]()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Try, try again</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">traceback</span>
                        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">frame</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                           <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error in WebSocket action, </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2"> line </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Client sent unknown WebSocket action: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.on_close"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.on_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the client terminates the connection.  Also calls the</span>
<span class="sd">        :meth:`on_close` method of any and all enabled Applications.</span>

<span class="sd">        Triggers the `go:close` event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;on_close()&quot;</span><span class="p">)</span>
        <span class="n">ApplicationWebSocket</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]][</span><span class="s1">&#39;client_ids&#39;</span><span class="p">]:</span>
                <span class="n">SESSIONS</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]][</span><span class="s1">&#39;client_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>
            <span class="c1"># This check is so we don&#39;t accidentally timeout a user&#39;s session if</span>
            <span class="c1"># the server has session_timeout=0 and the user still has a browser</span>
            <span class="c1"># connected at a different location:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]][</span><span class="s1">&#39;client_ids&#39;</span><span class="p">]:</span>
                <span class="c1"># Update &#39;last_seen&#39; with a datetime object for accuracy</span>
                <span class="n">SESSIONS</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]][</span><span class="s1">&#39;last_seen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s1">&#39;upn&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;WebSocket closed (</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">).&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span> <span class="n">client_address</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;WebSocket closed (unknown user).&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinger</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="c1"># Call applications&#39; on_close() functions (if any)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;on_close&#39;</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">on_close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;go:close&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.on_pong"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.on_pong">[docs]</a>    <span class="k">def</span> <span class="nf">on_pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records the latency of clients (from the server&#39;s perspective) via a</span>
<span class="sd">        log message.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This is the ``pong`` specified in the WebSocket protocol itself.</span>
<span class="sd">            The `pong` method is a Gate One-specific implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latency_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latency</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Something went wrong; skip this one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latency</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latency</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">latency_count</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span> <span class="c1"># Only log once a minute</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latency_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;WebSocket Latency: {0}ms&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latency</span><span class="p">))</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.pong"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.pong">[docs]</a>    <span class="k">def</span> <span class="nf">pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:ping` WebSocket action; responds to a client&#39;s</span>
<span class="sd">        ``ping`` by returning the value (*timestamp*) that was sent.  This</span>
<span class="sd">        allows the client to measure the round-trip time of the WebSocket.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This is a WebSocket action specific to Gate One. It</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:pong&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:log` WebSocket action; logs the given *log_obj* via</span>
<span class="sd">        :meth:`ApplicationWebSocket.client_log`.  The *log_obj* should be a</span>
<span class="sd">        dict (JSON object, really) in the following format::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;level&quot;: &quot;info&quot;, # Optional</span>
<span class="sd">                &quot;message&quot;: &quot;Actual log message here&quot;</span>
<span class="sd">            }</span>

<span class="sd">        If a &quot;level&quot; is not given the &quot;info&quot; level will be used.</span>

<span class="sd">        *Supported Levels:* &quot;info&quot;, &quot;error&quot;, &quot;warning&quot;, &quot;debug&quot;, &quot;fatal&quot;,</span>
<span class="sd">        &quot;critical&quot;.</span>

<span class="sd">        .. note::</span>

<span class="sd">            The &quot;critical&quot; and &quot;fatal&quot; log levels both use the</span>
<span class="sd">            `logging.Logger.critical` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Don&#39;t let unauthenticated users log messages.</span>
            <span class="c1"># NOTE:  We&#39;re not using the authenticated() check here so we don&#39;t</span>
            <span class="c1"># end up logging a zillion error messages when an unauthenticated</span>
            <span class="c1"># user&#39;s client has debug logging enabled.</span>
        <span class="k">if</span> <span class="s2">&quot;message&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">log_obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="n">log_obj</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span> <span class="c1"># Default to &quot;info&quot;</span>
        <span class="n">loggers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_log</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
            <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_log</span><span class="o">.</span><span class="n">warning</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_log</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_log</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
            <span class="s2">&quot;fatal&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_log</span><span class="o">.</span><span class="n">critical</span><span class="p">,</span> <span class="c1"># Python doesn&#39;t use &quot;fatal&quot;</span>
            <span class="s2">&quot;critical&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_log</span><span class="o">.</span><span class="n">critical</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log_obj</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="n">log_obj</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="n">log_obj</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">loggers</span><span class="p">[</span><span class="n">log_obj</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()](</span>
            <span class="s2">&quot;Client Logging: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_msg</span><span class="p">))</span>

<div class="viewcode-block" id="ApplicationWebSocket.api_auth"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.api_auth">[docs]</a>    <span class="k">def</span> <span class="nf">api_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auth_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the *auth_obj* dict validates, returns the user dict and sets</span>
<span class="sd">        ``self.current_user``.  If it doesn&#39;t validate, returns ``False``.</span>

<span class="sd">        This function also takes care of creating the user&#39;s directory if it</span>
<span class="sd">        does not exist and creating/updating the user&#39;s &#39;session&#39; file (which</span>
<span class="sd">        just stores metadata related to their session).</span>

<span class="sd">        Example usage::</span>

<span class="sd">            auth_obj = {</span>
<span class="sd">                &#39;api_key&#39;: &#39;MjkwYzc3MDI2MjhhNGZkNDg1MjJkODgyYjBmN2MyMTM4M&#39;,</span>
<span class="sd">                &#39;upn&#39;: &#39;joe@company.com&#39;,</span>
<span class="sd">                &#39;timestamp&#39;: &#39;1323391717238&#39;,</span>
<span class="sd">                &#39;signature&#39;: &lt;gibberish&gt;,</span>
<span class="sd">                &#39;signature_method&#39;: &#39;HMAC-SHA1&#39;,</span>
<span class="sd">                &#39;api_version&#39;: &#39;1.0&#39;</span>
<span class="sd">            }</span>
<span class="sd">            result = self.api_auth(auth_obj)</span>

<span class="sd">        .. seealso:: :ref:`api-auth` documentation.</span>

<span class="sd">        Here&#39;s a rundown of the required *auth_obj* parameters:</span>

<span class="sd">            :api_key:</span>
<span class="sd">                The first half of what gets generated when you run</span>
<span class="sd">                ``gateone --new_api_key`` (the other half is the secret).</span>
<span class="sd">            :upn:</span>
<span class="sd">                The userPrincipalName (aka username) of the user being</span>
<span class="sd">                authenticated.</span>
<span class="sd">            :timestamp:</span>
<span class="sd">                A 13-digit &quot;time since the epoch&quot; JavaScript-style timestamp.</span>
<span class="sd">                Both integers and strings are accepted.</span>
<span class="sd">                Example JavaScript: ``var timestamp = new Date().getTime()``</span>
<span class="sd">            :signature:</span>
<span class="sd">                The HMAC signature of the combined *api_key*, *upn*, and</span>
<span class="sd">                *timestamp*; hashed using the secret associated with the given</span>
<span class="sd">                *api_key*.</span>
<span class="sd">            :signature_method:</span>
<span class="sd">                The hashing algorithm used to create the *signature*.  Currently</span>
<span class="sd">                this must be one of &quot;HMAC-SHA1&quot;, &quot;HMAC-SHA256&quot;, &quot;HMAC-SHA384&quot;,</span>
<span class="sd">                or &quot;HMAC-SHA512&quot;</span>
<span class="sd">            :api_version:</span>
<span class="sd">                Which version of the authentication API to use when performing</span>
<span class="sd">                authentication.  Currently the only supported version is &#39;1.0&#39;.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Any additional key/value pairs that are included in the *auth_obj*</span>
<span class="sd">            will be assigned to the ``self.current_user`` object.  So if you&#39;re</span>
<span class="sd">            embedding Gate One and wish to associate extra metadata with the</span>
<span class="sd">            user you may do so via the API authentication process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">create_signature</span>
        <span class="n">reauth</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_key&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;API AUTH: Invalid API authentication object (missing api_key).&#39;</span>
            <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">upn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">])</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span> <span class="c1"># str in case integer</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">]</span>
        <span class="n">signature_method</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;signature_method&#39;</span><span class="p">]</span>
        <span class="n">api_version</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;api_version&#39;</span><span class="p">]</span>
        <span class="n">supported_hmacs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;HMAC-SHA1&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">,</span>
            <span class="s1">&#39;HMAC-SHA256&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span>
            <span class="s1">&#39;HMAC-SHA384&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha384</span><span class="p">,</span>
            <span class="s1">&#39;HMAC-SHA512&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">signature_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_hmacs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;API AUTH: Unsupported API auth &#39;</span> <span class="s1">&#39;signature method: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="o">%</span> <span class="n">signature_method</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">hmac_algo</span> <span class="o">=</span> <span class="n">supported_hmacs</span><span class="p">[</span><span class="n">signature_method</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">api_version</span> <span class="o">!=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;API AUTH: Unsupported API version: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">api_version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;api_keys&#39;</span><span class="p">][</span><span class="n">api_key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;API AUTH: API Key not found.&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
<span class="c1"># TODO: Make API version 1.1 that signs *all* attributes--not just the known ones</span>
        <span class="c1"># Check the signature against existing API keys</span>
        <span class="n">sig_check</span> <span class="o">=</span> <span class="n">create_signature</span><span class="p">(</span>
            <span class="n">secret</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">upn</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">hmac_algo</span><span class="o">=</span><span class="n">hmac_algo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sig_check</span> <span class="o">!=</span> <span class="n">signature</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;API AUTH: Signature check failed.&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Got signature: {0}, expected: {1}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">signature</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sig_check</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c1"># Everything matches (great!) so now we do due diligence</span>
        <span class="c1"># by checking the timestamp against the</span>
        <span class="c1"># api_timestamp_window setting and whether or not we&#39;ve</span>
        <span class="c1"># already used it (to prevent replay attacks).</span>
        <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_signatures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;API AUTH: replay attack detected!  User: &quot;</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, Remote IP: </span><span class="si">%s</span><span class="s2">, Origin: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">upn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)))</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;API AUTH: Replay attack detected!  This &#39;</span>
                <span class="s1">&#39;event has been logged.&#39;</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_timestamp_window&#39;</span><span class="p">,</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span>
        <span class="n">then</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">time_diff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">then</span>
        <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;API AUTH: Authentication failed due to an expired auth &quot;</span>
                <span class="s2">&quot;object.  If you just restarted the server this is &quot;</span>
                <span class="s2">&quot;normal (users just need to reload the page).  If &quot;</span>
                <span class="s2">&quot; this problem persists it could be a problem with &quot;</span>
                <span class="s2">&quot;the server&#39;s clock (either this server or the &quot;</span>
                <span class="s2">&quot;server(s) embedding Gate One).&quot;</span>
            <span class="p">))</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;AUTH FAILED: Authentication object timed out. &#39;</span>
                <span class="s1">&#39;Try reloading this page (F5).&#39;</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;AUTH FAILED: If the problem persists after &#39;</span>
                <span class="s1">&#39;reloading this page please contact your server&#39;</span>
                <span class="s1">&#39; administrator to notify them of the issue.&#39;</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;API Authentication Successful&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_signatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span> <span class="c1"># Prevent replays</span>
        <span class="c1"># Attach any additional provided keys/values to the user</span>
        <span class="c1"># object so applications embedding Gate One can use</span>
        <span class="c1"># them in their own plugins and whatnot.</span>
        <span class="n">user</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">known_params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;api_key&#39;</span><span class="p">,</span>
            <span class="s1">&#39;api_version&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;signature&#39;</span><span class="p">,</span>
            <span class="s1">&#39;signature_method&#39;</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_params</span><span class="p">:</span>
                <span class="n">user</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># user dicts need a little extra attention for IPs...</span>
        <span class="n">user</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
        <span class="c1"># Force-set the current user:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="c1"># Make a directory to store this user&#39;s settings/files/logs/etc</span>
        <span class="n">user_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">user_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Creating user directory: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">user_dir</span><span class="p">))</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">user_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
        <span class="n">session_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">session_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">session_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">session_data</span><span class="p">)[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
            <span class="n">session_info_json</span> <span class="o">=</span> <span class="n">json_encode</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">session_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># Save it so we can keep track across multiple clients</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">session_info_json</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.authenticate"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticates the client by first trying to use the &#39;gateone_user&#39;</span>
<span class="sd">        cookie or if Gate One is configured to use API authentication it will</span>
<span class="sd">        use *settings[&#39;auth&#39;]*.  Additionally, it will accept</span>
<span class="sd">        *settings[&#39;container&#39;]* and *settings[&#39;prefix&#39;]* to apply those to the</span>
<span class="sd">        equivalent properties (`self.container` and `self.prefix`).</span>

<span class="sd">        If *settings[&#39;url&#39;]* is provided it will be used to update</span>
<span class="sd">        `self.base_url` (so that we can correct for situations where Gate One</span>
<span class="sd">        is running behind a reverse proxy with a different protocol/URL than</span>
<span class="sd">        what the user used to connect).</span>

<span class="sd">        .. note::</span>

<span class="sd">            &#39;container&#39; refers to the element on which Gate One was initialized</span>
<span class="sd">            at the client (e.g. `#gateone`).  &#39;prefix&#39; refers to the string that</span>
<span class="sd">            will be prepended to all Gate One element IDs when added to the web</span>
<span class="sd">            page (to avoid namespace conflicts).  Both these values are only</span>
<span class="sd">            used when generating CSS templates.</span>

<span class="sd">        If *settings[&#39;location&#39;]* is something other than &#39;default&#39; all new</span>
<span class="sd">        application instances will be associated with the given (string) value.</span>
<span class="sd">        These applications will be treated separately so they can exist in a</span>
<span class="sd">        different browser tab/window.</span>

<span class="sd">        Triggers the `go:authenticate` event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;authenticate(): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="c1"># Make sure the client is authenticated if authentication is enabled</span>
        <span class="n">reauth</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span> <span class="c1"># Just a shortcut to keep lines short</span>
        <span class="c1"># Apply the container/prefix settings (if present)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;container&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="c1"># Update self.base_url if a url was given</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">orig_base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">port</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="mi">443</span>
                <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;http&#39;</span><span class="p">:</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;{protocol}://{host}:{port}{url_prefix}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">protocol</span><span class="o">=</span><span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span>
                <span class="n">host</span><span class="o">=</span><span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                <span class="n">url_prefix</span><span class="o">=</span><span class="n">parsed</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">orig_base_url</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Proxy in use: Client URL differs from server.&quot;</span><span class="p">))</span>
        <span class="n">auth_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auth_method</span> <span class="ow">and</span> <span class="n">auth_method</span> <span class="o">!=</span> <span class="s1">&#39;api&#39;</span><span class="p">:</span>
            <span class="c1"># Regular, non-API authentication</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="c1"># Try authenticating with the given (encrypted) &#39;auth&#39; value</span>
                <span class="n">expiration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth_timeout&#39;</span><span class="p">,</span> <span class="s2">&quot;14d&quot;</span><span class="p">)</span>
                <span class="n">expiration</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">total_seconds</span><span class="p">(</span><span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">expiration</span><span class="p">)))</span>
                    <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">86400</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">auth_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="s2">&quot;gateone_user&quot;</span><span class="p">,</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">],</span> <span class="n">max_age_days</span><span class="o">=</span><span class="n">expiration</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Received strange data when performing &quot;</span>
                        <span class="s2">&quot;authentication.  Did you forget to set &#39;api&#39; in &quot;</span>
                        <span class="s2">&quot;20authentication.conf?&quot;</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="c1"># NOTE:  This will override whatever is in the cookie.</span>
                <span class="c1"># Why?  Because we&#39;ll eventually transition to not using cookies</span>
                <span class="k">if</span> <span class="n">auth_data</span><span class="p">:</span>
                    <span class="c1"># Force-set the current user</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">auth_data</span><span class="p">)</span>
                    <span class="c1"># Add/update the user&#39;s IP address</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
                    <span class="c1"># This usually happens when the cookie_secret gets changed</span>
                    <span class="c1"># resulting in &quot;Invalid cookie...&quot; errors.  If we tell the</span>
                    <span class="c1"># client to re-auth the problem should correct itself.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ANONYMOUS&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
                    <span class="c1"># This can happen when a client logs in with no auth type</span>
                    <span class="c1"># configured and then later the server is configured to use</span>
                    <span class="c1"># authentication.  The client must be told to re-auth:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># &#39;upn&#39; wasn&#39;t in user</span>
                <span class="c1"># Force them to authenticate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                <span class="c1">#self.close() # Close the WebSocket</span>
        <span class="k">elif</span> <span class="n">auth_method</span> <span class="ow">and</span> <span class="n">auth_method</span> <span class="o">==</span> <span class="s1">&#39;api&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;auth&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;auth settings: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">])</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_auth</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                    <span class="c1"># The api_auth() function takes care of logging/notification</span>
                    <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Anonymous auth</span>
            <span class="c1"># Double-check there isn&#39;t a user set in the cookie (i.e. we have</span>
            <span class="c1"># recently changed Gate One&#39;s settings).  If there is, force it</span>
            <span class="c1"># back to ANONYMOUS.</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="n">cookie_data</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="c1"># The client is trying to authenticate using the</span>
                    <span class="c1"># &#39;gateone_user&#39; parameter in localStorage.</span>
                    <span class="c1"># Authenticate/decode the encoded auth info</span>
                    <span class="n">expiration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth_timeout&#39;</span><span class="p">,</span> <span class="s2">&quot;14d&quot;</span><span class="p">)</span>
                    <span class="n">expiration</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">total_seconds</span><span class="p">(</span><span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">expiration</span><span class="p">)))</span>
                        <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">86400</span><span class="p">))</span>
                    <span class="n">cookie_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="s2">&quot;gateone_user&quot;</span><span class="p">,</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">],</span> <span class="n">max_age_days</span><span class="o">=</span><span class="n">expiration</span><span class="p">)</span>
                    <span class="c1"># NOTE: The above doesn&#39;t actually touch any cookies</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Someone is attempting to perform API-based authentication</span>
                    <span class="c1"># but this server isn&#39;t configured with &#39;auth = &quot;api&quot;&#39;.</span>
                    <span class="c1"># Let&#39;s be real user-friendly and point out this mistake</span>
                    <span class="c1"># with a helpful error message...</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Client tried to use API-based authentication but this &quot;</span>
                        <span class="s2">&quot;server is configured with &#39;auth = </span><span class="se">\&quot;</span><span class="s2">{0}</span><span class="se">\&quot;</span><span class="s2">&#39;.  Did you &quot;</span>
                        <span class="s2">&quot;forget to set &#39;</span><span class="se">\&quot;</span><span class="s2">auth</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">api</span><span class="se">\&quot;</span><span class="s2">&#39; in the settings?&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]))</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;AUTHENTICATION ERROR: Server is not configured to &quot;</span>
                        <span class="s2">&quot;perform API-based authentication.  Did someone forget &quot;</span>
                        <span class="s2">&quot;to set &#39;</span><span class="se">\&quot;</span><span class="s2">auth</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">api</span><span class="se">\&quot;</span><span class="s2">&#39; in the settings?&quot;</span><span class="p">)}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">cookie_data</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">cookie_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                <span class="c1"># Generate a new session/anon user</span>
                <span class="c1"># Also store/update their session info in localStorage</span>
                <span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;upn&#39;</span><span class="p">:</span> <span class="s1">&#39;ANONYMOUS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">generate_session_id</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">encoded_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_signed_value</span><span class="p">(</span>
                    <span class="s1">&#39;gateone_user&#39;</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                <span class="n">session_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:gateone_user&#39;</span><span class="p">:</span> <span class="n">encoded_user</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">session_message</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span> <span class="o">=</span> <span class="n">user</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ANONYMOUS&#39;</span><span class="p">:</span>
                <span class="c1"># Gate One server&#39;s auth config probably changed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span> <span class="ow">and</span> <span class="s1">&#39;session&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Authentication failed for unknown user&quot;</span><span class="p">))</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;AUTHENTICATION ERROR: User unknown&#39;</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">reauth</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="c1"># Locations are used to differentiate between different tabs/windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="c1"># Update our loggers to include the user metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;upn&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span>
            <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.sync&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.auth&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.message&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s1">&#39;gateone.client&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="c1"># NOTE: NOT using self.auth_log() here on purpose (this log message</span>
        <span class="c1"># should stay consistent for easier auditing):</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s2">u&quot;User {upn} authenticated successfully via origin {origin} &quot;</span>
            <span class="s2">u&quot;(location {location}).&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">upn</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
                <span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span>
                <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="c1"># This check is to make sure there&#39;s no existing session so we don&#39;t</span>
        <span class="c1"># accidentally clobber it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="c1"># Start a new session:</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;client_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">],</span>
                <span class="s1">&#39;last_seen&#39;</span><span class="p">:</span> <span class="s1">&#39;connected&#39;</span><span class="p">,</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span>
                <span class="s1">&#39;kill_session_callbacks&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Please wait while the server is restarted...&quot;</span><span class="p">))</span>
                <span class="p">],</span>
                <span class="s1">&#39;timeout_callbacks&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="c1"># Locations are virtual containers that indirectly correlate</span>
                <span class="c1"># with browser windows/tabs.  The point is to allow things like</span>
                <span class="c1"># opening/moving applications/terminals in/to new windows/tabs.</span>
                <span class="s1">&#39;locations&#39;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s1">&#39;last_seen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;connected&#39;</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s1">&#39;client_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s1">&#39;locations&#39;</span><span class="p">]:</span>
                <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s1">&#39;locations&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># A shortcut:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locations</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s1">&#39;locations&#39;</span><span class="p">]</span>
        <span class="c1"># Call applications&#39; authenticate() functions (if any)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="c1"># Set the current user for convenient access</span>
            <span class="n">app</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;authenticate&#39;</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">authenticate</span><span class="p">()</span>
        <span class="c1"># This is just so the client has a human-readable point of reference:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:set_username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;go:authenticate&#39;</span><span class="p">)</span>
        <span class="c1"># Perform a license check</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span><span class="o">.</span><span class="n">_list_connected_users</span><span class="p">()</span>
        <span class="n">user_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span> <span class="c1"># Broadcast/unauthenticated clients don&#39;t count</span>
                <span class="k">continue</span>
            <span class="n">user_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">max_users</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Figure out how many users we&#39;ll allow by adding up all the licenses</span>
        <span class="k">for</span> <span class="n">license</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">__license_info__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gateone&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Unlimited</span>
                    <span class="k">return</span> <span class="c1"># Nothing to check</span>
                <span class="n">max_users</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user_count</span> <span class="o">&gt;</span> <span class="n">max_users</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Licensed user limit {max_users} exceeded: {user_count} &quot;</span>
                  <span class="s2">&quot;connected users&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">max_users</span><span class="o">=</span><span class="n">max_users</span><span class="p">,</span> <span class="n">user_count</span><span class="o">=</span><span class="n">user_count</span><span class="p">))</span></div>

<div class="viewcode-block" id="ApplicationWebSocket._start_session_watcher"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket._start_session_watcher">[docs]</a>    <span class="k">def</span> <span class="nf">_start_session_watcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts up the `SESSION_WATCHER` (assigned to that global)</span>
<span class="sd">        :class:`~tornado.ioloop.PeriodicCallback` that regularly checks for user</span>
<span class="sd">        sessions that have timed out via the :func:`timeout_sessions` function</span>
<span class="sd">        and cleans them up (shuts down associated processes).</span>

<span class="sd">        The interval in which it performs this check is controlled via the</span>
<span class="sd">        `session_timeout_check_interval` setting. This setting is not included</span>
<span class="sd">        in Gate One&#39;s 10server.conf by default but can be added if needed to</span>
<span class="sd">        override the default value of 30 seconds.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;*&quot;: {</span>
<span class="sd">                    &quot;gateone&quot;: {</span>
<span class="sd">                        &quot;session_timeout_check_interval&quot;: &quot;30s&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">SESSION_WATCHER</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SESSION_WATCHER</span> <span class="ow">or</span> <span class="n">restart</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;session_timeout_check_interval&#39;</span><span class="p">,</span> <span class="s2">&quot;30s&quot;</span><span class="p">)</span> <span class="c1"># 30s default</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">total_seconds</span><span class="p">(</span><span class="n">td</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="c1"># milliseconds</span>
            <span class="n">SESSION_WATCHER</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">PeriodicCallback</span><span class="p">(</span>
                <span class="n">timeout_sessions</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">SESSION_WATCHER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="ApplicationWebSocket._start_cleaner"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket._start_cleaner">[docs]</a>    <span class="k">def</span> <span class="nf">_start_cleaner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts up the `CLEANER` (assigned to that global)</span>
<span class="sd">        `~tornado.ioloop.PeriodicCallback` that regularly checks for and</span>
<span class="sd">        deletes expired user logs (e.g. terminal session logs or anything in the</span>
<span class="sd">        `&lt;user_dir&gt;/&lt;user&gt;/logs` dir) and old session directories via the</span>
<span class="sd">        :func:`cleanup_user_logs` and :func:`cleanup_old_sessions` functions.</span>

<span class="sd">        The interval in which it performs this check is controlled via the</span>
<span class="sd">        `cleanup_interval` setting. This setting is not included in Gate One&#39;s</span>
<span class="sd">        10server.conf by default but can be added if needed to override the</span>
<span class="sd">        default value of 5 minutes.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;*&quot;: {</span>
<span class="sd">                    &quot;gateone&quot;: {</span>
<span class="sd">                        &quot;cleanup_interval&quot;: &quot;5m&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">CLEANER</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">CLEANER</span><span class="p">:</span>
            <span class="n">default_interval</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span> <span class="c1"># 5 minutes</span>
            <span class="c1"># NOTE: This interval isn&#39;t in the settings by default because it is</span>
            <span class="c1"># kind of obscure.  No reason to clutter things up.</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;cleanup_interval&#39;</span><span class="p">,</span> <span class="n">default_interval</span><span class="p">)</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="p">((</span>
                <span class="n">td</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">*</span>
                <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">CLEANER</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">PeriodicCallback</span><span class="p">(</span><span class="n">clean_up</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">CLEANER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="ApplicationWebSocket._start_file_watcher"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket._start_file_watcher">[docs]</a>    <span class="k">def</span> <span class="nf">_start_file_watcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts up the :attr:`ApplicationWebSocket.file_watcher`</span>
<span class="sd">        `~tornado.ioloop.PeriodicCallback` (which regularly calls</span>
<span class="sd">        :meth:`ApplicationWebSocket.file_checker` and immediately starts it</span>
<span class="sd">        watching the broadcast file for changes (if not already watching it).</span>

<span class="sd">        The path to the broadcast file defaults to &#39;*settings_dir*/broadcast&#39;</span>
<span class="sd">        but can be changed via the &#39;broadcast_file&#39; setting.  This setting is</span>
<span class="sd">        not included in Gate One&#39;s 10server.conf by default but can be added if</span>
<span class="sd">        needed to overrided the default value.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;*&quot;: {</span>
<span class="sd">                    &quot;gateone&quot;: {</span>
<span class="sd">                        &quot;broadcast_file&quot;: &quot;/some/path/to/broadcast&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        .. tip::</span>

<span class="sd">            You can send messages to all users currently connected to the Gate</span>
<span class="sd">            One server by writing text to the broadcast file.  Example:</span>
<span class="sd">            `sudo echo &quot;Server will be rebooted as part of regularly scheduled</span>
<span class="sd">            maintenance in 5 minutes.  Pleas save your work.&quot; &gt;</span>
<span class="sd">            /tmp/gateone/broadcast`</span>

<span class="sd">        The interval in which it performs this check is controlled via the</span>
<span class="sd">        `file_check_interval` setting. This setting is not included in</span>
<span class="sd">        Gate One&#39;s 10server.conf by default but can be added if needed to</span>
<span class="sd">        override the default value of 5 seconds.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;*&quot;: {</span>
<span class="sd">                    &quot;gateone&quot;: {</span>
<span class="sd">                        &quot;file_check_interval&quot;: &quot;5s&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">broadcast_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">],</span> <span class="s1">&#39;broadcast&#39;</span><span class="p">)</span>
        <span class="n">broadcast_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;broadcast_file&#39;</span><span class="p">,</span> <span class="n">broadcast_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">broadcast_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="p">:</span>
            <span class="c1"># No broadcast file means the file watcher isn&#39;t running</span>
            <span class="n">touch</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;file_check_interval&#39;</span><span class="p">,</span> <span class="s2">&quot;5s&quot;</span><span class="p">)</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="p">((</span>
                <span class="n">td</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">*</span>
                <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">watch_file</span><span class="p">(</span><span class="n">broadcast_file</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">broadcast_file_update</span><span class="p">)</span>
            <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">file_watcher</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">PeriodicCallback</span><span class="p">(</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">file_checker</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">io_loop</span><span class="o">=</span><span class="n">io_loop</span><span class="p">)</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">file_watcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">watched_files</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">watch_file</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">load_prefs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.list_applications"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.list_applications">[docs]</a>    <span class="k">def</span> <span class="nf">list_applications</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client indiciating which applications and</span>
<span class="sd">        sub-applications are available to the user.</span>

<span class="sd">        .. note::</span>

<span class="sd">            What&#39;s the difference between an &quot;application&quot; and a</span>
<span class="sd">            &quot;sub-application&quot;?  An &quot;application&quot; is a `GOApplication` like</span>
<span class="sd">            `app_terminal.TerminalApplication` while a &quot;sub-application&quot; would</span>
<span class="sd">            be something like &quot;SSH&quot; or &quot;nethack&quot; which runs inside the parent</span>
<span class="sd">            application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span><span class="s2">&quot;gateone&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">enabled_applications</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled_applications&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">enabled_applications</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">enabled_applications</span><span class="p">]</span>
        <span class="n">applications</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled_applications</span><span class="p">:</span> <span class="c1"># Load all apps</span>
            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span> <span class="c1"># Use the app&#39;s name attribute</span>
                <span class="n">info_dict</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Make a copy so we can change it</span>
                <span class="n">applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span> <span class="c1"># Use the app&#39;s name attribute</span>
                <span class="n">info_dict</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Make a copy so we can change it</span>
                <span class="k">if</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">enabled_applications</span><span class="p">:</span>
                    <span class="n">applications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info_dict</span><span class="p">)</span>
        <span class="n">applications</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">applications</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:applications&#39;</span><span class="p">:</span> <span class="n">applications</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:set_location` WebSocket action.  Sets</span>
<span class="sd">        ``self.location`` to the given value.</span>

<span class="sd">        This mechanism can be used by applications embedding Gate One to</span>
<span class="sd">        create/control groups of application resources (e.g. terminals) that</span>
<span class="sd">        each reside in unique virtual &#39;locations&#39;.  Use this function to change</span>
<span class="sd">        locations on-the-fly without having to re-authenticate the user.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If this location is new, ``self.locations[*location*]`` will be</span>
<span class="sd">            created automatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;go:set_location&quot;</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">get_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:get_locations` WebSocket action.  Sends a message to</span>
<span class="sd">        the client (via the `go:locations` WebSocket action) with a dict</span>
<span class="sd">        containing location information for the connected user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">location_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">location</span><span class="p">,</span> <span class="n">apps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">location_data</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">location_data</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># This would be something like:</span>
                    <span class="c1">#  location     name     item     metadata</span>
                    <span class="c1"># {&#39;default&#39;: {&#39;terminal&#39; {1: {&#39;title&#39;: &#39;foo&#39;}}}}</span>
                    <span class="n">location_data</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                    <span class="n">location_data</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                    <span class="n">location_data</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span>
                    <span class="n">created</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">created</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="c1"># Convert it to a JavaScript-style timestamp</span>
                        <span class="n">created</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">created</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="n">location_data</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">created</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:locations&#39;</span><span class="p">:</span> <span class="n">location_data</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;go:get_locations&quot;</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">set_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:set_dimensions` WebSocket action.  Sets</span>
<span class="sd">        ``self.dimensions`` to the given *dimensions* which should be a dict::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;width&quot;: 1366,</span>
<span class="sd">                &quot;height&quot;: 768,</span>
<span class="sd">                &quot;workspace_width&quot;: 1337,</span>
<span class="sd">                &quot;workspace_height&quot;: 768</span>
<span class="sd">            }</span>

<span class="sd">        .. note::</span>

<span class="sd">            The idea behind this mechanism is to give applications (e.g. X11) a</span>
<span class="sd">            means to know how big things are at the client so it can size things</span>
<span class="sd">            correctly before sending them to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="n">dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;go:set_dimensions&quot;</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationWebSocket.render_style"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.render_style">[docs]</a>    <span class="k">def</span> <span class="nf">render_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style_path</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renders the CSS template at *style_path* using *kwargs* and returns the</span>
<span class="sd">        path to the rendered result.  If the given style has already been</span>
<span class="sd">        rendered the existing cache path will be returned.</span>

<span class="sd">        If *force* is ``True`` the stylesheet will be rendered even if it</span>
<span class="sd">        already exists (cached).</span>

<span class="sd">        This method also cleans up older versions of the same rendered template.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">style_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">style_path</span> <span class="o">=</span> <span class="n">style_path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">style_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">shortened_path</span> <span class="o">=</span> <span class="n">short_hash</span><span class="p">(</span><span class="n">style_path</span><span class="p">)</span>
        <span class="n">rendered_filename</span> <span class="o">=</span> <span class="s1">&#39;rendered_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shortened_path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
        <span class="n">rendered_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">rendered_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">style_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
                <span class="n">style_path</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="c1"># NOTE: Tornado templates are always rendered as bytes.  That is why</span>
            <span class="c1"># we&#39;re using &#39;wb&#39; below...</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">style_css</span><span class="p">)</span>
            <span class="c1"># Remove older versions of the rendered template if present</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="n">rendered_filename</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">shortened_path</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                    <span class="c1"># Older version present.</span>
                    <span class="c1"># Remove it (and it&#39;s minified counterpart).</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rendered_path</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.get_theme"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.get_theme">[docs]</a>    <span class="k">def</span> <span class="nf">get_theme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the theme stylesheets matching the properties specified in</span>
<span class="sd">        *settings* to the client.  *settings* must contain the following:</span>

<span class="sd">            * **container** - The element Gate One resides in (e.g. &#39;gateone&#39;)</span>
<span class="sd">            * **prefix** - The string being used to prefix all elements (e.g. &#39;go\_&#39;)</span>
<span class="sd">            * **theme** - The name of the CSS theme to be retrieved.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This will send the theme files for all applications and plugins that</span>
<span class="sd">            have a matching stylesheet in their &#39;templates&#39; directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;get_theme(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">send_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;send_css&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send_css</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s1">&#39;logged_css_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;send_css is false; will not send JavaScript.&quot;</span><span class="p">))</span>
            <span class="c1"># So we don&#39;t repeat this message a zillion times in the logs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logged_css_message</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sync Theme: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;theme&#39;</span><span class="p">])</span>
        <span class="n">use_client_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;use_client_cache&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">go_url</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;go_url&#39;</span><span class="p">]</span> <span class="c1"># Used to prefix the url_prefix</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">go_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">go_url</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;container&quot;</span><span class="p">]</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span>
        <span class="n">theme</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span>
        <span class="n">template_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
            <span class="n">url_prefix</span><span class="o">=</span><span class="n">go_url</span><span class="p">,</span>
            <span class="n">embedded</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;embedded&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">theme_mtimes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;theme_mtimes&#39;</span><span class="p">]</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="n">theme_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.css&quot;</span> <span class="o">%</span> <span class="n">theme</span>
        <span class="n">theme_relpath</span> <span class="o">=</span> <span class="s1">&#39;/templates/themes/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">theme_file</span>
        <span class="n">theme_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="n">theme_relpath</span><span class="p">)</span>
        <span class="n">cached_theme_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">theme_file</span><span class="p">)</span>
        <span class="n">filename_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">theme_file</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">theme_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">theme_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theme_path</span><span class="p">)</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">theme_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">modifications</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">theme_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">theme_mtimes</span> <span class="ow">or</span> <span class="n">mtime</span> <span class="o">!=</span> <span class="n">theme_mtimes</span><span class="p">[</span><span class="n">theme_path</span><span class="p">]:</span>
            <span class="n">theme_mtimes</span><span class="p">[</span><span class="n">theme_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime</span>
            <span class="n">modifications</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Now enumerate all applications/plugins looking for their own</span>
        <span class="c1"># implementations of this theme (must have same name)...</span>
        <span class="c1"># Find plugin&#39;s theme-specific CSS files:</span>
        <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">iter_entry_points</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;go_plugins&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">resource_exists</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="n">theme_relpath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c1"># Plugin has an issue or has been removed</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="n">theme_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="n">theme_relpath</span><span class="p">)</span>
                <span class="n">theme_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theme_path</span><span class="p">)</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">theme_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">theme_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">theme_mtimes</span>
                    <span class="ow">or</span> <span class="n">mtime</span> <span class="o">!=</span> <span class="n">theme_mtimes</span><span class="p">[</span><span class="n">theme_path</span><span class="p">]):</span>
                    <span class="n">theme_mtimes</span><span class="p">[</span><span class="n">theme_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime</span>
                    <span class="n">modifications</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Find application&#39;s theme-specific CSS files:</span>
        <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">iter_entry_points</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;go_applications&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">resource_exists</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="n">theme_relpath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c1"># Plugin has an issue or has been removed</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="n">theme_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="n">theme_relpath</span><span class="p">)</span>
                <span class="n">theme_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theme_path</span><span class="p">)</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">theme_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">theme_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">theme_mtimes</span>
                    <span class="ow">or</span> <span class="n">mtime</span> <span class="o">!=</span> <span class="n">theme_mtimes</span><span class="p">[</span><span class="n">theme_path</span><span class="p">]):</span>
                    <span class="n">theme_mtimes</span><span class="p">[</span><span class="n">theme_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime</span>
                    <span class="n">modifications</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c1"># Find application plugin&#39;s theme-specific CSS files</span>
            <span class="n">entry_point</span> <span class="o">=</span> <span class="s1">&#39;go_</span><span class="si">%s</span><span class="s1">_plugins&#39;</span> <span class="o">%</span> <span class="n">ep</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">plugin_ep</span> <span class="ow">in</span> <span class="n">iter_entry_points</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">entry_point</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">exists</span> <span class="o">=</span> <span class="n">resource_exists</span><span class="p">(</span>
                        <span class="n">plugin_ep</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="n">theme_relpath</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c1"># Plugin has an issue or has been removed</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                    <span class="n">theme_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
                        <span class="n">plugin_ep</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="n">theme_relpath</span><span class="p">)</span>
                    <span class="n">theme_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theme_path</span><span class="p">)</span>
                    <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">theme_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">theme_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">theme_mtimes</span>
                        <span class="ow">or</span> <span class="n">mtime</span> <span class="o">!=</span> <span class="n">theme_mtimes</span><span class="p">[</span><span class="n">theme_path</span><span class="p">]):</span>
                        <span class="n">theme_mtimes</span><span class="p">[</span><span class="n">theme_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime</span>
                        <span class="n">modifications</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Grab the modification times for each theme file</span>
        <span class="k">if</span> <span class="n">modifications</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cached_theme_path</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Modification to theme file detected.  &quot;</span>
                <span class="s2">&quot;Theme will be recreated.&quot;</span><span class="p">))</span>
            <span class="c1"># Combine the theme files into one</span>
            <span class="n">rendered_theme_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">template_loaders</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span>
            <span class="c1"># This wierd little bit empties Tornado&#39;s template cache:</span>
            <span class="k">for</span> <span class="n">web_template_path</span> <span class="ow">in</span> <span class="n">template_loaders</span><span class="p">:</span>
                <span class="n">template_loaders</span><span class="p">[</span><span class="n">web_template_path</span><span class="p">]</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">template_file</span> <span class="ow">in</span> <span class="n">theme_files</span><span class="p">:</span>
                <span class="n">rendered_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_style</span><span class="p">(</span>
                    <span class="n">template_file</span><span class="p">,</span> <span class="o">**</span><span class="n">template_args</span><span class="p">)</span>
                <span class="n">rendered_theme_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">)</span>
            <span class="n">new_theme_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">theme_file</span><span class="o">+</span><span class="s1">&#39;.new&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">new_theme_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">rendered_theme_files</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_theme_path</span><span class="p">,</span> <span class="n">cached_theme_path</span><span class="p">)</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">cached_theme_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="c1"># This makes sure that the files are always re-downloaded</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;css&#39;</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">theme_file</span><span class="p">,</span>
            <span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="n">filename_hash</span><span class="p">,</span>
            <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s1">&#39;element_id&#39;</span><span class="p">:</span> <span class="s1">&#39;theme&#39;</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">theme_file</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">cached_theme_path</span><span class="p">,</span>
            <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s1">&#39;element_id&#39;</span><span class="p">:</span> <span class="s1">&#39;theme&#39;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">use_client_cache</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:file_sync&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">(</span>
                <span class="n">filename_hash</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="n">use_client_cache</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.cache_cleanup"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.cache_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cache_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:cache_cleanup` WebSocket action; rifles through the</span>
<span class="sd">        given list of *message[&#39;filenames&#39;]* from the client and sends a</span>
<span class="sd">        `go:cache_expired` WebSocket action to the client with a list of files</span>
<span class="sd">        that no longer exist in `self.file_cache` (so it can clean them up).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cache_cleanup(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
        <span class="n">expired</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename_hash</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">:</span>
                <span class="n">expired</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expired</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;No expired </span><span class="si">%s</span><span class="s2"> files at client </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Requesting deletion of expired files at client </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)))</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:cache_expired&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="c1"># Also clean up stale files in the cache while we&#39;re at it</span>
        <span class="n">newest_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">filename_hash</span><span class="p">,</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_obj</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">newest_files</span><span class="p">:</span>
                <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_obj</span>
                <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s1">&#39;filename_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename_hash</span>
            <span class="k">if</span> <span class="n">file_obj</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s1">&#39;mtime&#39;</span><span class="p">]:</span>
                <span class="c1"># Delete then replace the stale one</span>
                <span class="n">stale_hash</span> <span class="o">=</span> <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s1">&#39;filename_hash&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">stale_hash</span><span class="p">]</span>
                <span class="n">newest_files</span><span class="p">[</span><span class="n">file_obj</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">file_obj</span>
            <span class="k">if</span> <span class="n">file_obj</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">newest_files</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s1">&#39;mtime&#39;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span> <span class="c1"># Stale</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.file_request"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.file_request">[docs]</a>    <span class="k">def</span> <span class="nf">file_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files_or_hash</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:file_request` WebSocket action; minifies, caches,</span>
<span class="sd">        and finally sends the requested file to the client.  If</span>
<span class="sd">        *use_client_cache* is `False` the client will be instructed not to cache</span>
<span class="sd">        the file.  Example message from the client requesting a file:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({</span>
<span class="sd">                &#39;go:file_request&#39;: {&#39;some_file.js&#39;}}));</span>

<span class="sd">        .. note:: In reality &#39;some_file.js&#39; will be a unique/unguessable hash.</span>

<span class="sd">        Optionally, *files_or_hash* may be given as a list or tuple and all the</span>
<span class="sd">        requested files will be sent.</span>

<span class="sd">        Files will be cached after being minified until a file is modified or</span>
<span class="sd">        Gate One is restarted.</span>

<span class="sd">        If the `slimit` module is installed JavaScript files will be minified</span>
<span class="sd">        before being sent to the client.</span>

<span class="sd">        If the `cssmin` module is installed CSS files will be minified before</span>
<span class="sd">        being sent to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;file_request(</span><span class="si">%s</span><span class="s2">, use_client_cache=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">files_or_hash</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files_or_hash</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">filename_hash</span> <span class="ow">in</span> <span class="n">files_or_hash</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">(</span>
                    <span class="n">filename_hash</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="n">use_client_cache</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename_hash</span> <span class="o">=</span> <span class="n">files_or_hash</span>
        <span class="k">if</span> <span class="n">filename_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;File Request Error: File not found ({0})&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename_hash</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename_hash</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">({</span><span class="s1">&#39;go:load_js&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">})</span>
            <span class="k">return</span>
        <span class="c1"># Get the file info out of the file_cache so we can send it</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">][</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Success&#39;</span><span class="p">,</span> <span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="n">filename_hash</span><span class="p">}</span>
        <span class="n">out_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="c1"># Don&#39;t want the client knowing this</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Sending: {0}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">send_file</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Adds our minified data to the out_dict and sends it to the</span>
<span class="sd">            client.  Also adds sourceURL comments if possible.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;js&#39;</span><span class="p">:</span>
                <span class="n">source_url</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="s1">&#39;gateone/applications/&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">application</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;applications/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;plugins&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                        <span class="n">static_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/plugins/&quot;</span> <span class="o">%</span> <span class="n">application</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># e.g. /terminal/ssh/static/</span>
                        <span class="n">source_url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">url_prefix</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">static_path</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">static_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/static/&quot;</span> <span class="o">%</span> <span class="n">application</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">source_url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">/static/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">url_prefix</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">static_path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;gateone/plugins/&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">plugin_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s1">&#39;gateone/plugins/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">static_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/static/&quot;</span> <span class="o">%</span> <span class="n">plugin_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">source_url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">plugins/</span><span class="si">%s</span><span class="s2">/static/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">url_prefix</span><span class="p">,</span> <span class="n">plugin_name</span><span class="p">,</span> <span class="n">static_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">source_url</span><span class="p">:</span>
                    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">//# sourceURL={source_url}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">source_url</span><span class="o">=</span><span class="n">source_url</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:load_js&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;css&#39;</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;css&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># So loadStyleAction() knows what to do</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:load_style&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;theme&#39;</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;theme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:load_theme&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:cache_file&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:cache_file&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">WebSocketClosedError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="k">pass</span> <span class="c1"># WebSocket closed before we got a chance to send this</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;file_request() for: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">get_or_cache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">minify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">send_file</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NOTE: We disable memoization below because get_or_cache() does its</span>
            <span class="c1"># own check to see if processing the file is necessary.</span>
            <span class="n">CPU_ASYNC</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">get_or_cache</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
                           <span class="n">minify</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">send_file</span><span class="p">,</span> <span class="n">memoize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.send_file"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.send_file">[docs]</a>    <span class="k">def</span> <span class="nf">send_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;misc&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tells the client to perform a sync of the file at the given *filepath*.</span>
<span class="sd">        The *kind* should only be one of &#39;html&#39; or &#39;misc&#39; for HTML templates</span>
<span class="sd">        and everything else, respectively.</span>

<span class="sd">        Any additional keyword arguments provided via *metadata* will be</span>
<span class="sd">        stored in the client-side fileCache database.</span>

<span class="sd">        .. note:: This kind of file sending *always* uses the client-side cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;File does not exist: {0}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filepath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">filepath_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># Store the file info in the file_cache just in case we need to</span>
        <span class="c1"># reference the original (non-rendered) path later:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filepath_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">filepath</span><span class="p">,</span>
            <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filepath_hash</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">file_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="n">filepath_hash</span><span class="p">,</span>
            <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span>
        <span class="p">}</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">file_dict</span><span class="p">]}</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:file_sync&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.send_js_or_css"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.send_js_or_css">[docs]</a>    <span class="k">def</span> <span class="nf">send_js_or_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths_or_fileobj</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">requires</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="s2">&quot;screen&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiates a file synchronization of the given *paths_or_fileobj* with</span>
<span class="sd">        the client to ensure it has the latest version of the file(s).</span>

<span class="sd">        The *kind* argument must be one of &#39;js&#39; or &#39;css&#39; to indicate JavaScript</span>
<span class="sd">        or CSS, respectively.</span>

<span class="sd">        Optionally, *element_id* may be provided which will be assigned to the</span>
<span class="sd">        &lt;script&gt; or &lt;style&gt; tag that winds up being created (only works with</span>
<span class="sd">        single files).</span>

<span class="sd">        Optionally, a *requires* string or list/tuple may be given which will</span>
<span class="sd">        ensure that the given file gets loaded after any dependencies.</span>

<span class="sd">        Optionally, a *media* string may be provided to specify the &#39;media=&#39;</span>
<span class="sd">        value when creating a &lt;style&gt; tag to hold the given CSS.</span>

<span class="sd">        Optionally, a *filename* string may be provided which will be used</span>
<span class="sd">        instead of the name of the actual file when file synchronization occurs.</span>
<span class="sd">        This is useful for multi-stage processes (e.g. rendering templates)</span>
<span class="sd">        where you wish to preserve the original filename.  Just be aware that</span>
<span class="sd">        if you do this the given *filename* must be unique.</span>

<span class="sd">        If *force* is ``True`` the file will be synchronized regardless of the</span>
<span class="sd">        &#39;send_js&#39; or &#39;send_css&#39; settings in your global Gate One settings.</span>

<span class="sd">        .. note:</span>

<span class="sd">            If the slimit module is installed it will be used to minify the JS</span>
<span class="sd">            before being sent to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;js&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">send_js</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;send_js&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">send_js</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s1">&#39;logged_js_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;send_js is false; will not send JavaScript.&quot;</span><span class="p">))</span>
                <span class="c1"># So we don&#39;t repeat this message a zillion times in the logs:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logged_js_message</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;css&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">send_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;send_css&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">send_css</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s1">&#39;logged_css_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;send_css is false; will not send CSS.&quot;</span><span class="p">))</span>
                <span class="c1"># So we don&#39;t repeat this message a zillion times in the logs:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logged_css_message</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">use_client_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;use_client_cache&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">requires</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">requires</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">requires</span> <span class="o">=</span> <span class="p">[</span><span class="n">requires</span><span class="p">]</span> <span class="c1"># This makes the logic simpler at the client</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths_or_fileobj</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">paths_or_fileobj</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">file_obj</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_obj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Just in case</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Sync Check: {filename}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
                <span class="n">filename_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
                    <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                    <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                    <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
                    <span class="s1">&#39;element_id&#39;</span><span class="p">:</span> <span class="n">element_id</span><span class="p">,</span>
                    <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">,</span>
                    <span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span> <span class="c1"># NOTE: Ignored if JS</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
                    <span class="c1"># This makes sure that the files are always re-downloaded</span>
                    <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="n">filename_hash</span><span class="p">,</span>
                    <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
                    <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                    <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">,</span>
                    <span class="s1">&#39;element_id&#39;</span><span class="p">:</span> <span class="n">element_id</span><span class="p">,</span>
                    <span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span> <span class="c1"># NOTE: Ignored if JS</span>
                <span class="p">})</span>
            <span class="k">if</span> <span class="n">use_client_cache</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:file_sync&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="n">use_client_cache</span><span class="p">)</span>
            <span class="k">return</span> <span class="c1"># No further processing is necessary</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths_or_fileobj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">paths_or_fileobj</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paths_or_fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Just in case</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">paths_or_fileobj</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">paths_or_fileobj</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Sync check: {filename}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>
        <span class="c1"># NOTE: The .split(&#39;.&#39;) above is so the hash we generate is always the</span>
        <span class="c1"># same.  The tail end of the filename will have its modification date.</span>
        <span class="c1"># Cache the metadata for sync</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;send_js_or_css(</span><span class="si">%s</span><span class="s1">) (mtime: </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;send_js_or_css(): File not found: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="c1"># Use a hash of the filename because these names can get quite long.</span>
        <span class="c1"># Also, we don&#39;t want to reveal the file structure on the server.</span>
        <span class="n">filename_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filename_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
            <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s1">&#39;element_id&#39;</span><span class="p">:</span> <span class="n">element_id</span><span class="p">,</span>
            <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">,</span>
            <span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span> <span class="c1"># NOTE: Ignored if JS</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="c1"># This makes sure that the files are always re-downloaded</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="n">filename_hash</span><span class="p">,</span>
            <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">,</span>
            <span class="s1">&#39;element_id&#39;</span><span class="p">:</span> <span class="n">element_id</span><span class="p">,</span>
            <span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span> <span class="c1"># NOTE: Ignored if JS</span>
        <span class="p">}]}</span>
        <span class="k">if</span> <span class="n">use_client_cache</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:file_sync&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_request</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">use_client_cache</span><span class="o">=</span><span class="n">use_client_cache</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.send_js"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.send_js">[docs]</a>    <span class="k">def</span> <span class="nf">send_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut for ``self.send_js_or_css(path, &#39;js&#39;, **kwargs)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_or_css</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.send_css"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.send_css">[docs]</a>    <span class="k">def</span> <span class="nf">send_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut for ``self.send_js_or_css(path, &#39;css&#39;, **kwargs)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_or_css</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.wrap_and_send_js"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.wrap_and_send_js">[docs]</a>    <span class="k">def</span> <span class="nf">wrap_and_send_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">js_path</span><span class="p">,</span> <span class="n">exports</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wraps the JavaScript code at *js_path* in a (JavaScript) sandbox which</span>
<span class="sd">        exports whatever global variables are provided via *exports* then</span>
<span class="sd">        minifies, caches, and sends the result to the client.</span>

<span class="sd">        The provided *kwargs* will be passed to the</span>
<span class="sd">        `ApplicationWebSocket.send_js` method.</span>

<span class="sd">        The *exports* dict needs to be in the following format::</span>

<span class="sd">            exports = {</span>
<span class="sd">                &quot;global&quot;: &quot;export_name&quot;</span>
<span class="sd">            }</span>

<span class="sd">        For example, if you wanted to use underscore.js but didn&#39;t want to</span>
<span class="sd">        overwrite the global ``_`` variable (if already being used by a parent</span>
<span class="sd">        web application)::</span>

<span class="sd">            exports = {&quot;_&quot;: &quot;GateOne._&quot;}</span>
<span class="sd">            self.wrap_and_send_js(&#39;/path/to/underscore.js&#39;, exports)</span>

<span class="sd">        This would result in the &quot;_&quot; global being exported as &quot;GateOne._&quot;.  In</span>
<span class="sd">        other words, this is what will end up at the bottom of the wrapped</span>
<span class="sd">        JavaScript just before the end of the sandbox:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            window.GateOne._ = _;</span>

<span class="sd">        This method should make it easy to include any given JavaScript library</span>
<span class="sd">        without having to worry (as much) about namespace conflicts.</span>

<span class="sd">        .. note::</span>

<span class="sd">            You don&#39;t have to prefix your export with &#39;GateOne&#39;.  You can export</span>
<span class="sd">            the global with whatever name you like.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">js_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;File does not exist: {0}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">js_path</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">js_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">js_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">script</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">}</span>
        <span class="n">filepath_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
            <span class="n">js_path</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># Store the file info in the file_cache just in case we need to</span>
        <span class="c1"># reference the original (non-rendered) path later:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filepath_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">js_path</span><span class="p">,</span>
            <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">rendered_filename</span> <span class="o">=</span> <span class="s1">&#39;rendered_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filepath_hash</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
        <span class="n">rendered_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">rendered_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">script</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_string</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;templates/libwrapper.js&#39;</span><span class="p">)</span>
        <span class="n">rendered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
            <span class="n">libwrapper</span><span class="p">,</span>
            <span class="n">script</span><span class="o">=</span><span class="n">script</span><span class="p">,</span>
            <span class="n">exports</span><span class="o">=</span><span class="n">exports</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Remove older versions of the rendered template if present</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="n">rendered_filename</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">filepath_hash</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                <span class="c1"># Older version present.</span>
                <span class="c1"># Remove it (and it&#39;s minified counterpart).</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rendered_path</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.render_and_send_css"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.render_and_send_css">[docs]</a>    <span class="k">def</span> <span class="nf">render_and_send_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">css_path</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="s2">&quot;screen&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renders, caches (in the `cache_dir`), and sends a stylesheet template at</span>
<span class="sd">        the given *css_path*.  The template will be rendered with the following</span>
<span class="sd">        keyword arguments::</span>

<span class="sd">            container = self.container</span>
<span class="sd">            prefix = self.prefix</span>
<span class="sd">            url_prefix = self.settings[&#39;url_prefix&#39;]</span>
<span class="sd">            **kwargs</span>

<span class="sd">        Returns the path to the rendered template.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If you want to serve Gate One&#39;s CSS via a different mechanism</span>
<span class="sd">            (e.g. nginx) this functionality can be completely disabled by adding</span>
<span class="sd">            `&quot;send_css&quot;: false` to gateone/settings/10server.conf</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">send_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;send_css&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send_css</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s1">&#39;logged_css_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;send_css is false; will not send CSS.&quot;</span><span class="p">))</span>
            <span class="c1"># So we don&#39;t repeat this message a zillion times in the logs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logged_css_message</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">css_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;File does not exist: {0}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">css_path</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">css_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">css_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">filepath_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">css_path</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># Store the file info in the file_cache just in case we need to</span>
        <span class="c1"># reference the original (non-rendered) path later:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span><span class="p">[</span><span class="n">filepath_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;css&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">css_path</span><span class="p">,</span>
            <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">rendered_filename</span> <span class="o">=</span> <span class="s1">&#39;rendered_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filepath_hash</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
        <span class="n">rendered_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">rendered_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span>
                <span class="n">element_id</span><span class="o">=</span><span class="n">element_id</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="n">media</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">template_loaders</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span>
        <span class="c1"># This wierd little bit empties Tornado&#39;s template cache:</span>
        <span class="k">for</span> <span class="n">web_template_path</span> <span class="ow">in</span> <span class="n">template_loaders</span><span class="p">:</span>
            <span class="n">template_loaders</span><span class="p">[</span><span class="n">web_template_path</span><span class="p">]</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">rendered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
            <span class="n">css_path</span><span class="p">,</span>
            <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
            <span class="n">url_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="n">rendered_path</span><span class="p">,</span>
            <span class="n">element_id</span><span class="o">=</span><span class="n">element_id</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="n">media</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># Remove older versions of the rendered template if present</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="n">rendered_filename</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">filepath_hash</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                <span class="c1"># Older version present.</span>
                <span class="c1"># Remove it (and it&#39;s minified counterpart).</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rendered_path</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.send_plugin_static_files"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.send_plugin_static_files">[docs]</a>    <span class="k">def</span> <span class="nf">send_plugin_static_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends all plugin .js and .css files to the client that exist inside the</span>
<span class="sd">        /static/ directory for given *entry_point*.  The policies that apply to</span>
<span class="sd">        the current user will be used to determine whether and which static</span>
<span class="sd">        files will be sent.</span>

<span class="sd">        If *requires* is given it will be passed along to `self.send_js()`.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If you want to serve Gate One&#39;s JavaScript via a different mechanism</span>
<span class="sd">            (e.g. nginx) this functionality can be completely disabled by adding</span>
<span class="sd">            `&quot;send_js&quot;: false` to gateone/settings/10server.conf</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;send_plugin_static_files(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">entry_point</span><span class="p">)</span>
        <span class="n">send_js</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;send_js&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send_js</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s1">&#39;logged_js_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;send_js is false; will not send JavaScript.&quot;</span><span class="p">))</span>
            <span class="c1"># So we don&#39;t repeat this message a zillion times in the logs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logged_js_message</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">send_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;send_css&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send_css</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s1">&#39;logged_css_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;send_css is false; will not send JavaScript.&quot;</span><span class="p">))</span>
            <span class="c1"># So we don&#39;t repeat this message a zillion times in the logs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logged_css_message</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">application</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">entry_point</span> <span class="o">==</span> <span class="s1">&#39;go_plugins&#39;</span><span class="p">:</span>
            <span class="n">application</span> <span class="o">=</span> <span class="s1">&#39;gateone&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Find the application that this belongs to</span>
            <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">iter_entry_points</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">entry_point</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ep</span><span class="o">.</span><span class="n">module_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gateone.applications&#39;</span><span class="p">):</span>
                    <span class="n">application</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">module_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">break</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">globally_enabled_plugins</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled_plugins&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># This controls the client-side plugins that will be sent</span>
        <span class="n">allowed_client_side_plugins</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_plugins&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># Remove non-globally-enabled plugins from user_plugins (if set)</span>
        <span class="k">if</span> <span class="n">globally_enabled_plugins</span> <span class="ow">and</span> <span class="n">allowed_client_side_plugins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">allowed_client_side_plugins</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">globally_enabled_plugins</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">allowed_client_side_plugins</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">globally_enabled_plugins</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allowed_client_side_plugins</span><span class="p">:</span>
            <span class="n">allowed_client_side_plugins</span> <span class="o">=</span> <span class="n">globally_enabled_plugins</span>
        <span class="c1"># Get the list of plugins</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">entry_point_files</span><span class="p">(</span><span class="n">entry_point</span><span class="p">,</span> <span class="n">allowed_client_side_plugins</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">send_js</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">asset_list</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">asset_list</span><span class="p">:</span>
                    <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">asset</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">js_file_path</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">requires</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">send_css</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">asset_list</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;css&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">asset_list</span><span class="p">:</span>
                    <span class="n">css_file_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">asset</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="n">css_file_path</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">requires</span><span class="p">)</span></div>

<span class="c1"># TODO:  Add support for a setting that can control which themes are visible to users.</span>
<div class="viewcode-block" id="ApplicationWebSocket.enumerate_themes"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.enumerate_themes">[docs]</a>    <span class="k">def</span> <span class="nf">enumerate_themes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a JSON-encoded object containing the installed themes and text</span>
<span class="sd">        color schemes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">themes</span> <span class="o">=</span> <span class="n">resource_listdir</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/templates/themes&#39;</span><span class="p">)</span>
        <span class="c1"># Just in case other junk wound up in that directory:</span>
        <span class="n">themes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">themes</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.css&#39;</span><span class="p">)]</span>
        <span class="n">themes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.css&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">themes</span><span class="p">]</span> <span class="c1"># Just need the names</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:themes_list&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;themes&#39;</span><span class="p">:</span> <span class="n">themes</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.set_locales"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.set_locales">[docs]</a>    <span class="k">def</span> <span class="nf">set_locales</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locales</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the &#39;go:set_locales` WebSocket action; sets</span>
<span class="sd">        ``self.user_locales`` to the given *locales* and calls</span>
<span class="sd">        `ApplicationWebSocket.send_js_translation` to deliver the best-match</span>
<span class="sd">        JSON-encoded translation to the client (if available).</span>

<span class="sd">        The *locales* argument may be a string or a list.  If a string,</span>
<span class="sd">        ``self.user_locales`` will be set to a list with the given locale as the</span>
<span class="sd">        first (and only) item.  If *locales* is a list ``self.user_locales``</span>
<span class="sd">        will simply be replaced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">locales</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">locales</span> <span class="o">=</span> <span class="p">[</span><span class="n">locales</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_locales</span> <span class="o">=</span> <span class="n">locales</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_translation</span><span class="p">()</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.send_js_translation"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.send_js_translation">[docs]</a>    <span class="k">def</span> <span class="nf">send_js_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">locales</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client containing a JSON-encoded table of strings</span>
<span class="sd">        that have been translated to the user&#39;s locale.  The translation file</span>
<span class="sd">        will be retrieved via the `pkg_resources.resource_string` function using</span>
<span class="sd">        the given *package* with a default path (if not given) of,</span>
<span class="sd">        &#39;/i18n/{locale}/LC_MESSAGES/gateone_js.json&#39;.  For example::</span>

<span class="sd">            self.send_js_translation(package=&quot;gateone.plugins.myplugin&quot;)</span>

<span class="sd">        Would result in the `pkg_resources.resource_string` function being</span>
<span class="sd">        called like so::</span>

<span class="sd">            path = &#39;/i18n/{locale}/LC_MESSAGES/gateone_js.json&#39;.format(</span>
<span class="sd">                locale=locale)</span>
<span class="sd">            translation = pkg_resources.resource_string(</span>
<span class="sd">                &quot;gateone.plugins.myplugin&quot;, path)</span>

<span class="sd">        If providing a custom *path* be sure it includes the &#39;{locale}&#39; portion</span>
<span class="sd">        so the correct translation will be chosen.  As an example, your plugin</span>
<span class="sd">        might store locales inside a &#39;translations&#39; directory with each locale</span>
<span class="sd">        JSON translation file named, &#39;&lt;locale&gt;/myplugin.json&#39;.  The correct</span>
<span class="sd">        *path* for that would be: &#39;/translations/{locale}/myplugin.json&#39;</span>

<span class="sd">        If no *locales* (may be list or string) is given the</span>
<span class="sd">        ``self.user_locales`` variable will be used.</span>

<span class="sd">        This method will attempt to find the closest locale if no direct match</span>
<span class="sd">        can be found.  For example, if ``locales==&quot;fr&quot;`` the &#39;fr_FR&#39; locale</span>
<span class="sd">        would be used.  If *locales* is a list, the first matching locale will</span>
<span class="sd">        be used.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Translation files must be the result of a</span>
<span class="sd">            ``pojson /path/to/translation.po`` conversion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gateone.core.locale</span> <span class="kn">import</span> <span class="n">supported_locales</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">locales</span><span class="p">:</span>
            <span class="n">locales</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_locales</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">locales</span><span class="p">:</span> <span class="c1"># Use the server&#39;s locale</span>
            <span class="n">locales</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locale&#39;</span><span class="p">)]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;send_js_translation() locales: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">locales</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">locale</span> <span class="ow">in</span> <span class="n">locales</span><span class="p">:</span>
            <span class="n">locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1"># Example: Converts en-US to en_US</span>
            <span class="k">if</span> <span class="n">locale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;en&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="c1"># Gate One strings are English by default</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/i18n/{locale}/LC_MESSAGES/gateone_js.json&#39;</span>
            <span class="k">if</span> <span class="n">locale</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_locales</span><span class="p">:</span> <span class="c1"># Try next-closest match</span>
                <span class="n">first_part</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Try the first bit</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">supported_locales</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">first_part</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                        <span class="n">locale</span> <span class="o">=</span> <span class="n">l</span>
                        <span class="k">break</span>
            <span class="n">json_translation</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resource_exists</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">json_translation</span><span class="p">):</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span>
                    <span class="n">resource_string</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">json_translation</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:register_translation&#39;</span><span class="p">:</span> <span class="n">decoded</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;No matching translation found for locale: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">locale</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No translation file could not be found for the given &quot;</span>
              <span class="s2">&quot;locales: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">locales</span><span class="p">)</span></div>

<span class="c1"># NOTE: This is not meant to be a chat application.  That&#39;ll come later :)</span>
<span class="c1">#       The real purpose of send_user_message() and broadcast() are for</span>
<span class="c1">#       programmatic use.  For example, when a user shares a terminal and it</span>
<span class="c1">#       would be appropriate to notify certain users that the terminal is now</span>
<span class="c1">#       available for them to connect.</span>
    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">send_user_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the given *settings[&#39;message&#39;]* to the given *settings[&#39;upn&#39;]*.</span>

<span class="sd">        if *upn* is &#39;AUTHENTICATED&#39; all users will get the message.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            var obj = {&quot;message&quot;: &quot;This is a test&quot;, &quot;upn&quot;: &quot;joe@company.com&quot;}</span>
<span class="sd">            GateOne.ws.send(JSON.stringify({&quot;go:send_user_message&quot;: obj}));</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;message&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error: No message to send.&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error: Missing UPN.&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;upn&quot;</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;User Message: {0}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]),</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">],</span> <span class="n">upn</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;go:send_user_message&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationWebSocket.send_message"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.send_message">[docs]</a>    <span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the given *message* to the client using the `go:user_message`</span>
<span class="sd">        WebSocket action at the currently-connected client.</span>

<span class="sd">        If *upn* is provided the *message* will be sent to all users with a</span>
<span class="sd">        matching &#39;upn&#39; value.</span>

<span class="sd">        If *session* is provided the message will be sent to all users with a</span>
<span class="sd">        matching session ID.  This is useful in situations where all users share</span>
<span class="sd">        the same &#39;upn&#39; (i.e. ANONYMOUS).</span>

<span class="sd">        if *upn* is &#39;AUTHENTICATED&#39; all users will get the message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:user_message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">upn</span><span class="p">:</span>
            <span class="n">ApplicationWebSocket</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message_dict</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="n">upn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">ApplicationWebSocket</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message_dict</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Just send to the currently-connected client</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;go:send_message&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `go:broadcast` WebSocket action; sends the given</span>
<span class="sd">        *message* (string) to all connected, authenticated users.  Example</span>
<span class="sd">        usage:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({&quot;go:broadcast&quot;: &quot;This is a test&quot;}));</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Broadcast: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">strip_xss</span> <span class="c1"># Prevent XSS attacks</span>
        <span class="n">message</span><span class="p">,</span> <span class="n">bad_tags</span> <span class="o">=</span> <span class="n">strip_xss</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="s2">&quot;entities&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="s2">&quot;AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;go:broadcast&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">list_server_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of users currently connected to the Gate One server to</span>
<span class="sd">        the client via the &#39;go:user_list&#39; WebSocket action.  Only users with the</span>
<span class="sd">        &#39;list_users&#39; policy are allowed to execute this action.  Example:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({&quot;go:list_users&quot;: null}));</span>

<span class="sd">        That would send a JSON message to the client like so::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;go:user_list&quot;: [</span>
<span class="sd">                    {&quot;upn&quot;: &quot;user@enterprise&quot;, &quot;ip_address&quot;: &quot;10.0.1.11&quot;},</span>
<span class="sd">                    {&quot;upn&quot;: &quot;bsmith@enterprise&quot;, &quot;ip_address&quot;: &quot;10.0.2.15&quot;}</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span><span class="o">.</span><span class="n">_list_connected_users</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;list_server_users(): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">users</span><span class="p">))</span>
        <span class="c1"># Remove things that users should not see such as their session ID</span>
        <span class="n">filtered_users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">allowed_fields</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_list_fields&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="c1"># If not set, just strip the session ID</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_fields</span><span class="p">:</span>
            <span class="n">allowed_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;upn&#39;</span><span class="p">,</span> <span class="s1">&#39;ip_address&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span> <span class="c1"># Broadcast client (view-only situation)</span>
                <span class="k">continue</span>
            <span class="n">user_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">allowed_fields</span><span class="p">:</span>
                    <span class="n">user_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">filtered_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_dict</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:user_list&#39;</span><span class="p">:</span> <span class="n">filtered_users</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;go:user_list&#39;</span><span class="p">,</span> <span class="n">filtered_users</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket._deliver"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket._deliver">[docs]</a>    <span class="k">def</span> <span class="nf">_deliver</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="s2">&quot;AUTHENTICATED&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the given *message* (string) to all users matching *upn* using</span>
<span class="sd">        the write_message() function.  If *upn* is not provided or is</span>
<span class="sd">        &quot;AUTHENTICATED&quot;, will send the *message* to all users.</span>

<span class="sd">        Alternatively a *session* ID may be specified instead of a *upn*.  This</span>
<span class="sd">        is useful when more than one user shares a UPN (i.e. ANONYMOUS).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_deliver(</span><span class="si">%s</span><span class="s2">, upn=</span><span class="si">%s</span><span class="s2">, session=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="p">,</span> <span class="n">session</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="c1"># Only send to users that have authenticated</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">current_user</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">WebSocketClosedError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">session</span> <span class="ow">and</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">upn</span> <span class="o">==</span> <span class="s2">&quot;AUTHENTICATED&quot;</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">upn</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upn&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ApplicationWebSocket._list_connected_users"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket._list_connected_users">[docs]</a>    <span class="k">def</span> <span class="nf">_list_connected_users</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple of user objects representing the users that are</span>
<span class="sd">        currently connected (and authenticated) to this Gate One server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_list_connected_users()&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="c1"># We only care about authenticated users</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">current_user</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<div class="viewcode-block" id="ApplicationWebSocket.license_info"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ApplicationWebSocket.license_info">[docs]</a>    <span class="k">def</span> <span class="nf">license_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the contents of the `__license_info__` dict to the client as</span>
<span class="sd">        a JSON-encoded message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">licenses</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__license_info__</span><span class="p">)</span>
        <span class="c1"># Remove the signatures so the license can&#39;t be copied by clients</span>
        <span class="k">for</span> <span class="n">license</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">licenses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;signature&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;signature_method&#39;</span><span class="p">]</span> <span class="c1"># No need to send this either</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;license_format&#39;</span><span class="p">]</span>   <span class="c1"># Ditto</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:license_info&#39;</span><span class="p">:</span> <span class="n">licenses</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Imports Python&#39;s Garbage Collection module (gc) and displays various</span>
<span class="sd">        information about the current state of things inside of Gate One.</span>

<span class="sd">        .. note:: Can only be called from a JavaScript console like so...</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({&#39;go:debug&#39;: null}));</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Making a debug-specific logger but logging using info() so that</span>
        <span class="c1"># the log messages show up even if I don&#39;t have logging set to debug.</span>
        <span class="c1"># Since this debugging function is only ever called manually there&#39;s no</span>
        <span class="c1"># need to use debug() logging.</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;upn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span>
            <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span>
        <span class="p">}</span>
        <span class="n">debug_logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s2">&quot;gateone.debugging&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">gc</span>
        <span class="c1">#gc.set_debug(gc.DEBUG_UNCOLLECTABLE|gc.DEBUG_OBJECTS)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_UNCOLLECTABLE</span> <span class="o">|</span> <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_INSTANCES</span> <span class="o">|</span> <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_OBJECTS</span><span class="p">)</span>
        <span class="c1"># Using pprint for some things below instead of the logger because they</span>
        <span class="c1"># just won&#39;t look right if they go to the logs.</span>
        <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">garbage</span><span class="p">)</span>
        <span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Debug: gc.collect(): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">garbage</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SESSIONS:&quot;</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">SESSIONS</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PERSIST:&quot;</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">PERSIST</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pympler</span> <span class="kn">import</span> <span class="n">asizeof</span>
            <span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Debug: Size of SESSIONS dict: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">asizeof</span><span class="o">.</span><span class="n">asizeof</span><span class="p">(</span><span class="n">SESSIONS</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># No biggie</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># NOTE: For this Heapy stuff to work best you have to make more then</span>
            <span class="c1"># one call to this function (just do it at regular intervals).</span>
            <span class="kn">from</span> <span class="nn">guppy</span> <span class="kn">import</span> <span class="n">hpy</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hp&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">hpy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">setrelheap</span><span class="p">()</span> <span class="c1"># We only want to track NEW stuff</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Heap:&quot;</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">heap</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="c1"># Uncomment this to troubleshoot memory leaks.  If any exist this</span>
            <span class="c1"># loop will shine a light on them:</span>
            <span class="c1">#print(&quot;Heap Details (up to top 10):&quot;)</span>
            <span class="c1">#for i in range(10):</span>
                <span class="c1">#try:</span>
                    <span class="c1">#print(h.byrcs[i].byid)</span>
                <span class="c1">#except IndexError:</span>
                    <span class="c1">#break</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Oh well</span></div>

<div class="viewcode-block" id="ErrorHandler"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.ErrorHandler">[docs]</a><span class="k">class</span> <span class="nc">ErrorHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates an error response with status_code for all requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_error_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Server&#39;</span><span class="p">,</span> <span class="s1">&#39;GateOne&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;License&#39;</span><span class="p">,</span> <span class="n">__license__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s2">&quot;static_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">403</span><span class="p">]:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;static_url&#39;</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.html&#39;</span> <span class="o">%</span> <span class="n">status_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="kn">import</span> <span class="nn">httplib</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;html&gt;&lt;title&gt;</span><span class="si">%(code)d</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&lt;/title&gt;&quot;</span> \
           <span class="s2">&quot;&lt;body class=&#39;bodyErrorPage&#39;&gt;</span><span class="si">%(code)d</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&lt;/body&gt;&lt;/html&gt;&quot;</span> <span class="o">%</span> <span class="p">{</span>
               <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
               <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">status_code</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">)</span></div>

<span class="k">class</span> <span class="nc">GateOneApp</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup our Tornado application...  Everything in *settings* will wind up</span>
<span class="sd">        in the Tornado settings dict so as to be accessible under self.settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Base settings for our Tornado app</span>
        <span class="n">static_url</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/static&#39;</span><span class="p">)</span>
        <span class="n">tornado_settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">cookie_secret</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cookie_secret&#39;</span><span class="p">],</span>
            <span class="n">static_url</span><span class="o">=</span><span class="n">static_url</span><span class="p">,</span>
            <span class="n">static_url_prefix</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">static/&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">],</span>
            <span class="n">gzip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">auth&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Make sure all the provided settings wind up in self.settings</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tornado_settings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># Setup the configured authentication type</span>
        <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">NullAuthHandler</span> <span class="c1"># Default</span>
        <span class="k">if</span> <span class="s1">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;kerberos&#39;</span> <span class="ow">and</span> <span class="n">KerberosAuthHandler</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">KerberosAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pam&#39;</span> <span class="ow">and</span> <span class="n">PAMAuthHandler</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">PAMAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;google&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">GoogleAuthHandler</span>
                <span class="k">if</span> <span class="s1">&#39;google_oauth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tornado_settings</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s1">&#39;In order to use Google authentication you must create &#39;</span>
                        <span class="s1">&#39;a Google project for your installation and add:</span><span class="se">\n\t</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;{&quot;google_oauth&quot;: {&quot;key&quot;: &quot;&lt;YOUR CLIENT ID&gt;&quot;, &quot;secret&quot;:&#39;</span>
                        <span class="s1">&#39; &quot;&lt;YOUR CLIENT SECRET&gt;&quot;}} to your &#39;</span>
                        <span class="s1">&#39;20authentication.conf (under the &quot;gateone&quot; section).&#39;</span><span class="p">))</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s1">&#39;To create a Google auth client ID and secret go to: &#39;</span>
                        <span class="s1">&#39;https://console.developers.google.com/ and click on &#39;</span>
                        <span class="s1">&#39;&quot;APIs and Auth&quot;.  Then click &quot;Create New Client ID&quot;.&#39;</span>
                        <span class="s1">&#39; Set the &quot;JavaScript Origins&quot; value to your Gate One &#39;</span>
                        <span class="s1">&#39;server</span><span class="se">\&#39;</span><span class="s1">s address and the &quot;Redirect URIs&quot; to https://&#39;</span>
                        <span class="s1">&#39;&lt;your Gate One server FQDN&gt;/auth&#39;</span><span class="p">))</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s1">&#39;For example, if your &quot;JavaScript Origins&quot; is: &#39;</span>
                        <span class="s1">&#39;https://gateone.example.com/&#39;</span><span class="p">))</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s1">&#39;Your &quot;Redirect URIs&quot; would be: &#39;</span>
                        <span class="s1">&#39;https://gateone.example.com/auth&#39;</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cas&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">CASAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ssl&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">SSLAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;api&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">APIAuthHandler</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Using </span><span class="si">%s</span><span class="s2"> authentication&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auth_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;No authentication method configured. All users will be &quot;</span>
                <span class="s2">&quot;ANONYMOUS&quot;</span><span class="p">))</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/docs/build/html&#39;</span><span class="p">)</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url_prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="c1"># Make sure there&#39;s a trailing slash</span>
            <span class="n">url_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span>
        <span class="c1"># Make the / optional in the regex so it works with the @addslash</span>
        <span class="c1"># decorator.  e.g. &quot;/whatever/&quot; would become &quot;/whatever/?&quot;</span>
        <span class="n">index_regex</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">?&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span>
        <span class="c1"># Setup our URL handlers</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">index_regex</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">r&quot;</span><span class="si">%s</span><span class="s2">ws&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span>
                <span class="n">ApplicationWebSocket</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">apps</span><span class="o">=</span><span class="n">APPLICATIONS</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">r&quot;</span><span class="si">%s</span><span class="s2">auth&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">AuthHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">r&quot;</span><span class="si">%s</span><span class="s2">downloads/(.*)&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">DownloadHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">r&quot;</span><span class="si">%s</span><span class="s2">docs/(.*)&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">docs_path</span><span class="p">,</span>
                <span class="s2">&quot;default_filename&quot;</span><span class="p">:</span> <span class="s2">&quot;index.html&quot;</span>
            <span class="p">})</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;web_handlers&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">handler_tuple</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;web_handlers&#39;</span><span class="p">]:</span>
                <span class="n">regex</span> <span class="o">=</span> <span class="n">handler_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">handler_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">handler_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1"># No kwargs for this handler</span>
                <span class="c1"># Make sure the regex is prefix with the url_prefix</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">regex</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span>
                    <span class="n">regex</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_prefix</span><span class="p">,</span> <span class="n">regex</span><span class="p">)</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">regex</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="c1"># Override the default static handler to ensure the headers are set</span>
        <span class="c1"># to allow cross-origin requests.</span>
        <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">r&quot;</span><span class="si">%s</span><span class="s2">static/(.*)&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">StaticHandler</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">static_url</span><span class="p">}</span>
        <span class="p">))</span>
        <span class="c1"># Hook up the hooks</span>
        <span class="k">for</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;Web&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c1"># Apply the plugin&#39;s Web handlers</span>
                <span class="n">fixed_hooks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Web&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Web&#39;</span><span class="p">]:</span>
                        <span class="c1"># h == (regex, Handler)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span> <span class="c1"># Fix it</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">url_prefix</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Web&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span> <span class="c1"># Fix it</span>
                        <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Web&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">url_prefix</span> <span class="o">+</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Web&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
                            <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Web&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Web&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Web&#39;</span><span class="p">])</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fixed_hooks</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;Init&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c1"># Call the plugin&#39;s initialization functions</span>
                <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Init&#39;</span><span class="p">](</span><span class="n">tornado_settings</span><span class="p">)</span>
        <span class="c1"># Include JS-only and CSS-only plugins (for logging purposes)</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">PLUGINS</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="n">PLUGINS</span><span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="n">PLUGINS</span><span class="p">[</span><span class="s1">&#39;css&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># NOTE: JS and CSS files are normally sent after the user authenticates</span>
        <span class="c1">#       via ApplicationWebSocket.send_plugin_static_files()</span>
        <span class="c1"># Add static handlers for all the JS plugins (primarily for source URLs)</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="s2">r&quot;</span><span class="si">%s</span><span class="s2">plugins/</span><span class="si">%s</span><span class="s2">/static/(.*)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">url_path</span><span class="p">,</span> <span class="n">StaticHandler</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s1">&#39;/static/&#39;</span><span class="p">,</span> <span class="s1">&#39;use_pkg&#39;</span><span class="p">:</span> <span class="n">plugin</span><span class="p">}</span>
            <span class="p">))</span>
        <span class="c1"># This removes duplicate handlers for the same regex, allowing plugins</span>
        <span class="c1"># to override defaults:</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="n">merge_handlers</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Loaded global plugins: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins</span><span class="p">))</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="p">,</span> <span class="o">**</span><span class="n">tornado_settings</span><span class="p">)</span>

<div class="viewcode-block" id="validate_authobj"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.validate_authobj">[docs]</a><span class="k">def</span> <span class="nf">validate_authobj</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the &#39;validate_authobj&#39; CLI command.  Takes a JSON object as the only</span>
<span class="sd">    argument (must be inside single quotes) and validates the singature using</span>
<span class="sd">    the same mechanism as `ApplicationWebSocket.api_auth`.  Example usage:</span>

<span class="sd">    .. ansi-block::</span>

<span class="sd">        \x1b[1;34muser\x1b[0m@modern-host\x1b[1;34m:~ $\x1b[0m gateone validate_authobj &#39;{&quot;upn&quot;: &quot;jdoe@company.com&quot;, &quot;signature_method&quot;: &quot;HMAC-SHA1&quot;, &quot;timestamp&quot;: &quot;1409266590093&quot;, &quot;signature&quot;: &quot;004464e27db90180a4b87b50b00dd77420052b6d&quot;, &quot;api_key&quot;: &quot;NGQxNTVjZWEzMmM1NDBmNGI5MzYwNTM3ZDY0MzZiNTczY&quot;, &quot;api_version&quot;: &quot;1.0&quot;}&#39;</span>
<span class="sd">        API Authentication Successful!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">create_signature</span>
    <span class="k">if</span> <span class="s1">&#39;--help&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Usage: gateone validate_authobj &#39;&lt;JSON auth object&gt;&#39;&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="o">*</span><span class="n">messages</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[1;31mError:</span><span class="se">\x1b</span><span class="s2">[0m {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\x1b</span><span class="s2">[1;31mAPI Authentication Failed!</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Checking: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">auth_obj</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_obj</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">auth_obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Not valid JSON: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">auth_obj</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">all_settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
    <span class="n">go_settings</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span>
    <span class="c1"># Validate all required values are present</span>
    <span class="n">required_keys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;api_key&#39;</span><span class="p">,</span> <span class="s1">&#39;api_version&#39;</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">,</span>
        <span class="s1">&#39;signature_method&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;upn&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">auth_obj</span><span class="p">:</span>
            <span class="n">missing_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You appear to be missing the following keys from your JSON &quot;</span>
                <span class="s2">&quot;object: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">api_keys</span> <span class="o">=</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_keys&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_keys</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You don&#39;t appear to have any API keys configured.&quot;</span><span class="p">),</span>
             <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Tip: You can create them on-demand via: gateone --new_api_key&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;api_key&#39;</span><span class="p">]</span>
    <span class="n">upn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">])</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span> <span class="c1"># str in case integer</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">]</span>
    <span class="n">signature_method</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;signature_method&#39;</span><span class="p">]</span>
    <span class="n">api_version</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s1">&#39;api_version&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">api_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">api_keys</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The given API key (</span><span class="si">%s</span><span class="s2">) was not found.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">api_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">secret</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The given API key (</span><span class="si">%s</span><span class="s2">) has no secret!&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">api_key</span><span class="p">,</span>
             <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Your api_keys setting is probably not in the correct format.&quot;</span><span class="p">),</span>
             <span class="n">_</span><span class="p">(</span><span class="s1">&#39;The correct format is {&quot;api_keys&quot;: {&quot;&lt;API key&gt;&quot;:&quot;&lt;secret&gt;&quot;}}&#39;</span><span class="p">),</span>
             <span class="n">_</span><span class="p">(</span><span class="s2">&quot;It is recommended that you run &#39;gateone --new_api_key&#39; and &quot;</span>
               <span class="s2">&quot;modify (or at least look at) the resulting 30api_keys.conf&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">supported_hmacs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;HMAC-SHA1&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">,</span>
        <span class="s1">&#39;HMAC-SHA256&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span>
        <span class="s1">&#39;HMAC-SHA384&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha384</span><span class="p">,</span>
        <span class="s1">&#39;HMAC-SHA512&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">signature_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_hmacs</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;API AUTH: Unsupported API auth signature method: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="o">%</span> <span class="n">signature_method</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">hmac_algo</span> <span class="o">=</span> <span class="n">supported_hmacs</span><span class="p">[</span><span class="n">signature_method</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">api_version</span> <span class="o">!=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;API AUTH: Unsupported API version: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">api_version</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Everything checked out OK so we can try validating the signature now...</span>
    <span class="n">sig_check</span> <span class="o">=</span> <span class="n">create_signature</span><span class="p">(</span>
        <span class="n">secret</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">upn</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span>
        <span class="n">hmac_algo</span><span class="o">=</span><span class="n">supported_hmacs</span><span class="p">[</span><span class="n">signature_method</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">sig_check</span> <span class="o">!=</span> <span class="n">signature</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;The generated signature (</span><span class="si">%s</span><span class="s2">) does not match what was provided in &quot;</span>
            <span class="s2">&quot;the given auth object (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">sig_check</span><span class="p">,</span> <span class="n">signature</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[1;32mAPI Authentication Successful!</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="install_license"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.install_license">[docs]</a><span class="k">def</span> <span class="nf">install_license</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the &#39;install_license&#39; CLI command.  Just installs the license at the</span>
<span class="sd">    path given via `sys.argv[1]` (first argument after the &#39;install_license&#39;</span>
<span class="sd">    command).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;--help&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Usage: {0} /path/to/license.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">shutil</span>
    <span class="c1"># Give it a unique filename in case they&#39;re installing more than one</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;license</span><span class="si">%s</span><span class="s1">.conf&#39;</span> <span class="o">%</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span>
    <span class="n">install_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">license_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># In case ~</span>
    <span class="n">license_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">license_path</span><span class="p">)</span> <span class="c1"># In case $HOME (or similar)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">install_path</span><span class="p">):</span>
        <span class="n">yesno</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;A license file is already installed.  Are you sure you want to &quot;</span>
            <span class="s2">&quot;replace it? (y/n) &quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">yesno</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;YES&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">license_path</span><span class="p">,</span> <span class="n">install_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Error: Could not copy license (permission denied).&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} has been installed ({1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">license_path</span><span class="p">,</span> <span class="n">install_path</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="validate_licenses"><a class="viewcode-back" href="../../../Developer/server.html#gateone.core.server.validate_licenses">[docs]</a><span class="k">def</span> <span class="nf">validate_licenses</span><span class="p">(</span><span class="n">licenses</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a *licenses* dict, logs and removes any licenses that have expired or</span>
<span class="sd">    have invalid signatures.  It then sets the `__license_info__` global with</span>
<span class="sd">    the updated dict.  Example license dict::</span>

<span class="sd">        {</span>
<span class="sd">            &quot;11252c41-d3cd-45b7-929b-4a3baedcc152&quot;: {</span>
<span class="sd">                &quot;product&quot;: &quot;gateone&quot;,</span>
<span class="sd">                &quot;customer&quot;: &quot;ACME, Inc&quot;,</span>
<span class="sd">                &quot;users&quot;: 250,</span>
<span class="sd">                &quot;expires&quot;: 1441071222,</span>
<span class="sd">                &quot;license_format&quot;: &quot;1.0&quot;,</span>
<span class="sd">                &quot;signature&quot;: &quot;&lt;gobbledygook&gt;&quot;,</span>
<span class="sd">                &quot;signature_method&quot;: &quot;secp256k1&quot;</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">    .. note::</span>

<span class="sd">        Signatures will be validated against Liftoff Software&#39;s public key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If you wish to defraud Liftoff Software (and your users) in regards to</span>
    <span class="c1"># licensing just uncomment this line:</span>
    <span class="c1"># return True</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pyelliptic</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Could not import pyelliptic which is required to validate &quot;</span>
            <span class="s2">&quot;licenses.  Please install it:  sudo pip install pyelliptic&quot;</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Or you could just download it: &quot;</span>
            <span class="s2">&quot;https://github.com/yann2192/pyelliptic&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pubkey</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">b</span><span class="s1">&#39;</span><span class="se">\x02\xca\x00</span><span class="s1"> J</span><span class="se">\xd9\xbb\x16</span><span class="s1">(_ d</span><span class="se">\x03\xf6\xc2\x9d</span><span class="s1">c</span><span class="se">\xea</span><span class="s1">]</span><span class="se">\xef\x19</span><span class="s1">).5?*#.&#39;</span>
        <span class="n">b</span><span class="s1">&#39;</span><span class="se">\xc6\x9c</span><span class="s1">p</span><span class="se">\xb0</span><span class="s1">G</span><span class="se">\x82\xab\x9e\x00</span><span class="s1"> W</span><span class="se">\xa1</span><span class="s1">t</span><span class="se">\xc1</span><span class="s1">;</span><span class="se">\x08\xd7</span><span class="s1">8</span><span class="se">\x97\x1f\xfa\xe4</span><span class="s1">&#39;</span>
        <span class="n">b</span><span class="s1">&#39;</span><span class="se">\xc7</span><span class="s1">H5</span><span class="se">\x0f</span><span class="s1">+</span><span class="se">\xbc</span><span class="s1">G</span><span class="se">\x8a\xb6\xf6</span><span class="s1">^</span><span class="se">\xf5</span><span class="s1">N</span><span class="se">\xdd\xdf</span><span class="s1">m</span><span class="se">\xe0</span><span class="s1">V</span><span class="se">\xaa</span><span class="s1">r&#39;</span><span class="p">)</span>
    <span class="n">new_licenses</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">licenses</span><span class="p">)</span>
    <span class="n">ecc</span> <span class="o">=</span> <span class="n">pyelliptic</span><span class="o">.</span><span class="n">ECC</span><span class="p">(</span><span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="s1">&#39;secp256k1&#39;</span><span class="p">)</span> <span class="c1"># Same as Bitcoin</span>
    <span class="n">ignore_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;signature&quot;</span><span class="p">,</span> <span class="s2">&quot;signature_method&quot;</span><span class="p">,</span> <span class="s2">&quot;license_format&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">license</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">licenses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Signatures are generated/validated using a concatenated string of all</span>
        <span class="c1"># keys in the license&#39;s dict in lexicographical order.</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">validated</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Make a combined string to validate the signature against:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">combined</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;expires&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;License for &#39;{product}&#39; has expired: {license}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">product</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">],</span> <span class="n">license</span><span class="o">=</span><span class="n">license</span><span class="p">))</span>
            <span class="n">validated</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;signature&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">validated</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ecc</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">combined</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;License has an invalid signature: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">license</span><span class="p">)</span>
            <span class="n">validated</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">validated</span><span class="p">:</span> <span class="c1"># Show a helpful warning message about soon-to-expires</span>
            <span class="n">thirty_days_from_now</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">2592000</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;expires&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">thirty_days_from_now</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;License for &#39;{product}&#39; will expire in less than 30 days: &quot;</span>
                    <span class="s2">&quot;{license}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">product</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">],</span> <span class="n">license</span><span class="o">=</span><span class="n">license</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validated</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">new_licenses</span><span class="p">[</span><span class="n">license</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">new_licenses</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All Gate One licenses are valid and up-to-date.&quot;</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">__license_info__</span>
        <span class="n">__license_info__</span> <span class="o">=</span> <span class="n">new_licenses</span></div>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">installed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_</span>
    <span class="k">global</span> <span class="n">PLUGINS</span>
    <span class="k">global</span> <span class="n">APPLICATIONS</span>
    <span class="n">cli_commands</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gateone&#39;</span><span class="p">:</span> <span class="p">{}}</span> <span class="c1"># CLI commands provided by plugins/apps</span>
    <span class="n">define_options</span><span class="p">(</span><span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">,</span> <span class="n">cli_commands</span><span class="o">=</span><span class="n">cli_commands</span><span class="p">)</span>
    <span class="c1"># Before we do anything else we need the get the settings_dir argument (if</span>
    <span class="c1"># given) so we can make sure we&#39;re handling things accordingly.</span>
    <span class="n">settings_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span> <span class="c1"># Set the default</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--settings_dir&#39;</span><span class="p">):</span>
            <span class="n">settings_dir</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;--help&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="c1"># Try to create it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
               <span class="s2">&quot;Could not find/create settings directory at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">settings_dir</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">all_settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SettingsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># The error will be logged to stdout inside all_settings</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">enabled_plugins</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">enabled_applications</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cli_commands</span><span class="p">[</span><span class="s1">&#39;gateone&#39;</span><span class="p">][</span><span class="s1">&#39;broadcast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">broadcast_message</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Broadcast messages to users connected to Gate One.&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">cli_commands</span><span class="p">[</span><span class="s1">&#39;gateone&#39;</span><span class="p">][</span><span class="s1">&#39;install_license&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">install_license</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Install a commercial license for Gate One.&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">cli_commands</span><span class="p">[</span><span class="s1">&#39;gateone&#39;</span><span class="p">][</span><span class="s1">&#39;validate_authobj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">validate_authobj</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Test API authentication by validating a JSON auth object.&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">go_settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">log_fail_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
        <span class="s2">&quot;You probably want to provide a different destination via &quot;</span>
        <span class="s2">&quot;--log_file_prefix=/path/to/gateone.log&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;gateone&#39;</span> <span class="ow">in</span> <span class="n">all_settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]:</span>
        <span class="c1"># The check above will fail in first-run situations</span>
        <span class="n">enabled_plugins</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;enabled_plugins&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">enabled_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">enabled_plugins</span><span class="p">]</span>
        <span class="n">enabled_applications</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;enabled_applications&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">enabled_applications</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">enabled_applications</span><span class="p">]</span>
        <span class="n">go_settings</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;log_file_prefix&#39;</span> <span class="ow">in</span> <span class="n">go_settings</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;log_file_prefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
                <span class="n">log_path</span> <span class="o">=</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;log_file_prefix&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">bytes</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># Python 2</span>
                    <span class="n">log_path</span> <span class="o">=</span> <span class="n">log_path</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span> <span class="c1"># Make it str</span>
                <span class="n">options</span><span class="o">.</span><span class="n">log_file_prefix</span> <span class="o">=</span> <span class="n">log_path</span>
                <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;log_file_prefix&#39;</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mkdir_p</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not create log directory: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">log_dir</span><span class="p">))</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">log_fail_msg</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;log_file_prefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log_file_prefix</span><span class="p">)</span> <span class="c1"># Try the default</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not create log directory: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">log_dir</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">log_fail_msg</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">PLUGINS</span> <span class="o">=</span> <span class="n">entry_point_files</span><span class="p">(</span><span class="s1">&#39;go_plugins&#39;</span><span class="p">,</span> <span class="n">enabled_plugins</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">PLUGINS</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span> <span class="n">module</span><span class="o">.</span><span class="n">hooks</span><span class="p">})</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;commands&#39;</span><span class="p">):</span>
                <span class="n">cli_commands</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;gateone&#39;</span><span class="p">:</span> <span class="n">module</span><span class="o">.</span><span class="n">commands</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># No hooks--probably just a supporting .py file.</span>
    <span class="c1"># NOTE: entry_point_files() imports all the .py files in applications.  This</span>
    <span class="c1"># means that applications can place calls to tornado.options.define()</span>
    <span class="c1"># anywhere in their .py files and they should automatically be usable by the</span>
    <span class="c1"># user at this point in the startup process.</span>
    <span class="n">app_modules</span> <span class="o">=</span> <span class="n">entry_point_files</span><span class="p">(</span>
        <span class="s1">&#39;go_applications&#39;</span><span class="p">,</span> <span class="n">enabled_applications</span><span class="p">)[</span><span class="s1">&#39;py&#39;</span><span class="p">]</span>
    <span class="c1"># Check if the user is running a command as opposed to passing arguments</span>
    <span class="c1"># so we can set the log_file_prefix to something innocuous so as to prevent</span>
    <span class="c1"># IOError exceptions from Tornado&#39;s parse_command_line() below...</span>
    <span class="k">if</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">log_file_prefix</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># Make sure</span>
    <span class="c1"># Having parse_command_line() after loading applications in case an</span>
    <span class="c1"># application has additional calls to define().</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not write to the log: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">log_file_prefix</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">log_fail_msg</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># NOTE: Here&#39;s how settings/command line args works:</span>
    <span class="c1">#       * The &#39;options&#39; object gets set from the arguments on the command</span>
    <span class="c1">#         line (parse_command_line() above).</span>
    <span class="c1">#       * &#39;go_settings&#39; gets set from the stuff in the &#39;settings_dir&#39;</span>
    <span class="c1">#       * Once both are parsed (on their own) we overwrite &#39;go_settings&#39;</span>
    <span class="c1">#         with what was given on the command line.</span>
    <span class="c1">#       * Once &#39;go_settings&#39; has been adjusted we overwrite &#39;options&#39; with</span>
    <span class="c1">#         any settings that directly correlate with command line options.</span>
    <span class="c1">#         This ensures that the &#39;options&#39; object (which controls Tornado&#39;</span>
    <span class="c1">#         settings) gets the stuff from &#39;settings_dir&#39; if not provided on</span>
    <span class="c1">#         the command line.</span>
    <span class="c1"># TODO: Add a way for applications/plugins to add to this list:</span>
    <span class="n">non_options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># These are things that don&#39;t really belong in settings</span>
        <span class="s1">&#39;new_api_key&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;kill&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;combine_js&#39;</span><span class="p">,</span> <span class="s1">&#39;combine_css&#39;</span><span class="p">,</span>
        <span class="s1">&#39;combine_css_container&#39;</span>
    <span class="p">]</span>
    <span class="c1"># Figure out which options are being overridden on the command line</span>
    <span class="n">apply_cli_overrides</span><span class="p">(</span><span class="n">go_settings</span><span class="p">)</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">licenses</span> <span class="o">=</span> <span class="n">all_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;licenses&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">licenses</span><span class="p">:</span>
        <span class="n">validate_licenses</span><span class="p">(</span><span class="n">licenses</span><span class="p">)</span>
    <span class="c1"># TODO: Get this outputting installed plugins and versions as well</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[1mGate One:</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Version: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__version__</span><span class="p">,</span> <span class="n">__commit__</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[1mInstalled Applications:</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">app_modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;apps&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">_app</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_app</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">_app</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">ver</span> <span class="o">=</span> <span class="n">_app</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
                            <span class="c1"># It&#39;s a function; grab its output (cool feature)</span>
                            <span class="n">ver</span> <span class="o">=</span> <span class="n">ver</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2"> Version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ver</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Turn any API keys provided on the command line into a dict</span>
    <span class="n">api_keys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;api_keys&#39;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">api_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">api_keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">api_key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">bytes</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
                    <span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
                <span class="n">api_keys</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">api_key</span><span class="p">:</span> <span class="n">secret</span><span class="p">})</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;api_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_keys</span>
    <span class="c1"># Setting the log level using go_settings requires an additional step:</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;NONE&#39;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">APPLICATIONS</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Replace it with a list of actual class instances</span>
    <span class="n">web_handlers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Convert the old server.conf to the new settings file format and save it</span>
    <span class="c1"># as a number of distinct .conf files to keep things better organized.</span>
    <span class="c1"># NOTE: This logic will go away some day as it only applies when moving from</span>
    <span class="c1">#       Gate One 1.1 (or older) to newer versions.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="n">convert_old_server_conf</span>
        <span class="n">convert_old_server_conf</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;gateone&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]:</span>
        <span class="c1"># User has yet to create a 10server.conf (or equivalent)</span>
        <span class="n">all_settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Will be filled out below</span>
    <span class="c1"># If you want any missing config file entries re-generated just delete the</span>
    <span class="c1"># cookie_secret line...</span>
    <span class="k">if</span> <span class="s1">&#39;cookie_secret&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">go_settings</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;cookie_secret&#39;</span><span class="p">]:</span>
        <span class="c1"># Generate a default 10server.conf with a random cookie secret</span>
        <span class="c1"># NOTE: This will also generate a new 10server.conf if it is missing.</span>
        <span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="n">generate_server_conf</span>
        <span class="n">generate_server_conf</span><span class="p">(</span><span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">)</span>
        <span class="c1"># Make sure these values get updated</span>
        <span class="n">all_settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="n">go_settings</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">app_modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;apps&#39;</span><span class="p">):</span>
                <span class="n">APPLICATIONS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">apps</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">):</span>
                <span class="n">module</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">all_settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;web_handlers&#39;</span><span class="p">):</span>
                <span class="n">web_handlers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">web_handlers</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;commands&#39;</span><span class="p">):</span>
                <span class="n">cli_commands</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span> <span class="n">module</span><span class="o">.</span><span class="n">commands</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># No apps--probably just a supporting .py file.</span>
            <span class="c1"># Uncomment if you can&#39;t figure out why your app isn&#39;t loading:</span>
            <span class="c1">#print(&quot;Error initializing module: %s&quot; % module)</span>
            <span class="c1">#import traceback</span>
            <span class="c1">#traceback.print_exc(file=sys.stdout)</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="n">print_help</span>
        <span class="n">print_help</span><span class="p">(</span><span class="n">cli_commands</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">commands</span><span class="p">:</span> <span class="c1"># Optional CLI functionality provided by plugins/applications</span>
        <span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="n">parse_commands</span>
        <span class="n">parsed_commands</span> <span class="o">=</span> <span class="n">parse_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">flattened_commands</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">cmds</span> <span class="ow">in</span> <span class="n">cli_commands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">command_dict</span> <span class="ow">in</span> <span class="n">cmds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">flattened_commands</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">command_dict</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]})</span>
        <span class="k">for</span> <span class="n">command</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parsed_commands</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">command</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flattened_commands</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unknown CLI command: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flattened_commands</span><span class="p">[</span><span class="n">command</span><span class="p">](</span><span class="n">commands</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">__license__</span> <span class="o">==</span> <span class="s2">&quot;AGPLv3&quot;</span><span class="p">:</span>
        <span class="n">agplv3_url</span> <span class="o">=</span> <span class="s1">&#39;http://www.gnu.org/licenses/agpl-3.0.html&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Gate One License: {0} ({1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">__license__</span><span class="p">,</span> <span class="n">agplv3_url</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Gate One License: {license} (Max Users: {users}, &quot;</span>
            <span class="s2">&quot;Version: {version})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">license</span><span class="o">=</span><span class="n">__license_info__</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">],</span>
                <span class="n">users</span><span class="o">=</span><span class="n">__license_info__</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">],</span>
                <span class="n">version</span><span class="o">=</span><span class="n">__license_info__</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">]))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Imported applications: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">APPLICATIONS</span><span class="p">]))))</span>
    <span class="c1"># Change the uid/gid strings into integers</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pwd</span>
        <span class="c1"># Assume it&#39;s a username and grab its uid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">pw_uid</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The configured &#39;uid&#39; ({0}) does not exist.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">grp</span>
        <span class="c1"># Assume it&#39;s a group name and grab its gid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">gr_gid</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The configured &#39;gid&#39; ({0}) does not exist.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">]))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Running as non-root; set uid/gid to the current user</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Running as non-root; will not drop privileges.&quot;</span><span class="p">))</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">]):</span> <span class="c1"># Make our user_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pwd</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Gate One could not create </span><span class="si">%s</span><span class="s2">.  Please ensure that user,&quot;</span>
                <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> has permission to create this directory or create it &quot;</span>
                <span class="s2">&quot;yourself and make user, </span><span class="si">%s</span><span class="s2"> its owner.&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">],</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]))))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># If we could create it we should be able to adjust its permissions:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_write_permissions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">]):</span>
        <span class="c1"># Try correcting this first</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recursive_chown</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Failed to recursively change permissions of user_dir: </span><span class="si">%s</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;uid: </span><span class="si">%s</span><span class="s2">, gid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">]):</span> <span class="c1"># Make our session_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Error: Gate One could not create </span><span class="si">%s</span><span class="s2">.  Please ensure that user,&quot;</span>
                <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> has permission to create this directory or create it &quot;</span>
                <span class="s2">&quot;yourself and make user, </span><span class="si">%s</span><span class="s2"> its owner.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">],</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]))))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_write_permissions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">]):</span>
        <span class="c1"># Try correcting it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recursive_chown</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;session_dir: </span><span class="si">%s</span><span class="s2">, uid: </span><span class="si">%s</span><span class="s2">, gid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Re-do the locale in case the user supplied something as --locale</span>
    <span class="n">server_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">])</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">server_locale</span><span class="o">.</span><span class="n">translate</span> <span class="c1"># Also replaces our wrapper so no more .encode()</span>
    <span class="c1"># Create the log dir if not already present (NOTE: Assumes we&#39;re root)</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;log_file_prefix&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;NONE&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[1;31mERROR:</span><span class="se">\x1b</span><span class="s2">[0m Could not create </span><span class="si">%s</span><span class="s2"> for &quot;</span>
                    <span class="s2">&quot;log_file_prefix: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;log_file_prefix&#39;</span><span class="p">]</span>
                <span class="p">)))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;You probably want to change this option, run Gate &quot;</span>
                    <span class="s2">&quot;One as root, or create that directory and give the proper &quot;</span>
                    <span class="s2">&quot;user ownership of it.&quot;</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_write_permissions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">):</span>
            <span class="c1"># Try to correct it</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">recursive_chown</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;log_dir: </span><span class="si">%s</span><span class="s2">, uid: </span><span class="si">%s</span><span class="s2">, gid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Now fix the permissions on each log (no need to check)</span>
        <span class="k">for</span> <span class="n">log_file</span> <span class="ow">in</span> <span class="n">LOGS</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_file</span><span class="p">):</span>
                <span class="n">touch</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">recursive_chown</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;log_file: </span><span class="si">%s</span><span class="s2">, uid: </span><span class="si">%s</span><span class="s2">, gid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_dir</span><span class="p">,</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">new_api_key</span><span class="p">:</span>
        <span class="c1"># Generate a new API key for an application to use and save it to</span>
        <span class="c1"># settings/30api_keys.conf.</span>
        <span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="n">RUDict</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="c1"># Generate a new secret</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="n">api_keys_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">,</span> <span class="s1">&#39;30api_keys.conf&#39;</span><span class="p">)</span>
        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">api_key</span><span class="p">:</span> <span class="n">secret</span><span class="p">}</span>
        <span class="n">api_keys</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">({</span><span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gateone&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;api_keys&quot;</span><span class="p">:</span> <span class="p">{}}}})</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">):</span>
            <span class="n">api_keys</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">)</span>
        <span class="n">api_keys</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gateone&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;api_keys&quot;</span><span class="p">:</span> <span class="n">new_keys</span><span class="p">}}})</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conf</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                <span class="s2">u&quot;// This file contains the key and secret pairs used by Gate &quot;</span>
                <span class="s2">u&quot;One&#39;s API authentication method.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">api_keys</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">u&quot;A new API key has been generated: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">api_key</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">u&quot;This key can now be used to embed Gate One into other &quot;</span>
            <span class="s2">u&quot;applications.&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">combine_js</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="n">combine_javascript</span>
        <span class="n">combine_javascript</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">combine_js</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">combine_css</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="n">combine_css</span>
        <span class="n">combine_css</span><span class="p">(</span>
            <span class="n">options</span><span class="o">.</span><span class="n">combine_css</span><span class="p">,</span>
            <span class="n">options</span><span class="o">.</span><span class="n">combine_css_container</span><span class="p">,</span>
            <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Display the version in case someone sends in a log for for support</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Version: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__version__</span><span class="p">,</span> <span class="n">__commit__</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Tornado version </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tornado_version</span><span class="p">))</span>
    <span class="c1"># Set our global session timeout</span>
    <span class="k">global</span> <span class="n">TIMEOUT</span>
    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_timeout&#39;</span><span class="p">])</span>
    <span class="c1"># Fix the url_prefix if the user forgot the trailing slash</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
    <span class="c1"># Convert the origins into a list if overridden via the command line</span>
    <span class="k">if</span> <span class="s1">&#39;origins&#39;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">origins</span><span class="p">:</span>
            <span class="n">origins</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">origins</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="n">real_origins</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">origins</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;://&#39;</span> <span class="ow">in</span> <span class="n">origin</span><span class="p">:</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">origin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">real_origins</span><span class="p">:</span>
                    <span class="n">real_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
            <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;origins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_origins</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s2">&quot;Connections to this server will be allowed from the following&quot;</span>
        <span class="s2">&quot; origins: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;origins&#39;</span><span class="p">]))</span>
    <span class="c1"># Normalize certain settings</span>
    <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;api_timestamp_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;api_timestamp_window&#39;</span><span class="p">])</span>
    <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">none_fix</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">])</span>
    <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;settings_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_dir</span>
    <span class="c1"># Check to make sure we have a certificate and keyfile and generate fresh</span>
    <span class="c1"># ones if not.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;disable_ssl&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;keyfile&#39;</span><span class="p">]):</span>
            <span class="n">ssl_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;keyfile&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ssl_base</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mkdir_p</span><span class="p">(</span><span class="n">ssl_base</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Gate One could not create {ssl_base} ({e}). &quot;</span>
                        <span class="s2">&quot;Are you using the correct --settings_dir?&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ssl_base</span><span class="o">=</span><span class="n">ssl_base</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;No SSL private key found.  One will be generated.&quot;</span><span class="p">))</span>
            <span class="n">gen_self_signed_ssl</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">ssl_base</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;certificate&#39;</span><span class="p">]):</span>
            <span class="n">ssl_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;certificate&#39;</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;No SSL certificate found.  One will be generated.&quot;</span><span class="p">))</span>
            <span class="n">gen_self_signed_ssl</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">ssl_base</span><span class="p">)</span>
    <span class="c1"># When logging==&quot;debug&quot; it will display all user&#39;s keystrokes so make sure</span>
    <span class="c1"># we warn about this.</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Logging is set to DEBUG.  Be aware that this will record the &quot;</span>
            <span class="s2">&quot;keystrokes of all users.  Don&#39;t be evil!&quot;</span><span class="p">))</span>
    <span class="n">ssl_auth</span> <span class="o">=</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ssl_auth&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ssl_auth</span> <span class="o">==</span> <span class="s1">&#39;required&#39;</span><span class="p">:</span>
        <span class="c1"># Convert to an integer using the ssl module</span>
        <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
    <span class="k">elif</span> <span class="n">ssl_auth</span> <span class="o">==</span> <span class="s1">&#39;optional&#39;</span><span class="p">:</span>
        <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
    <span class="c1"># Instantiate our Tornado web server</span>
    <span class="n">ssl_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;certfile&quot;</span><span class="p">:</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;certificate&#39;</span><span class="p">],</span>
        <span class="s2">&quot;keyfile&quot;</span><span class="p">:</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;keyfile&#39;</span><span class="p">],</span>
        <span class="s2">&quot;cert_reqs&quot;</span><span class="p">:</span> <span class="n">cert_reqs</span>
    <span class="p">}</span>
    <span class="n">ca_certs</span> <span class="o">=</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ca_certs&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ca_certs</span><span class="p">:</span>
        <span class="n">ssl_options</span><span class="p">[</span><span class="s1">&#39;ca_certs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca_certs</span>
    <span class="n">disable_ssl</span> <span class="o">=</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disable_ssl&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">disable_ssl</span><span class="p">:</span>
        <span class="n">proto</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span>
        <span class="n">ssl_options</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proto</span> <span class="o">=</span> <span class="s2">&quot;https://&quot;</span>
    <span class="c1"># Fill out our settings with command line args if any are missing</span>
    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">non_options</span><span class="p">:</span>
            <span class="k">continue</span> <span class="c1"># These don&#39;t belong</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">go_settings</span><span class="p">:</span>
            <span class="n">go_settings</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
    <span class="n">https_server</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span>
        <span class="n">GateOneApp</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">go_settings</span><span class="p">,</span> <span class="n">web_handlers</span><span class="o">=</span><span class="n">web_handlers</span><span class="p">),</span>
        <span class="n">ssl_options</span><span class="o">=</span><span class="n">ssl_options</span><span class="p">)</span>
    <span class="n">https_redirect</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span>
        <span class="p">[(</span><span class="s2">r&quot;.*&quot;</span><span class="p">,</span> <span class="n">HTTPSRedirectHandler</span><span class="p">),],</span>
        <span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
        <span class="n">url_prefix</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">ErrorHandler</span> <span class="o">=</span> <span class="n">ErrorHandler</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pam&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;PAM authentication is configured but you are not running Gate&quot;</span>
                <span class="s2">&quot; One as root.  If the pam_service you&#39;ve selected (</span><span class="si">%s</span><span class="s2">) is &quot;</span>
                <span class="s2">&quot;configured to use pam_unix.so for &#39;auth&#39; (i.e. authenticating &quot;</span>
                <span class="s2">&quot;against /etc/passwd and /etc/shadow) Gate One will not be able&quot;</span>
                <span class="s2">&quot; to authenticate all users.  It will only be able to &quot;</span>
                <span class="s2">&quot;authenticate the user that owns the gateone.py process.&quot;</span> <span class="o">%</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;pam_service&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">configure</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Gate One has been configured.&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span> <span class="c1"># Start your engines!</span>
        <span class="k">if</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enable_unix_socket&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">https_server</span><span class="o">.</span><span class="n">add_socket</span><span class="p">(</span>
                <span class="n">tornado</span><span class="o">.</span><span class="n">netutil</span><span class="o">.</span><span class="n">bind_unix_socket</span><span class="p">(</span>
                    <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;unix_socket_path&#39;</span><span class="p">],</span>
                    <span class="c1"># Tornado uses octal encoding</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;unix_socket_mode&#39;</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Listening on Unix socket &#39;{socketpath}&#39; ({socketmode})&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                  <span class="n">socketpath</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;unix_socket_path&#39;</span><span class="p">],</span>
                  <span class="n">socketmode</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;unix_socket_mode&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">))</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">none_fix</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">address</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">addr</span><span class="p">:</span> <span class="c1"># Listen on all given addresses</span>
                    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;https_redirect&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;disable_ssl&#39;</span><span class="p">]:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s2">&quot;You have https_redirect *and* disable_ssl enabled.&quot;</span>
                            <span class="s2">&quot;  Please pick one or the other.&quot;</span><span class="p">))</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s2">&quot;http://{addr}:80/ will be redirected to...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
                        <span class="p">))</span>
                        <span class="n">https_redirect</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Listening on {proto}{address}:{port}/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">proto</span><span class="o">=</span><span class="n">proto</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
                    <span class="p">))</span>
                    <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">address</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># Listen on all addresses (including IPv6)</span>
            <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;https_redirect&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;disable_ssl&#39;</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;You have https_redirect *and* disable_ssl enabled.&quot;</span>
                        <span class="s2">&quot;  Please pick one or the other.&quot;</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;http://*:80/ will be redirected to...&quot;</span><span class="p">))</span>
                <span class="n">https_redirect</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Listening on {proto}*:{port}/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">proto</span><span class="o">=</span><span class="n">proto</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])))</span>
            <span class="k">try</span><span class="p">:</span> <span class="c1"># Listen on all IPv4 and IPv6 addresses</span>
                <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span> <span class="c1"># Fall back to all IPv4 addresses</span>
                <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">)</span>
        <span class="c1"># NOTE:  To have Gate One *not* listen on a TCP/IP address you may set</span>
        <span class="c1">#        address=None</span>
        <span class="c1"># Check to see what group owns /dev/pts and use that for supl_groups</span>
        <span class="c1"># First we have to make sure there&#39;s at least one pty present</span>
        <span class="n">tempfd1</span><span class="p">,</span> <span class="n">tempfd2</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
        <span class="c1"># Now check the owning group (doesn&#39;t matter which one so we use 0)</span>
        <span class="n">ptm</span> <span class="o">=</span> <span class="s1">&#39;/dev/ptm&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/dev/ptm&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;/dev/ptmx&#39;</span>
        <span class="n">tty_gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">ptm</span><span class="p">)</span><span class="o">.</span><span class="n">st_gid</span>
        <span class="c1"># Close our temmporary pty/fds so we&#39;re not wasting them</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">tempfd1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">tempfd2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">():</span>
            <span class="n">drop_privileges</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="p">[</span><span class="n">tty_gid</span><span class="p">])</span>
        <span class="k">global</span> <span class="n">CPU_ASYNC</span>
        <span class="k">global</span> <span class="n">IO_ASYNC</span>
        <span class="n">IO_ASYNC</span> <span class="o">=</span> <span class="n">ThreadedRunner</span><span class="p">()</span>
        <span class="n">cores</span> <span class="o">=</span> <span class="n">go_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multiprocessing_workers&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cores</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cores</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">cores</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">cores</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Multiprocessing is disabled.  Performance will be sub-optimal.&quot;</span>
            <span class="p">))</span>
            <span class="n">CPU_ASYNC</span> <span class="o">=</span> <span class="n">IO_ASYNC</span> <span class="c1"># Use threading instead</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">CPU_ASYNC</span> <span class="o">=</span> <span class="n">MultiprocessRunner</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">cores</span><span class="p">)</span>
                <span class="n">CPU_ASYNC</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">memoize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># Perform a realistic test</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="c1"># System doesn&#39;t support multiprocessing (for whatever reason).</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Multiprocessing is not functional on this system.  &quot;</span>
                    <span class="s2">&quot;Threading for all async calls.&quot;</span><span class="p">))</span>
                <span class="n">CPU_ASYNC</span> <span class="o">=</span> <span class="n">IO_ASYNC</span> <span class="c1"># Fall back to using threading</span>
        <span class="nd">@atexit.register</span>
        <span class="k">def</span> <span class="nf">shutdown_async</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Shuts down our asynchronous processes/threads.  Specifically, calls</span>
<span class="sd">            ``CPU_ASYNC.shutdown()`` and ``IO_ASYNC.shutdown()``.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Shutting down asynchronous processes/threads...&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">CPU_ASYNC</span> <span class="o">!=</span> <span class="n">IO_ASYNC</span><span class="p">:</span>
                <span class="n">CPU_ASYNC</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">IO_ASYNC</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">write_pid</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">read_pid</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Process running with pid &quot;</span> <span class="o">+</span> <span class="n">pid</span><span class="p">))</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">errno</span><span class="o">,</span> <span class="nn">pwd</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="p">:</span> <span class="n">address</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0&quot;</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EADDRINUSE</span><span class="p">:</span> <span class="c1"># Address/port already in use</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Could not listen on {address}:{port} (address:port is already &quot;</span>
                <span class="s2">&quot;in use by another application).&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;User &#39;{user}&#39; does not have permission to create a process &quot;</span>
                <span class="s2">&quot;listening on {address}:{port}.  Typically only root can use &quot;</span>
                <span class="s2">&quot;ports &lt; 1024.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
                    <span class="n">port</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;An error was encountered trying to listen on &quot;</span>
                <span class="s2">&quot;{address}:{port}...&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Exception was: {0}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span> <span class="c1"># ctrl-c</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Caught KeyboardInterrupt.  Killing sessions...&quot;</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Clearing cache_dir: {0}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">],</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">remove_pid</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;pid file removed.&quot;</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Liftoff Software Corporation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script type="text/javascript">
window.onload = function(e) {
    // Make our collapseindex elements actually collapsible
    $('<span class="collapsindextitle">Index</span> <a class="showhide">[show]</a>').insertBefore('.collapseindex');
    $('.showhide').each(function(index, value){
        var showHide = $(this);
        showHide.click(function() {
            if (this.innerHTML == "[hide]") {
                this.innerHTML = "[show]";
            } else {
                this.innerHTML = "[hide]";
            }
            $(this).next('.collapseindex').toggle(1); // This should always be the next .collapseindex element
        });
    });
    $('.collapseindex').each(function(index, value){
        // Start them out hidden
        $(this).hide();
    });
}
</script>


</body>
</html>