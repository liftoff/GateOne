

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29645087-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>app_terminal &mdash; Gate One 1.2.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.png"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/ansi.css" type="text/css" />
  

  
    <link rel="top" title="Gate One 1.2.0 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Gate One
          

          
          </a>

          
            
            
              <div class="version">
                1.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../About/index.html">About Gate One</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Applications/index.html">Gate One Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developer/index.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ReleaseNotes/index.html">Release Notes / Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Gate One</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>app_terminal</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for app_terminal</h1><div class="highlight"><pre>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1">#       Copyright 2013 Liftoff Software Corporation</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="n">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">A Gate One Application (`GOApplication`) that provides a terminal emulator.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Meta</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;1.2&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;AGPLv3 or Proprietary (see LICENSE.txt)&quot;</span>
<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>

<span class="c1"># Standard library imports</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">atexit</span><span class="o">,</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="c1"># Pseudo stdlib</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_filename</span><span class="p">,</span> <span class="n">resource_listdir</span><span class="p">,</span> <span class="n">resource_string</span>

<span class="c1"># Gate One imports</span>
<span class="kn">from</span> <span class="nn">gateone</span> <span class="kn">import</span> <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="n">SESSIONS</span>
<span class="kn">from</span> <span class="nn">gateone.core.server</span> <span class="kn">import</span> <span class="n">StaticHandler</span><span class="p">,</span> <span class="n">BaseHandler</span><span class="p">,</span> <span class="n">GOApplication</span>
<span class="kn">from</span> <span class="nn">gateone.core.server</span> <span class="kn">import</span> <span class="n">ApplicationWebSocket</span>
<span class="kn">from</span> <span class="nn">gateone.auth.authorization</span> <span class="kn">import</span> <span class="n">require</span><span class="p">,</span> <span class="n">authenticated</span>
<span class="kn">from</span> <span class="nn">gateone.auth.authorization</span> <span class="kn">import</span> <span class="n">applicable_policies</span><span class="p">,</span> <span class="n">policies</span>
<span class="kn">from</span> <span class="nn">gateone.core.configuration</span> <span class="kn">import</span> <span class="n">get_settings</span><span class="p">,</span> <span class="n">RUDict</span>
<span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">cmd_var_swap</span><span class="p">,</span> <span class="n">json_encode</span><span class="p">,</span> <span class="n">generate_session_id</span>
<span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">entry_point_files</span>
<span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">process_opt_esc_sequence</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">MimeTypeFail</span>
<span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">short_hash</span><span class="p">,</span> <span class="n">create_data_uri</span><span class="p">,</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">gateone.core.locale</span> <span class="kn">import</span> <span class="n">get_translation</span>
<span class="kn">from</span> <span class="nn">gateone.core.log</span> <span class="kn">import</span> <span class="n">go_logger</span><span class="p">,</span> <span class="n">string_to_syslog_facility</span>
<span class="kn">from</span> <span class="nn">gateone.applications.terminal.logviewer</span> <span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">logviewer_main</span>
<span class="kn">from</span> <span class="nn">gateone.applications.terminal.policy</span> <span class="kn">import</span> <span class="n">terminal_policies</span>

<span class="c1"># 3rd party imports</span>
<span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="kn">import</span> <span class="n">json_decode</span>
<span class="kn">from</span> <span class="nn">tornado.options</span> <span class="kn">import</span> <span class="n">options</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span> <span class="n">Error</span>

<span class="c1"># Globals</span>
<span class="n">REGISTERED_HANDLERS</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># So we don&#39;t accidentally re-add handlers</span>
<span class="n">web_handlers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Assigned in init()</span>

<span class="c1"># Localization support</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">get_translation</span><span class="p">()</span>

<span class="c1"># Terminal-specific command line options.  These become options you can pass to</span>
<span class="c1"># gateone.py (e.g. --session_logging)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;session_logging&#39;</span><span class="p">):</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s2">&quot;session_logging&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">group</span><span class="o">=</span><span class="s1">&#39;terminal&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;If enabled, logs of user sessions will be saved in &quot;</span>
                <span class="s2">&quot;&lt;user_dir&gt;/&lt;user&gt;/logs.  Default: Enabled&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span> <span class="c1"># This is an easy way to support cetralized logging</span>
        <span class="s2">&quot;syslog_session_logging&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">group</span><span class="o">=</span><span class="s1">&#39;terminal&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;If enabled, logs of user sessions will be written to syslog.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s2">&quot;dtach&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">group</span><span class="o">=</span><span class="s1">&#39;terminal&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Wrap terminals with dtach. Allows sessions to be resumed even &quot;</span>
                <span class="s2">&quot;if Gate One is stopped and started (which is a sweet feature).&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s2">&quot;kill&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">group</span><span class="o">=</span><span class="s1">&#39;terminal&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Kill any running Gate One terminal processes including dtach&#39;d &quot;</span>
                <span class="s2">&quot;processes.&quot;</span><span class="p">)</span>
    <span class="p">)</span>

<div class="viewcode-block" id="kill_session"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.kill_session">[docs]</a><span class="k">def</span> <span class="nf">kill_session</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">kill_dtach</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Terminates all the terminal processes associated with *session*.  If</span>
<span class="sd">    *kill_dtach* is True, the dtach processes associated with the session will</span>
<span class="sd">    also be killed.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This function gets appended to the</span>
<span class="sd">        `SESSIONS[session][&quot;kill_session_callbacks&quot;]` list inside of</span>
<span class="sd">        :meth:`TerminalApplication.authenticate`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">term_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s2">&quot;gateone.terminal&quot;</span><span class="p">)</span>
    <span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;kill_session(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kill_dtach</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">kill_dtached_proc</span>
    <span class="k">for</span> <span class="n">location</span><span class="p">,</span> <span class="n">apps</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s1">&#39;locations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s1">&#39;locations&#39;</span><span class="p">][</span><span class="n">location</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="n">apps</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">loc</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                    <span class="n">loc</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">kill_dtach</span><span class="p">:</span>
                    <span class="n">kill_dtached_proc</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span></div>

<div class="viewcode-block" id="timeout_session"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.timeout_session">[docs]</a><span class="k">def</span> <span class="nf">timeout_session</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attached to Gate One&#39;s &#39;timeout_callbacks&#39;; kills the given session.</span>

<span class="sd">    If &#39;dtach&#39; support is enabled the dtach processes associated with the</span>
<span class="sd">    session will also be killed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kill_session</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">kill_dtach</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<span class="nd">@atexit.register</span>
<span class="k">def</span> <span class="nf">quit</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">killall</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Error</span><span class="p">:</span> <span class="c1"># options.Error</span>
        <span class="k">return</span> <span class="c1"># Bad command line options provided--let the parent handle it</span>
    <span class="k">if</span> <span class="n">commands</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
        <span class="c1"># Don&#39;t call killall() if the user is invoking gateone --help or a</span>
        <span class="c1"># CLI command like &#39;broadcast&#39; or &#39;termlog&#39;</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">dtach</span><span class="p">:</span>
        <span class="c1"># If we&#39;re not using dtach play it safe by cleaning up any leftover</span>
        <span class="c1"># processes.  When passwords are used with the ssh_conenct.py script</span>
        <span class="c1"># it runs os.setsid() on the child process which means it won&#39;t die</span>
        <span class="c1"># when Gate One is closed.  This is primarily to handle that</span>
        <span class="c1"># specific situation.</span>
        <span class="n">killall</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">pid_file</span><span class="p">)</span>

<span class="c1"># NOTE:  THE BELOW IS A WORK IN PROGRESS</span>
<div class="viewcode-block" id="SharedTermHandler"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.SharedTermHandler">[docs]</a><span class="k">class</span> <span class="nc">SharedTermHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renders shared.html which allows an anonymous user to view a shared</span>
<span class="sd">    terminal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">share_id</span><span class="p">):</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;prefs&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">gateone_js</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">static/gateone.js&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">minified_js_abspath</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/gateone.min.js&#39;</span><span class="p">)</span>
        <span class="c1"># Use the minified version if it exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">minified_js_abspath</span><span class="p">):</span>
            <span class="n">gateone_js</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">static/gateone.min.js&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">index_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/templates/share.html&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">index_path</span><span class="p">,</span>
            <span class="n">share_id</span><span class="o">=</span><span class="n">share_id</span><span class="p">,</span>
            <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>
            <span class="n">gateone_js</span><span class="o">=</span><span class="n">gateone_js</span><span class="p">,</span>
            <span class="n">url_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">],</span>
            <span class="n">prefs</span><span class="o">=</span><span class="n">prefs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TermStaticFiles"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TermStaticFiles">[docs]</a><span class="k">class</span> <span class="nc">TermStaticFiles</span><span class="p">(</span><span class="n">StaticHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Serves static files in the `gateone/applications/terminal/static` directory.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This is configured via the `web_handlers` global (a feature inherent to</span>
<span class="sd">        Gate One applications).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="TerminalApplication"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication">[docs]</a><span class="k">class</span> <span class="nc">TerminalApplication</span><span class="p">(</span><span class="n">GOApplication</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Gate One Application (`GOApplication`) that handles creating and</span>
<span class="sd">    controlling terminal applications running on the Gate One server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Terminal&quot;</span><span class="p">,</span>
        <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">__version__</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s2">&quot;Open terminals running any number of configured applications.&quot;</span><span class="p">),</span>
        <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;terminal.js&#39;</span><span class="p">,</span> <span class="s1">&#39;terminal_input.js&#39;</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Terminal&quot;</span> <span class="c1"># A user-friendly name that will be displayed to the user</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TerminalApplication.__init__(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">ws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Gets set in authenticate() below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># So we can keep track and avoid sending unnecessary messages:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">em_dimensions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">race_check</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;application&#39;</span><span class="p">:</span> <span class="s1">&#39;terminal&#39;</span><span class="p">}</span>
        <span class="n">GOApplication</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">)</span>

<div class="viewcode-block" id="TerminalApplication.initialize"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the WebSocket is instantiated, sets up our WebSocket</span>
<span class="sd">        actions, security policies, and attaches all of our plugin hooks/events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;application&#39;</span><span class="p">:</span> <span class="s1">&#39;terminal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span>
            <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s2">&quot;gateone.terminal&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TerminalApplication.initialize()&quot;</span><span class="p">)</span>
        <span class="c1"># Register our security policy function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;terminal&#39;</span><span class="p">:</span> <span class="n">terminal_policies</span><span class="p">})</span>
        <span class="c1"># Register our WebSocket actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;terminal:new_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_terminal</span><span class="p">,</span>
            <span class="s1">&#39;terminal:set_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_terminal</span><span class="p">,</span>
            <span class="s1">&#39;terminal:move_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_terminal</span><span class="p">,</span>
            <span class="s1">&#39;terminal:swap_terminals&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_terminals</span><span class="p">,</span>
            <span class="s1">&#39;terminal:kill_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_terminal</span><span class="p">,</span>
            <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_handler</span><span class="p">,</span> <span class="c1"># Just &#39;c&#39; to keep the bandwidth down</span>
            <span class="s1">&#39;terminal:write_chars&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_chars</span><span class="p">,</span>
            <span class="s1">&#39;terminal:refresh&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">,</span>
            <span class="s1">&#39;terminal:full_refresh&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_refresh</span><span class="p">,</span>
            <span class="s1">&#39;terminal:resize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">,</span>
            <span class="s1">&#39;terminal:get_bell&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bell</span><span class="p">,</span>
            <span class="s1">&#39;terminal:manual_title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual_title</span><span class="p">,</span>
            <span class="s1">&#39;terminal:reset_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_terminal</span><span class="p">,</span>
            <span class="s1">&#39;terminal:get_webworker&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_webworker</span><span class="p">,</span>
            <span class="s1">&#39;terminal:get_font&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_font</span><span class="p">,</span>
            <span class="s1">&#39;terminal:get_colors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_colors</span><span class="p">,</span>
            <span class="s1">&#39;terminal:set_encoding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_term_encoding</span><span class="p">,</span>
            <span class="s1">&#39;terminal:set_keyboard_mode&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_term_keyboard_mode</span><span class="p">,</span>
            <span class="s1">&#39;terminal:get_locations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locations</span><span class="p">,</span>
            <span class="s1">&#39;terminal:get_terminals&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminals</span><span class="p">,</span>
            <span class="s1">&#39;terminal:get_client_files&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_client_files</span><span class="p">,</span>
            <span class="s1">&#39;terminal:permissions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="p">,</span>
            <span class="s1">&#39;terminal:new_share_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_share_id</span><span class="p">,</span>
            <span class="s1">&#39;terminal:share_user_list&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">share_user_list</span><span class="p">,</span>
            <span class="s1">&#39;terminal:enumerate_commands&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_commands</span><span class="p">,</span>
            <span class="s1">&#39;terminal:enumerate_fonts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_fonts</span><span class="p">,</span>
            <span class="s1">&#39;terminal:enumerate_colors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_colors</span><span class="p">,</span>
            <span class="s1">&#39;terminal:list_shared_terminals&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_shared_terminals</span><span class="p">,</span>
            <span class="s1">&#39;terminal:attach_shared_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">attach_shared_terminal</span><span class="p">,</span>
            <span class="s1">&#39;terminal:detach_shared_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">detach_shared_terminal</span><span class="p">,</span>
            <span class="s1">&#39;terminal:start_capture&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_capture</span><span class="p">,</span>
            <span class="s1">&#39;terminal:stop_capture&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_capture</span><span class="p">,</span>
            <span class="s1">&#39;terminal:debug_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_terminal</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="s1">&#39;terminal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Initialize plugins (every time a connection is established so we can</span>
        <span class="c1"># load new plugins with a simple page reload)</span>
        <span class="n">enabled_plugins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;enabled_plugins&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span> <span class="o">=</span> <span class="n">entry_point_files</span><span class="p">(</span><span class="s1">&#39;go_terminal_plugins&#39;</span><span class="p">,</span> <span class="n">enabled_plugins</span><span class="p">)</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;css&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">plugin</span><span class="p">:</span>
                <span class="n">plugin</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">plugin_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="c1"># So there&#39;s consistent ordering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Active Terminal Plugins: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)))</span>
        <span class="c1"># Setup some events</span>
        <span class="n">terminals_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminals</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;go:set_location&quot;</span><span class="p">,</span> <span class="n">terminals_func</span><span class="p">)</span>
        <span class="c1"># Attach plugin hooks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_hooks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># TODO: Keep track of plugins and hooks to determine when they&#39;ve</span>
        <span class="c1">#       changed so we can tell clients to pull updates and whatnot</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s1">&#39;hooks&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plugin_hooks</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plugin</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span> <span class="n">plugin</span><span class="o">.</span><span class="n">hooks</span><span class="p">})</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s1">&#39;initialize&#39;</span><span class="p">):</span>
                    <span class="n">plugin</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Got exception trying to initialize the {0} plugin:&quot;</span>
                         <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plugin</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="kn">import</span> <span class="nn">traceback</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="k">pass</span> <span class="c1"># No hooks--probably just a supporting .py file.</span>
        <span class="c1"># Hook up the hooks</span>
        <span class="c1"># NOTE:  Most of these will soon be replaced with on() and off() events</span>
        <span class="c1"># and maybe some functions related to initialization.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_esc_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_auth_hooks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_command_hooks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_log_metadata_hooks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_new_multiplex_hooks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_new_term_hooks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_env_hooks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">plugin_name</span><span class="p">,</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugin_hooks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">plugin_name</span> <span class="o">=</span> <span class="n">plugin_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;WebSocket&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c1"># Apply the plugin&#39;s WebSocket actions</span>
                <span class="k">for</span> <span class="n">ws_command</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;WebSocket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ws_command</span><span class="p">:</span> <span class="n">bind</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="p">)})</span>
            <span class="k">if</span> <span class="s1">&#39;Escape&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c1"># Apply the plugin&#39;s Escape handler</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span>
                    <span class="s2">&quot;terminal:opt_esc_handler:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="n">plugin_name</span><span class="p">,</span> <span class="n">bind</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Escape&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;Command&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c1"># Apply the plugin&#39;s &#39;Command&#39; hooks (called by new_multiplex)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Command&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plugin_command_hooks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Command&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plugin_command_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Command&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;Metadata&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c1"># Apply the plugin&#39;s &#39;Metadata&#39; hooks (called by new_multiplex)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Metadata&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plugin_log_metadata_hooks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Metadata&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plugin_log_metadata_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Metadata&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;Multiplex&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c1"># Apply the plugin&#39;s Multiplex hooks (called by new_multiplex)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Multiplex&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plugin_new_multiplex_hooks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Multiplex&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plugin_new_multiplex_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Multiplex&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;TermInstance&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c1"># Apply the plugin&#39;s TermInstance hooks (called by new_terminal)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;TermInstance&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plugin_new_term_hooks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;TermInstance&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plugin_new_term_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;TermInstance&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;Environment&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plugin_env_hooks</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Environment&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;Events&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">bind</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span></div>

<div class="viewcode-block" id="TerminalApplication.open"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This gets called at the end of :meth:`ApplicationWebSocket.open` when</span>
<span class="sd">        the WebSocket is opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TerminalApplication.open()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">;</span><span class="si">%s</span><span class="s2">;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:open&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.send_client_files"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.send_client_files">[docs]</a>    <span class="k">def</span> <span class="nf">send_client_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the client our standard CSS and JS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Render and send the client our terminal.css</span>
        <span class="n">terminal_css</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/templates/terminal.css&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_and_send_css</span><span class="p">(</span><span class="n">terminal_css</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="s2">&quot;terminal.css&quot;</span><span class="p">)</span>
        <span class="c1"># Send the client our JavaScript files</span>
        <span class="n">js_files</span> <span class="o">=</span> <span class="n">resource_listdir</span><span class="p">(</span><span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/&#39;</span><span class="p">)</span>
        <span class="n">js_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">js_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.js&#39;</span><span class="p">):</span>
                <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
                    <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;terminal.js&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">js_file_path</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;terminal.css&quot;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;terminal_input.js&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">js_file_path</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="s2">&quot;terminal.js&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">js_file_path</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="s1">&#39;terminal_input.js&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_plugin_static_files</span><span class="p">(</span>
            <span class="s1">&#39;go_terminal_plugins&#39;</span><span class="p">,</span>
            <span class="n">requires</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;terminal_input.js&quot;</span><span class="p">])</span>
        <span class="c1"># Send the client the 256-color style information and our printing CSS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_256_colors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_print_stylesheet</span><span class="p">()</span></div>

<div class="viewcode-block" id="TerminalApplication.authenticate"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This gets called immediately after the user is authenticated</span>
<span class="sd">        successfully at the end of :meth:`ApplicationWebSocket.authenticate`.</span>
<span class="sd">        Sends all plugin JavaScript files to the client and triggers the</span>
<span class="sd">        &#39;terminal:authenticate&#39; event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TerminalApplication.authenticate()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;application&#39;</span><span class="p">:</span> <span class="s1">&#39;terminal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;upn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span>
            <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s2">&quot;gateone.terminal&quot;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span><span class="p">)</span>
        <span class="c1"># Get our user-specific settings/policies for quick reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span>
            <span class="s1">&#39;terminal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="c1"># NOTE: If you want to be able to check policies on-the-fly without</span>
        <span class="c1"># requiring the user reload the page when a change is made make sure</span>
        <span class="c1"># call applicable_policies() on your own using self.ws.prefs every time</span>
        <span class="c1"># you want to check them.  This will ensure it&#39;s always up-to-date.</span>
        <span class="c1"># NOTE:  applicable_policies() is memoized so calling it over and over</span>
        <span class="c1"># again shouldn&#39;t slow anything down.</span>
        <span class="c1"># Start by determining if the user can even login to the terminal app</span>
        <span class="k">if</span> <span class="s1">&#39;allow&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;allow&#39;</span><span class="p">]:</span>
                <span class="c1"># User is not allowed to access the terminal application.  Don&#39;t</span>
                <span class="c1"># bother sending them any static files and whatnot.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;User is not allowed to use the Terminal application.  &quot;</span>
                    <span class="s2">&quot;Skipping post-authentication functions.&quot;</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_client_files</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">]</span>
        <span class="c1"># Create a place to store app-specific stuff related to this session</span>
        <span class="c1"># (but not necessarily this &#39;location&#39;)</span>
        <span class="k">if</span> <span class="s2">&quot;terminal&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sess</span><span class="p">:</span>
            <span class="n">sess</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># When Gate One exits...</span>
        <span class="k">if</span> <span class="n">kill_session</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;kill_session_callbacks&quot;</span><span class="p">]:</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;kill_session_callbacks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kill_session</span><span class="p">)</span>
        <span class="c1"># When a session actually times out (kill dtach&#39;d processes too)...</span>
        <span class="k">if</span> <span class="n">timeout_session</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;timeout_callbacks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeout_session</span><span class="p">)</span>
        <span class="c1"># Set the sub-applications list to our commands</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;commands&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">sub_apps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;commands&#39;</span><span class="p">][</span><span class="n">command</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">sub_app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;commands&#39;</span><span class="p">][</span><span class="n">command</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="c1"># Don&#39;t want clients to know this</span>
                <span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span> <span class="c1"># Let them have the short name</span>
                <span class="k">if</span> <span class="s1">&#39;icon&#39;</span> <span class="ow">in</span> <span class="n">sub_app</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
                        <span class="c1"># This is a path to the icon instead of the actual</span>
                        <span class="c1"># icon (has to be SVG, after all).  Replace it with</span>
                        <span class="c1"># the actual icon data (should start with &lt;svg&gt;)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]):</span>
                            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                                <span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                                <span class="s2">&quot;Path to icon ({icon}) for command, &quot;</span>
                                <span class="s2">&quot;&#39;{cmd}&#39; could not be found.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">cmd</span><span class="o">=</span><span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                                    <span class="n">icon</span><span class="o">=</span><span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]))</span>
                            <span class="k">del</span> <span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_app</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">}</span>
            <span class="k">if</span> <span class="s1">&#39;icon&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub_app</span><span class="p">:</span>
                <span class="c1"># Use the generic one</span>
                <span class="n">icon_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
                    <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;/templates/command_icon.svg&#39;</span><span class="p">)</span>
                <span class="n">sub_app_icon</span> <span class="o">=</span> <span class="n">resource_string</span><span class="p">(</span>
                    <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;/templates/command_icon.svg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_app_icon</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">sub_app</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">sub_apps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sub_applications&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">sub_apps</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="c1"># NOTE: The user will often be authenticated before terminal.js is</span>
        <span class="c1"># loaded.  This means that self.terminals() will be ignored in most</span>
        <span class="c1"># cases (only when the connection lost and re-connected without a page</span>
        <span class="c1"># reload).  For this reason GateOne.Terminal.init() calls</span>
        <span class="c1"># getOpenTerminals().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminals</span><span class="p">()</span> <span class="c1"># Tell the client about open terminals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_shared_terminals</span><span class="p">()</span> <span class="c1"># Also tell them about any shared terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:authenticate&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.on_close"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.on_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all attached callbacks and triggers the `terminal:on_close`</span>
<span class="sd">        event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove all attached callbacks so we&#39;re not wasting memory/CPU on</span>
        <span class="c1"># disconnected clients</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="c1"># Connection closed before authentication completed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="c1"># Broadcast terminal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:on_close&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">session_locs</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s1">&#39;locations&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span> <span class="ow">in</span> <span class="n">session_locs</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;loc_terms&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">multiplex</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
                        <span class="n">multiplex</span><span class="o">.</span><span class="n">remove_all_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
                        <span class="n">client_dict</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span>
                        <span class="n">term_emulator</span> <span class="o">=</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">term</span>
                        <span class="n">term_emulator</span><span class="o">.</span><span class="n">remove_all_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
                        <span class="c1"># Remove anything associated with the client_id</span>
                        <span class="n">multiplex</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">remove_timeout</span><span class="p">(</span>
                            <span class="n">client_dict</span><span class="p">[</span><span class="s1">&#39;refresh_timeout&#39;</span><span class="p">])</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                        <span class="c1"># User never completed opening a terminal so</span>
                        <span class="c1"># self.callback_id is missing.  Nothing to worry about</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span> <span class="ow">in</span> <span class="n">term_obj</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">term_obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:on_close&quot;</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">enumerate_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tell the client which &#39;commands&#39; (from settings/policy) that are</span>
<span class="sd">        available via the `terminal:commands_list` WebSocket action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the current settings in case they&#39;ve changed:</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span>
            <span class="s1">&#39;terminal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;commands&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">commands</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You&#39;re missing the &#39;commands&#39; setting!&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:commands_list&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;commands&#39;</span><span class="p">:</span> <span class="n">commands</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="TerminalApplication.enumerate_fonts"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.enumerate_fonts">[docs]</a>    <span class="k">def</span> <span class="nf">enumerate_fonts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a JSON-encoded object containing the installed fonts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.woff_info</span> <span class="kn">import</span> <span class="n">woff_info</span>
        <span class="n">fonts</span> <span class="o">=</span> <span class="n">resource_listdir</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/fonts&#39;</span><span class="p">)</span>
        <span class="n">font_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">font</span> <span class="ow">in</span> <span class="n">fonts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">font</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.woff&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">font_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
                <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/fonts/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">font</span><span class="p">)</span>
            <span class="n">font_info</span> <span class="o">=</span> <span class="n">woff_info</span><span class="p">(</span><span class="n">font_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Font Family&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">font_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Bad font in fonts dir (missing Font Family in name &quot;</span>
                    <span class="s2">&quot;table): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">font</span><span class="p">))</span>
                <span class="k">continue</span> <span class="c1"># Bad font</span>
            <span class="k">if</span> <span class="n">font_info</span><span class="p">[</span><span class="s2">&quot;Font Family&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">font_list</span><span class="p">:</span>
                <span class="n">font_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">font_info</span><span class="p">[</span><span class="s2">&quot;Font Family&quot;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:fonts_list&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fonts&#39;</span><span class="p">:</span> <span class="n">font_list</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">get_font</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `terminal:get_font` WebSocket action; sends the client</span>
<span class="sd">        CSS that includes a complete set of fonts associated with</span>
<span class="sd">        *settings[&quot;font_family&quot;]*.  Optionally, the following additional</span>
<span class="sd">        *settings* may be provided:</span>

<span class="sd">            :font_size:</span>

<span class="sd">                Assigns the &#39;font-size&#39; property according to the given value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;font_family&#39;</span><span class="p">]</span>
        <span class="n">font_size</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;font_size&#39;</span><span class="p">,</span> <span class="s1">&#39;90%&#39;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;font.css&#39;</span>
        <span class="n">font_css_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/templates/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">font_family</span> <span class="o">==</span> <span class="s1">&#39;monospace&#39;</span><span class="p">:</span>
            <span class="c1"># User wants the browser to control the font; real simple:</span>
            <span class="n">rendered_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_style</span><span class="p">(</span>
                <span class="n">font_css_path</span><span class="p">,</span>
                <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">font_family</span><span class="o">=</span><span class="n">font_family</span><span class="p">,</span>
                <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span>
                <span class="n">rendered_path</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="s2">&quot;terminal_font&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">.woff_info</span> <span class="kn">import</span> <span class="n">woff_info</span>
        <span class="n">fonts</span> <span class="o">=</span> <span class="n">resource_listdir</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/fonts&#39;</span><span class="p">)</span>
        <span class="n">woffs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">font</span> <span class="ow">in</span> <span class="n">fonts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">font</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.woff&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">font_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
                <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/fonts/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">font</span><span class="p">)</span>
            <span class="n">font_info</span> <span class="o">=</span> <span class="n">woff_info</span><span class="p">(</span><span class="n">font_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Font Family&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">font_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Bad font in fonts dir (missing Font Family in name &quot;</span>
                    <span class="s2">&quot;table): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">font</span><span class="p">))</span>
                <span class="k">continue</span> <span class="c1"># Bad font</span>
            <span class="k">if</span> <span class="n">font_info</span><span class="p">[</span><span class="s2">&quot;Font Family&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">font_family</span><span class="p">:</span>
                <span class="n">font_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;subfamily&quot;</span><span class="p">:</span> <span class="n">font_info</span><span class="p">[</span><span class="s2">&quot;Font Subfamily&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;font_style&quot;</span><span class="p">:</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="c1"># Overwritten below (if warranted)</span>
                    <span class="s2">&quot;font_weight&quot;</span><span class="p">:</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="c1"># Ditto</span>
                    <span class="s2">&quot;locals&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;{server_url}terminal/static/fonts/{font}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">server_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span>
                            <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="s2">&quot;Full Name&quot;</span> <span class="ow">in</span> <span class="n">font_info</span><span class="p">:</span>
                    <span class="n">font_dict</span><span class="p">[</span><span class="s2">&quot;locals&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;local(&#39;{0}&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">font_info</span><span class="p">[</span><span class="s2">&quot;Full Name&quot;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="s2">&quot;Postscript Name&quot;</span> <span class="ow">in</span> <span class="n">font_info</span><span class="p">:</span>
                    <span class="n">font_dict</span><span class="p">[</span><span class="s2">&quot;locals&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;, local(&#39;{0}&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">font_info</span><span class="p">[</span><span class="s2">&quot;Postscript Name&quot;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="s1">&#39;italic&#39;</span> <span class="ow">in</span> <span class="n">font_info</span><span class="p">[</span><span class="s2">&quot;Font Subfamily&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">font_dict</span><span class="p">[</span><span class="s2">&quot;font_style&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;italic&quot;</span>
                <span class="k">if</span> <span class="s1">&#39;oblique&#39;</span> <span class="ow">in</span> <span class="n">font_info</span><span class="p">[</span><span class="s2">&quot;Font Subfamily&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">font_dict</span><span class="p">[</span><span class="s2">&quot;font_style&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;oblique&quot;</span>
                <span class="k">if</span> <span class="s1">&#39;bold&#39;</span> <span class="ow">in</span> <span class="n">font_info</span><span class="p">[</span><span class="s2">&quot;Font Subfamily&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">font_dict</span><span class="p">[</span><span class="s2">&quot;font_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bold&quot;</span>
                <span class="n">woffs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">font</span><span class="p">:</span> <span class="n">font_dict</span><span class="p">})</span>
        <span class="c1"># NOTE: Not using render_and_send_css() because the source CSS file will</span>
        <span class="c1"># never change but the output will.</span>
        <span class="n">rendered_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_style</span><span class="p">(</span>
            <span class="n">font_css_path</span><span class="p">,</span>
            <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">woffs</span><span class="o">=</span><span class="n">woffs</span><span class="p">,</span>
            <span class="n">font_family</span><span class="o">=</span><span class="n">font_family</span><span class="p">,</span>
            <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span>
            <span class="n">rendered_path</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="s2">&quot;terminal_font&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="TerminalApplication.enumerate_colors"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.enumerate_colors">[docs]</a>    <span class="k">def</span> <span class="nf">enumerate_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a JSON-encoded object containing the installed text color</span>
<span class="sd">        schemes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">resource_listdir</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/templates/term_colors&#39;</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">colors</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.css&#39;</span><span class="p">)]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.css&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:colors_list&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colors&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.save_term_settings"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.save_term_settings">[docs]</a>    <span class="k">def</span> <span class="nf">save_term_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves whatever *settings* (must be JSON-encodable) are provided in the</span>
<span class="sd">        user&#39;s session directory; associated with the given *term*.</span>

<span class="sd">        The `restore_term_settings` function can be used to restore the provided</span>
<span class="sd">        settings.</span>

<span class="sd">        .. note:: This method is primarily to aid dtach support.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;save_term_settings(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">settings</span><span class="p">))</span>
        <span class="kn">from</span> <span class="nn">.term_utils</span> <span class="kn">import</span> <span class="n">save_term_settings</span> <span class="k">as</span> <span class="n">_save</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="c1"># JSON wants strings as keys</span>
        <span class="k">def</span> <span class="nf">saved</span><span class="p">(</span><span class="n">result</span><span class="p">):</span> <span class="c1"># NOTE: result will always be None</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Called when we&#39;re done JSON-decoding and re-encoding the given</span>
<span class="sd">            settings.  Just triggers the `terminal:save_term_settings` event.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:save_term_settings&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
        <span class="c1"># Why bother with an async call for something so small?  Well, we can&#39;t</span>
        <span class="c1"># be sure it will *always* be a tiny amount of data.  What if some app</span>
        <span class="c1"># embedding Gate One wants to pass in some huge amount of metadata when</span>
        <span class="c1"># they open new terminals?  Don&#39;t want to block while the read, JSON</span>
        <span class="c1"># decode, JSON encode, and write operations take place.</span>
        <span class="c1"># Also note that this function gets called whenever a new terminal is</span>
        <span class="c1"># opened or resumed.  So if you have 100 users each with a dozen or so</span>
        <span class="c1"># terminals it could slow things down quite a bit in the event that a</span>
        <span class="c1"># number of users lose connectivity and reconnect at once (or the server</span>
        <span class="c1"># is restarted with dtach support enabled).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_async</span><span class="o">.</span><span class="n">call_singleton</span><span class="p">(</span> <span class="c1"># Singleton since we&#39;re writing async</span>
            <span class="n">_save</span><span class="p">,</span>
            <span class="s1">&#39;save_term_settings_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="n">term</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="n">settings</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">saved</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.restore_term_settings"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.restore_term_settings">[docs]</a>    <span class="k">def</span> <span class="nf">restore_term_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the settings associated with the given *term* that are stored in</span>
<span class="sd">        the user&#39;s session directory and applies them to</span>
<span class="sd">        ``self.loc_terms[term]``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="c1"># JSON wants strings as keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;restore_term_settings(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.term_utils</span> <span class="kn">import</span> <span class="n">restore_term_settings</span> <span class="k">as</span> <span class="n">_restore</span>
        <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Saves the *settings* returned by :func:`restore_term_settings`</span>
<span class="sd">            in `self.loc_terms[term]` and triggers the</span>
<span class="sd">            `terminal:restore_term_settings` event.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">]:</span>
                    <span class="n">termNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">termNum</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="n">settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">][</span><span class="n">term</span><span class="p">])</span>
                    <span class="c1"># The terminal title needs some special love</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">termNum</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">termNum</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:restore_term_settings&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_async</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">_restore</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="n">memoize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">restore</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">future</span></div>

<div class="viewcode-block" id="TerminalApplication.clear_term_settings"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.clear_term_settings">[docs]</a>    <span class="k">def</span> <span class="nf">clear_term_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes any settings associated with the given *term* in the user&#39;s</span>
<span class="sd">        term_settings.json file (in their session directory).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;clear_term_settings(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_settings</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">()</span>
        <span class="n">term_settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">term</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="n">settings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="s1">&#39;term_settings.json&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="c1"># First we read in the existing settings and then update them.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">term_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json_decode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="k">del</span> <span class="n">term_settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">][</span><span class="n">term</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">term_settings</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:clear_term_settings&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">terminals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a list of the current open terminals to the client using the</span>
<span class="sd">        `terminal:terminals` WebSocket action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: *args and **kwargs are present so we can attach this to a go:</span>
        <span class="c1"># event and just ignore the provided arguments.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;terminals()&#39;</span><span class="p">)</span>
        <span class="n">terminals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Create an application-specific storage space in the locations dict</span>
        <span class="k">if</span> <span class="s1">&#39;terminal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Quick reference for our terminals in the current location:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># WebSocket disconnected or not-yet-authenticated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="c1"># Only terminals are integers in the dict</span>
                <span class="n">terminals</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="n">term</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;metadata&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;command&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
                    <span class="p">}})</span>
                <span class="n">share_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;share_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">share_id</span><span class="p">:</span>
                    <span class="n">terminals</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;share_id&#39;</span><span class="p">:</span> <span class="n">share_id</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Just a broadcast terminal viewer</span>
        <span class="c1"># Check for any dtach&#39;d terminals we might have missed</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dtach</span> <span class="ow">and</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;dtach&#39;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">.term_utils</span> <span class="kn">import</span> <span class="n">restore_term_settings</span>
            <span class="n">term_settings</span> <span class="o">=</span> <span class="n">restore_term_settings</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="n">session_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span>
            <span class="n">session_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_dir</span><span class="p">):</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">session_dir</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">session_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dtach_&#39;</span><span class="p">):</span>
                    <span class="n">split</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="n">location</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
                        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">terminals</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">term_settings</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="c1"># NOTE: str() below because the dict comes from JSON</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">term_settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">]:</span>
                                <span class="k">continue</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">term_settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">)]</span>
                            <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
                            <span class="n">command</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                            <span class="n">title</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Gate One&#39;</span><span class="p">)</span>
                            <span class="n">terminals</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">term</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
                                <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span>
                                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span>
                            <span class="p">}})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;terminal:terminals&#39;</span><span class="p">,</span> <span class="n">terminals</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:terminals&#39;</span><span class="p">:</span> <span class="n">terminals</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

<div class="viewcode-block" id="TerminalApplication.term_ended"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.term_ended">[docs]</a>    <span class="k">def</span> <span class="nf">term_ended</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the &#39;term_ended&#39; message to the client letting it know that the</span>
<span class="sd">        given *term* is no more.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Terminal Closed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:term_ended&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="n">timediff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;created&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">race_check</span><span class="p">:</span>
                <span class="n">race_check_timediff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">race_check</span>
                <span class="k">if</span> <span class="n">race_check_timediff</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
                    <span class="c1"># Definitely a race condition (command is failing to run).</span>
                    <span class="c1"># Add a delay</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="s2">&quot;5s&quot;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term_ended</span><span class="p">,</span> <span class="n">term</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">race_check</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Warning: Terminals are closing too fast.  If you see &quot;</span>
                        <span class="s2">&quot;this message multiple times it is likely that the &quot;</span>
                        <span class="s2">&quot;configured command is failing to execute.  Please &quot;</span>
                        <span class="s2">&quot;check your server settings.&quot;</span>
                    <span class="p">))</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cmd</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Terminals are closing too quickly after being opened &quot;</span>
                        <span class="s2">&quot;(command: </span><span class="si">%s</span><span class="s2">).  Please check your &#39;commands&#39; (usually &quot;</span>
                        <span class="s2">&quot;in settings/50terminal.conf).&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
                    <span class="k">return</span>
            <span class="k">elif</span> <span class="n">timediff</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># Potential race condition</span>
                <span class="c1"># Alow the first one to go through immediately</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">race_check</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Because this function can be called after a timeout it is possible</span>
            <span class="c1"># that the client will have disconnected in the mean time resulting</span>
            <span class="c1"># in this exception.  Not a problem; ignore.</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:term_ended&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.add_terminal_callbacks"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.add_terminal_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">add_terminal_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">multiplex</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up all the callbacks associated with the given *term*, *multiplex*</span>
<span class="sd">        instance and *callback_id*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">terminal</span>
        <span class="n">refresh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">multiplex</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">multiplex</span><span class="o">.</span><span class="n">CALLBACK_UPDATE</span><span class="p">,</span> <span class="n">refresh</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">ended</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term_ended</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">multiplex</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">multiplex</span><span class="o">.</span><span class="n">CALLBACK_EXIT</span><span class="p">,</span> <span class="n">ended</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="c1"># Setup the terminal emulator callbacks</span>
        <span class="n">term_emulator</span> <span class="o">=</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">term</span>
        <span class="n">set_title</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_title</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_TITLE</span><span class="p">,</span> <span class="n">set_title</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="c1">#set_title() # Set initial title</span>
        <span class="n">bell</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bell</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_BELL</span><span class="p">,</span> <span class="n">bell</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">opt_esc_handler</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_esc_handler</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">multiplex</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_OPT</span><span class="p">,</span> <span class="n">opt_esc_handler</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">mode_handler</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_handler</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_MODE</span><span class="p">,</span> <span class="n">mode_handler</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">reset_term</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_client_terminal</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_RESET</span><span class="p">,</span> <span class="n">reset_term</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">dsr</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dsr</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_DSR</span><span class="p">,</span> <span class="n">dsr</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_MESSAGE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="c1"># Call any registered plugin Terminal hooks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span>
            <span class="s2">&quot;terminal:add_terminal_callbacks&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">multiplex</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.remove_terminal_callbacks"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.remove_terminal_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">remove_terminal_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplex</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all the Multiplex and terminal emulator callbacks attached to</span>
<span class="sd">        the given *multiplex* instance and *callback_id*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">terminal</span>
        <span class="n">multiplex</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">multiplex</span><span class="o">.</span><span class="n">CALLBACK_UPDATE</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">multiplex</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">multiplex</span><span class="o">.</span><span class="n">CALLBACK_EXIT</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">term_emulator</span> <span class="o">=</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">term</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_TITLE</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_MESSAGE</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_DSR</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_RESET</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_MODE</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_OPT</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_BELL</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.new_multiplex"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.new_multiplex">[docs]</a>    <span class="k">def</span> <span class="nf">new_multiplex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">term_id</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new instance of :py:class:`termio.Multiplex` with the proper</span>
<span class="sd">        global and client-specific settings.</span>

<span class="sd">            :cmd:</span>
<span class="sd">                The command to execute inside of Multiplex.</span>
<span class="sd">            :term_id:</span>
<span class="sd">                The terminal to associate with this Multiplex or a descriptive</span>
<span class="sd">                identifier (it&#39;s only used for logging purposes).</span>
<span class="sd">            :logging:</span>
<span class="sd">                If ``False``, logging will be disabled for this instance of</span>
<span class="sd">                Multiplex (even if it would otherwise be enabled).</span>
<span class="sd">            :encoding:</span>
<span class="sd">                The default encoding that will be used when reading or writing</span>
<span class="sd">                to the Multiplex instance.</span>
<span class="sd">            :debug:</span>
<span class="sd">                If ``True``, will enable debugging on the created Multiplex</span>
<span class="sd">                instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">termio</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">TerminalApplication</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span>
            <span class="s1">&#39;terminal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">shell_command</span> <span class="o">=</span> <span class="n">policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shell_command&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">enabled_filetypes</span> <span class="o">=</span> <span class="n">policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled_filetypes&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">use_shell</span> <span class="o">=</span> <span class="n">policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_shell&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">user_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># No auth, use ANONYMOUS (% is there to prevent conflicts)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="s1">r&#39;ANONYMOUS&#39;</span> <span class="c1"># Don&#39;t get on this guy&#39;s bad side</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">syslog_logging</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
            <span class="n">syslog_logging</span> <span class="o">=</span> <span class="n">policies</span><span class="p">[</span><span class="s1">&#39;syslog_session_logging&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">policies</span><span class="p">[</span><span class="s1">&#39;session_logging&#39;</span><span class="p">]:</span>
                <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
                <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>
                <span class="c1"># Create the log dir if not already present</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
                    <span class="n">mkdir_p</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
                <span class="n">log_suffix</span> <span class="o">=</span> <span class="s2">&quot;-{0}.golog&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip_address&#39;</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">))</span>
                <span class="n">log_name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                    <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_suffix</span>
                <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">log_name</span><span class="p">)</span>
        <span class="n">facility</span> <span class="o">=</span> <span class="n">string_to_syslog_facility</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;syslog_facility&#39;</span><span class="p">])</span>
        <span class="c1"># This allows plugins to transform the command however they like</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugin_command_hooks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugin_command_hooks</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="n">term_id</span><span class="p">)</span>
        <span class="n">additional_log_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip_address&#39;</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1"># This allows plugins to add their own metadata to .golog files:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugin_log_metadata_hooks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugin_log_metadata_hooks</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="n">term_id</span><span class="p">)</span>
                <span class="n">additional_log_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">terminal_emulator_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">enabled_filetypes</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="c1"># Only need to bother if it is something other than the default</span>
            <span class="n">terminal_emulator_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;enabled_filetypes&#39;</span><span class="p">:</span> <span class="n">enabled_filetypes</span><span class="p">}</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">termio</span><span class="o">.</span><span class="n">Multiplex</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">terminal_emulator_kwargs</span><span class="o">=</span><span class="n">terminal_emulator_kwargs</span><span class="p">,</span>
            <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">term_id</span><span class="o">=</span><span class="n">term_id</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="n">syslog</span><span class="o">=</span><span class="n">syslog_logging</span><span class="p">,</span>
            <span class="n">syslog_facility</span><span class="o">=</span><span class="n">facility</span><span class="p">,</span>
            <span class="n">additional_metadata</span><span class="o">=</span><span class="n">additional_log_metadata</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">use_shell</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">use_shell</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># This is the default anyway</span>
            <span class="k">if</span> <span class="n">shell_command</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">shell_command</span> <span class="o">=</span> <span class="n">shell_command</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">use_shell</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugin_new_multiplex_hooks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugin_new_multiplex_hooks</span><span class="p">:</span>
                <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:new_multiplex&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="TerminalApplication.highest_term_num"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.highest_term_num">[docs]</a>    <span class="k">def</span> <span class="nf">highest_term_num</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the highest terminal number at the given *location* (so we can</span>
<span class="sd">        figure out what&#39;s next).  If *location* is omitted, uses</span>
<span class="sd">        `self.ws.location`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="c1"># Broadcast terminal viewer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">location</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s1">&#39;locations&#39;</span><span class="p">][</span><span class="n">location</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span>
        <span class="n">highest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">loc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">term</span> <span class="o">&gt;</span> <span class="n">highest</span><span class="p">:</span>
                    <span class="n">highest</span> <span class="o">=</span> <span class="n">term</span>
        <span class="k">return</span> <span class="n">highest</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">new_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts up a new terminal associated with the user&#39;s session using</span>
<span class="sd">        *settings* as the parameters.  If a terminal already exists with the</span>
<span class="sd">        same number as *settings[term]*, self.set_terminal() will be called</span>
<span class="sd">        instead of starting a new terminal (so clients can resume their session</span>
<span class="sd">        without having to worry about figuring out if a new terminal already</span>
<span class="sd">        exists or not).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highest_term_num</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># TODO: Make these specific to each terminal:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="mi">24</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">cols</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Something went wrong calculating term size</span>
            <span class="c1"># Fall back to a standard default</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="n">default_env</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TERM&quot;</span><span class="p">:</span> <span class="s1">&#39;xterm-256color&#39;</span><span class="p">}</span> <span class="c1"># Only one default</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">applicable_policies</span><span class="p">(</span>
            <span class="s1">&#39;terminal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">environment_vars</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;environment_vars&#39;</span><span class="p">,</span> <span class="n">default_env</span><span class="p">)</span>
        <span class="n">default_encoding</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">encoding</span><span class="p">:</span> <span class="c1"># Was passed as None or &#39;null&#39;</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">default_encoding</span>
        <span class="n">term_metadata</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">settings_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;settings_dir&#39;</span><span class="p">]</span>
        <span class="n">user_session_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="c1"># NOTE: &#39;command&#39; here is actually just the short name of the command.</span>
        <span class="c1">#       ...which maps to what&#39;s configured the &#39;commands&#39; part of your</span>
        <span class="c1">#       terminal settings.</span>
        <span class="k">if</span> <span class="s1">&#39;command&#39;</span> <span class="ow">in</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;default_command&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                   <span class="s2">&quot;You are missing a &#39;default_command&#39; in your terminal &quot;</span>
                   <span class="s2">&quot;settings (usually 50terminal.conf in </span><span class="si">%s</span><span class="s2">)&quot;</span>
                   <span class="o">%</span> <span class="n">settings_dir</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="n">cmd_dtach_enabled</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Get the full command</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">full_command</span> <span class="o">=</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;commands&#39;</span><span class="p">][</span><span class="n">command</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># The given command isn&#39;t an option</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Attempted to execute invalid command (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span> <span class="n">command</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Terminal: Invalid command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_ended</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">full_command</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="c1"># Extended command definition</span>
            <span class="c1"># This lets you disable dtach on a per-command basis:</span>
            <span class="n">cmd_dtach_enabled</span> <span class="o">=</span> <span class="n">full_command</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtach&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">full_command</span> <span class="o">=</span> <span class="n">full_command</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span>
        <span class="c1"># Make a nice, useful logging line with extra metadata</span>
        <span class="n">log_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">],</span>
            <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">],</span>
            <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New Terminal: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">log_metadata</span><span class="p">)</span>
        <span class="c1"># Now remove the new-term-specific metadata</span>
        <span class="k">if</span> <span class="s1">&#39;em_dimensions&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">em_dimensions</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;em_dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;h&#39;</span><span class="p">],</span>
                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;em_dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="n">user_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="c1"># Setup the requisite dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;last_activity&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Gate One&#39;</span><span class="p">,</span>
                <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span>
                <span class="s1">&#39;manual_title&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">term_metadata</span><span class="p">,</span> <span class="c1"># Any extra info the client gave us</span>
                <span class="c1"># This is needed by the terminal sharing policies:</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span> <span class="c1"># So we can determine the owner</span>
            <span class="p">}</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">term_obj</span><span class="p">:</span>
            <span class="n">term_obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># Used by refresh_screen()</span>
                <span class="s1">&#39;refresh_timeout&#39;</span><span class="p">:</span> <span class="bp">None</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;multiplex&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">term_obj</span><span class="p">:</span>
            <span class="c1"># Start up a new terminal</span>
            <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="c1"># NOTE: Not doing anything with &#39;created&#39;...  yet!</span>
            <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># No auth, use ANONYMOUS (% is there to prevent conflicts)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;ANONYMOUS&#39;</span> <span class="c1"># Don&#39;t get on this guy&#39;s bad side</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_var_swap</span><span class="p">(</span><span class="n">full_command</span><span class="p">,</span> <span class="c1"># Swap out variables like %USER%</span>
                <span class="n">gateone_dir</span><span class="o">=</span><span class="n">GATEONE_DIR</span><span class="p">,</span>
                <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="c1"># with their real-world values.</span>
                <span class="n">session_dir</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span>
                <span class="n">session_hash</span><span class="o">=</span><span class="n">short_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">),</span>
                <span class="n">userdir</span><span class="o">=</span><span class="n">user_dir</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">now</span>
            <span class="p">)</span>
            <span class="c1"># Now swap out any variables like $PATH, $HOME, $USER, etc</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">resumed_dtach</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c1"># Create the user&#39;s session dir if not already present</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">user_session_dir</span><span class="p">):</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">user_session_dir</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">user_session_dir</span><span class="p">,</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dtach</span> <span class="ow">and</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;dtach&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cmd_dtach_enabled</span><span class="p">:</span>
                <span class="c1"># Wrap in dtach (love this tool!)</span>
                <span class="n">dtach_path</span> <span class="o">=</span> <span class="s2">&quot;{session_dir}/dtach_{location}_{term}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">session_dir</span><span class="o">=</span><span class="n">user_session_dir</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                    <span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dtach_path</span><span class="p">):</span>
                    <span class="c1"># Using &#39;none&#39; for the refresh because termio</span>
                    <span class="c1"># likes to manage things like that on his own...</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dtach -a </span><span class="si">%s</span><span class="s2"> -E -z -r none&quot;</span> <span class="o">%</span> <span class="n">dtach_path</span>
                    <span class="n">resumed_dtach</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># No existing dtach session...  Make a new one</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dtach -c </span><span class="si">%s</span><span class="s2"> -E -z -r none </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dtach_path</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;new_terminal cmd: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_multiplex</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
            <span class="c1"># Set some environment variables so the programs we execute can use</span>
            <span class="c1"># them (very handy).  Allows for &quot;tight integration&quot; and &quot;synergy&quot;!</span>
            <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;GO_DIR&#39;</span><span class="p">:</span> <span class="n">GATEONE_DIR</span><span class="p">,</span>
                <span class="s1">&#39;GO_SETTINGS_DIR&#39;</span><span class="p">:</span> <span class="n">settings_dir</span><span class="p">,</span>
                <span class="s1">&#39;GO_USER_DIR&#39;</span><span class="p">:</span> <span class="n">user_dir</span><span class="p">,</span>
                <span class="s1">&#39;GO_USER&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                <span class="s1">&#39;GO_TERM&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">),</span>
                <span class="s1">&#39;GO_LOCATION&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                <span class="s1">&#39;GO_SESSION&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                <span class="s1">&#39;GO_SESSION_DIR&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span>
                <span class="s1">&#39;GO_USER_SESSION_DIR&#39;</span><span class="p">:</span> <span class="n">user_session_dir</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span> <span class="c1"># Add the defaults for this system</span>
            <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">environment_vars</span><span class="p">)</span> <span class="c1"># Apply policy-based environment</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugin_env_hooks</span><span class="p">:</span>
                <span class="c1"># This allows plugins to add/override environment variables</span>
                <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plugin_env_hooks</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">em_dimensions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_dimensions</span><span class="p">)</span>
            <span class="c1"># Give the terminal emulator a path to store temporary files</span>
            <span class="n">m</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">temppath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_session_dir</span><span class="p">,</span> <span class="s1">&#39;downloads&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">temppath</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">temppath</span><span class="p">)</span>
            <span class="c1"># Tell it how to serve them up (origin ensures correct link)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">linkpath</span> <span class="o">=</span> <span class="s2">&quot;{server_url}downloads&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">server_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
            <span class="c1"># Make sure it can generate pretty icons for file downloads</span>
            <span class="n">m</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">icondir</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/icons&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resumed_dtach</span><span class="p">:</span>
                <span class="c1"># Send an extra Ctrl-L to refresh the screen and fix the sizing</span>
                <span class="c1"># after it has been reattached.</span>
                <span class="n">m</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x0c</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Terminal already exists</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="c1"># It&#39;s ALIVE!!!</span>
                <span class="k">if</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">:</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span>
                        <span class="n">ctrl_l</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">em_dimensions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_dimensions</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:term_exists&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">}}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="c1"># This resets the screen diff</span>
                <span class="n">m</span><span class="o">.</span><span class="n">prev_output</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Tell the client this terminal is no more</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">term_ended</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="c1"># Setup callbacks so that everything gets called when it should</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_terminal_callbacks</span><span class="p">(</span>
            <span class="n">term</span><span class="p">,</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
        <span class="c1"># NOTE: refresh_screen will also take care of cleaning things up if</span>
        <span class="c1">#       term_obj[&#39;multiplex&#39;].isalive() is False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="c1"># Send a fresh screen to the client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span> <span class="o">=</span> <span class="n">term</span>
        <span class="c1"># Restore expanded modes</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">expanded_modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode_handler</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;WARNING: Logging is set to DEBUG.  All keystrokes will be &quot;</span>
                <span class="s2">&quot;logged!&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_term_encoding</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dtach -a&#39;</span><span class="p">):</span>
            <span class="c1"># This dtach session was resumed; restore terminal settings</span>
            <span class="n">m_term</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">term</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_term_settings</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_future</span><span class="p">(</span>
                <span class="n">future</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
            <span class="c1"># The multiplex instance needs the title set by hand (it&#39;s special)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_future</span><span class="p">(</span>
                <span class="n">future</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">m_term</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:new_terminal&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="c1"># Calling save_term_settings() after the event is fired so that plugins</span>
        <span class="c1"># can modify the metadata before it gets saved.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_term_settings</span><span class="p">(</span>
            <span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span>
                   <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;metadata&#39;</span><span class="p">]})</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">set_term_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the encoding for the given *settings[&#39;term&#39;]* to</span>
<span class="sd">        *settings[&#39;encoding&#39;]*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">])</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="c1"># Invalid encoding</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Invalid encoding.  For a list of valid encodings see:&lt;br&gt;&quot;</span>
    <span class="s2">&quot;&lt;a href=&#39;http://docs.python.org/2/library/codecs.html#standard-encodings&#39;&quot;</span>
                <span class="s2">&quot; target=&#39;new&#39;&gt;Standard Encodings&lt;/a&gt;&quot;</span>
            <span class="p">))</span>
            <span class="k">return</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="c1"># Make sure the client is aware that the change was successful</span>

<div class="viewcode-block" id="TerminalApplication.send_term_encoding"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.send_term_encoding">[docs]</a>    <span class="k">def</span> <span class="nf">send_term_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">encoding</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client indicating the *encoding* of *term* (in</span>
<span class="sd">        the event that a terminal is reattached or when sharing a terminal).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:encoding&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;encoding&#39;</span><span class="p">:</span> <span class="n">encoding</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">set_term_keyboard_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the keyboard mode (e.g. &#39;sco&#39;) for the given *settings[&#39;term&#39;]* to</span>
<span class="sd">        *settings[&#39;mode&#39;]*.  This is only so we can inform the client of the</span>
<span class="sd">        mode when a terminal is re-attached (the serer-side stuff doesn&#39;t use</span>
<span class="sd">        keyboard modes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;sco&#39;</span><span class="p">,</span> <span class="s1">&#39;xterm&#39;</span><span class="p">,</span> <span class="s1">&#39;linux&#39;</span><span class="p">]</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">])</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_modes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Invalid keyboard mode.  Must be one of: </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_modes</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;keyboard_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>

<div class="viewcode-block" id="TerminalApplication.send_term_keyboard_mode"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.send_term_keyboard_mode">[docs]</a>    <span class="k">def</span> <span class="nf">send_term_keyboard_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client indicating the *mode* of *term* (in</span>
<span class="sd">        the event that a terminal is reattached or when sharing a terminal).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:keyboard_mode&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">mode</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">start_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts capturing output for the terminal given via *term*.</span>
<span class="sd">        The output will be saved to a temporary file and delivered to the client</span>
<span class="sd">        when `TerminalApplication.stop_capture` is called.</span>

<span class="sd">        If no *term* is given the currently-selected terminal will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;start_capture(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">term</span><span class="p">))</span>
        <span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
        <span class="kn">from</span> <span class="nn">.term_utils</span> <span class="kn">import</span> <span class="n">capture_stream</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">term</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span>
        <span class="c1"># Make a temporary file to save the terminal&#39;s output</span>
        <span class="n">capture_file</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;go_term_cap&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">capture_path</span> <span class="o">=</span> <span class="n">capture_file</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Don&#39;t need the object anymore since we&#39;ll be using io.open():</span>
        <span class="n">capture_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Will get deleted in stop_capture()</span>
        <span class="n">capture_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">capture_stream</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="n">term_obj</span><span class="p">[</span><span class="s2">&quot;capture&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">capture_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
            <span class="s2">&quot;capture_func&quot;</span><span class="p">:</span> <span class="n">capture_func</span> <span class="c1"># So we can call self.off() with it</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;terminal:refresh_screen&quot;</span><span class="p">,</span> <span class="n">capture_func</span><span class="p">)</span>

<div class="viewcode-block" id="TerminalApplication.stop_capture"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.stop_capture">[docs]</a>    <span class="k">def</span> <span class="nf">stop_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops capturing output for the given *term* by closing the open file</span>
<span class="sd">        object and deleting the &quot;capture&quot; dict from the current instance of</span>
<span class="sd">        `TerminalApplication.loc_terms[term]`.  The captured data will be sent</span>
<span class="sd">        to the client via the &#39;terminal:captured_data&#39; WebSocket action which</span>
<span class="sd">        will included a dict like so::</span>

<span class="sd">            {&quot;term&quot;: 1, &quot;data&quot;: &quot;$ ls\nfile1 file2\n$ &quot; }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;stop_capture(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;capture&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">term_obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="n">capture</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s2">&quot;capture&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
        <span class="n">capture_path</span> <span class="o">=</span> <span class="n">capture</span><span class="o">.</span><span class="n">name</span>
        <span class="n">capture</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">capture</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">capture_func</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s2">&quot;capture&quot;</span><span class="p">][</span><span class="s2">&quot;capture_func&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">off</span><span class="p">(</span><span class="s2">&quot;terminal:refresh_screen&quot;</span><span class="p">,</span> <span class="n">capture_func</span><span class="p">)</span>
        <span class="n">capture_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">capture_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">capture_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">capture_data</span>
        <span class="p">}</span>
        <span class="c1"># Cleanup</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">capture_path</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">term_obj</span><span class="p">[</span><span class="s2">&quot;capture&quot;</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:captured_data&#39;</span><span class="p">:</span> <span class="n">capture_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">swap_terminals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Swaps the numbers of *settings[&#39;term1&#39;]* and *settings[&#39;term2&#39;]*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term1&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term2&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">term1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">term2</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="n">missing_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error: Terminal {term} does not exist.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">missing_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">term1</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">term2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">missing_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">term2</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">term1_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">term1</span><span class="p">)</span>
        <span class="n">term2_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">term2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_terminal_callbacks</span><span class="p">(</span>
            <span class="n">term1_dict</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_terminal_callbacks</span><span class="p">(</span>
            <span class="n">term2_dict</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">term1</span><span class="p">:</span> <span class="n">term2_dict</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">term2</span><span class="p">:</span> <span class="n">term1_dict</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_terminal_callbacks</span><span class="p">(</span>
            <span class="n">term1</span><span class="p">,</span> <span class="n">term2_dict</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_terminal_callbacks</span><span class="p">(</span>
            <span class="n">term2</span><span class="p">,</span> <span class="n">term1_dict</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:swap_terminals&quot;</span><span class="p">,</span> <span class="n">term1</span><span class="p">,</span> <span class="n">term2</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">move_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `terminal:move_terminal` WebSocket action. Moves</span>
<span class="sd">        *settings[&#39;term&#39;]* (terminal number) to</span>
<span class="sd">        ``SESSIONS[self.ws.session][[*settings[&#39;location&#39;]*][&#39;terminal&#39;]``.  In</span>
<span class="sd">        other words, it moves the given terminal to the given location in the</span>
<span class="sd">        *SESSIONS* dict.</span>

<span class="sd">        If the given location dict doesn&#39;t exist (yet) it will be created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;move_terminal(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">new_location_exists</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">existing_term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">])</span>
        <span class="n">new_location</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Error: Terminal {term} does not exist at the current location&quot;</span>
                <span class="s2">&quot; ({location})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="n">existing_term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">locations</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Starting anew in the new location</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span><span class="n">new_location</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span><span class="n">new_location</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">term</span><span class="p">:</span> <span class="n">existing_term_obj</span>
            <span class="p">}</span>
            <span class="n">new_location_exists</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">existing_terms</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span>
                  <span class="n">new_location</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">int</span><span class="p">)]</span>
            <span class="n">existing_terms</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">new_term_num</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">existing_terms</span><span class="p">:</span>
                <span class="n">new_term_num</span> <span class="o">=</span> <span class="n">existing_terms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span><span class="n">new_location</span><span class="p">][</span>
                <span class="s1">&#39;terminal&#39;</span><span class="p">][</span><span class="n">new_term_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">existing_term_obj</span>
        <span class="n">multiplex</span> <span class="o">=</span> <span class="n">existing_term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="c1"># Remove the existing object&#39;s callbacks so we don&#39;t end up sending</span>
        <span class="c1"># things like screen updates to the wrong place.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_terminal_callbacks</span><span class="p">(</span><span class="n">multiplex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Already removed callbacks--no biggie</span>
        <span class="n">em_dimensions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">em_dimensions</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
            <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">em_dimensions</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">new_location_exists</span><span class="p">:</span>
            <span class="c1"># Already an open window using this &#39;location&#39;...  Tell it to open</span>
            <span class="c1"># a new terminal for the user.</span>
            <span class="n">new_location_instance</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c1"># Find the ApplicationWebSocket instance using the given &#39;location&#39;:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">new_location</span><span class="p">:</span>
                    <span class="n">ws_instance</span> <span class="o">=</span> <span class="n">instance</span>
                    <span class="k">break</span>
            <span class="c1"># Find the TerminalApplication inside the ws_instance:</span>
            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">ws_instance</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">TerminalApplication</span><span class="p">):</span>
                    <span class="n">new_location_instance</span> <span class="o">=</span> <span class="n">app</span>
            <span class="n">new_location_instance</span><span class="o">.</span><span class="n">new_terminal</span><span class="p">({</span>
                <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">new_term_num</span><span class="p">,</span>
                <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span>
                <span class="s1">&#39;columns&#39;</span><span class="p">:</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">cols</span><span class="p">,</span>
                <span class="s1">&#39;em_dimensions&#39;</span><span class="p">:</span> <span class="n">em_dimensions</span>
            <span class="p">})</span>
            <span class="n">ws_instance</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Incoming terminal from location: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">))</span>
        <span class="c1">#else:</span>
            <span class="c1"># Make sure the new location dict is setup properly</span>
            <span class="c1">#self.add_terminal_callbacks(term, multiplex, callback_id)</span>
        <span class="c1"># Remove old location:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">existing_term</span><span class="p">]</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">new_location</span>
        <span class="p">}</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># Closes the term in the current window/tab</span>
            <span class="s1">&#39;terminal:term_moved&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:move_terminal&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">kill_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kills *term* and any associated processes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s2">&quot;command&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Terminal Killed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">multiplex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="c1"># Remove the EXIT callback so the terminal doesn&#39;t restart itself</span>
        <span class="n">multiplex</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">multiplex</span><span class="o">.</span><span class="n">CALLBACK_EXIT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dtach</span><span class="p">:</span> <span class="c1"># dtach needs special love</span>
                <span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">kill_dtached_proc</span>
                <span class="n">kill_dtached_proc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="n">multiplex</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># The EVIL termio has killed my child!  Wait, that&#39;s good...</span>
                 <span class="c1"># Because now I don&#39;t have to worry about it!</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_term_settings</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:kill_terminal&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>

<div class="viewcode-block" id="TerminalApplication.set_terminal"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.set_terminal">[docs]</a>    <span class="k">def</span> <span class="nf">set_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets `self.current_term = *term*` so we can determine where to send</span>
<span class="sd">        keystrokes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:set_terminal&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Bad term given</span></div>

<div class="viewcode-block" id="TerminalApplication.reset_client_terminal"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.reset_client_terminal">[docs]</a>    <span class="k">def</span> <span class="nf">reset_client_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tells the client to reset the terminal (clear the screen and remove</span>
<span class="sd">        scrollback).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:reset_client_terminal&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:reset_client_terminal&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">reset_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the equivalent of the &#39;reset&#39; command which resets the terminal</span>
<span class="sd">        emulator (among other things) to return the terminal to a sane state in</span>
<span class="sd">        the event that something went wrong (bad escape sequence).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;reset_terminal(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="c1"># This re-creates all the tabstops:</span>
        <span class="n">tabs</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">H        &#39;</span> <span class="o">*</span> <span class="mi">22</span>
        <span class="n">reset_sequence</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\r\x1b</span><span class="s1">[3g        </span><span class="si">%s</span><span class="s1">r</span><span class="se">\x1b</span><span class="s1">c</span><span class="se">\x1b</span><span class="s1">[!p</span><span class="se">\x1b</span><span class="s1">[?3;4l</span><span class="se">\x1b</span><span class="s1">[4l</span><span class="se">\x1b</span><span class="s1">&gt;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tabs</span><span class="p">)</span>
        <span class="n">multiplex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="n">multiplex</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">reset_sequence</span><span class="p">)</span>
        <span class="n">multiplex</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x0c</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># ctrl-l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_refresh</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:reset_terminal&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>

<div class="viewcode-block" id="TerminalApplication.set_title"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.set_title">[docs]</a>    <span class="k">def</span> <span class="nf">set_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client telling it to set the window title of</span>
<span class="sd">        *term* to whatever comes out of::</span>

<span class="sd">            self.loc_terms[term][&#39;multiplex&#39;].term.get_title() # Whew! Say that three times fast!</span>

<span class="sd">        Example message::</span>

<span class="sd">            {&#39;set_title&#39;: {&#39;term&#39;: 1, &#39;title&#39;: &quot;user@host&quot;}}</span>

<span class="sd">        If *force* resolves to True the title will be sent to the cleint even if</span>
<span class="sd">        it matches the previously-set title.</span>

<span class="sd">        if *save* is ``True`` (the default) the title will be saved via the</span>
<span class="sd">        `TerminalApplication.save_term_settings` function so that it may be</span>
<span class="sd">        restored later (in the event of a server restart--if you&#39;ve got dtach</span>
<span class="sd">        support enabled).</span>

<span class="sd">        .. note:: Why the complexity on something as simple as setting the title?  Many prompts set the title.  This means we&#39;d be sending a &#39;title&#39; message to the client with nearly every screen update which is a pointless waste of bandwidth if the title hasn&#39;t changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;set_title(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">save</span><span class="p">))</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;manual_title&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
                <span class="n">title_message</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;terminal:set_title&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">}}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">title_message</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
        <span class="c1"># Only send a title update if it actually changed</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
            <span class="n">title_message</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;terminal:set_title&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">title_message</span><span class="p">))</span>
            <span class="c1"># Save it in case we&#39;re restarted (only matters for dtach)</span>
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_term_settings</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:set_title&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">manual_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the title of *settings[&#39;term&#39;]* to *settings[&#39;title&#39;]*.  Differs</span>
<span class="sd">        from :func:`set_title` in that this is an action that gets called by the</span>
<span class="sd">        client when the user sets a terminal title manually.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;manual_title: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">])</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
            <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;manual_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;manual_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="n">title_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:set_title&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">title_message</span><span class="p">))</span>
        <span class="c1"># Save it in case we&#39;re restarted (only matters for dtach)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_term_settings</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:manual_title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

<div class="viewcode-block" id="TerminalApplication.bell"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.bell">[docs]</a>    <span class="k">def</span> <span class="nf">bell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client indicating that a bell was encountered in</span>
<span class="sd">        the given terminal (*term*).  Example message::</span>

<span class="sd">            {&#39;bell&#39;: {&#39;term&#39;: 1}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bell_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:bell&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">bell_message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:bell&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.mode_handler"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.mode_handler">[docs]</a>    <span class="k">def</span> <span class="nf">mode_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles mode settings that require an action on the client by pasing it</span>
<span class="sd">        a message like::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;terminal:set_mode&#39;: {</span>
<span class="sd">                    &#39;mode&#39;: setting,</span>
<span class="sd">                    &#39;bool&#39;: True,</span>
<span class="sd">                    &#39;term&#39;: term</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;mode_handler() term: </span><span class="si">%s</span><span class="s2">, setting: </span><span class="si">%s</span><span class="s2">, boolean: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">boolean</span><span class="p">))</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="c1"># So we can restore it:</span>
        <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;application_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boolean</span>
        <span class="k">if</span> <span class="n">boolean</span><span class="p">:</span>
            <span class="c1"># Tell client to set this mode</span>
            <span class="n">mode_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:set_mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">setting</span><span class="p">,</span>
                <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span>
            <span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">mode_message</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Tell client to reset this mode</span>
            <span class="n">mode_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:set_mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">setting</span><span class="p">,</span>
                <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span>
            <span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">mode_message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:mode_handler&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">boolean</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.dsr"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.dsr">[docs]</a>    <span class="k">def</span> <span class="nf">dsr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles Device Status Report (DSR) calls from the underlying program</span>
<span class="sd">        that get caught by the terminal emulator.  *response* is what the</span>
<span class="sd">        terminal emulator returns from the CALLBACK_DSR callback.</span>

<span class="sd">        .. note:: This also handles the CSI DSR sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="n">m</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication._send_refresh"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication._send_refresh">[docs]</a>    <span class="k">def</span> <span class="nf">_send_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends a screen update to the client.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
            <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;last_activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># This can happen if the user disconnected in the middle of a screen</span>
            <span class="c1"># update or if the terminal was closed really quickly before the</span>
            <span class="c1"># Tornado framework got a chance to call this function.  Nothing to</span>
            <span class="c1"># be concerned about.</span>
            <span class="k">return</span> <span class="c1"># Ignore</span>
        <span class="n">multiplex</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="n">scrollback</span><span class="p">,</span> <span class="n">screen</span> <span class="o">=</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">dump_html</span><span class="p">(</span>
            <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">screen</span> <span class="k">if</span> <span class="n">a</span><span class="p">]:</span> <span class="c1"># Checking for non-empty lines here</span>
            <span class="n">output_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;terminal:termupdate&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                    <span class="s1">&#39;scrollback&#39;</span><span class="p">:</span> <span class="n">scrollback</span><span class="p">,</span>
                    <span class="s1">&#39;screen&#39;</span> <span class="p">:</span> <span class="n">screen</span><span class="p">,</span>
                    <span class="s1">&#39;ratelimiter&#39;</span><span class="p">:</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">ratelimiter_engaged</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">output_dict</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span> <span class="c1"># Socket was just closed, no biggie</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;WebSocket closed (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">])</span>
                <span class="n">multiplex</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
                <span class="n">multiplex</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span> <span class="c1"># Stop trying to write</span>
                    <span class="n">multiplex</span><span class="o">.</span><span class="n">CALLBACK_UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.refresh_screen"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.refresh_screen">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the state of the given terminal&#39;s screen and scrollback buffer to</span>
<span class="sd">        the client using `_send_refresh()`.  Also ensures that screen updates</span>
<span class="sd">        don&#39;t get sent too fast to the client by instituting a rate limiter that</span>
<span class="sd">        also forces a refresh every 150ms.  This keeps things smooth on the</span>
<span class="sd">        client side and also reduces the bandwidth used by the application (CPU</span>
<span class="sd">        too).</span>

<span class="sd">        If *full*, send the whole screen (not just the difference).</span>

<span class="sd">        The *stream* argument is meant to contain the raw character stream that</span>
<span class="sd">        resulted in the terminal screen being updated.  It is only used to pass</span>
<span class="sd">        the data through to the &#39;terminal:refresh_screen&#39; event.  This event is</span>
<span class="sd">        and that raw data is used by the `TerminalApplication.start_capture` and</span>
<span class="sd">        `TerminalApplication.stop_capture` methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Commented this out because it was getting annoying.</span>
        <span class="c1"># Note to self: add more levels of debugging beyond just &quot;debug&quot;.</span>
        <span class="c1">#self.term_log.debug(</span>
            <span class="c1">#&quot;refresh_screen (full=%s) on %s&quot; % (full, self.callback_id))</span>
        <span class="k">if</span> <span class="n">term</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># This just prevents an exception when the cookie is invalid</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msec</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1"># Keeps things smooth</span>
            <span class="c1"># In testing, 150 milliseconds was about as low as I could go and</span>
            <span class="c1"># still remain practical.</span>
            <span class="n">force_refresh_threshold</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
            <span class="n">last_activity</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;last_activity&#39;</span><span class="p">]</span>
            <span class="n">timediff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_activity</span>
            <span class="c1"># Because users can be connected to their session from more than one</span>
            <span class="c1"># browser/computer we differentiate between refresh timeouts by</span>
            <span class="c1"># tying the timeout to the client_id.</span>
            <span class="n">client_dict</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span>
            <span class="n">multiplex</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_refresh</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
            <span class="c1"># We impose a rate limit of max one screen update every 50ms by</span>
            <span class="c1"># wrapping the call to _send_refresh() in an IOLoop timeout that</span>
            <span class="c1"># gets cancelled and replaced if screen updates come in faster than</span>
            <span class="c1"># once every 50ms.  If screen updates are consistently faster than</span>
            <span class="c1"># that (e.g. a key is held down) we also force sending the screen</span>
            <span class="c1"># to the client every 150ms.  This ensures that no matter how fast</span>
            <span class="c1"># screen updates are happening the user will get at least one</span>
            <span class="c1"># update every 150ms.  It works out quite nice, actually.</span>
            <span class="k">if</span> <span class="n">client_dict</span><span class="p">[</span><span class="s1">&#39;refresh_timeout&#39;</span><span class="p">]:</span>
                <span class="n">multiplex</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">remove_timeout</span><span class="p">(</span><span class="n">client_dict</span><span class="p">[</span><span class="s1">&#39;refresh_timeout&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">timediff</span> <span class="o">&gt;</span> <span class="n">force_refresh_threshold</span><span class="p">:</span>
                <span class="n">refresh</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client_dict</span><span class="p">[</span><span class="s1">&#39;refresh_timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span>
                    <span class="n">msec</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Session died (i.e. command ended).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;KeyError in refresh_screen: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:refresh_screen&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.full_refresh"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.full_refresh">[docs]</a>    <span class="k">def</span> <span class="nf">full_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls `self.refresh_screen(*term*, full=True)`&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Invalid terminal number given to full_refresh(): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:full_refresh&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resize_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resize the terminal window to the rows/columns specified in *resize_obj*</span>

<span class="sd">        Example *resize_obj*::</span>

<span class="sd">            {&#39;rows&#39;: 24, &#39;columns&#39;: 80}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s1">&#39;term&#39;</span> <span class="ow">in</span> <span class="n">resize_obj</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resize_obj</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="c1"># Got bad value, skip this resize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resizing Terminal: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">resize_obj</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">resize_obj</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">resize_obj</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">em_dimensions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">resize_obj</span><span class="p">[</span><span class="s1">&#39;em_dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;h&#39;</span><span class="p">],</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">resize_obj</span><span class="p">[</span><span class="s1">&#39;em_dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">ctrl_l</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="s1">&#39;ctrl_l&#39;</span> <span class="ow">in</span> <span class="n">resize_obj</span><span class="p">:</span>
            <span class="n">ctrl_l</span> <span class="o">=</span> <span class="n">resize_obj</span><span class="p">[</span><span class="s1">&#39;ctrl_l&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">cols</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Fall back to a standard default:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="c1"># If the user already has a running session, set the new terminal size:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">term</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
                <span class="n">m</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                    <span class="n">rows</span><span class="p">,</span>
                    <span class="n">cols</span><span class="p">,</span>
                    <span class="n">em_dimensions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_dimensions</span><span class="p">,</span>
                    <span class="n">ctrl_l</span><span class="o">=</span><span class="n">ctrl_l</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Resize them all</span>
                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="c1"># Skip the TidyThread</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                            <span class="n">rows</span><span class="p">,</span>
                            <span class="n">cols</span><span class="p">,</span>
                            <span class="n">em_dimensions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_dimensions</span><span class="p">,</span>
                            <span class="n">ctrl_l</span><span class="o">=</span><span class="n">ctrl_l</span>
                        <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># Session doesn&#39;t exist yet, no biggie</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;terminal:resize&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span> <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="n">rows</span><span class="p">,</span> <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">cols</span><span class="p">}})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:resize&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">char_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes *chars* (string) to *term*.  If *term* is not provided the</span>
<span class="sd">        characters will be sent to the currently-selected terminal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;char_handler(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">chars</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">term</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">term</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="c1"># Just in case it was sent as a string</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span> <span class="ow">in</span> <span class="n">SESSIONS</span> <span class="ow">and</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="n">multiplex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="n">multiplex</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
                <span class="c1"># Handle (gracefully) the situation where a capture is stopped</span>
                <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">capture</span><span class="p">:</span>
                        <span class="k">return</span> <span class="c1"># Nothing to do</span>
                    <span class="c1"># Make sure the call to abort_capture() comes *after* the</span>
                    <span class="c1"># underlying program has itself caught the SIGINT (Ctrl-C)</span>
                    <span class="n">multiplex</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span>
                        <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
                        <span class="n">multiplex</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">abort_capture</span><span class="p">)</span>
                    <span class="c1"># Also make sure the client gets a screen update</span>
                    <span class="n">refresh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
                    <span class="n">multiplex</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span>
                        <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">1050</span><span class="p">),</span> <span class="n">refresh</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">write_chars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes *message[&#39;chars&#39;]* to *message[&#39;term&#39;]*.  If *message[&#39;term&#39;]*</span>
<span class="sd">        is not present, *self.current_term* will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self.term_log.debug(&#39;write_chars(%s)&#39; % message)</span>
        <span class="k">if</span> <span class="s1">&#39;chars&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Invalid message</span>
        <span class="k">if</span> <span class="s1">&#39;term&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">message</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">char_handler</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;chars&#39;</span><span class="p">],</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Term is closed or invalid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Got exception trying to write_chars() to terminal </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

<div class="viewcode-block" id="TerminalApplication.opt_esc_handler"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.opt_esc_handler">[docs]</a>    <span class="k">def</span> <span class="nf">opt_esc_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">multiplex</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls whatever function is attached to the</span>
<span class="sd">        &#39;terminal:opt_esc_handler:&lt;name&gt;&#39; event; passing it the *text* (second</span>
<span class="sd">        item in the tuple) that is returned by</span>
<span class="sd">        :func:`utils.process_opt_esc_sequence`.  Such functions are usually</span>
<span class="sd">        attached via the &#39;Escape&#39; plugin hook but may also be registered via</span>
<span class="sd">        the usual event method, :meth`self.on`::</span>

<span class="sd">            self.on(&#39;terminal:opt_esc_handler:somename&#39;, some_function)</span>

<span class="sd">        The above example would result in :func:`some_function` being called</span>
<span class="sd">        whenever a matching optional escape sequence handler is encountered.</span>
<span class="sd">        For example:</span>

<span class="sd">        .. ansi-block::</span>

<span class="sd">            $ echo -e &quot;\\033]_;somename|Text passed to some_function()\\007&quot;</span>

<span class="sd">        Which would result in :func:`some_function` being called like so::</span>

<span class="sd">            some_function(</span>
<span class="sd">                self, &quot;Text passed to some_function()&quot;, term, multiplex)</span>

<span class="sd">        In the above example, *term* will be the terminal number that emitted</span>
<span class="sd">        the event and *multiplex* will be the `termio.Multiplex` instance that</span>
<span class="sd">        controls the terminal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;opt_esc_handler(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">chars</span><span class="p">))</span>
        <span class="n">plugin_name</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">process_opt_esc_sequence</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plugin_name</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;terminal:opt_esc_handler:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">plugin_name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">,</span> <span class="n">multiplex</span><span class="o">=</span><span class="n">multiplex</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Got exception trying to execute plugin&#39;s optional ESC &quot;</span>
                    <span class="s2">&quot;sequence handler...&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span></div>

<div class="viewcode-block" id="TerminalApplication.get_bell"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.get_bell">[docs]</a>    <span class="k">def</span> <span class="nf">get_bell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the bell sound data to the client in in the form of a data::URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bell_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/bell.ogg&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bell_data_uri</span> <span class="o">=</span> <span class="n">create_data_uri</span><span class="p">(</span><span class="n">bell_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">MimeTypeFail</span><span class="p">):</span> <span class="c1"># There&#39;s always the fallback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not load bell: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">bell_path</span><span class="p">)</span>
            <span class="n">bell_data_uri</span> <span class="o">=</span> <span class="n">resource_string</span><span class="p">(</span>
                <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/fallback_bell.txt&#39;</span><span class="p">)</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="n">bell_data_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;terminal:load_bell&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;data_uri&#39;</span><span class="p">:</span> <span class="n">bell_data_uri</span><span class="p">,</span> <span class="s1">&#39;mimetype&#39;</span><span class="p">:</span> <span class="n">mimetype</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span></div>

<div class="viewcode-block" id="TerminalApplication.get_webworker"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.get_webworker">[docs]</a>    <span class="k">def</span> <span class="nf">get_webworker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the text of our term_ww.js to the client in order to get</span>
<span class="sd">        around the limitations of loading remote Web Worker URLs (for embedding</span>
<span class="sd">        Gate One into other apps).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">go_process</span> <span class="o">=</span> <span class="n">resource_string</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/webworkers/term_ww.js&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:load_webworker&#39;</span><span class="p">:</span> <span class="n">go_process</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span></div>

<div class="viewcode-block" id="TerminalApplication.get_colors"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.get_colors">[docs]</a>    <span class="k">def</span> <span class="nf">get_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the text color stylesheet matching the properties specified in</span>
<span class="sd">        *settings* to the client.  *settings* must contain the following:</span>

<span class="sd">           :colors: The name of the CSS text color scheme to be retrieved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;get_colors(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">send_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;send_css&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send_css</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="s1">&#39;logged_css_message&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;send_css is false; will not send JavaScript.&quot;</span><span class="p">))</span>
            <span class="c1"># So we don&#39;t repeat this message a zillion times in the logs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logged_css_message</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>
        <span class="n">colors_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.css&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;colors&quot;</span><span class="p">]</span>
        <span class="n">colors_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;/templates/term_colors/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">colors_filename</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;term_colors.css&quot;</span> <span class="c1"># Make sure it&#39;s the same every time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_and_send_css</span><span class="p">(</span><span class="n">colors_path</span><span class="p">,</span>
            <span class="n">element_id</span><span class="o">=</span><span class="s2">&quot;text_colors&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">get_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `terminal:get_locations` WebSocket action.  Sends a</span>
<span class="sd">        message to the client (via the `terminal:term_locations` WebSocket</span>
<span class="sd">        action) listing all &#39;locations&#39; where terminals reside.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Typically the location mechanism is used to open terminals in</span>
<span class="sd">            different windows/tabs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term_locations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">location</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">locations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">terms</span><span class="p">:</span>
                <span class="n">term_locations</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">terms</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:term_locations&#39;</span><span class="p">:</span> <span class="n">term_locations</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:term_locations&quot;</span><span class="p">,</span> <span class="n">term_locations</span><span class="p">)</span>

<span class="c1"># Terminal sharing TODO (not in any particular order or priority):</span>
<span class="c1">#   * GUI elements that allow a user to share a terminal:</span>
<span class="c1">#       DONE Share this terminal:</span>
<span class="c1">#           DONE - Allow anyone with the right URL to view (requires authorization-on-connect).</span>
<span class="c1">#           DONE - Allow only authenticated users.</span>
<span class="c1">#           DONE - Allow only specified users.</span>
<span class="c1">#       - Sharing controls widget (pause/resume sharing, primarily).</span>
<span class="c1">#       - Chat widget (or similar--maybe with audio/video via WebRTC).</span>
<span class="c1">#       - A mechanism to invite people (send an email/alert).</span>
<span class="c1">#       - A mechanism to approve inbound viewers (for &quot;allow AUTHENTICATED&quot; situations).</span>
<span class="c1">#   * A server-side API to control sharing:</span>
<span class="c1">#       DONE - Share X with authorization options (allow anon w/URL and/or password, authenticated users, or a specific list)</span>
<span class="c1">#       DONE            - Stop sharing terminal X.</span>
<span class="c1">#       - Pause sharing of terminal X (So it can be resumed without having to change the viewers/write list).</span>
<span class="c1">#       DONE - Generate sharing URL for terminal X.</span>
<span class="c1">#       - Send invitation to view terminal X.  Connected user(s), email, and possibly other mechanisms (Jabber/Google Talk, SMS, etc)</span>
<span class="c1">#       - Approve inbound viewer.</span>
<span class="c1">#       DONE            - Allow viewer(s) to control terminal X.</span>
<span class="c1">#       - A completely separate chat/communications API.</span>
<span class="c1">#       DONE            - List shared terminals.</span>
<span class="c1">#       DONE            - Must integrate policy support for @require(policies(&#39;terminal&#39;))</span>
<span class="c1">#   * A client-side API to control sharing:</span>
<span class="c1">#       DONE - Notify user of connected viewers.</span>
<span class="c1">#       - Notify user of access/control grants.</span>
<span class="c1">#       - Control playback history via server-side events (in case a viewer wants to point something out that just happened).</span>
<span class="c1">#   * DONE - A RequestHandler to handle anonymous connections to shared terminals.  Needs to serve up something specific (not index.html).</span>
<span class="c1">#   * DONE - A mechanism to generate anonymous sharing URLs.</span>
<span class="c1">#   * A way for users to communicate with each other (chat, audio, video).</span>
<span class="c1">#   * DONE - A mechansim for password-protecting shared terminals.</span>
<span class="c1">#   * Logic to detect the optimum terminal size for all viewers.</span>
<span class="c1">#   * DONE - A data structure of some sort to keep track of shared terminals and who is currently connected to them.</span>
<span class="c1">#   * A way to view multiple shared terminals on a single page with the option to break them out into individual windows/tabs.</span>
    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attached to the `terminal:permissions` WebSocket action; controls the</span>
<span class="sd">        sharing permissions on a given *settings[&#39;term&#39;]*.  Specifically, who</span>
<span class="sd">        may view or write to a given terminal.</span>

<span class="sd">        The *settings* dict **must** contain the following::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;term&#39;: &lt;terminal number&gt;,</span>
<span class="sd">                &#39;read&#39;: &lt;&quot;ANONYMOUS&quot;, &quot;AUTHENTICATED&quot;, or a list of UPNs&gt;</span>
<span class="sd">            }</span>

<span class="sd">        Optionally, the *settings* dict may also contain the following::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;broadcast&#39;: &lt;True/False&gt;, # Default: False</span>
<span class="sd">                &#39;password&#39;: &lt;string&gt;, # Default: No password</span>
<span class="sd">                &#39;write&#39;: &lt;&quot;ANONYMOUS&quot;, &quot;AUTHENTICATED&quot;,  or a list of UPNs&gt;</span>
<span class="sd">                # If &quot;write&quot; is omitted the terminal will be shared read-only</span>
<span class="sd">            }</span>

<span class="sd">        If *broadcast* is True, anyone will be able to connect to the shared</span>
<span class="sd">        terminal without a password.  A URL where users can access the shared</span>
<span class="sd">        terminal will be automatically generated.</span>

<span class="sd">        If a *password* is provided, the given password will be required before</span>
<span class="sd">        users may connect to the shared terminal.</span>

<span class="sd">        Example WebSocket command to share a terminal:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            settings = {</span>
<span class="sd">                &quot;term&quot;: 1,</span>
<span class="sd">                &quot;read&quot;: &quot;AUTHENTICATED&quot;,</span>
<span class="sd">                &quot;password&quot;: &quot;foo&quot; // Omit if no password is required</span>
<span class="sd">            }</span>
<span class="sd">            GateOne.ws.send(JSON.stringify({&quot;terminal:permissions&quot;: settings}));</span>

<span class="sd">        .. note::</span>

<span class="sd">            If the server is configured with `&quot;auth&quot;: &quot;none&quot;` and</span>
<span class="sd">            *settings[&#39;read&#39;]* is &quot;AUTHENTICATED&quot; all users will be able to view</span>
<span class="sd">            the shared terminal without having to enter a password.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;permissions(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">random_words</span>
        <span class="n">share_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span><span class="p">))</span>
        <span class="c1"># Share permissions get stored in the PERSIST global</span>
        <span class="k">if</span> <span class="s1">&#39;shared&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">][</span><span class="s1">&#39;shared&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">shared_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">][</span><span class="s1">&#39;shared&#39;</span><span class="p">]</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">term_obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Terminal does not exist (anymore)</span>
        <span class="n">read</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># List of who to share with</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">read</span> <span class="o">=</span> <span class="p">[</span><span class="n">read</span><span class="p">]</span> <span class="c1"># Must be a list even if only one permission</span>
        <span class="n">write</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># Who can write (implies read access)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">write</span> <span class="o">=</span> <span class="p">[</span><span class="n">write</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c1"># &quot;broadcast&quot; mode allows anonymous access without a password</span>
        <span class="n">broadcast_url_template</span> <span class="o">=</span> <span class="s2">&quot;{base_url}terminal/shared/{share_id}&quot;</span>
        <span class="n">broadcast</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;broadcast&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">share_id</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">shared_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;term_obj&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">term_obj</span><span class="p">:</span>
                <span class="c1"># Save the original read permissions for access check/revoke</span>
                <span class="n">orig_read</span> <span class="o">=</span> <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">][</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
                <span class="c1"># Update existing permissions</span>
                <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">][</span><span class="s1">&#39;read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read</span>
                <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">][</span><span class="s1">&#39;write&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">write</span>
                <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
                <span class="k">if</span> <span class="n">broadcast</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span> <span class="c1"># Generate a new broadcast URL</span>
                    <span class="n">broadcast</span> <span class="o">=</span> <span class="n">broadcast_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span>
                        <span class="n">share_id</span><span class="o">=</span><span class="n">share_id</span><span class="p">)</span>
                <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">][</span><span class="s1">&#39;broadcast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">broadcast</span>
                <span class="c1"># Perform an access check and revoke access for existing viewers</span>
                <span class="c1"># if they have been removed from the &#39;read&#39; list</span>
                <span class="k">for</span> <span class="n">upn</span> <span class="ow">in</span> <span class="n">orig_read</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">upn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">][</span><span class="s1">&#39;read&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">remove_viewer</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">upn</span><span class="p">)</span>
                <span class="c1"># Check if nothing is shared anymore so we can remove it</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">read</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">broadcast</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_viewer</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="c1"># Remove all viewers</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">][</span><span class="s1">&#39;shared&#39;</span><span class="p">][</span><span class="n">share_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notify_permissions</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">read</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">broadcast</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="n">share_id</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random_words</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">broadcast</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span> <span class="c1"># Generate a broadcast URL</span>
            <span class="n">broadcast</span> <span class="o">=</span> <span class="n">broadcast_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span>
                <span class="n">share_id</span><span class="o">=</span><span class="n">share_id</span><span class="p">)</span>
        <span class="n">share_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span>
            <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s1">&#39;term_obj&#39;</span><span class="p">:</span> <span class="n">term_obj</span><span class="p">,</span>
            <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">read</span><span class="p">,</span>
            <span class="s1">&#39;write&#39;</span><span class="p">:</span> <span class="n">write</span><span class="p">,</span> <span class="c1"># Populated on-demand by the sharing user</span>
            <span class="s1">&#39;broadcast&#39;</span><span class="p">:</span> <span class="n">broadcast</span><span class="p">,</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
            <span class="s1">&#39;viewers&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">})</span>
        <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">share_dict</span>
        <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;share_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">share_id</span> <span class="c1"># So we can quickly tell it&#39;s shared</span>
        <span class="c1"># Make a note of this shared terminal and its permissions in the logs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;{upn} updated sharing permissions on terminal {term} ({title}))&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">upn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
                <span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]),</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;share_id&#39;</span><span class="p">:</span> <span class="n">share_id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:permissions&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
        <span class="c1"># Send the client the permissions information now that it&#39;s changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify_permissions</span><span class="p">()</span>

<div class="viewcode-block" id="TerminalApplication.remove_viewer"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.remove_viewer">[docs]</a>    <span class="k">def</span> <span class="nf">remove_viewer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disconnects all callbacks attached to the given *term* for the given</span>
<span class="sd">        *upn* and notifies that user that the terminal is no longer shared (so</span>
<span class="sd">        it can be shown to be disconnected at the client).</span>

<span class="sd">        If *upn* is `None` all users (broadcast viewers included) will have the</span>
<span class="sd">        given *term* disconnected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="n">share_id</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;share_id&#39;</span><span class="p">]</span>
        <span class="n">shared_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">][</span><span class="s1">&#39;shared&#39;</span><span class="p">]</span>
        <span class="n">share_obj</span> <span class="o">=</span> <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">]</span>
        <span class="n">term_app_instance</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="n">term_instance</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:share_disconnected&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">}}</span>
            <span class="c1">#self.write_message(json_encode(message))</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ANONYMOUS&#39;</span><span class="p">:</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">current_user</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">upn</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upn&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">upn</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c1"># Don&#39;t need to &quot;remove&quot; the owner</span>
            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">TerminalApplication</span><span class="p">):</span>
                    <span class="c1"># This is that user&#39;s instance of the Terminal app</span>
                    <span class="n">term_app_instance</span> <span class="o">=</span> <span class="n">app</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">u_term_obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">term_app_instance</span><span class="o">.</span><span class="n">loc_terms</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">term_obj</span> <span class="o">==</span> <span class="n">u_term_obj</span><span class="p">:</span>
                    <span class="n">multiplex</span> <span class="o">=</span> <span class="n">u_term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_terminal_callbacks</span><span class="p">(</span>
                        <span class="n">multiplex</span><span class="p">,</span> <span class="n">term_app_instance</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">term_app_instance</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
                    <span class="n">term_app_instance</span><span class="o">.</span><span class="n">clear_term_settings</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                    <span class="n">term_app_instance</span><span class="o">.</span><span class="n">term_ended</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">viewer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;viewers&#39;</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">viewer</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]:</span>
                    <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;viewers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">upn</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upn&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">upn</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">term_app_instance</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># User is no longer viewing the terminal</span></div>

<div class="viewcode-block" id="TerminalApplication.notify_permissions"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.notify_permissions">[docs]</a>    <span class="k">def</span> <span class="nf">notify_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends clients the list of shared terminals if they have been granted</span>
<span class="sd">        access to any shared terminal.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Normally this only gets called from</span>
<span class="sd">            `~TerminalApplication.permissions` after something changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;notify_permissions()&quot;</span><span class="p">)</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_list_connected_users</span><span class="p">()</span>
        <span class="n">shared_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">][</span><span class="s1">&#39;shared&#39;</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">out_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_terminals_dict</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:shared_terminals&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;terminals&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}}</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ANONYMOUS&#39;</span><span class="p">:</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="n">upn</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upn&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">upn</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">share_id</span><span class="p">,</span> <span class="n">share_dict</span> <span class="ow">in</span> <span class="n">shared_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span> <span class="c1"># Owner</span>
                        <span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="s1">&#39;AUTHENTICATED&#39;</span> <span class="ow">in</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]:</span>
                        <span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">upn</span> <span class="ow">in</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]:</span>
                        <span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1"># User disconnected in the middle of this operation</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">new_share_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a new pair of words to act as the share/broadcast ID for a</span>
<span class="sd">        given *settings[&#39;term&#39;]*.  If a &#39;term&#39; is not provided the currently</span>
<span class="sd">        selected terminal will be used.</span>

<span class="sd">        Optionally, *settings[&#39;share_id&#39;] may be provied to explicitly set it to</span>
<span class="sd">        the given value.</span>

<span class="sd">        .. note:: The terminal must already be shared with broadcast enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">random_words</span>
        <span class="k">if</span> <span class="s1">&#39;term&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Invalid</span>
        <span class="k">if</span> <span class="s1">&#39;shared&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span><span class="p">))</span>
        <span class="n">random_share_id</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random_words</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">new_share_id</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;share_id&#39;</span><span class="p">,</span> <span class="n">random_share_id</span><span class="p">)</span>
        <span class="n">shared_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">][</span><span class="s1">&#39;shared&#39;</span><span class="p">]</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="n">broadcast_url_template</span> <span class="o">=</span> <span class="s2">&quot;{base_url}terminal/shared/{share_id}&quot;</span>
        <span class="n">old_share_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">new_share_id</span> <span class="ow">in</span> <span class="n">shared_terms</span><span class="p">:</span> <span class="c1"># Already exists</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Share ID &#39;</span><span class="si">%s</span><span class="s2">&#39; is already in use&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">new_share_id</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">share_id</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">shared_terms</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;term_obj&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">term_obj</span><span class="p">:</span>
                <span class="n">old_share_id</span> <span class="o">=</span> <span class="n">share_id</span>
                <span class="n">broadcast</span> <span class="o">=</span> <span class="n">broadcast_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span>
                    <span class="n">share_id</span><span class="o">=</span><span class="n">new_share_id</span><span class="p">)</span>
                <span class="n">shared_terms</span><span class="p">[</span><span class="n">new_share_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">]</span>
                <span class="n">shared_terms</span><span class="p">[</span><span class="n">new_share_id</span><span class="p">][</span><span class="s1">&#39;broadcast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">broadcast</span>
                <span class="k">del</span> <span class="n">shared_terms</span><span class="p">[</span><span class="n">share_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;{upn} changed share ID of terminal {term} from &#39;{old}&#39;&#39; to &quot;</span>
              <span class="s2">&quot;&#39;{new}&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">upn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
                <span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">,</span>
                <span class="n">old</span><span class="o">=</span><span class="n">old_share_id</span><span class="p">,</span>
                <span class="n">new</span><span class="o">=</span><span class="n">new_share_id</span><span class="p">))</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the client an object representing the permissions of the given</span>
<span class="sd">        *term*.  Example JavaScript:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({</span>
<span class="sd">                &quot;terminal:get_permissions&quot;: 1</span>
<span class="sd">            }));</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;shared&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error: Invalid share ID.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Success&#39;</span><span class="p">}</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">term_obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Term doesn&#39;t exist</span>
        <span class="n">shared_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">][</span><span class="s1">&#39;shared&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">share_id</span><span class="p">,</span> <span class="n">share_dict</span> <span class="ow">in</span> <span class="n">shared_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;term_obj&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">term_obj</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;share_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">share_id</span>
                <span class="k">break</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:sharing_permissions&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:get_sharing_permissions&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">share_user_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">share_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the client a dict of users that are currently viewing the terminal</span>
<span class="sd">        associated with *share_id* using the &#39;terminal:share_user_list&#39;</span>
<span class="sd">        WebSocket action.  The output will indicate which users have write</span>
<span class="sd">        access.  Example JavaScript:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            var shareID = &quot;notification-chicken&quot;;</span>
<span class="sd">            GateOne.ws.send(JSON.stringify({</span>
<span class="sd">                &quot;terminal:share_user_list&quot;: shareID</span>
<span class="sd">            }));</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;viewers&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:share_user_list&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">share_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">][</span><span class="s1">&#39;shared&#39;</span><span class="p">][</span><span class="n">share_id</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No terminal associated with the given share_id.&quot;</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;viewers&#39;</span> <span class="ow">in</span> <span class="n">share_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;viewers&#39;</span><span class="p">]:</span>
                <span class="c1"># Only let the client know about the UPN and IP Address</span>
                <span class="n">user_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;upn&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
                    <span class="n">user_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]})</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;viewers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">allowed</span> <span class="ow">in</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:share_user_list&quot;</span><span class="p">,</span> <span class="n">share_id</span><span class="p">)</span>

<div class="viewcode-block" id="TerminalApplication._shared_terminals_dict"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication._shared_terminals_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_shared_terminals_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dict containing information about all shared terminals that</span>
<span class="sd">        the given *user* has access to.  If no *user* is given</span>
<span class="sd">        `self.current_user` will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="n">shared_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shared&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">share_id</span><span class="p">,</span> <span class="n">share_dict</span> <span class="ow">in</span> <span class="n">shared_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">auth_or_anon</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">explicit_user</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">read_perm</span> <span class="ow">in</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">read_perm</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AUTHENTICATED&#39;</span><span class="p">,</span> <span class="s1">&#39;ANONYMOUS&#39;</span><span class="p">]:</span>
                    <span class="n">auth_or_anon</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]:</span>
                <span class="n">explicit_user</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]:</span>
                <span class="n">owner</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">owner</span> <span class="ow">or</span> <span class="n">auth_or_anon</span> <span class="ow">or</span> <span class="n">explicit_user</span><span class="p">:</span>
                <span class="n">password</span> <span class="o">=</span> <span class="n">share_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">password</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">password</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># Looks better at the client this way</span>
                <span class="k">elif</span> <span class="n">password</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">owner</span><span class="p">:</span> <span class="c1"># This would be a string</span>
                    <span class="n">password</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># Don&#39;t want to reveal it to the client!</span>
                <span class="n">broadcast</span> <span class="o">=</span> <span class="n">share_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;broadcast&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="n">share_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">],</span> <span class="c1"># Only useful for the owner</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;term_obj&#39;</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;write&#39;</span><span class="p">:</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;viewers&#39;</span><span class="p">:</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;viewers&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;password_protected&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                    <span class="s1">&#39;broadcast&#39;</span><span class="p">:</span> <span class="n">broadcast</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="n">out_dict</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">(),</span> <span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">list_shared_terminals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a message to the client listing all the shared terminals they</span>
<span class="sd">        may access.  Example JavaScript:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({</span>
<span class="sd">                &quot;terminal:list_shared_terminals&quot;: null</span>
<span class="sd">            }));</span>

<span class="sd">        The client will be sent the list of shared terminals via the</span>
<span class="sd">        `terminal:shared_terminals` WebSocket action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_terminals_dict</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:shared_terminals&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;terminals&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:list_shared_terminals&quot;</span><span class="p">)</span>

    <span class="c1"># NOTE: This doesn&#39;t require authenticated() so anonymous sharing can work</span>
    <span class="nd">@require</span><span class="p">(</span><span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">attach_shared_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attaches callbacks for the terminals associated with</span>
<span class="sd">        *settings[&#39;share_id&#39;]* if the user is authorized to view the share or if</span>
<span class="sd">        the given *settings[&#39;password&#39;]* is correct (if shared anonymously).</span>

<span class="sd">        To attach to a shared terminal from the client:</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            settings = {</span>
<span class="sd">                &quot;share_id&quot;: &quot;ZWVjNGRiZTA0OTllNDJiODkwOGZjNDA2ZWNkNGU4Y2UwM&quot;,</span>
<span class="sd">                &quot;password&quot;: &quot;password here&quot;,</span>
<span class="sd">                &quot;metadata&quot;: {&quot;optional metadata&quot;: &quot;would go here&quot;}</span>
<span class="sd">            }</span>
<span class="sd">            GateOne.ws.send(JSON.stringify({</span>
<span class="sd">                &quot;terminal:attach_shared_terminal&quot;: settings</span>
<span class="sd">            }));</span>

<span class="sd">        .. note::</span>

<span class="sd">            Providing a password is only necessary if the shared terminal</span>
<span class="sd">            requires it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;attach_shared_terminal(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;share_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid share_id.&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">shared_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shared&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">share_obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">share_id</span><span class="p">,</span> <span class="n">share_dict</span> <span class="ow">in</span> <span class="n">shared_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">share_id</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;share_id&#39;</span><span class="p">]:</span>
                <span class="n">share_obj</span> <span class="o">=</span> <span class="n">share_dict</span>
                <span class="k">break</span> <span class="c1"># This is the share_dict we want</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">share_obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Requested shared terminal does not exist.&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;broadcast&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;AUTHENTICATED&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;You are not authorized to view this terminal&quot;</span><span class="p">))</span>
                    <span class="k">return</span>
        <span class="k">if</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid password.&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highest_term_num</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;term_obj&#39;</span><span class="p">]</span>
        <span class="c1"># Add this terminal to our existing SESSION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="n">term_obj</span>
        <span class="c1"># We&#39;re basically making a new terminal for this client that happens to</span>
        <span class="c1"># have been started by someone else.</span>
        <span class="n">multiplex</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">term_obj</span><span class="p">:</span>
            <span class="n">term_obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># Used by refresh_screen()</span>
                <span class="s1">&#39;refresh_timeout&#39;</span><span class="p">:</span> <span class="bp">None</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;terminal:term_exists&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;share_id&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;share_id&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="c1"># This resets the screen diff</span>
            <span class="n">multiplex</span><span class="o">.</span><span class="n">prev_output</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">multiplex</span><span class="o">.</span><span class="n">rows</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="c1"># Setup callbacks so that everything gets called when it should</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_terminal_callbacks</span><span class="p">(</span>
            <span class="n">term</span><span class="p">,</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
        <span class="c1"># NOTE: refresh_screen will also take care of cleaning things up if</span>
        <span class="c1">#       term_obj[&#39;multiplex&#39;].isalive() is False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="c1"># Send a fresh screen to the client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span> <span class="o">=</span> <span class="n">term</span>
        <span class="c1"># Restore expanded modes (at the client)</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">expanded_modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode_handler</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>
        <span class="c1"># Tell the client about this terminal&#39;s title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c1"># TODO: Get this performing lookups in an attribute repository</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># In case it&#39;s null/None</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">upn</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upn&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="n">broadcast_viewer</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">:</span>
            <span class="n">upn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span>
            <span class="n">broadcast_viewer</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># Add this user to the list of viewers</span>
        <span class="n">current_viewer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_viewer</span><span class="p">:</span> <span class="c1"># Anonymous broadcast viewer</span>
            <span class="n">current_viewer</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;upn&#39;</span><span class="p">:</span> <span class="n">upn</span><span class="p">,</span>
                <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span>
                <span class="s1">&#39;broadcast&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span>
            <span class="p">}</span>
        <span class="n">viewer_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># Limit it so we don&#39;t give away sensitive info</span>
            <span class="s1">&#39;upn&#39;</span><span class="p">:</span> <span class="n">current_viewer</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">current_viewer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">),</span>
            <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">current_viewer</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">],</span>
            <span class="s1">&#39;broadcast&#39;</span><span class="p">:</span> <span class="n">current_viewer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;broadcast&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;viewers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">share_obj</span><span class="p">:</span>
            <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;viewers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">viewer_dict</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;viewers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">viewer_dict</span><span class="p">)</span>
        <span class="c1"># Make a note of this connection in the logs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;{upn} connected to terminal shared by {owner}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">upn</span><span class="o">=</span><span class="n">upn</span><span class="p">,</span>
                <span class="n">owner</span><span class="o">=</span><span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;upn&#39;</span><span class="p">]),</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">current_viewer</span><span class="p">)</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_terminals_dict</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:shared_terminals&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;terminals&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="c1"># Notify the owner of the terminal that this user is now viewing:</span>
        <span class="n">notice</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) is now viewing terminal </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">current_viewer</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span>
            <span class="n">current_viewer</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">],</span>
            <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">upn</span> <span class="o">==</span> <span class="s1">&#39;ANONYMOUS&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">notice</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;session&#39;</span><span class="p">])</span>
            <span class="c1"># Also send them an updated shared_terminals list:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;session&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">notice</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;upn&#39;</span><span class="p">])</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_deliver</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">upn</span><span class="o">=</span><span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;upn&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">remove_callbacks</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_terminal_callbacks</span><span class="p">(</span><span class="n">multiplex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># Already removed callbacks--no biggie</span>
        <span class="k">if</span> <span class="n">broadcast_viewer</span><span class="p">:</span>
            <span class="n">detach</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detach_shared_terminal</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s1">&#39;terminal:on_close&#39;</span><span class="p">,</span> <span class="n">detach</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># This lets regular users resume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s1">&#39;terminal:on_close&#39;</span><span class="p">,</span> <span class="n">remove_callbacks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;terminal:attach_shared_terminal&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>

    <span class="nd">@require</span><span class="p">(</span><span class="n">policies</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">detach_shared_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops watching the terminal specified via *settings[&#39;term&#39;]*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;detach_shared_terminal(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">term</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># bad settings</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Already detached</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
        <span class="n">multiplex</span> <span class="o">=</span> <span class="n">term_obj</span><span class="p">[</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="n">shared_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shared&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shared_terms</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Nothing to do</span>
        <span class="n">share_obj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">share_id</span><span class="p">,</span> <span class="n">share_dict</span> <span class="ow">in</span> <span class="n">shared_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">term_obj</span> <span class="o">==</span> <span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;term_obj&#39;</span><span class="p">]:</span>
                <span class="n">share_obj</span> <span class="o">=</span> <span class="n">share_dict</span>
                <span class="k">break</span> <span class="c1"># This is the share dict we want</span>
        <span class="c1"># Remove ourselves from the list of viewers for this terminal</span>
        <span class="k">for</span> <span class="n">viewer</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">share_dict</span><span class="p">[</span><span class="s1">&#39;viewers&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">viewer</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">client_id</span><span class="p">:</span>
                <span class="n">share_obj</span><span class="p">[</span><span class="s1">&#39;viewers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_terminal_callbacks</span><span class="p">(</span><span class="n">multiplex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_term_settings</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Already removed callbacks--no biggie</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notify_permissions</span><span class="p">()</span>

<div class="viewcode-block" id="TerminalApplication.render_256_colors"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.render_256_colors">[docs]</a>    <span class="k">def</span> <span class="nf">render_256_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renders the CSS for 256 color support and saves the result as</span>
<span class="sd">        &#39;256_colors.css&#39; in Gate One&#39;s configured `cache_dir`.  If that file</span>
<span class="sd">        already exists and has not been modified since the last time it was</span>
<span class="sd">        generated rendering will be skipped.</span>

<span class="sd">        Returns the path to that file as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE:  Why generate this every time?  Presumably these colors can be</span>
        <span class="c1">#        changed on-the-fly by terminal programs.  That functionality</span>
        <span class="c1">#        has yet to be implemented but this function will enable use to</span>
        <span class="c1">#        eventually do that.</span>
        <span class="c1"># Use the get_settings() function to import our 256 colors (convenient)</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="n">cached_256_colors</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="s1">&#39;256_colors.css&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cached_256_colors</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cached_256_colors</span>
        <span class="n">colors_json_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static/256colors.json&#39;</span><span class="p">)</span>
        <span class="n">color_map</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">colors_json_path</span><span class="p">,</span> <span class="n">add_default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c1"># Setup our 256-color support CSS:</span>
        <span class="n">colors_256</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fg</span> <span class="o">=</span> <span class="s2">&quot;#</span><span class="si">%s</span><span class="s2"> span.fx</span><span class="si">%s</span><span class="s2"> {color: #</span><span class="si">%s</span><span class="s2">;}&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">color_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="s2">&quot;#</span><span class="si">%s</span><span class="s2"> span.bx</span><span class="si">%s</span><span class="s2"> {background-color: #</span><span class="si">%s</span><span class="s2">;} &quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">color_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">fg_rev</span> <span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;#</span><span class="si">%s</span><span class="s2"> span.reverse.fx</span><span class="si">%s</span><span class="s2"> {background-color: #</span><span class="si">%s</span><span class="s2">; color: &quot;</span>
                <span class="s2">&quot;inherit;}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">color_map</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">bg_rev</span> <span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;#</span><span class="si">%s</span><span class="s2"> span.reverse.bx</span><span class="si">%s</span><span class="s2"> {color: #</span><span class="si">%s</span><span class="s2">; background-color: &quot;</span>
                <span class="s2">&quot;inherit;} &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">color_map</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">colors_256</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">fg_rev</span><span class="p">,</span> <span class="n">bg_rev</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cached_256_colors</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">colors_256</span><span class="p">)</span>
        <span class="c1"># send_css() will take care of minifiying and caching further</span>
        <span class="k">return</span> <span class="n">cached_256_colors</span></div>

<div class="viewcode-block" id="TerminalApplication.send_256_colors"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.send_256_colors">[docs]</a>    <span class="k">def</span> <span class="nf">send_256_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the client the CSS to handle 256 color support.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render_256_colors</span><span class="p">())</span></div>

<div class="viewcode-block" id="TerminalApplication.send_print_stylesheet"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.TerminalApplication.send_print_stylesheet">[docs]</a>    <span class="k">def</span> <span class="nf">send_print_stylesheet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the &#39;templates/printing/printing.css&#39; stylesheet to the client</span>
<span class="sd">        using `ApplicationWebSocket.ws.send_css` with the &quot;media&quot; set to</span>
<span class="sd">        &quot;print&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">print_css_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/templates/printing/printing.css&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_and_send_css</span><span class="p">(</span>
            <span class="n">print_css_path</span><span class="p">,</span> <span class="n">element_id</span><span class="o">=</span><span class="s2">&quot;terminal_print_css&quot;</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="s2">&quot;print&quot;</span><span class="p">)</span></div>

    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">debug_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints the terminal&#39;s screen and renditions to stdout so they can be</span>
<span class="sd">        examined more closely.</span>

<span class="sd">        .. note:: Can only be called from a JavaScript console like so...</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({&#39;terminal:debug_terminal&#39;: *term*}));</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="n">term_obj</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">term</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="n">term_obj</span><span class="o">.</span><span class="n">screen</span>
        <span class="n">renditions</span> <span class="o">=</span> <span class="n">term_obj</span><span class="o">.</span><span class="n">renditions</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">screen</span><span class="p">):</span>
            <span class="c1"># This gets rid of images:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">renditions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pympler</span> <span class="kn">import</span> <span class="n">asizeof</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;screen size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">asizeof</span><span class="o">.</span><span class="n">asizeof</span><span class="p">(</span><span class="n">screen</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;renditions size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">asizeof</span><span class="o">.</span><span class="n">asizeof</span><span class="p">(</span><span class="n">renditions</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Total term object size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">asizeof</span><span class="o">.</span><span class="n">asizeof</span><span class="p">(</span><span class="n">term_obj</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># No biggie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">debug</span><span class="p">()</span> <span class="c1"># Do regular debugging as well</span></div>

<div class="viewcode-block" id="apply_cli_overrides"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.apply_cli_overrides">[docs]</a><span class="k">def</span> <span class="nf">apply_cli_overrides</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates *settings* in-place with values given on the command line and</span>
<span class="sd">    updates the `options` global with the values from *settings* if not provided</span>
<span class="sd">    on the command line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Figure out which options are being overridden on the command line</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">terminal_options</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;dtach&#39;</span><span class="p">,</span> <span class="s1">&#39;syslog_session_logging&#39;</span><span class="p">,</span> <span class="s1">&#39;session_logging&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">argument</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">terminal_options</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">settings</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span> <span class="o">==</span> <span class="nb">bytes</span><span class="p">:</span> <span class="c1"># Python 2</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                    <span class="c1"># For whatever reason Tornado doesn&#39;t like unicode values</span>
                    <span class="c1"># for its own settings unless you&#39;re using Python 3...</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="init"><a class="viewcode-back" href="../Applications/terminal/app_terminal.html#app_terminal.init">[docs]</a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to make sure 50terminal.conf is created if terminal-specific settings</span>
<span class="sd">    are not found in the settings directory.</span>

<span class="sd">    Also checks to make sure that the logviewer.py script is executable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">term_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s2">&quot;gateone.terminal&quot;</span><span class="p">)</span>
    <span class="n">logviewer_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
        <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/logviewer.py&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">stat</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">logviewer_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">logviewer_path</span><span class="p">,</span> <span class="mi">0</span><span class="n">o755</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># We don&#39;t have permission to change it.  Not a big deal.</span>
            <span class="k">pass</span>
    <span class="n">terminal_options</span> <span class="o">=</span> <span class="p">(</span> <span class="c1"># These are now terminal-app-specific setttings</span>
        <span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;dtach&#39;</span><span class="p">,</span> <span class="s1">&#39;session_logging&#39;</span><span class="p">,</span> <span class="s1">&#39;syslog_session_logging&#39;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
        <span class="c1"># Get the old settings from the old config file and use them to generate</span>
        <span class="c1"># a new 50terminal.conf</span>
        <span class="k">if</span> <span class="s1">&#39;terminal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">terminal_options</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;command&#39;</span><span class="p">:</span>
                    <span class="c1"># Fix the path to ssh_connect.py if present</span>
                    <span class="k">if</span> <span class="s1">&#39;ssh_connect.py&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s1">&#39;/plugins/&#39;</span><span class="p">,</span> <span class="s1">&#39;/applications/terminal/plugins/&#39;</span><span class="p">)</span>
                    <span class="c1"># Also fix the path to the known_hosts file</span>
                    <span class="k">if</span> <span class="s1">&#39;/ssh/known_hosts&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s1">&#39;/ssh/known_hosts&#39;</span><span class="p">,</span> <span class="s1">&#39;/.ssh/known_hosts&#39;</span><span class="p">)</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;commands&#39;</span> <span class="c1"># Convert to new name</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SSH&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
                <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
    <span class="n">required_settings</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;commands&#39;</span><span class="p">,</span> <span class="s1">&#39;default_command&#39;</span><span class="p">,</span> <span class="s1">&#39;session_logging&#39;</span><span class="p">)</span>
    <span class="n">term_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">generate_terminal_config</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">required_settings</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">setting</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">term_settings</span><span class="p">:</span>
            <span class="n">generate_terminal_config</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">term_settings</span> <span class="ow">or</span> <span class="n">generate_terminal_config</span><span class="p">:</span>
        <span class="c1"># Create some defaults and save the config as 50terminal.conf</span>
        <span class="n">settings_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span>
        <span class="n">terminal_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s1">&#39;50terminal.conf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">terminal_conf_path</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">gateone.core.configuration</span> <span class="kn">import</span> <span class="n">settings_template</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
                <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;/templates/settings/50terminal.conf&#39;</span><span class="p">)</span>
            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Update the settings with defaults</span>
            <span class="n">ssh_connect_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
                <span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;/plugins/ssh/scripts/ssh_connect.py&#39;</span><span class="p">)</span>
            <span class="n">default_command</span> <span class="o">=</span> <span class="p">(</span>
              <span class="s2">&quot;{0} -S &quot;</span>
              <span class="s2">r&quot;&#39;%SESSION_DIR%/%SESSION%/%SHORT_SOCKET%&#39; --sshfp &quot;</span>
              <span class="s2">r&quot;-a &#39;-oUserKnownHostsFile=</span><span class="se">\&quot;</span><span class="s2">%USERDIR%/%USER%/.ssh/known_hosts</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ssh_connect_path</span><span class="p">)</span>
            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;dtach&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s1">&#39;session_logging&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s1">&#39;syslog_session_logging&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s1">&#39;commands&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;SSH&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">default_command</span><span class="p">,</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Connect to hosts via SSH.&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;default_command&#39;</span><span class="p">:</span> <span class="s1">&#39;SSH&#39;</span><span class="p">,</span>
                <span class="s1">&#39;environment_vars&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;TERM&#39;</span><span class="p">:</span> <span class="s1">&#39;xterm-256color&#39;</span>
                <span class="p">},</span>
                <span class="s1">&#39;enabled_filetypes&#39;</span><span class="p">:</span> <span class="s1">&#39;all&#39;</span>
            <span class="p">})</span>
            <span class="n">new_term_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span>
                <span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">terminal_conf_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;// This is Gate One&#39;s Terminal application settings &quot;</span>
                    <span class="s2">&quot;file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_term_settings</span><span class="p">)</span>
    <span class="n">term_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">kill</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">killall</span>
        <span class="n">go_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">]</span>
        <span class="c1"># Kill all running dtach sessions (associated with Gate One anyway)</span>
        <span class="n">killall</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="c1"># Cleanup the session_dir (it is supposed to only contain temp stuff)</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;dtach&#39;</span><span class="p">):</span>
        <span class="n">term_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;dtach command not found.  dtach support has been disabled.&quot;</span><span class="p">))</span>
    <span class="n">apply_cli_overrides</span><span class="p">(</span><span class="n">term_settings</span><span class="p">)</span>
    <span class="c1"># Fix the path to known_hosts if using the old default command</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">term_settings</span><span class="p">[</span><span class="s1">&#39;commands&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">%USERDIR%/%USER%/ssh/known_hosts</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
            <span class="n">term_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;The default path to known_hosts has been changed.  Please &quot;</span>
                <span class="s2">&quot;update your settings to use &#39;/.ssh/known_hosts&#39; instead of &quot;</span>
                <span class="s2">&quot;&#39;/ssh/known_hosts&#39;.  Applying a termporary fix...&quot;</span><span class="p">))</span>
            <span class="n">term_settings</span><span class="p">[</span><span class="s1">&#39;commands&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/ssh/&#39;</span><span class="p">,</span> <span class="s1">&#39;/.ssh/&#39;</span><span class="p">)</span>
    <span class="c1"># Initialize plugins so we can add their &#39;Web&#39; handlers</span>
    <span class="n">enabled_plugins</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled_plugins&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">plugins</span> <span class="o">=</span> <span class="n">entry_point_files</span><span class="p">(</span><span class="s1">&#39;go_terminal_plugins&#39;</span><span class="p">,</span> <span class="n">enabled_plugins</span><span class="p">)</span>
    <span class="c1"># Attach plugin hooks</span>
    <span class="n">plugin_hooks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plugin_hooks</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plugin</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span> <span class="n">plugin</span><span class="o">.</span><span class="n">hooks</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># No hooks, no problem</span>
    <span class="c1"># Add static handlers for all the JS plugins (primarily for source maps)</span>
    <span class="n">url_prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="s1">&#39;gateone&#39;</span><span class="p">][</span><span class="s1">&#39;url_prefix&#39;</span><span class="p">]</span>
    <span class="n">plugins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;css&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plugin_static_url</span> <span class="o">=</span> <span class="s2">r&quot;{prefix}terminal/{name}/static/(.*)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">url_prefix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="p">(</span><span class="n">plugin_static_url</span><span class="p">,</span> <span class="n">StaticHandler</span><span class="p">,</span> <span class="p">{</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s1">&#39;/static/&#39;</span><span class="p">,</span>
            <span class="s1">&#39;use_pkg&#39;</span><span class="p">:</span> <span class="n">plugin</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REGISTERED_HANDLERS</span><span class="p">:</span>
            <span class="n">REGISTERED_HANDLERS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">web_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="c1"># Hook up the &#39;Web&#39; handlers so those URLs are immediately available</span>
    <span class="k">for</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">plugin_hooks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;Web&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;Web&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span> <span class="c1"># Fix it</span>
                    <span class="n">handler</span> <span class="o">=</span> <span class="p">(</span><span class="n">url_prefix</span> <span class="o">+</span> <span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="n">handler</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">REGISTERED_HANDLERS</span><span class="p">:</span>
                    <span class="k">continue</span> <span class="c1"># Already registered this one</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">REGISTERED_HANDLERS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
                    <span class="n">web_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span></div>


<span class="c1"># Tell Gate One which classes are applications</span>
<span class="n">apps</span> <span class="o">=</span> <span class="p">[</span><span class="n">TerminalApplication</span><span class="p">]</span>
<span class="c1"># Tell Gate One about our terminal-specific static file handler</span>
<span class="n">web_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
    <span class="s1">r&#39;terminal/static/(.*)&#39;</span><span class="p">,</span>
    <span class="n">TermStaticFiles</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;gateone.applications.terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;/static&#39;</span><span class="p">)}</span>
<span class="p">))</span>
<span class="n">web_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">r&#39;terminal/shared/(.*)&#39;</span><span class="p">,</span> <span class="n">SharedTermHandler</span><span class="p">))</span>

<span class="c1"># Command line argument commands</span>
<span class="n">commands</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;termlog&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">logviewer_main</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;View terminal session logs.&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Liftoff Software Corporation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script type="text/javascript">
window.onload = function(e) {
    // Make our collapseindex elements actually collapsible
    $('<span class="collapsindextitle">Index</span> <a class="showhide">[show]</a>').insertBefore('.collapseindex');
    $('.showhide').each(function(index, value){
        var showHide = $(this);
        showHide.click(function() {
            if (this.innerHTML == "[hide]") {
                this.innerHTML = "[show]";
            } else {
                this.innerHTML = "[hide]";
            }
            $(this).next('.collapseindex').toggle(1); // This should always be the next .collapseindex element
        });
    });
    $('.collapseindex').each(function(index, value){
        // Start them out hidden
        $(this).hide();
    });
}
</script>


</body>
</html>